IDM DNS Problems
Red Hat Enterprise Linux 7.3
Filed on May 14 2017 09:21:46 AM -07:00 by Grace Thompson
Assigned to Jo Vilicic
PREMIUM Support Level
Waiting on Customer

1 (Urgent)

IDM DNS Problems
What problem/issue/behavior are you having trouble with?  What do you expect to see?

Most likely related to all our current Sev1 IDM tickets, now our DNS is acting up and showing intermittent problems not resolving host. This is impacting us.  Can somebody webex/bomgar with me now please? thanks
Product
Red Hat Enterprise Linux

Product Version
7.3

Alternate Case ID

Case Group
Ungrouped Case

Case Contact
dts-gracet

Case Type
Defect / Bug

Hostname 

24x7 Support

24x7 Contact

Save Changes
Send Email Notifications to
Don Siegfriedt <dts-siegfriedt>Grace Thompson <dts-gracet>
Top Solutions
 How to configure the BIND DNS service
 If the configuration has a problem, this command will show the error. If the configuration is OKAY, this command will return nothing. Start the DNS server: # chkconfig--level 35 named on # service named start #### How to configure multi-view DNS#### {#multi_view} In some environments, the same domain name needs
 Which network ports are used by Identity Management (IdM)?
* Which network ports are used by Identity Management (IdM)/IPA?- What network ports are used by Identity Management (IdM)? * Which ports does Identity Management (IdM)/IPA require?- Which firewall ports must I open for IdM (IPA)?- Which firewall ports need to be opened for functioning of IPA
 Integrate OpenShift Enterprise with IPA
- I would like to use IPA as my DNS solution and authentication solution for OpenShift Enterprise The following [Reference Architecture](https://access.redhat.com/sites/default/files/attachments/integrating-ose-with-idm-for-rhel-1.0-new.pdf) covers the IPA integration with OpenShift Enterprise
BACKNEXT
Request Management Escalation

Request a management escalation if you feel that:
Your issue isn't being resolved appropriately.
Your issue needs a more senior resource.
Your issue has become more severe or should be a higher priority.
Once submitted, your case will be reviewed by a support manager. To learn more, visit The Red Hat Escalation Process

Request Management Escalation
Case Discussion
All Attachments
Private Notes
Action Plan
Sort by  
Newest to Oldest


Attach File
PostCancel
MESSAGE
Farley, Amy on May 15 2017 at 07:15 AM -07:00
Good morning, Grace.

We see the following that concerns us, in /etc/named.conf:

dynamic-db "ipa" {
        library "ldap.so";
    arg "uri ldaps://idm02.disneytoonstudios.com"; <---------------------------------
#       arg "uri ldapi://%2fvar%2frun%2fslapd-DISNEYTOONSTUDIOS-COM.socket";
        arg "base cn=dns, dc=disneytoonstudios,dc=com";
        arg "fake_mname idm01.disneytoonstudios.com."; <-----------------------------
        arg "auth_method sasl";
        arg "sasl_mech GSSAPI";
        arg "sasl_user DNS/idm01.disneytoonstudios.com";
        arg "serial_autoincrement yes";
        arg "server_id idm01.disneytoonstudios.com";
};


Normally, we would expect this to be more like:

dynamic-db "ipa" {
        library "ldap.so";
        arg "uri ldapi://%2fvar%2frun%2fslapd--DISNEYTOONSTUDIOS-COM.socket";
        arg "base cn=dns, dc=disneytoonstudios,dc=com";
        arg "server_id idm01.disneytoonstudios.com";
        arg "auth_method sasl";
        arg "sasl_mech GSSAPI";
        arg "sasl_user DNS/idm01.disneytoonstudios.com";
        arg "serial_autoincrement yes";
};

Do you know if this was changed for any specific reason?

Otherwise, can you change this file to the above and try restarting the services to see if that alleviates the DNS issues?

Reinstalling the DNS would most likely make the same kind of change.

Thanks!

Amy Farley
Technical Support Engineer
RHCE
Customer Engagement and Experience
Red Hat, Inc.


If your systems are registered on Red Hat Network (RHN), visit https://access.redhat.com/products/red-hat-subscription-management/ 
to learn why you need to migrate to the Red Hat Subscription Management (RHSM) interface by July 2017.
Reply 
MESSAGE
Rajendran, Arya on May 14 2017 at 09:28 PM -07:00
Hello Grace,


In named.conf on  idm01.disneytoonstudios.com, I can see that you have pointed to idm02.

Why it is configured so?
----
arg "uri ldaps://idm02.disneytoonstudios.com";
----

etc/resolv.conf 
# Generated by NetworkManager
search disneytoonstudios.com
nameserver 10.106.228.20
nameserver 10.106.228.19


Regards,

Arya Rajendran
Techincal Support Engineer, RHCA 
GSS , Red Hat
Reply 
MESSAGE
Thompson, Grace on May 14 2017 at 09:18 PM -07:00
Are we sure that reinstalling DNS will solve the problem? Is there something in the logs that says so? IDM01 is our main master identity server, we use it satellite provisioning, enabling DDNS etc, so our named configuration is not the default. This problem just started happening today, without me making any prior changes to DNS. The only thing that was changed to our IDM setup was re-enabling IDM03.   

(In reply to Rajendran, Arya)
> Hello Don,
> 
> As In idm01 we have issue with DNS only, I request you to reconfigure named configurations, It will not remove any records or entries on ldap backend.
> 
> It will reinstall the named configurations only.
> 
> Login to idm01.disneytoonstudios.com
> 
> Run the following command
> 
> # ipa-dns-install
> 
> 
> Once completed check whether named works fine and all records are available.
> 
> Regards,
> 
> Arya Rajendran
> Techincal Support Engineer, RHCA 
> GSS , Red Hat
Reply 
MESSAGE
Rajendran, Arya on May 14 2017 at 08:56 PM -07:00
Hello Don,

As In idm01 we have issue with DNS only, I request you to reconfigure named configurations, It will not remove any records or entries on ldap backend.

It will reinstall the named configurations only.

Login to idm01.disneytoonstudios.com

Run the following command

# ipa-dns-install


Once completed check whether named works fine and all records are available.

Regards,

Arya Rajendran
Techincal Support Engineer, RHCA 
GSS , Red Hat
Reply 
MESSAGE
Siegfriedt, Don on May 14 2017 at 08:28 PM -07:00
I did not.   I was asking if it was a good idea to be modifying while LDAP is unstable.
Reply 
MESSAGE
Rajendran, Arya on May 14 2017 at 07:23 PM -07:00
Hello,

My name is Arya Rajendran and I will be assisting you with this case durig APAC hours.

Did you run the ldapmodify in all replica's.

I can see that  idm02 still have 1095.


Regards,

Arya Rajendran
Techincal Support Engineer, RHCA 
GSS , Red Hat
Reply 
MESSAGE
Siegfriedt, Don on May 14 2017 at 06:51 PM -07:00
Hi Cory

Grace has tagged me into the fray.

the command below (ldapmodify...) I assume will remove idm03 from RUV.   Currently we have apctl stopped/shutdown on idm03.  I can only assume that is why it is not responding when the ldapsearch is performed.  We stopped idm03 in order to narrow down what is going on with our idm.

Do we want to be pruning the rest of the idm service is not stable?

dsiegfriedt@idm01:~ $ ldapsearch -x -h idm01.disneytoonstudios.com -D "cn=Directory Manager" -W -b "o=ipaca" "(&(objectclass=nstombstone)(nsUniqueId=ffffffff-ffffffff-ffffffff-ffffffff))" | grep "nsds50ruv\|nsDS5ReplicaId"
Enter LDAP Password: 
nsDS5ReplicaId: 96
nsds50ruv: {replicageneration} 555a2bff000000600000
nsds50ruv: {replica 96 ldap://idm01.disneytoonstudios.com:389} 555a2c060000006
nsds50ruv: {replica 91 ldap://idm03.disneytoonstudios.com:389} 56fb01a20000005
nsds50ruv: {replica 97 ldap://idm02.disneytoonstudios.com:389} 555a2c0e0000006
nsds50ruv: {replica 1090 ldap://idm03.disneytoonstudios.com:389} 5916fb3c00000
dsiegfriedt@idm01:~ $ 


dsiegfriedt@idm02:~ $ ldapsearch -x -h idm02.disneytoonstudios.com -D "cn=Directory Manager" -W -b "o=ipaca" "(&(objectclass=nstombstone)(nsUniqueId=ffffffff-ffffffff-ffffffff-ffffffff))" | grep "nsds50ruv\|nsDS5ReplicaId"
Enter LDAP Password: 
nsDS5ReplicaId: 97
nsds50ruv: {replicageneration} 555a2bff000000600000
nsds50ruv: {replica 97 ldap://idm02.disneytoonstudios.com:389} 555a2c0e0000006
nsds50ruv: {replica 1090 ldap://idm03.disneytoonstudios.com:389} 5916fb3c00000
nsds50ruv: {replica 1095 ldap://idm03.disneytoonstudios.com:389}
nsds50ruv: {replica 96 ldap://idm01.disneytoonstudios.com:389} 555a2c060000006
nsds50ruv: {replica 91 ldap://idm03.disneytoonstudios.com:389} 56fb01a20000005
dsiegfriedt@idm02:~ $
Reply 
MESSAGE
Brown, Corey on May 14 2017 at 05:48 PM -07:00
Hi,

North American business hours are coming to an end. This case will be transferred to our Asia-Pacific team as part of the ongoing 24x7 support on this case. Below is the handover note:

Customer's OOH contact details:  
- Name: Grace Thompson
- Phone number: 818-544-9003

Problem specification (object/defect):  
- workaround that doesn't scale well: comment out references to idm01 in /etc/resolv.conf

Current status:  
Waiting on Customer

Next steps:
- Cu needs to check the RUVs again with the ldapsearches from comment #11
- Manually remove RUVs that are not present on both systems
- more DNS troubleshooting, not sure if replication problems are disrupting DNS somehow on idm01, but idm02 has had replication problems and we have taken idm03

Additional Notes:
> Topology:
- idm01 -- Bare metal, been working for 2 years, main server, DNS doesn't work
- idm02 -- Bare metal, been working for 2 years, has some replication issues, but resolves DNS lookups, some clients are pointing only to it now in /etc/resolv.conf
- idm03 -- New VM, always had problems, put it to sleep temporarily with `ipactl stop` and we could not remove it from topology


Thanks and have a nice day.

Best Regards,

Corey Brown, RHCSA
Associate Technical Support Engineer
Customer Experience & Engagement, North America
Red Hat, Inc.

If your systems are registered on Red Hat Network (RHN), visit https://access.redhat.com/products/red-hat-subscription-management/ 
to learn why you need to migrate to the Red Hat Subscription Management (RHSM) interface by July 2017.
Reply 
MESSAGE
Brown, Corey on May 14 2017 at 04:01 PM -07:00
Hello,

My name is Corey and I will assisting Jo on this case while he is out of the office.

Please check on the RUVs again with the ldapsearches from given in the previous comment.

The RUV "nsds50ruv: {replica 1095 ldap://idm03.disneytoonstudios.com:389}" seems to be the only one not showing up on both servers.

The "Here is an full example" section explains the selection process of which RUVs to remove, but in summary, we perform this command for every replica ID returned from the ldapsearches above that do not correspond to replicas we currently have.

         # ldapmodify -ZZ -D "cn=directory manager" -W -a
         dn: cn=clean <invalid_RUV_number>, cn=cleanallruv, cn=tasks, cn=config
         objectclass: extensibleObject
         replica-base-dn: o=ipaca
         replica-id: <1095>
         cn: clean <1095>

Thanks and kind regards,

Corey Brown, RHCSA
Associate Technical Support Engineer
Customer Experience & Engagement, NA
Red Hat, Inc.

If your systems are registered on Red Hat Network (RHN), visit https://access.redhat.com/products/red-hat-subscription-management/ 
to learn why you need to migrate to the Red Hat Subscription Management (RHSM) interface by July 2017.
Reply 
ATTACHMENT
Thompson, Grace on May 14 2017 at 04:01 PM -07:00
idm-message.tgz (169.3 MB) 
SHA-256: 68cc8e319c80a080b9ed88ec5598d8d95e8bdf366166b0772c439b7e25c4f0aa
ATTACHMENT
Thompson, Grace on May 14 2017 at 04:00 PM -07:00
sosreport-idm02.disneytoonstudios.com-20170514115902.tar.xz (179.8 MB) 
SHA-256: a87fc06f27863f458caae950864ebb04f2ae073e01c6f490764103e3c593ad0d
ATTACHMENT
Thompson, Grace on May 14 2017 at 04:00 PM -07:00
idm01-var.log.messages (78.5 MB) 
SHA-256: 6c27750025d99250d2d828bb14476d679bbab939f97576ebe30a124d4812b532
messages log for idm01. You'll see named-pkcs11 errors
ATTACHMENT
Vilicic, Jo on May 14 2017 at 04:00 PM -07:00
Bomgar-grace-thompson-20170514144241.png (88.8 kB) 
SHA-256: 244cd62eeb6def40d5bcf619f9bb5a475619ccea1b3055684599cc34403a110c
contents of /etc/named.conf on idm01 with non-default `arg "uri"` line pointing to idm02 instead of local socket, but that file hasn't been modified in over a month
ATTACHMENT
Thompson, Grace on May 14 2017 at 04:00 PM -07:00
sosreport-idm01.disneytoonstudios.com-20170514115900.tar.xz (207.8 MB) 
SHA-256: bf8380161c207cc72cc36df2c114e70f911ce8b6d3a9831cc679b0d0efdeaf77
MESSAGE
Thompson, Grace on May 14 2017 at 03:42 PM -07:00
This is a high impact problem and we need this to be on 24/7 support
Reply 
MESSAGE
Thompson, Grace on May 14 2017 at 03:36 PM -07:00
I restarted named-pkcs11

[root@idm01 log]# systemctl status named-pkcs11
● named-pkcs11.service - Berkeley Internet Name Domain (DNS) with native
PKCS#11
   Loaded: loaded (/usr/lib/systemd/system/named-pkcs11.service; disabled;
vendor preset: disabled)
   Active: active (running) since Sun 2017-05-14 14:07:12 PDT; 1h 27min ago
  Process: 32967 ExecStop=/bin/sh -c /usr/sbin/rndc stop > /dev/null 2>&1
|| /bin/kill -TERM $MAINPID (code=exited, status=0/SUCCESS)
  Process: 22395 ExecReload=/bin/sh -c /usr/sbin/rndc reload > /dev/null
2>&1 || /bin/kill -HUP $MAINPID (code=exited, status=0/SUCCESS)
  Process: 32981 ExecStart=/usr/sbin/named-pkcs11 -u named $OPTIONS
(code=exited, status=0/SUCCESS)
  Process: 32978 ExecStartPre=/bin/bash -c if [ ! "$DISABLE_ZONE_CHECKING"
== "yes" ]; then /usr/sbin/named-checkconf -z /etc/named.conf; else echo
"Checking of zone files is disabled"; fi (code=exited, status=0/SUCCESS)
 Main PID: 32983 (named-pkcs11)
   CGroup: /system.slice/named-pkcs11.service
           └─32983 /usr/sbin/named-pkcs11 -u named -4

May 14 15:33:41 idm01.disneytoonstudios.com named-pkcs11[32983]:
dns_rdatatype_fromtext() failed for attribute
'idnsTemplateAttribute;cnamerecord': unknown class/type
May 14 15:33:50 idm01.disneytoonstudios.com named-pkcs11[32983]: client
10.106.228.19#62835: received notify for zone '228.106.10.in-addr.arpa':
not authoritative
May 14 15:33:50 idm01.disneytoonstudios.com named-pkcs11[32983]:
dns_rdatatype_fromtext() failed for attribute
'idnsTemplateAttribute;cnamerecord': unknown class/type
May 14 15:33:50 idm01.disneytoonstudios.com named-pkcs11[32983]:
dns_rdatatype_fromtext() failed for attribute
'idnsTemplateAttribute;cnamerecord': unknown class/type
May 14 15:33:59 idm01.disneytoonstudios.com named-pkcs11[32983]: client
10.106.228.19#62835: received notify for zone '224.106.10.in-addr.arpa':
not authoritative
May 14 15:34:08 idm01.disneytoonstudios.com named-pkcs11[32983]: client
10.106.228.19#62835: received notify for zone '229.106.10.in-addr.arpa':
not authoritative
May 14 15:34:17 idm01.disneytoonstudios.com named-pkcs11[32983]: client
10.106.228.19#62835: received notify for zone '231.106.10.in-addr.arpa':
not authoritative
May 14 15:34:26 idm01.disneytoonstudios.com named-pkcs11[32983]: client
10.106.228.19#62835: received notify for zone '230.106.10.in-addr.arpa':
not authoritative
May 14 15:34:35 idm01.disneytoonstudios.com named-pkcs11[32983]: client
10.106.228.19#62835: received notify for zone '225.106.10.in-addr.arpa':
not authoritative
May 14 15:34:44 idm01.disneytoonstudios.com named-pkcs11[32983]: client
10.106.228.19#62835: received notify for zone '226.106.10.in-addr.arpa':
not authoritative



[root@idm01 log]# ldapsearch -x -h idm01.disneytoonstudios.com -D
"cn=Directory Manager" -W -b "o=ipaca"
"(&(objectclass=nstombstone)(nsUniqueId=ffffffff-ffffffff-ffffffff-ffffffff))"
| grep "nsds50ruv\|nsDS5ReplicaId"
Enter LDAP Password:
nsDS5ReplicaId: 96
nsds50ruv: {replicageneration} 555a2bff000000600000
nsds50ruv: {replica 96 ldap://idm01.disneytoonstudios.com:389}
555a2c060000006
nsds50ruv: {replica 91 ldap://idm03.disneytoonstudios.com:389}
56fb01a20000005
nsds50ruv: {replica 97 ldap://idm02.disneytoonstudios.com:389}
555a2c0e0000006
nsds50ruv: {replica 1090 ldap://idm03.disneytoonstudios.com:389}
5916fb3c00000
[root@idm01 log]# ldapsearch -x -h idm02.disneytoonstudios.com -D
"cn=Directory Manager" -W -b "o=ipaca"
"(&(objectclass=nstombstone)(nsUniqueId=ffffffff-ffffffff-ffffffff-ffffffff))"
| grep "nsds50ruv\|nsDS5ReplicaId"
Enter LDAP Password:
nsDS5ReplicaId: 97
nsds50ruv: {replicageneration} 555a2bff000000600000
nsds50ruv: {replica 97 ldap://idm02.disneytoonstudios.com:389}
555a2c0e0000006
nsds50ruv: {replica 1090 ldap://idm03.disneytoonstudios.com:389}
5916fb3c00000
nsds50ruv: {replica 1095 ldap://idm03.disneytoonstudios.com:389}
nsds50ruv: {replica 96 ldap://idm01.disneytoonstudios.com:389}
555a2c060000006
nsds50ruv: {replica 91 ldap://idm03.disneytoonstudios.com:389}
56fb01a20000005
[root@idm01 log]# ldapsearch -x -h idm03.disneytoonstudios.com -D
"cn=Directory Manager" -W -b "o=ipaca"
"(&(objectclass=nstombstone)(nsUniqueId=ffffffff-ffffffff-ffffffff-ffffffff))"
| grep "nsds50ruv\|nsDS5ReplicaId"
Enter LDAP Password:
ldap_sasl_bind(SIMPLE): Can't contact LDAP server (-1)


[root@idm01 log]# ipa-replica-manage clean-dangling-ruv
Directory Manager password:

The server 'idm03.disneytoonstudios.com' appears to be offline.
*No dangling RUVs found*



On Sun, May 14, 2017 at 2:45 PM, Red Hat Support <support@redhat.com> wrote:




-- 


*Grace Thompson *
*Sr. Systems Engineer - DTS*
Reply 
MESSAGE
Vilicic, Jo on May 14 2017 at 02:45 PM -07:00
Hi Grace,

I also wanted to document that we are currently researching.


1) To address these errors from /var/log/messages:

     13 May 14 10:03:09 idm01 named-pkcs11[14951]: error (network unreachable) resolving 'esrs3-core.emc.com/A/IN': 2001:503:c27::2:30#53
     14 May 14 10:03:09 idm01 named-pkcs11[14951]: error (network unreachable) resolving 'esrs3-core.emc.com/A/IN': 2001:503:c27::2:30#53
     ...
  66830 May 14 11:58:59 idm01 named-pkcs11[27689]: error (network unreachable) resolving 'a18-128.akadns.org/AAAA/IN': 2001:500:f::1#53
  66831 May 14 11:58:59 idm01 named-pkcs11[27689]: error (network unreachable) resolving 'a18-128.akadns.org/AAAA/IN': 2001:500:f::1#53

   I had us perform the steps at this guide:

      "named is logging "network unreachable" messages "  --  https://access.redhat.com/solutions/153153

   a) I apologize, instead of restarting the `named` service, we will have to restart the `named-pkcs11` service:

      # systemctl status named-pkcs11

   b) Could you please attach all of /var/log/messages to this case?  The sosreport only captured from 10:03 this morning, but you mentioned that the DNS issue may have started as early as 4:00 AM.



2) For these errors in /var/log/dirsrv/slapd-DISNEYTOONSTUDIOS-COM/errors:

 558412 [14/May/2017:05:00:33.658213433 -0700] attrlist_replace - attr_replace (nsslapd-referral, ldap://idm02.disneytoonstudios.com:389/o%3Dipaca) failed.
 558413 [14/May/2017:05:00:33.659694918 -0700] attrlist_replace - attr_replace (nsslapd-referral, ldap://idm02.disneytoonstudios.com:389/o%3Dipaca) failed.
 558414 [14/May/2017:05:00:33.660591821 -0700] attrlist_replace - attr_replace (nsslapd-referral, ldap://idm02.disneytoonstudios.com:389/o%3Dipaca) failed.

   Those sounds like we have some "dangling RUVs", and some of our investigations into idm03 also pointed to similar issues.

   a) To list all the RUVs we have, could you please provide the output of these 3 commands?

      # ldapsearch -x -h idm01.disneytoonstudios.com -D "cn=Directory Manager" -W -b "o=ipaca"
"(&(objectclass=nstombstone)(nsUniqueId=ffffffff-ffffffff-ffffffff-ffffffff))" | grep "nsds50ruv\|nsDS5ReplicaId"

      # ldapsearch -x -h idm02.disneytoonstudios.com -D "cn=Directory Manager" -W -b "o=ipaca"
"(&(objectclass=nstombstone)(nsUniqueId=ffffffff-ffffffff-ffffffff-ffffffff))" | grep "nsds50ruv\|nsDS5ReplicaId"

      # ldapsearch -x -h idm03.disneytoonstudios.com -D "cn=Directory Manager" -W -b "o=ipaca"
"(&(objectclass=nstombstone)(nsUniqueId=ffffffff-ffffffff-ffffffff-ffffffff))" | grep "nsds50ruv\|nsDS5ReplicaId"


      We expect to see something like this per IdM server:

         # ldapsearch -x -h idm01.disneytoonstudios.com ...
         nsDS5ReplicaId: 4
         nsds50ruv: {replicageneration} 56f3e283000000060000
         nsds50ruv: {replica 4 ldap://idm01.disneytoonstudios.com:389} 56f3e2
         nsds50ruv: {replica 3 ldap://idm02.disneytoonstudios:389} 56f3e2
         nsds50ruv: {replica 8 ldap://idm03.disneytoonstudios:389} 56f3e7

idm01.disneytoonstudios.com:389: 4
	idm02.disneytoonstudios.com:389: 3
	idm03.disneytoonstudios.com:389: 8


   b) Please perform this command on idm01 to clean the dangling RUVs:

      # ipa-replica-manage clean-dangling-ruvs

      Then please check on the RUVs again with the ldapsearches from above.


   c) If the listing hasn't changed, we will have to remove them manually according to this guide:

      "How can I delete dangling RUVs from IPA CA tree?"
         https://access.redhat.com/solutions/2354661

      At the very bottom, the "Here is an full example" section explains the selection process of which RUVs to remove, but in summary, we perform this command for every replica ID returned from the ldapsearches above that do not correspond to replicas we currently have.

         # ldapmodify -ZZ -D "cn=directory manager" -W -a
         dn: cn=clean <invalid_RUV_number>, cn=cleanallruv, cn=tasks, cn=config
         objectclass: extensibleObject
         replica-base-dn: o=ipaca
         replica-id: <invalid_RUV_number>
         cn: clean <invalid_RUV_number>



3) Since we've narrowed down the issue and you are not currently in a "Complete Production Down without any Workaround" situation, would you mind if we adjust the Severity of this case to a 2?

   We understand that the current workaround of commenting out the reference to idm01 in /etc/resolv.conf as you were already doing does not scale well for the amount of IdM Clients you have, so we will continue working quickly towards a lasting, robust solution.  We just ask for more time to reach out to other engineers to work collaboratively, since DNS issues seem to be intertwined with larger Replication problems.


4) Could you please attach a sosreport from idm02 as well?


Take care,

Jo Vilicic
Associate Technical Support Engineer
Identity Management Team
Red Hat



If your systems are registered on Red Hat Network (RHN), visit https://access.redhat.com/products/red-hat-subscription-management/ to learn why you need to migrate to the Red Hat Subscription Management (RHSM) interface by July 2017.
Reply 
MESSAGE
Brown, Corey on May 14 2017 at 12:44 PM -07:00
Hi,

Thank you for uploading the sosreport, please allow us some time to analyze it. We will continue to research and come up with steps towards a resolution.

Best Regards,

Corey Brown
Customer Experience & Engagement, NA
Red Hat, Inc.

If your systems are registered on Red Hat Network (RHN), visit https://access.redhat.com/products/red-hat-subscription-management/ 
to learn why you need to migrate to the Red Hat Subscription Management (RHSM) interface by July 2017.
Reply 
MESSAGE
Vilicic, Jo on May 14 2017 at 11:54 AM -07:00
Hi Grace,

As an update of our progress:

1) You let us know that:
   - idm01 and idm02 are bare metal and have been around for a while
   - idm02 has been having replication problems

2) We made /etc/hosts uniform among all 3 servers:

   10.106.228.20  idm01.disneytoonstudios.com idm01
   10.106.228.19  idm02.disneytoonstudios.com idm02
   10.106.228.70  idm03.disneytoonstudios.com idm03

   And made sure idm01 and idm02 had entries in /etc/resolv.conf:

   nameserver 10.106.228.20
   nameserver 10.106.228.19
   
3) We commented out entries from resolv.conf one at a time and found that we could depend on idm02 to resolve properly, so idm01 (10.106.228.20) is the server consistently unable to handle DNS lookups.


Take care,

Jo Vilicic
Associate Technical Support Engineer
Identity Management Team
Red Hat



If your systems are registered on Red Hat Network (RHN), visit https://access.redhat.com/products/red-hat-subscription-management/ to learn why you need to migrate to the Red Hat Subscription Management (RHSM) interface by July 2017.
Reply 
MESSAGE
Vilicic, Jo on May 14 2017 at 10:45 AM -07:00
Hello Grace,

We saw "can't find CSN" errors on 03 and it was showing 3 RUVs for the CA:

   Certificate Server Replica Update Vectors:
	idm03.disneytoonstudios.com:389: 1095
	idm01.disneytoonstudios.com:389: 96
	idm02.disneytoonstudios.com:389: 97
	idm03.disneytoonstudios.com:389: 1090
	idm03.disneytoonstudios.com:389: 91

So we reinitialized 03 it from 01.  We later tried to remove 03 from the topology but were unsuccessful, so we are going to shut its services down for now.

Even though we still see issues with idm03, we will first focus on the DNS issue that idm01 and idm02 are experiencing.

Take care,

Jo Vilicic
Associate Technical Support Engineer
Identity Management Team
Red Hat



If your systems are registered on Red Hat Network (RHN), visit https://access.redhat.com/products/red-hat-subscription-management/ to learn why you need to migrate to the Red Hat Subscription Management (RHSM) interface by July 2017.
Reply 
MESSAGE
Thompson, Grace on May 14 2017 at 10:22 AM -07:00
[root@idm03 slapd-DISNEYTOONSTUDIOS-COM]# tail -f errors
[14/May/2017:09:54:30.926462725 -0700] NSMMReplicationPlugin - agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389): Data required to update replica has been purged from the changelog. The replica must be reinitialized.
[14/May/2017:09:54:33.947624673 -0700] agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389) - Can't locate CSN 5910f8b7000d00030000 in the changelog (DB rc=-30988). If replication stops, the consumer may need to be reinitialized.
[14/May/2017:09:54:33.950244091 -0700] NSMMReplicationPlugin - changelog program - agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389): CSN 5910f8b7000d00030000 not found, we aren't as up to date, or we purged
[14/May/2017:09:54:33.953248701 -0700] NSMMReplicationPlugin - agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389): Data required to update replica has been purged from the changelog. The replica must be reinitialized.
[14/May/2017:09:54:36.979040977 -0700] agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389) - Can't locate CSN 5910f8b7000d00030000 in the changelog (DB rc=-30988). If replication stops, the consumer may need to be reinitialized.
[14/May/2017:09:54:36.982331599 -0700] NSMMReplicationPlugin - changelog program - agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389): CSN 5910f8b7000d00030000 not found, we aren't as up to date, or we purged
[14/May/2017:09:54:36.984469732 -0700] NSMMReplicationPlugin - agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389): Data required to update replica has been purged from the changelog. The replica must be reinitialized.
[14/May/2017:09:54:40.005751432 -0700] agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389) - Can't locate CSN 5910f8b7000d00030000 in the changelog (DB rc=-30988). If replication stops, the consumer may need to be reinitialized.
[14/May/2017:09:54:40.008216398 -0700] NSMMReplicationPlugin - changelog program - agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389): CSN 5910f8b7000d00030000 not found, we aren't as up to date, or we purged
[14/May/2017:09:54:40.010414869 -0700] NSMMReplicationPlugin - agmt="cn=meToidm01.disneytoonstudios.com" (idm01:389): Data required to update replica has been purged from the changelog. The replica must be reinitialized.
Reply 
MESSAGE
Thompson, Grace on May 14 2017 at 10:22 AM -07:00
[root@idm03 slapd-DISNEYTOONSTUDIOS-COM]# ipa-replica-manage re-initialize --from idm01.disneytoonstudios.com
Directory Manager password:

ipa: INFO: Setting agreement cn=meToidm03.disneytoonstudios.com,cn=replica,cn=dc\=disneytoonstudios\,dc\=com,cn=mapping tree,cn=config schedule to 2358-2359 0 to force synch
ipa: INFO: Deleting schedule 2358-2359 0 from agreement cn=meToidm03.disneytoonstudios.com,cn=replica,cn=dc\=disneytoonstudios\,dc\=com,cn=mapping tree,cn=config
Update in progress, 4 seconds elapsed
Update succeeded

[root@idm03 slapd-DISNEYTOONSTUDIOS-COM]# ipa-replica-manage list-ruv
Directory Manager password:

Replica Update Vectors:
	idm01.disneytoonstudios.com:389: 4
	idm02.disneytoonstudios.com:389: 3
	idm03.disneytoonstudios.com:389: 8
Certificate Server Replica Update Vectors:
	idm03.disneytoonstudios.com:389: 1095
	idm01.disneytoonstudios.com:389: 96
	idm02.disneytoonstudios.com:389: 97
	idm03.disneytoonstudios.com:389: 1090
	idm03.disneytoonstudios.com:389: 91
[root@idm03 slapd-DISNEYTOONSTUDIOS-COM]# ipa-csreplica-manage list
Directory Manager password:

idm01.disneytoonstudios.com: master
idm03.disneytoonstudios.com: master
idm02.disneytoonstudios.com: master
Reply 
MESSAGE
Thompson, Grace on May 14 2017 at 10:04 AM -07:00
[root@idm03 ~]# ldapsearch -xLLL -D "cn=directory manager" -W -b "cn=config" "(cn=replica)" nsDS5ReplicaId
Enter LDAP Password:
dn: cn=replica,cn=dc\3Ddisneytoonstudios\2Cdc\3Dcom,cn=mapping tree,cn=config
nsDS5ReplicaId: 8

dn: cn=replica,cn=o\3Dipaca,cn=mapping tree,cn=config
nsDS5ReplicaId: 1090
Reply 
MESSAGE
Vilicic, Jo on May 14 2017 at 09:30 AM -07:00
Hello Grace,

Thank you for contacting Red Hat Technical Support -- my name is Jo and I'll be assisting you with this case.

These are the details for our Bomgar Remote Session, so we can see the problem happening:

   Session Key: 0177787

   URL: https://remotesupport.redhat.com/?ak=dbbee0161beaf8147a526cadc91f4228


Take care,

Jo Vilicic
Associate Technical Support Engineer
Identity Management Team
Red Hat

>>>>><<<<<
17Oct17 Notes from RHEL 7 IDM

PDF located:
/disney/home/dsiegfriedt/JOBS/DISNEYTS/IDM/Red_Hat_Enterprise_Linux-7-Linux_Domain_Identity_Authentication_and_Policy_Guide-en-US.pdf

PAGE:
12	KDC
13	NO NTP on virtual instances
14	sssd
54	ipa topologycheck
64	ip stop/start
66	klist
84	ipa topologysegment-find
84	ipa topologysegment-show
88	ipa server-show
106	list of files to B/U
141	ipa user-find
141	ipa stageuser-find
141	ipa user-show <login name>


>>>>><<<<<
19Oct17

@@@ get cert
[root@skipper ~]# keytool -exportcert -keystore /etc/pki/ovirt-engine/.truststore -alias cacert -storepass mypass -file /root/rhvm.cer

keytool 
	-exportcert 
	-keystore /etc/pki/ovirt-engine/.truststore 
	-alias cacert 
	-storepass mypass 
	-file /root/rhvm.cer

@@@ command line to collect list of hostnames

/usr/bin/rhevm-shell -c -u root -l "https://rhevm.disneytoonstudios.com/ovirt-engine" -A /root/rhvm.cer -E "list-vms --show-all"

/usr/bin/rhevm-shell 
		     -c 
		     -u root 
		     -l "https://rhevm.disneytoonstudios.com/ovirt-engine" 
		     -A /root/rhvm.cer 
		     -E "list-vms --show-all"


>>>>><<<<<


>>>>><<<<<


>>>>><<<<<


>>>>><<<<<



>>>>><<<<<


>>>>><<<<<


>>>>><<<<<


>>>>><<<<<


>>>>><<<<<



>>>>><<<<<


>>>>><<<<<


>>>>><<<<<


>>>>><<<<<


>>>>><<<<<



