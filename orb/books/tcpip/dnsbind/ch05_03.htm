<HTML><HEAD><TITLE>[Chapter 5] 5.3 The MX Algorithm</TITLE><METANAME="DC.title"CONTENT="DNS &amp; BIND"><METANAME="DC.creator"CONTENT="Cricket Liu &amp; Paul Albitz"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T18:28:29Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-512-2"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch05_01.htm"TITLE="5. DNS and Electronic Mail"><LINKREL="prev"HREF="ch05_02.htm"TITLE="5.2 What's a Mail Exchanger, Again?"><LINKREL="next"HREF="ch06_01.htm"TITLE="6. Configuring Hosts"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="DNS &amp; BIND"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="DNS &amp; BIND"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/dsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch05_02.htm"TITLE="5.2 What's a Mail Exchanger, Again?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 5.2 What's a Mail Exchanger, Again?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 5<BR><SPANCLASS="acronym">DNS</SPAN> and Electronic Mail</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="CHAPTER"HREF="ch06_01.htm"TITLE="6. Configuring Hosts"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 6. Configuring Hosts"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="AUTOID-4279">5.3 The <SPANCLASS="acronym">MX</SPAN> Algorithm</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="DNS3-IDX-5-MX-RECORDS-ROUTING-LOOPS"></A><ACLASS="indexterm"NAME="DNS3-IDX-5-ROUTING-LOOPS"></A><ACLASS="indexterm"NAME="DNS3-IDX-5-ELECTRONIC-MAIL-ROUTING-LOOPS"></A>That's the basic idea behind <SPANCLASS="acronym">MX</SPAN> records and mailexchangers, but there are a few more wrinkles you should knowabout. To avoid routing loops, mailers need to use a slightly morecomplicated algorithm than what we've described when they determinewhere to send mail.[2]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[2] This algorithm is based on <SPANCLASS="acronym">RFC</SPAN> 974, whichdescribes how Internet mail routing works.</P></BLOCKQUOTE><PCLASS="para">Imagine what would happen if mailers didn't check for routingloops. Let's say you send mail from your workstation to<ACLASS="email"HREF="mailto:nuts@ora.com"TITLE="nuts@ora.com">nuts@ora.com</A>, raving (or raging) about the quality ofthis book. Unfortunately, <ICLASS="systemitem.sitename">ora.ora.com</I> is down at the moment. Noproblem! Recall <ICLASS="systemitem.sitename">ora.com</I>'s<SPANCLASS="acronym">MX</SPAN> records:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">ora.com.    IN    MX    0  ora.ora.com.ora.com.    IN    MX    10 ruby.ora.com.ora.com.    IN    MX    10 opal.ora.com.</PRE></BLOCKQUOTE><PCLASS="para">Your mailer falls back and sends your message to <ICLASS="systemitem.sitename">ruby.ora.com</I>, which is up. <ICLASS="systemitem.sitename">ruby</I>'s mailer then tries to forward themail on to <ICLASS="systemitem.sitename">ora.ora.com</I>, butcan't, because <ICLASS="systemitem.sitename">ora.ora.com</I> isdown. Now what? Unless <ICLASS="systemitem.sitename">ruby</I>checks the sanity of what she is doing, she'll try to forward themessage to <ICLASS="systemitem.sitename">opal.ora.com</I>, ormaybe even to herself. That's certainly not going to help get the maildelivered. If <ICLASS="systemitem.sitename">ruby</I> sends themessage to herself, we have a mail routing loop. If <ICLASS="systemitem.sitename">ruby</I> sends the message to <ICLASS="systemitem.sitename">opal</I>, <ICLASS="systemitem.sitename">opal</I> will either send it back to<ICLASS="systemitem.sitename">ruby</I> or send it to herself,and we again have a mail routing loop.<ACLASS="indexterm"NAME="AUTOID-4313"></A></P><PCLASS="para">To prevent this from happening, mailers discard certain<SPANCLASS="acronym">MX</SPAN> records before they decide where to send amessage. A mailer sorts the list of <SPANCLASS="acronym">MX</SPAN> records bypreference value and looks in the list for the canonical domain nameof the host it's running on. If the local host appears as a mailexchanger, the mailer discards that <SPANCLASS="acronym">MX</SPAN> record andall <SPANCLASS="acronym">MX</SPAN> records in which the preference value ishigher (that is, less preferred mail exchangers). That prevents themailer from sending messages to itself or to mailers<SPANCLASS="quote">"farther"</SPAN> from the eventual destination.</P><PCLASS="para">Let's think about this in the context of our airportanalogy. This time, imagine you're an airline passenger (a message),and you're trying to get to Greeley, Colorado. You can't get a directflight to Greeley, but you can fly to either Fort Collins or Denver(the two next highest mail exchangers). Since Fort Collins is closerto Greeley, you opt to fly to Fort Collins.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4325"></A>Now, once you've arrived in Fort Collins, there's no sense in flyingto Denver, away from your destination (a lower preference mailexchanger). (And flying from Fort Collins to Fort Collins would besilly, too.) So the only acceptable flight to get you to yourdestination is now a Fort Collins-Greeley flight.  You eliminateflights to less preferred destinations to prevent frequent flyerlooping and wasteful travel time.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4330"></A><ACLASS="indexterm"NAME="AUTOID-4333"></A>One caveat: most mailers will <EMCLASS="emphasis">only</EM> look fortheir local host's <ICLASS="firstterm">canonical</I> domain name in thelist of <SPANCLASS="acronym">MX</SPAN> records. They don't check for aliases(domain names on the left side of <SPANCLASS="acronym">CNAME</SPAN>records). Unless you always use canonical names in your<SPANCLASS="acronym">MX</SPAN> records, there's no guarantee a mailer will beable to find itself in the <SPANCLASS="acronym">MX</SPAN> list, and you'll runthe risk of having your mail loop. If you send mail addressed to aparticular domain name to a mailer that isn't configured to acceptmail for that domain name, and it finds itself as the most preferredmail exchanger, it may bounce the mail with the error:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">554 MX list for movie.edu points back to relay.isp.com554 &lt;root@movie.edu&gt;... Local configuration error</PRE></BLOCKQUOTE><PCLASS="para">This replaces the quainter <SPANCLASS="quote">"I refuse to talk tomyself"</SPAN> error in newer versions of<KBDCLASS="command">sendmail</KBD>. The moral: in an <SPANCLASS="acronym">MX</SPAN>record, always use the mail exchanger's canonical name.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4348"></A>One more caveat: the hosts you list as mail exchangers<EMCLASS="emphasis">must</EM> have address records. A mailer needs to findan address for each mail exchanger you name, or else it can't attemptdelivery there.</P><PCLASS="para">To go back to our <ICLASS="systemitem.sitename">ora.com</I> example, when <ICLASS="systemitem.sitename">ruby</I> received the message from yourworkstation, her mailer would have checked the list of<SPANCLASS="acronym">MX</SPAN> records:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">ora.com.    IN    MX    0  ora.ora.com.ora.com.    IN    MX    10 ruby.ora.com.ora.com.    IN    MX    10 opal.ora.com.</PRE></BLOCKQUOTE><PCLASS="para">Finding the local host's domain name in the list at preferencevalue 10, <ICLASS="systemitem.sitename">ruby</I>'s mailer woulddiscard all the records at preference value 10 or higher (the recordsin bold):</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">ora.com.    IN    MX    0 ora.ora.com.<BCLASS="emphasis.bold">ora.com.    IN    MX    10 ruby.ora.com.</B><BCLASS="emphasis.bold">ora.com.    IN    MX    10 opal.ora.com.</B></PRE></BLOCKQUOTE><PCLASS="para">leaving only:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">ora.com.    IN    MX    0 ora.ora.com.</PRE></BLOCKQUOTE><PCLASS="para">Since <ICLASS="systemitem.sitename">ora.ora.com</I> isdown, <ICLASS="systemitem.sitename">ruby</I> would deferdelivery until later, and queue the message.</P><PCLASS="para">What happens if a mailer finds <EMCLASS="emphasis">itself</EM> atthe highest preference (lowest preference value), and has to discardthe whole <SPANCLASS="acronym">MX</SPAN> list? Some mailers attempt deliverydirectly to the destination host's <SPANCLASS="acronym">IP</SPAN> address, as alast-ditch effort. In most mailers, however, it's an error. It mayindicate that <SPANCLASS="acronym">DNS</SPAN> thinks the mailer should beprocessing (not just forwarding) mail for the destination, but themailer hasn't been configured to know that. Or it may indicate thatthe administrator has ordered the <SPANCLASS="acronym">MX</SPAN> recordsincorrectly by using the wrong preference values.</P><PCLASS="para">Say, for example, the folks who run <ICLASS="systemitem.sitename">acme.com</I> add a mail exchanger record todirect mail addressed to <ICLASS="systemitem.sitename">acme.com</I> to a mailer at their InternetService Provider:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">acme.com.    IN    MX    10 mail.isp.net.</PRE></BLOCKQUOTE><PCLASS="para">Many mailers need to be configured to identify their aliases andthe names of other hosts they process mail for. Unless the mailer on<ICLASS="systemitem.sitename">mail.isp.net</I> is configured torecognize email addressed to <ICLASS="systemitem.sitename">acme.com</I> as local mail, it will assumeit's being asked to relay the mail and attempt to forward the mail toa mail exchanger closer to the final destination.[3] When it looks up the <SPANCLASS="acronym">MX</SPAN> records for<ICLASS="systemitem.sitename">acme.com</I>, it'll find itselfas the most preferred mail exchanger, and return the mail to thesender.  Then it will bounce the mail with the familiar error:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[3] Unless, of course, <ICLASS="systemitem.sitename">mail.isp.net</I>'s mailer is configured not torelay mail for unknown domains.</P></BLOCKQUOTE><BLOCKQUOTECLASS="screen"><PRECLASS="screen">554 MX list for acme.com points back to mail.isp.com554 &lt;root@acme.com&gt;... Local configuration error</PRE></BLOCKQUOTE><PCLASS="para">Many versions of <KBDCLASS="command">sendmail</KBD> use class<ICLASS="wordasword">w</I> or fileclass <ICLASS="wordasword">w</I> asthe list of <SPANCLASS="quote">"local"</SPAN> destinations. Depending on your<ICLASS="filename">sendmail.cf</I> file, adding an alias can be as easyas adding the line</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Cw acme.com</PRE></BLOCKQUOTE><PCLASS="para">to <ICLASS="filename">sendmail.cf</I>. If your mailer uses anothermail transport, such as <SPANCLASS="acronym">UUCP</SPAN>, to deliver mail tothe hosts it acts as a mail exchanger for, this will probably requiremore involved configuration.[4]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[4] Configuring <SPANCLASS="acronym">UUCP</SPAN>, while beyond the scope ofthis book, is covered in <CITECLASS="citetitle">Using &amp; Managinguucp</CITE>, by Ed Ravin, published by O'Reilly &amp; Associates(1996).</P></BLOCKQUOTE><PCLASS="para">You may have noticed that we tend to use multiples of ten forour preference values.  Ten is convenient because it allows you toinsert other <SPANCLASS="acronym">MX</SPAN> records temporarily at intermediatevalues without changing the other weights, but otherwise there'snothing magical<ACLASS="indexterm"NAME="AUTOID-4402"></A><ACLASS="indexterm"NAME="AUTOID-4403"></A><ACLASS="indexterm"NAME="AUTOID-4404"></A>about it.<ACLASS="indexterm"NAME="AUTOID-4405"></A></P></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch05_02.htm"TITLE="5.2 What's a Mail Exchanger, Again?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 5.2 What's a Mail Exchanger, Again?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="DNS &amp; BIND"><IMGSRC="../gifs/txthome.gif"ALT="DNS &amp; BIND"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="CHAPTER"HREF="ch06_01.htm"TITLE="6. Configuring Hosts"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 6. Configuring Hosts"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">5.2 What's a Mail Exchanger, Again?</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">6. Configuring Hosts</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>