<HTML><HEAD><TITLE>[Chapter 8] 8.5 Planning for Disasters</TITLE><METANAME="DC.title"CONTENT="DNS &amp; BIND"><METANAME="DC.creator"CONTENT="Cricket Liu &amp; Paul Albitz"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T18:33:54Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-512-2"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch08_01.htm"TITLE="8. Growing Your Domain"><LINKREL="prev"HREF="ch08_04.htm"TITLE="8.4 Changing TTLs"><LINKREL="next"HREF="ch08_06.htm"TITLE="8.6 Coping with Disaster"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="DNS &amp; BIND"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="DNS &amp; BIND"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/dsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_04.htm"TITLE="8.4 Changing TTLs"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 8.4 Changing TTLs"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 8<BR>Growing Your Domain</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_06.htm"TITLE="8.6 Coping with Disaster"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 8.6 Coping with Disaster"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="AUTOID-9035">8.5 Planning for Disasters</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="DNS3-IDX-8-TROUBLESHOOTING-PREVENTING-AND-HANDLING-DISASTERS"></A><ACLASS="indexterm"NAME="DNS3-IDX-8-ADMINISTRATION-PREVENTING-AND-HANDLING-DISASTERS"></A><ACLASS="indexterm"NAME="DNS3-IDX-8-PREVENTING-DISASTERS"></A><ACLASS="indexterm"NAME="DNS3-IDX-8-ERRORS-DISASTERS"></A><ACLASS="indexterm"NAME="DNS3-IDX-8-DISASTERS-PREVENTING-AND-HANDLING"></A><ACLASS="indexterm"NAME="DNS3-IDX-8-DNS-DOMAIN-NAME-SYSTEM-DISASTERS"></A>It's a fact of life on a network that things go wrong. Hardware fails,software has bugs, and people very occasionally makemistakes. Sometimes this results in minor inconvenience, like having afew users lose connections. Sometimes the results are catastrophicand involve the loss of important data and valuable jobs.</P><PCLASS="para">Because the Domain Name System relies so heavily on the network,it is vulnerable to network outages.  Thankfully, the design of<SPANCLASS="acronym">DNS</SPAN> takes into account the imperfection ofnetworks: it allows for multiple, redundant name servers,retransmission of queries, retrying zone transfers, and so on.</P><PCLASS="para">The Domain Name System doesn't protect itself from everyconceivable calamity, though. There are types of networkfailure&nbsp;- some of them quite common&nbsp;- that<SPANCLASS="acronym">DNS</SPAN> doesn't or can't protect against. But with asmall investment of time and money, you can minimize the threat ofthese outages.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-9058">8.5.1 Outages</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="DNS3-IDX-8-POWER-OUTAGES"></A><ACLASS="indexterm"NAME="DNS3-IDX-8-OUTAGES"></A>Power outages, for example, are relatively common in many parts of theworld. In some parts of the U.S., thunderstorms or tornadoes may causea site to lose power, or to have only intermittent power, for anextended period. Elsewhere, typhoons, volcanoes, or construction workmay interrupt your electrical service.</P><PCLASS="para">If all your hosts are down, of course, you don't need nameservice. Quite often, however, sites have problems when power is<EMCLASS="emphasis">restored</EM>. Following our recommendations, they runtheir name servers on file servers and big multiuser machines. Andwhen the power comes up, those machines are naturally the last toboot&nbsp;- because all those disks need to be<KBDCLASS="command">fsck</KBD>ed first! Which means that all thehosts on-site that are quick to boot do so without the benefit of nameservice.</P><PCLASS="para">This can cause all sorts of wonderful problems, depending on howyour hosts' startup files are written. <SPANCLASS="acronym">UNIX</SPAN> hostsoften execute some variant of:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">    /etc/ifconfig lan0 inet `hostname` netmask 255.255.128.0 up    /etc/route add default site-router 1</PRE></BLOCKQUOTE><PCLASS="para">to bring up their network interface. Using host names in thecommands (<CODECLASS="literal">`hostname`</CODE> expands to the local host nameand <CODECLASS="literal">site-router</CODE> is the name of the local router) isadmirable for two reasons:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">It lets the administrators change the router's<SPANCLASS="acronym">IP</SPAN> address without changing all the startup fileson-site.</P></LI><LICLASS="listitem"><PCLASS="para">It lets the administrators change the host's<SPANCLASS="acronym">IP</SPAN> address by changing the <SPANCLASS="acronym">IP</SPAN>address in only one file.</P></LI></UL><PCLASS="para">Unfortunately, the<ACLASS="indexterm"NAME="AUTOID-9083"></A><KBDCLASS="command">route</KBD> command will fail without name service.  The<KBDCLASS="command">ifconfig</KBD> command will fail only if the localhost'sname and <SPANCLASS="acronym">IP</SPAN> address don't appear in the host's<ICLASS="filename">/etc/hosts</I> file, so it's a good idea to leave atleast that data in each host's <ICLASS="filename">/etc/hosts</I>.</P><PCLASS="para">By the time the startup sequence reaches the<KBDCLASS="command">route</KBD> command, the network interface will be up,and the host will use name service to map the name of the router to an<SPANCLASS="acronym">IP</SPAN> address. And since the host has no default routeuntil the <KBDCLASS="command">route</KBD> command is executed, the only nameservers it can reach are those on the local subnet.</P><PCLASS="para">If the booting host can reach a working name server on its localsubnet, it can execute the <KBDCLASS="command">route</KBD> commandsuccessfully. Quite often, however, one or more of the name servers itcan reach aren't yet running. What happens then depends on thecontents of<ACLASS="indexterm"NAME="AUTOID-9096"></A><ICLASS="filename">resolv.conf</I>.</P><PCLASS="para">In <SPANCLASS="acronym">BIND</SPAN> 4.9 and <SPANCLASS="acronym">BIND</SPAN> 8,the resolver will only fall back to the host table if there is onlyone name server listed in <ICLASS="filename">resolv.conf</I> (or if noname server is listed, and the resolver defaults to using a nameserver on the local host). If only one name server is configured, theresolver will query it, and if the network returns an error each timethe resolver sends a query, the resolver will fall back to searchingthe host table. The errors that cause the resolver to fall backinclude:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Receipt of an<ACLASS="indexterm"NAME="AUTOID-9107"></A><ACLASS="indexterm"NAME="AUTOID-9109"></A><SPANCLASS="acronym">ICMP</SPAN> <TTCLASS="computeroutput">portunreachable</TT> message</P></LI><LICLASS="listitem"><PCLASS="para">Receipt of an <SPANCLASS="acronym">ICMP</SPAN> <TTCLASS="computeroutput">networkunreachable</TT> message</P></LI><LICLASS="listitem"><PCLASS="para">Inability to send the <SPANCLASS="acronym">UDP</SPAN> packet (e.g.,because networking is not yet running on the local host)[11]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[11] Check <ACLASS="xref"HREF="ch06_01.htm"TITLE="Configuring Hosts">Chapter 6, <CITECLASS="chapter">Configuring Hosts</CITE></A>, for vendor-specificenhancements to and variants on this resolver algorithm.</P></BLOCKQUOTE></LI></UL><PCLASS="para">If the host running the one configured name server isn't runningat all, though, the resolver won't receive any errors. The name serveris effectively a black hole. After about 75 seconds of trying, theresolver will just time out and return a null answer to theapplication that called it. Only if the name server host has actuallystarted networking&nbsp;- but not yet started the nameserver&nbsp;- will the resolver get an error: an<SPANCLASS="acronym">ICMP</SPAN> port unreachable message.</P><PCLASS="para">Overall, the single name server configuration does work if youhave name servers available on each net, but perhaps not as elegantlyas we might like. If the local name server hasn't come up when a hoston its network reboots, the <KBDCLASS="command">route</KBD> command willfail.</P><PCLASS="para">This may seem awkward, but it's not nearly as bad as whathappens with multiple servers. With multiple servers listed in<ICLASS="filename">resolv.conf</I>, <SPANCLASS="acronym">BIND</SPAN><EMCLASS="emphasis">never</EM> falls back to the host table after theprimary network interface has been<KBDCLASS="command">ifconfig</KBD>ed.  The resolver simply loopsthrough the name servers, querying them until one answers or the75-plus second timeout is reached.</P><PCLASS="para">This is especially problematic during bootup. If none of theconfigured name servers are available, the resolver will time outwithout returning an <SPANCLASS="acronym">IP</SPAN> address, and adding thedefault route will fail.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-9134">8.5.2 Recommendations</A></H3><PCLASS="para">Our recommendation, as primitive as it sounds, is to hardcodethe <SPANCLASS="acronym">IP</SPAN> address of the default router into thestartup file, or to use an external file (many systems use<ACLASS="indexterm"NAME="AUTOID-9138"></A><ACLASS="indexterm"NAME="AUTOID-9140"></A><ICLASS="filename">/etc/defaultrouter</I>). This will ensure that yourhost's networking will start correctly.</P><PCLASS="para">An alternative is to list just a single, reliable name server onyour host's local net in <ICLASS="filename">resolv.conf</I>. This willallow you to use the name of the default router in the startup file,as long as you make sure that the router's name appears in<ICLASS="filename">/etc/hosts</I> (in case your reliable name serverisn't running when the host reboots).  Of course, if the host runningthe reliable name server isn't running when your host reboots, allbets are off. You won't fall back to <ICLASS="filename">/etc/hosts</I>,because there won't be any networking running to return an error toyour host.</P><PCLASS="para">If your vendor's version of <SPANCLASS="acronym">BIND</SPAN> allowsconfiguration of the order in which services are queried, or will fallback from <SPANCLASS="acronym">DNS</SPAN> to <ICLASS="filename">/etc/hosts</I> if<SPANCLASS="acronym">DNS</SPAN> doesn't find an answer, take advantage of it!In the former case, you can configure the resolver to check&nbsp;<ICLASS="filename">/etc/hosts</I> first, and then keep a<SPANCLASS="quote">"stub"</SPAN> <ICLASS="filename">/etc/hosts</I> file on each host,including the default router and the local host's name. In the lattersituation, just make sure such a <SPANCLASS="quote">"stub"</SPAN><ICLASS="filename">/etc/hosts</I> exists; no other configuration shouldbe necessary.</P><PCLASS="para">A last, promising prospect is to do away with setting thedefault route manually by using<ACLASS="indexterm"NAME="AUTOID-9158"></A><ICLASS="firstterm"><SPANCLASS="acronym">ICMP</SPAN> Router DiscoveryMessages</I>. This extension to the <SPANCLASS="acronym">ICMP</SPAN>protocol, described in <SPANCLASS="acronym">RFC</SPAN> 1256, uses broadcast ormulticast messages to dynamically discover and advertise routers on anetwork.  Sun includes an implementation of this protocol in recentversions of Solaris as <ICLASS="filename">/usr/sbin/in.rdisc</I>, andnewer versions of Cisco's Internetwork Operating System(<SPANCLASS="acronym">IOS</SPAN>) support it too.</P><PCLASS="para">And what if your default route is added correctly, but the nameservers still haven't come up? This can affect<KBDCLASS="command">sendmail</KBD>, <SPANCLASS="acronym">NFS</SPAN>, and a slew ofother services. <KBDCLASS="command">sendmail</KBD> won't canonicalize hostnames correctly without <SPANCLASS="acronym">DNS</SPAN>, and your<SPANCLASS="acronym">NFS</SPAN> mounts may fail.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9174"></A><ACLASS="indexterm"NAME="AUTOID-9177"></A><ACLASS="indexterm"NAME="AUTOID-9179"></A>The best solution to this problem is to run a name server on a hostwith uninterruptible power. If you rarely experience extended powerloss, battery backup might be enough. If your outages are longer, andname service is critical to you, you should consider anuninterruptible power system (<SPANCLASS="acronym">UPS</SPAN>) with a generatorof some kind.</P><PCLASS="para">If you can't afford luxuries like these, you might just try totrack down the fastest booting host around and run a name server onit.  Hosts with filesystem journaling should boot especially quickly,since they don't need to <KBDCLASS="command">fsck</KBD>. Hosts with smallfilesystems should boot quickly, too, since they don't have as muchfilesystem to check.</P><PCLASS="para">Once you've located the right host, you'll need to make sure thehost's <SPANCLASS="acronym">IP</SPAN> address appears in the<ICLASS="filename">resolv.conf</I> files of all the hosts that needfull-time name service. You'll probably want to list the backed-uphost last, since during normal operation, hosts should use the nameserver closest to them. Then, after a power failure, your criticalapplications will still have name service, albeit at a small sacrificein performance.<ACLASS="indexterm"NAME="AUTOID-9187"></A><ACLASS="indexterm"NAME="AUTOID-9190"></A></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_04.htm"TITLE="8.4 Changing TTLs"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 8.4 Changing TTLs"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="DNS &amp; BIND"><IMGSRC="../gifs/txthome.gif"ALT="DNS &amp; BIND"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_06.htm"TITLE="8.6 Coping with Disaster"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 8.6 Coping with Disaster"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">8.4 Changing TTLs</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">8.6 Coping with Disaster</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>