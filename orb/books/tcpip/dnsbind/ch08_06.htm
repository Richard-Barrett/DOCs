<HTML><HEAD><TITLE>[Chapter 8] 8.6 Coping with Disaster</TITLE><METANAME="DC.title"CONTENT="DNS &amp; BIND"><METANAME="DC.creator"CONTENT="Cricket Liu &amp; Paul Albitz"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T18:34:03Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-512-2"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch08_01.htm"TITLE="8. Growing Your Domain"><LINKREL="prev"HREF="ch08_05.htm"TITLE="8.5 Planning for Disasters"><LINKREL="next"HREF="ch09_01.htm"TITLE="9. Parenting"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="DNS &amp; BIND"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="DNS &amp; BIND"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/dsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_05.htm"TITLE="8.5 Planning for Disasters"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 8.5 Planning for Disasters"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 8<BR>Growing Your Domain</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="CHAPTER"HREF="ch09_01.htm"TITLE="9. Parenting"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 9. Parenting"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="AUTOID-9193">8.6 Coping with Disaster</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9196"></A>When disaster strikes, it really helps to know what to do. Knowing toduck under a sturdy table or desk during an earthquake can save youfrom being pinned under a toppling monitor. Knowing how to turn offyour gas can save your house from conflagration.</P><PCLASS="para">Likewise, knowing what to do in a network disaster (or even justa minor mishap) can help you keep your network running. Living out inCalifornia, as we do, we have some experience and somesuggestions.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-9200">8.6.1 Short Outages (Hours)</A></H3><PCLASS="para">If your network is cut off from the outside world (whether<SPANCLASS="quote">"the outside world"</SPAN> is the rest of the Internet or therest of your company), your name servers may start to have troubleresolving names. For example, if your domain, <ICLASS="systemitem.sitename">corp.acme.com</I>, is cut off from the restof the Acme Internet, you may not have access to your parent(<ICLASS="systemitem.sitename">acme.com</I>) name servers, orto the root name servers.</P><PCLASS="para">You'd think this wouldn't impact communication between hosts inyour local domain, but it can. For example, if you type:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>telnet selma.corp.acme.com</B></CODE></PRE></BLOCKQUOTE><PCLASS="para">on a host running an older version of the resolver, the firstdomain name the resolver looks up will be <ICLASS="systemitem.sitename">selma.corp.acme.com.corp.acme.com</I>(assuming your host is using the default search list&nbsp;- rememberthis from <ACLASS="xref"HREF="ch06_01.htm"TITLE="Configuring Hosts">Chapter 6</A>). The local domain name server,if it's authoritative for <ICLASS="systemitem.sitename">corp.acme.com</I>, can tell that's not akosher domain name. The following lookup, however, is for <ICLASS="systemitem.sitename">selma.corp.acme.com.acme.com</I>.  Thisprospective domain name is no longer in the <ICLASS="systemitem.sitename">corp.acme.com</I> domain, so the query issent to the <ICLASS="systemitem.sitename">acme.com</I> nameservers.  Or rather your local name server <EMCLASS="emphasis">tries</EM>to send the query there, and keeps retransmitting until it timesout.</P><PCLASS="para">You can avoid this problem by making sure the first domain namethe resolver looks up is the right one. Instead of typing:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>telnet selma.corp.acme.com</B></CODE></PRE></BLOCKQUOTE><PCLASS="para">typing:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>telnet selma</B></CODE></PRE></BLOCKQUOTE><PCLASS="para">or:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>telnet selma.corp.acme.com.</B></CODE></PRE></BLOCKQUOTE><PCLASS="para">(note the trailing dot) will result in a lookup of <ICLASS="systemitem.sitename">selma.corp.acme.com</I> first.</P><PCLASS="para">Note that <SPANCLASS="acronym">BIND</SPAN> 4.9 and later resolvers don'thave this problem, at least not by default. 4.9 and newer resolverscheck the domain name as is first, as long as the name has more thanone dot in it.  So, if you tried:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>telnet selma.corp.acme.com</B></CODE></PRE></BLOCKQUOTE><PCLASS="para">even without the trailing dot, the first name looked up would be<ICLASS="systemitem.sitename">selma.corp.acme.com</I>.</P><PCLASS="para">If you are stuck running a 4.8.3 <SPANCLASS="acronym">BIND</SPAN> orolder resolver, you can avoid querying off-site name servers by takingadvantage of the definable search list. You can use the<ICLASS="structfield">search</I> directive to define a search listthat doesn't include your parent zone's domain name.  For example, towork around the problem <ICLASS="systemitem.sitename">corp.acme.com</I> is having, you couldtemporarily set your hosts' search lists to just:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">search corp.acme.com</PRE></BLOCKQUOTE><PCLASS="para">Now, when a user types:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>telnet selma.corp.acme.com</B></CODE></PRE></BLOCKQUOTE><PCLASS="para">the resolver looks up <ICLASS="systemitem.sitename">selma.corp.acme.com.corp.acme.com</I> first(which the local name server can answer), then <ICLASS="systemitem.sitename">selma.corp.acme.com</I>, the correct domainname. And this works fine, too:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>telnet selma</B></CODE></PRE></BLOCKQUOTE><PCLASS="para">works fine, too.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-9248">8.6.2 Longer Outages (Days)</A></H3><PCLASS="para">If you lose network connectivity for a long time, your nameservers may have other problems.  If they lose connectivity to theroot name servers for an extended period, they'll stop resolvingqueries outside their authoritative data. If the slaves can't reachtheir master, sooner or later they'll expire the zone.</P><PCLASS="para">In case your name service really goes haywire because of theconnectivity loss, it's a good idea to keep a site-wide or workgroup<ACLASS="indexterm"NAME="AUTOID-9252"></A><ACLASS="indexterm"NAME="AUTOID-9255"></A><ICLASS="filename">/etc/hosts</I> around.  In times of dire need, youcan move <ICLASS="filename">resolv.conf</I> to<ICLASS="filename">resolv.bak</I>, kill the local name server (if thereis one), and just use <ICLASS="filename">/etc/hosts</I>. It's notflashy, but it'll get you by.</P><PCLASS="para">As for slaves, you can reconfigure a slave that can't reach itsmaster to run as a primary master. Just edit<ICLASS="filename">named.conf</I> and change the type substatement inthe <ICLASS="structfield">zone</I> statement from<ICLASS="wordasword">slave</I> to <ICLASS="wordasword">master</I>,then delete the <ICLASS="wordasword">master</I> substatement. If morethan one slave for the same zone is cut off, you can configure one asa primary master temporarily and reconfigure the other to load fromthe temporary primary.</P><PCLASS="para">Alternatively, you can just increase the expire time in all ofyour slaves' backup files and then signal the slaves to reload thefiles.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-9269">8.6.3 Really Long Outages (Weeks)</A></H3><PCLASS="para">If an extended outage cuts you off from the Internet&nbsp;- sayfor a week or more&nbsp;- you may need to restore connectivity to rootname servers artificially to get things working again. Every nameserver needs to talk to a root name server occasionally. It's a bitlike therapy: the name server needs to contact the root to regain itsperspective on the world.</P><PCLASS="para">To provide<ACLASS="indexterm"NAME="AUTOID-9273"></A><ACLASS="indexterm"NAME="AUTOID-9276"></A>root name service during a long outage, you can set up your own rootname servers, <EMCLASS="emphasis">but only temporarily</EM>. Once you'rereconnected to the Internet, you <EMCLASS="emphasis">must</EM> shut offyour temporary root servers. The most obnoxious vermin on the Internetare name servers that believe they're root name servers but don't knowanything about most top-level domains. A close second is the Internetname server configured to query&nbsp;- and report&nbsp;- a false set ofroot name servers.</P><PCLASS="para">That said, and our alibis in place, here's what you have to doto configure your own root name server. First, you need to create a<ICLASS="filename">db.root</I> file.  The <ICLASS="filename">db.root</I>file will delegate to the highest-level domain in your isolatednetwork. For example, if <ICLASS="systemitem.sitename">movie.edu</I> were to be isolated from theInternet, we might create a <ICLASS="filename">db.root</I> file for<ICLASS="systemitem.sitename">terminator</I> that looked likethis:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">. IN SOA terminator.movie.edu. al.robocop.movie.edu. (                 1        ; Serial                 10800    ; Refresh after 3 hours                 3600     ; Retry after 1 hour                 604800   ; Expire after 1 week                 86400 )  ; Minimum TTL of 1 day; Refresh, retry and expire really don't matter, since all; roots are primaries.  Minimum TTL could be longer, since; the data are likely to be stable.  IN NS terminator.movie.edu. ; terminator is the temp. root; Our root only knows about movie.edu and our two; in-addr.arpa domainsmovie.edu. 86400 IN NS terminator.movie.edu.           86400 IN NS wormhole.movie.edu.249.249.192.in-addr.arpa. 86400 IN NS terminator.movie.edu.                          86400 IN NS wormhole.movie.edu.253.253.192.in-addr.arpa. 86400 IN NS terminator.movie.edu.                          86400 IN NS wormhole.movie.edu.terminator.movie.edu. 86400 IN A 192.249.249.3wormhole.movie.edu.   86400 IN A 192.249.249.1                      86400 IN A 192.253.253.1</PRE></BLOCKQUOTE><PCLASS="para">Then we need to add the appropriate line to <ICLASS="systemitem.sitename">terminator</I>'s<ICLASS="filename">named.conf</I> file:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">// Comment out hints zone// zone . {//              type hint;//                      file &quot;db.cache&quot;;//              };zone                    &quot;.&quot;     {                type master;                file &quot;db.root&quot;;};&#13;</PRE></BLOCKQUOTE><PCLASS="para">Or, for <SPANCLASS="acronym">BIND</SPAN> 4's<ICLASS="filename">named.boot</I> file:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">; cache    .   db.cache  (comment out the cache directive)primary  .   db.root</PRE></BLOCKQUOTE><PCLASS="para">We then update all of our name servers (except the new,temporary root) with a <ICLASS="filename">db.cache</I> file thatincludes just the temporary root (best to move the old cache fileaside&nbsp;- we'll need it later, once connectivity isrestored).</P><PCLASS="para">Here are the contents of the file<ICLASS="filename">db.cache</I>:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">.  99999999  IN  NS  terminator.movie.edu.terminator.movie.edu.  IN  A  192.249.249.3</PRE></BLOCKQUOTE><ACLASS="indexterm"NAME="AUTOID-9300"></A><ACLASS="indexterm"NAME="AUTOID-9301"></A><PCLASS="para">That will keep <ICLASS="systemitem.sitename">movie.edu</I> name resolution going duringthe outage. Then, once Internet connectivity is restored, we candelete the <ICLASS="structfield">zone</I> statement from<ICLASS="filename">named.conf</I> on <ICLASS="systemitem.sitename">terminator</I>, and restore the originalcache files on all our other name servers.<ACLASS="indexterm"NAME="AUTOID-9307"></A><ACLASS="indexterm"NAME="AUTOID-9308"></A><ACLASS="indexterm"NAME="AUTOID-9309"></A><ACLASS="indexterm"NAME="AUTOID-9310"></A><ACLASS="indexterm"NAME="AUTOID-9311"></A><ACLASS="indexterm"NAME="AUTOID-9312"></A></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_05.htm"TITLE="8.5 Planning for Disasters"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 8.5 Planning for Disasters"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="DNS &amp; BIND"><IMGSRC="../gifs/txthome.gif"ALT="DNS &amp; BIND"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="CHAPTER"HREF="ch09_01.htm"TITLE="9. Parenting"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 9. Parenting"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">8.5 Planning for Disasters</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">9. Parenting</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>