<HTML><HEAD><TITLE>[Chapter 9] 9.6 Good Parenting</TITLE><METANAME="DC.title"CONTENT="DNS &amp; BIND"><METANAME="DC.creator"CONTENT="Cricket Liu &amp; Paul Albitz"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T18:35:13Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-512-2"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch09_01.htm"TITLE="9. Parenting"><LINKREL="prev"HREF="ch09_05.htm"TITLE="9.5 Subdomains of in-addr.arpa Domains"><LINKREL="next"HREF="ch09_07.htm"TITLE="9.7 Managing the Transition to Subdomains"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="DNS &amp; BIND"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="DNS &amp; BIND"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/dsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch09_05.htm"TITLE="9.5 Subdomains of in-addr.arpa Domains"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 9.5 Subdomains of in-addr.arpa Domains"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 9<BR>Parenting</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch09_07.htm"TITLE="9.7 Managing the Transition to Subdomains"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 9.7 Managing the Transition to Subdomains"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="AUTOID-9916">9.6 Good Parenting</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="DNS3-IDX-9-ADMINISTRATION-CHECKING-DELEGATION"></A><ACLASS="indexterm"NAME="DNS3-IDX-9-DELEGATION-CHECKING"></A><ACLASS="indexterm"NAME="DNS3-IDX-9-TROUBLESHOOTING-CHECKING-DELEGATION"></A><ACLASS="indexterm"NAME="DNS3-IDX-9-CHECKING-DELEGATION"></A><ACLASS="indexterm"NAME="DNS3-IDX-9-CHECK-DEL-UTILITY"></A><ACLASS="indexterm"NAME="DNS3-IDX-9-CONFIGURING"></A><ACLASS="indexterm"NAME="DNS3-IDX-9-PARENTING-CHECKING-DELEGATION"></A><ACLASS="indexterm"NAME="DNS3-IDX-9-DOMAINS-PARENTING-CHECKING-DELEGATION"></A>Now that the delegation to the <ICLASS="systemitem.sitename">fx.movie.edu</I> name servers is in place,we&nbsp;- responsible parents that we are&nbsp;- should check thatdelegation using <KBDCLASS="command">check_del</KBD>. What? We haven't givenyou <KBDCLASS="command">check_del</KBD> yet? Unfortunately,<KBDCLASS="command">check_del</KBD> is too long to include in this book, butwe've made it available via anonymous <KBDCLASS="command">ftp</KBD>. See thepreface for details.  Feel free to snatch the code there and compileit if you want to follow along.</P><PCLASS="para"><KBDCLASS="command">check_del</KBD> <SPANCLASS="quote">"knows"</SPAN>delegation. <KBDCLASS="command">check_del</KBD> reads <SPANCLASS="acronym">NS</SPAN>records. For each <SPANCLASS="acronym">NS</SPAN> record,<KBDCLASS="command">check_del</KBD> issues a query to the name server listedfor the zone's <SPANCLASS="acronym">SOA</SPAN> record. The query isnonrecursive, so the name server queried doesn't query other nameservers to find the <SPANCLASS="acronym">SOA</SPAN> record. If the name serverreplies, <KBDCLASS="command">check_del</KBD> checks the reply to see whetherthe<ACLASS="indexterm"NAME="AUTOID-9957"></A><ACLASS="indexterm"NAME="AUTOID-9959"></A><ICLASS="firstterm">aa</I>&nbsp;- authoritative answer&nbsp;- bit in thereply packet is set. If it is, the name server checks to make surethat the packet contains an answer. If both these criteria are met,the name server is flagged as authoritative for the zone.  Otherwise,the name server is not authoritative, and <KBDCLASS="command">check_del</KBD>reports an error.</P><PCLASS="para">Why all the fuss over bad delegation? Incorrect delegation cancause the propagation of old and erroneous root name serverinformation. When a name server is queried for data in a zone it isn'tauthoritative for, it does its best to provide useful information tothe querier. This <SPANCLASS="quote">"useful information"</SPAN> comes in the formof <SPANCLASS="acronym">NS</SPAN> records for the closest ancestor domain thename server knows.  (We mentioned this briefly in <ACLASS="xref"HREF="ch08_01.htm"TITLE="Growing Your Domain">Chapter 8, <CITECLASS="chapter">Growing Your Domain</CITE></A>, when we discussed why you shouldn't register acaching-only name server.)</P><PCLASS="para">For example, say one of the <ICLASS="systemitem.sitename">fx.movie.edu</I> name servers mistakenlyreceives an iterative query for the address of <ICLASS="systemitem.sitename">carrie.horror.movie.edu</I>.  It knowsnothing about the <ICLASS="systemitem.sitename">horror.movie.edu</I> domain (except for whatit might have cached), but it likely has <SPANCLASS="acronym">NS</SPAN> recordsfor <ICLASS="systemitem.sitename">movie.edu</I> cached, sincethose are its parent name servers. So it would return those records tothe querier.</P><PCLASS="para">In that scenario, the <SPANCLASS="acronym">NS</SPAN> records may help thequerying name server get an answer. However, it's a fact of life onthe Internet that not all administrators keep their cache files up todate. If one of your name servers follows a bad delegation and queriesa remote name server for records it doesn't have, look what canhappen:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>nslookup</B></CODE>Default Server:  terminator.movie.eduAddress:  192.249.249.3&gt; <CODECLASS="userinput"><B>set type=ns</B></CODE>&gt; <CODECLASS="userinput"><B>.</B></CODE>Server:  terminator.movie.eduAddress:  192.249.249.3Non-authoritative answer:(root)  nameserver = D.ROOT-SERVERS.NET(root)  nameserver = E.ROOT-SERVERS.NET(root)  nameserver = I.ROOT-SERVERS.NET(root)  nameserver = F.ROOT-SERVERS.NET(root)  nameserver = G.ROOT-SERVERS.NET(root)  nameserver = A.ROOT-SERVERS.NET(root)  nameserver = H.ROOT-SERVERS.NETNIC.NORDU.NET(root)  nameserver = B.ROOT-SERVERS.NET(root)  nameserver = C.ROOT-SERVERS.NET(root)  nameserver = A.ISI.EDU          <ICLASS="lineannotation">&nbsp;- These three name</I>(root)  nameserver = SRI-NIC.ARPA       <ICLASS="lineannotation">&nbsp;- servers are no longer</I>(root)  nameserver = GUNTER-ADAM.ARPA   <ICLASS="lineannotation">&nbsp;- roots</I></PRE></BLOCKQUOTE><PCLASS="para">A remote name server tried to <SPANCLASS="quote">"help out"</SPAN> our localname server by sending it the current list of roots. Unfortunately,the remote name server was corrupt, and returned <SPANCLASS="acronym">NS</SPAN>records that were incorrect. And our local name server, not knowingany better, cached that data.</P><PCLASS="para">Queries to misconfigured<ACLASS="indexterm"NAME="AUTOID-9987"></A><ACLASS="indexterm"NAME="AUTOID-9990"></A><ICLASS="systemitem.sitename">in-addr.arpa</I> name serversoften result in bad root <SPANCLASS="acronym">NS</SPAN> records, because the<ICLASS="systemitem.sitename">in-addr.arpa</I> and <ICLASS="systemitem.sitename">arpa</I> domains are the closest ancestors ofmost <ICLASS="systemitem.sitename">in-addr.arpa</I> subdomains,and name servers very seldom cache either <ICLASS="systemitem.sitename">in-addr.arpa</I> or <ICLASS="systemitem.sitename">arpa</I>'s <SPANCLASS="acronym">NS</SPAN>records. (The roots seldom give them out, since they delegate directlyto lower-level subdomains.) Once your name server has cached bad root<SPANCLASS="acronym">NS</SPAN> records, your name resolution may suffer.</P><PCLASS="para">Those root <SPANCLASS="acronym">NS</SPAN> records may have your nameserver querying a root name server that is no longer at that<SPANCLASS="acronym">IP</SPAN> address, or a root name server that no longerexists at all. If you're having an especially bad day, the bad root<SPANCLASS="acronym">NS</SPAN> records may point to a real, non-root nameserver that is close to your network. Even though it won't returnauthoritative root data, your name server will favor it because itwill have a low <SPANCLASS="acronym">RTT</SPAN> due to its proximity to yournetwork.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-10007">9.6.1 Using check_del</A></H3><PCLASS="para">If our little lecture has convinced you of the importance ofmaintaining correct delegation, you'll be eager to learn how to use<KBDCLASS="command">check_del</KBD> to ensure that you don't join the ranksof the miscreants.</P><PCLASS="para"><KBDCLASS="command">check_del</KBD> usually takes two arguments: thename of a data file to check, and the default origin in the datafile. The default origin tells <KBDCLASS="command">check_del</KBD> the domainname to append to relative names in the file. (When<KBDCLASS="command">named</KBD> reads the db file, it learns the defaultorigin in the <ICLASS="filename">named.conf</I> or<ICLASS="filename">named.boot</I> file; it's at the beginning of the<ICLASS="structfield">zone</I> statement, and always the second fieldin a <ICLASS="structfield">primary</I> or<ICLASS="structfield">secondary</I>directive. <KBDCLASS="command">check_del</KBD> doesn't read the conf or bootfile, though, so you need to specify the domain name on the commandline. If it read the conf or boot file, it'd be limited to checkingonly db files listed in it.)</P><PCLASS="para">To check whether the <ICLASS="filename">db.movie</I> file containsproper delegation to <ICLASS="systemitem.sitename">fx.movie.edu</I> (and any other subdomains),we'd run:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>check_del -o movie.edu -f db.movie</B></CODE></PRE></BLOCKQUOTE><PCLASS="para">If the delegation is correct, we'd see this:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">5 domains properly delegated</PRE></BLOCKQUOTE><PCLASS="para">Actually, it's one domain delegated to three authoritativeservers (<ICLASS="systemitem.sitename">movie.edu</I> delegatedto <ICLASS="systemitem.sitename">terminator</I>, <ICLASS="systemitem.sitename">wormhole</I>, and <ICLASS="systemitem.sitename">zardoz</I>), and one subdomain delegated totwo authoritative servers (<ICLASS="systemitem.sitename">fx.movie.edu</I> delegated to <ICLASS="systemitem.sitename">bladerunner</I> and <ICLASS="systemitem.sitename">outland</I>), but<KBDCLASS="command">check_del</KBD> doesn't know that. The point is that allthe <SPANCLASS="acronym">NS</SPAN> records in <ICLASS="filename">db.movie</I> arecorrect.</P><PCLASS="para">If one of the <ICLASS="systemitem.sitename">fx.movie.edu</I> name servers&nbsp;- say<ICLASS="systemitem.sitename">outland</I>&nbsp;- weremisconfigured, we'd see this:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Server outland.fx.movie.edu is not authoritative for fx.movie.edu4 domains properly delegated1 domains improperly delegated</PRE></BLOCKQUOTE><PCLASS="para">Okay, <KBDCLASS="command">check_del</KBD> doesn't really understandplurals, either.</P><PCLASS="para">If one of the <ICLASS="systemitem.sitename">fx.movie.edu</I> name servers weren't runningat all, we'd see:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">4 domains properly delegated1 servers not runningServers not running:        outland.fx.movie.edu</PRE></BLOCKQUOTE><PCLASS="para">In this case, not running really means that<KBDCLASS="command">check_del</KBD> tried to send the name server a query andgot an <SPANCLASS="acronym">ICMP</SPAN> port unreachable error back, whichindicated that nothing was listening on the name server port.</P><PCLASS="para">And if the name server didn't answer in an acceptable amount oftime, you'd see:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">4 domains properly delegated1 servers not respondingServers not responding:        outland.fx.movie.edu<ACLASS="indexterm"NAME="AUTOID-10053"></A></PRE></BLOCKQUOTE></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-10055">9.6.2 Managing Delegation</A></H3><PCLASS="para">If the special effects lab gets bigger, we may find that we needadditional name servers.  We dealt with setting up new name servers in<ACLASS="xref"HREF="ch08_01.htm"TITLE="Growing Your Domain">Chapter 8</A>, and even went over what information tosend to the parent zone's administrator. But we never explained whatthe parent needed to do.</P><PCLASS="para">It turns out that the parent's job is relatively easy,especially if the administrators of the subdomain send completeinformation. Imagine that the special effects lab expands to a newnetwork, 192.254.20. They have a passel of new, high-powered graphicsworkstations. One of them, <ICLASS="systemitem.sitename">alien.fx.movie.edu</I>, will act as thenetwork's name server.</P><PCLASS="para">The administrators of <ICLASS="systemitem.sitename">fx.movie.edu</I> (we delegated it to thefolks in the lab) send their parent zones' administrators (that's us)a short note:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Hi!We've just set up alien.fx.movie.edu (192.254.20.3) as a nameserver for fx.movie.edu.  Would you please update yourdelegation information?  I've attached the NS records you'llneed to add.Thanks,Arty Segueajs@fx.movie.edu----- cut here -----fx.movie.edu.  86400  IN  NS  bladerunner.fx.movie.edu.fx.movie.edu.  86400  IN  NS  outland.fx.movie.edu.fx.movie.edu.  86400  IN  NS  alien.fx.movie.edu.bladerunner.fx.movie.edu.  86400  IN  A  192.253.254.2outland.fx.movie.edu.      86400  IN  A  192.253.254.3alien.fx.movie.edu.        86400  IN  A  192.254.20.3</PRE></BLOCKQUOTE><PCLASS="para">Our job as the <ICLASS="systemitem.sitename">movie.edu</I> administrator isstraightforward: add the <SPANCLASS="acronym">NS</SPAN> and A records to<ICLASS="systemitem.sitename">db.movie</I>.</P><PCLASS="para">What if we're using <KBDCLASS="command">h2n</KBD> to create our nameserver data? We can stick the delegation information into the<ICLASS="filename">spcl.movie</I> file, which <KBDCLASS="command">h2n</KBD>$<SPANCLASS="acronym">INCLUDE</SPAN>s at the end of the<ICLASS="filename">db.movie</I> file it creates.</P><PCLASS="para">The final step for the <ICLASS="systemitem.sitename">fx.movie.edu</I> administrator is to send asimilar message to <ACLASS="email"HREF="mailto:hostmaster@internic.net"TITLE="hostmaster@internic.net">hostmaster@internic.net</A>(administrator for the <ICLASS="systemitem.sitename">in-addr.arpa</I> domain), requesting that the<ICLASS="systemitem.sitename">20.254.192.in-addr.arpa</I>domain be delegated to <ICLASS="systemitem.sitename">alien.fx.movie.edu</I>, <ICLASS="systemitem.sitename">bladerunner.fx.movie.edu</I>, and <ICLASS="systemitem.sitename">outland.fx.movie.edu</I>.<ACLASS="indexterm"NAME="AUTOID-10082"></A><ACLASS="indexterm"NAME="AUTOID-10085"></A><ACLASS="indexterm"NAME="AUTOID-10088"></A><ACLASS="indexterm"NAME="AUTOID-10091"></A><ACLASS="indexterm"NAME="AUTOID-10094"></A></P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-10096">9.6.2.1 Another way to manage delegation: stubs</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-10099"></A>If you're running <SPANCLASS="acronym">BIND</SPAN> 4.9 or<SPANCLASS="acronym">BIND</SPAN> 8 name servers, you don't have to managedelegation information manually.  <SPANCLASS="acronym">BIND</SPAN> 4.9 and<SPANCLASS="acronym">BIND</SPAN> 8 name servers support an experimentalfeature, called <ICLASS="structfield">stub</I>, which enables a nameserver to pick up changes to delegation informationautomatically.</P><PCLASS="para">Name servers that act as stubs for a subdomain do periodic zonetransfers of the subdomain's data, but they ignore everything in itexcept for the <SPANCLASS="acronym">NS</SPAN> records and the<SPANCLASS="acronym">SOA</SPAN> record.  The <SPANCLASS="acronym">NS</SPAN> records are<SPANCLASS="quote">"promoted"</SPAN> into the parent zone, and the<SPANCLASS="acronym">SOA</SPAN> record governs how often the stub does zonetransfers.  Now, when the administrators of a subdomain make changesto the subdomain's name servers, they simply update their<SPANCLASS="acronym">NS</SPAN> records.  The parent zone's authoritative nameservers will pick up the updated records within the refreshinterval.</P><PCLASS="para">On the <ICLASS="systemitem.sitename">movie.edu</I> nameservers running <SPANCLASS="acronym">BIND</SPAN> 8, here's what we'd add to<ICLASS="filename">named.conf</I>:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">zone &quot;fx.movie.edu&quot; {                type stub;                file &quot;db.fx&quot;;                masters { 192.253.254.2; };};</PRE></BLOCKQUOTE><PCLASS="para">On a <SPANCLASS="acronym">BIND</SPAN> 4.9 name server, we'd use thisdirective:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">stub     fx.movie.edu    192.253.254.2     db.fx</PRE></BLOCKQUOTE><PCLASS="para">Note that we should configure all of the <ICLASS="systemitem.sitename">movie.edu</I> name servers as stubs for<ICLASS="systemitem.sitename">fx.movie.edu</I>, because if the<ICLASS="systemitem.sitename">fx.movie.edu</I> delegationinformation changes, that won't change the <ICLASS="systemitem.sitename">movie.edu</I> zone's serial number.<ACLASS="indexterm"NAME="AUTOID-10127"></A><ACLASS="indexterm"NAME="AUTOID-10128"></A><ACLASS="indexterm"NAME="AUTOID-10129"></A><ACLASS="indexterm"NAME="AUTOID-10130"></A><ACLASS="indexterm"NAME="AUTOID-10131"></A><ACLASS="indexterm"NAME="AUTOID-10132"></A><ACLASS="indexterm"NAME="AUTOID-10133"></A><ACLASS="indexterm"NAME="AUTOID-10134"></A></P></DIV></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch09_05.htm"TITLE="9.5 Subdomains of in-addr.arpa Domains"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 9.5 Subdomains of in-addr.arpa Domains"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="DNS &amp; BIND"><IMGSRC="../gifs/txthome.gif"ALT="DNS &amp; BIND"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch09_07.htm"TITLE="9.7 Managing the Transition to Subdomains"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 9.7 Managing the Transition to Subdomains"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">9.5 Subdomains of in-addr.arpa Domains</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">9.7 Managing the Transition to Subdomains</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>