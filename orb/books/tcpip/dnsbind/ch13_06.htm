<HTML><HEAD><TITLE>[Chapter 13] 13.6 Problem Symptoms</TITLE><METANAME="DC.title"CONTENT="DNS &amp; BIND"><METANAME="DC.creator"CONTENT="Cricket Liu &amp; Paul Albitz"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T18:40:50Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-512-2"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch13_01.htm"TITLE="13. Troubleshooting DNS and BIND"><LINKREL="prev"HREF="ch13_05.htm"TITLE="13.5 Interoperability and Version Problems"><LINKREL="next"HREF="ch14_01.htm"TITLE="14. Programming with the Resolver and Name Server Library Routines"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="DNS &amp; BIND"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="DNS &amp; BIND"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/dsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch13_05.htm"TITLE="13.5 Interoperability and Version Problems"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 13.5 Interoperability and Version Problems"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 13<BR>Troubleshooting <SPANCLASS="acronym">DNS</SPAN> and<SPANCLASS="acronym">BIND</SPAN></FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="CHAPTER"HREF="ch14_01.htm"TITLE="14. Programming with the Resolver and Name Server Library Routines"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 14. Programming with the Resolver and Name Server Library Routines"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="AUTOID-14575">13.6 Problem Symptoms</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="CH13.SYMPTOMS"></A>Some problems, unfortunately,aren't as easy to identify as the ones we listed. You'll experiencesome misbehavior but won't be able to attribute it directly to itscause, often because any of a number of problems may cause the symptomsyou see. For cases like this, we'll suggest some of the common causesof these symptoms and ways to isolate them.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-14581">13.6.1 Local Name Can't Be Looked Up</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14584"></A><ACLASS="indexterm"NAME="AUTOID-14587"></A>The first thing to do whena program like <EMCLASS="emphasis">telnet</EM> or <EMCLASS="emphasis">ftp</EM> can'tlook up a local name is to use <EMCLASS="emphasis">nslookup</EM> totry to look up the same name. When we say <SPANCLASS="quote">"the same name,"</SPAN> we mean<EMCLASS="emphasis">literally</EM> the same name&nbsp;- don't add a domain anda trailing dot if the user didn't type either one. Don't query adifferent name server than the user did.</P><PCLASS="para">As often asnot, the user mistyped the name, or doesn't understand how the searchlist works, and just needs direction. Occasionally, you'll turnup real host configuration errors:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Syntax errors in <EMCLASS="emphasis">resolv.conf</EM> (problem11 in the <SPANCLASS="quote">"Potential Problem List"</SPAN> mentioned earlier in this chapter)</P></LI><LICLASS="listitem"><PCLASS="para">An unset default domain (problem 12)</P></LI></UL><PCLASS="para">You can check for either of these using <EMCLASS="emphasis">nslookup</EM>'s<ACLASS="indexterm"NAME="AUTOID-14605"></A><EMCLASS="emphasis">set all</EM> command.</P><PCLASS="para">If <EMCLASS="emphasis">nslookup</EM> points to a problem withthe name server, rather than with the host configuration, checkfor the problems associated with the type of name server. If thename server is the primary master for the zone, but it doesn't respondwith data you think it should:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Check that the db file contains thedata in question, and that the name server has been signaled toreload it (problem 2).</P></LI><LICLASS="listitem"><PCLASS="para">Check the conf or boot file and the pertinent dbfile for syntax errors (problem 5).</P></LI><LICLASS="listitem"><PCLASS="para">Ensure that the records have trailing dots, ifthey require them (problem 6).</P></LI></UL><PCLASS="para">Ifthe name server is a slave server, you should first check whetheror not its master has the correct data. If it does, and the slavedoesn't:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Make sure you've incremented theserial number on the primary (problem 1).</P></LI><LICLASS="listitem"><PCLASS="para">Look for a problem on the slave in updating thezone (problem 3).</P></LI></UL><PCLASS="para">If the primary <EMCLASS="emphasis">doesn't</EM> havethe correct data, of course, diagnose the problem on the primary.</P><PCLASS="para">If the problem server is a caching-only name server:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Make sure it has its cache data (problem7).</P></LI><LICLASS="listitem"><PCLASS="para">Check that your parent zone's delegation to yourzone exists and is correct (problems 9 and 10). Remember that toa caching-only server, your zone looks just like any other remotezone. Even though the host it runs on may be inside your zone, thecaching-only name server must be able to locate an authoritativeserver for your zone from your parent zone's servers.</P></LI></UL></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-14631">13.6.2 Remote Names Can't Be Looked Up</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14634"></A>If your local lookups succeed, butyou can't look up names outside your local zones, there is a differentset of problems to check:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">First, did you just set up your servers?You might have omitted the cache data (problem 7).</P></LI><LICLASS="listitem"><PCLASS="para">Can you <EMCLASS="emphasis">ping</EM> the remote zone'sname servers? Maybe you can't reach the remote zone's servers becauseof connectivity loss (problem 8).</P></LI><LICLASS="listitem"><PCLASS="para">Is the remote zone new? Maybe its delegation hasn'tyet appeared (problem 9). Or the delegation information for theremote zone may be wrong or out of date, due to neglect (problem10).</P></LI><LICLASS="listitem"><PCLASS="para">Does the domain name actually exist on the remotezone's servers (problem 2)?  On all of them (problems 1 and 3)?</P></LI></UL></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-14646">13.6.3 Wrong or Inconsistent Answer</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14649"></A><ACLASS="indexterm"NAME="AUTOID-14651"></A><ACLASS="indexterm"NAME="AUTOID-14653"></A>If you get the wrong answer whenlooking up a local name, or an inconsistent answer, depending onwhich name server you ask or when you ask, first check the synchronizationbetween your name servers:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Are they all holding the same serialnumber for the zone? Did you forget to increment the serial numberon the primary after you made a change (problem 1)? If you did,the name servers may all have the same serial number, but they willanswer differently out of their authoritative data.</P></LI><LICLASS="listitem"><PCLASS="para">Did you roll the serial number back to one (problem1 again)? Then the primary's serial number will appear much lowerthan the slaves' serial numbers.</P></LI><LICLASS="listitem"><PCLASS="para">Did you forget to signal the primary (problem 2)?Then the primary will return (via <EMCLASS="emphasis">nslookup</EM>,for example) a different serial number than the serial number inthe data file.</P></LI><LICLASS="listitem"><PCLASS="para">Are the slaves having trouble updating from theprimary (problem 3)? If so, they should have <EMCLASS="emphasis">syslog</EM>gedappropriate error messages.</P></LI><LICLASS="listitem"><PCLASS="para">Is the name server's round robin feature rotatingthe addresses of the domain name you're looking up?</P></LI></UL><PCLASS="para">If you get these results when looking up a name in a remotezone, you should check whether the remote zone's name servers havelost synchronization. You can use tools like <EMCLASS="emphasis">nslookup</EM> todetermine whether the remote zone's administrator has forgottento increment the serial number, for example. If the name serversanswer differently from their authoritative data but show the sameserial number, the serial number probably wasn't incremented. Ifthe primary's serial number is much lower than the slaves', theprimary's serial number was probably accidentally reset. We usuallyassume a zone's primary name server is running on the host listedas the origin in the <SPANCLASS="acronym">SOA</SPAN> record.</P><PCLASS="para">You probably can'tdetermine conclusively that the primary hasn't been signaled, though.It's also difficult to pin down updating problems between remotename servers. In cases like this, if you've determined that theremote name servers are giving out incorrect data, contact the zoneadministrator and (gently) relay what you've found. This will helpthe administrator track down the problem on the remote end.</P><PCLASS="para">If you can determine that a parent server&nbsp;- a remote zone'sparent, your zone's parent, or even your zone&nbsp;- is giving out a badanswer, check whether this is coming from old delegation information.Sometimes this will require contacting both the administrator ofthe remote zone and the administrator of its parent to compare thedelegation and the current, correct list of authoritative name servers.</P><PCLASS="para">If you can't induce the administrator to fix his data, and it'scausing your name server problems, or if you can't track down theadministrator, you can always use the <EMCLASS="emphasis">bogus</EM> substatement or <EMCLASS="emphasis">bogusns</EM> directive toinstruct your name server not to query that particular server.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-14677">13.6.4 Lookups Take a Long Time</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14680"></A><ACLASS="indexterm"NAME="AUTOID-14683"></A><ACLASS="indexterm"NAME="AUTOID-14686"></A><ACLASS="indexterm"NAME="AUTOID-14690"></A>Long name resolution is usuallydue to one of two problems:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Connectivity loss (problem 8), whichyou can diagnose with name server debugging output and tools like <EMCLASS="emphasis">ping</EM></P></LI><LICLASS="listitem"><PCLASS="para">Incorrect delegation information (problem 10),which points to the wrong name servers or the wrong <SPANCLASS="acronym">IP</SPAN> addresses</P></LI></UL><PCLASS="para">Usually, going over the debugging output and sending a few <EMCLASS="emphasis">ping</EM>swill point to one or the other. Either you can't reach the nameservers at all, or you can reach the hosts, but the name serversaren't responding.</P><PCLASS="para">Sometimes, though, the results areinconclusive. For example, the parent name servers delegate to aset of name servers that don't respond to <EMCLASS="emphasis">ping</EM>sor queries, but connectivity to the remote network seems all right(a <EMCLASS="emphasis">traceroute</EM>, for example, will get you tothe remote network's <SPANCLASS="quote">"doorstep"</SPAN>&nbsp;- the last router between you andthe host). Is the delegation information so badly out of date thatthe name servers have long since moved to other addresses? Are thehosts simply down? Or is there really a remote network problem? Usually,finding out will require a call or a message to the administratorof the remote zone. (And remember, <EMCLASS="emphasis">whois</EM> givesyou phone numbers!)</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-14707">13.6.5 rlogin and rsh to Host Fails Access Check</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14710"></A><ACLASS="indexterm"NAME="AUTOID-14713"></A><ACLASS="indexterm"NAME="AUTOID-14715"></A><ACLASS="indexterm"NAME="AUTOID-14717"></A>This is aproblem you expect to see right after you set up your name servers.Users unaware of the change from the host table to domain name servicewon't know to update their <EMCLASS="emphasis">.rhosts</EM> files. (Wecovered what needs to be updated in <ACLASS="xref"HREF="ch06_01.htm"TITLE="Configuring Hosts">Chapter 6</A>.) Consequently, <EMCLASS="emphasis">rlogin</EM>'sor <EMCLASS="emphasis">rsh</EM>'s access check will fail and deny theuser access.</P><PCLASS="para">Other causes of this problem are missingor incorrect<ACLASS="indexterm"NAME="AUTOID-14724"></A><ACLASS="indexterm"NAME="AUTOID-14727"></A><EMCLASS="emphasis">in-addr.arpa</EM> delegation(problems 9 and 10), and forgetting to add a <SPANCLASS="acronym">PTR</SPAN> record for the clienthost (problem 4). If you've recently upgraded to <SPANCLASS="acronym">BIND</SPAN> 4.9 or 8 andhave <SPANCLASS="acronym">PTR</SPAN> data for more than one <EMCLASS="emphasis">in-addr.arpa</EM> subdomainin a single file, your name server may be ignoring the out-of-zonedata. Any of these situations will result in the same behavior:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>rlogin wormhole</B></CODE>Password:</PRE></BLOCKQUOTE><PCLASS="para">In other words, the user is prompted for a passworddespite having set up passwordless access with <EMCLASS="emphasis">.rhosts</EM> or <EMCLASS="emphasis">hosts.equiv</EM>.If you were to look at the <EMCLASS="emphasis">syslog</EM> file on thedestination host (<EMCLASS="emphasis">wormhole</EM>, in this case),you'd probably see something like this:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">May  4 18:06:22 wormhole inetd[22514]: login/tcp: Connection       from unknown (192.249.249.213)</PRE></BLOCKQUOTE><PCLASS="para">You can tell which problem it is by stepping throughthe resolution process with <EMCLASS="emphasis">nslookup</EM>. Firstquery one of your <EMCLASS="emphasis">in-addr.arpa</EM> domain's parentname servers for <SPANCLASS="acronym">NS</SPAN> records for your <EMCLASS="emphasis">in-addr</EM> subdomain.If these are correct, query the name servers listed for the <SPANCLASS="acronym">PTR</SPAN>record corresponding to the <SPANCLASS="acronym">IP</SPAN> address of the <EMCLASS="emphasis">rlogin</EM> or <EMCLASS="emphasis">rsh</EM> client.Make sure they all have the <SPANCLASS="acronym">PTR</SPAN> record, and that the record mapsto the right domain name. If not all the name servers have the record, checkfor a loss of synchronization between the primary and the slaves(problems 1 and 3).</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-14754">13.6.6 Access to Services Denied</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14757"></A><ACLASS="indexterm"NAME="AUTOID-14760"></A>Sometimes <EMCLASS="emphasis">rlogin</EM> and<EMCLASS="emphasis">rsh</EM> aren't the only services to go. Occasionallyyou'll install <SPANCLASS="acronym">DNS</SPAN> on your server and your diskless hosts won'tboot, and hosts won't be able to mount disks from the server, either.</P><PCLASS="para">If this happens, make sure the case of the names your nameservers return agrees with the case your previous name service returned.For example, if you were running <SPANCLASS="acronym">NIS</SPAN>, and your <SPANCLASS="acronym">NIS</SPAN> host's maps containedonly lowercase names, you should make sure your name servers also returnlowercase names. Some programs are case-sensitive and won't recognize names in a different case in a data file, such as <EMCLASS="emphasis">/etc/bootparams</EM> or <EMCLASS="emphasis">/etc/exports</EM>.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-14771">13.6.7 Name Server Is Infected with Bogus Root Server Data</A></H3><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> <ACLASS="indexterm"NAME="AUTOID-14775"></A><ACLASS="indexterm"NAME="AUTOID-14778"></A><SPANCLASS="acronym">BIND</SPAN> name servers version 4.9 and newerare resistant to this problem.</P></BLOCKQUOTE><PCLASS="para">Here's a problemthat will be familiar to anyone who's run a name server on the Internetfor any length of time:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>nslookup</B></CODE>Default Server:  terminator.movie.eduAddress:  192.249.249.3&gt; <CODECLASS="userinput"><B>set type=ns</B></CODE>&gt; <CODECLASS="userinput"><B>.</B></CODE>Server:  terminator.movie.eduAddress:  192.249.249.3Non-authoritative answer:(root)  nameserver = <SPANCLASS="acronym">NS</SPAN>.<SPANCLASS="acronym">NIC</SPAN>.<SPANCLASS="acronym">DDN</SPAN>.<SPANCLASS="acronym">MIL</SPAN>(root)  nameserver = B.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = E.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = D.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = F.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = C.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = G.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = hpfcsx.fc.hp.com(root)  nameserver = hp-pcd.cv.hp.com(root)  nameserver = hp-ses.sde.hp.com(root)  nameserver = hpsatc1.gva.hp.com(root)  nameserver = named_master.ch.apollo.hp.com(root)  nameserver = A.<SPANCLASS="acronym">ISI</SPAN>.<SPANCLASS="acronym">EDU</SPAN>(root)  nameserver = <SPANCLASS="acronym">SRI-NIC</SPAN>.<SPANCLASS="acronym">ARPA</SPAN>(root)  nameserver = <SPANCLASS="acronym">GUNTER-ADAM</SPAN>.<SPANCLASS="acronym">ARPA</SPAN>Authoritative answers can be found from:(root)  nameserver = <SPANCLASS="acronym">NS</SPAN>.<SPANCLASS="acronym">NIC</SPAN>.<SPANCLASS="acronym">DDN</SPAN>.<SPANCLASS="acronym">MIL</SPAN>(root)  nameserver = B.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = E.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = D.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = F.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver = C.<SPANCLASS="acronym">ROOT-SERVERS</SPAN>.<SPANCLASS="acronym">NET</SPAN>(root)  nameserver =*** Error: record size incorrect (1050690 != 65519)*** terminator.movie.edu can't find .: Unspecified error</PRE></BLOCKQUOTE><PCLASS="para">Whoa! Where in the heck did all those root name serverscome from? And why is the record size messed up?</P><PCLASS="para">Ifyou look carefully, you'll notice that most of those records arebogus. <EMCLASS="emphasis"><SPANCLASS="acronym">SRI-NIC</SPAN>.<SPANCLASS="acronym">ARPA</SPAN></EM>, for example, is the originalname of <EMCLASS="emphasis">nic.ddn.mil</EM>, from the days when allARPAnet hosts lived under the top-level <EMCLASS="emphasis"><SPANCLASS="acronym">ARPA</SPAN></EM> domain.Moreover, even the name server on <EMCLASS="emphasis">nic.ddn.mil</EM> wasdecommissioned as a root some time ago, replaced by a new root on <EMCLASS="emphasis">ns.nic.ddn.mil</EM> (and <EMCLASS="emphasis">that</EM> nameserver moved from the old <SPANCLASS="acronym">NIC</SPAN> at <SPANCLASS="acronym">SRI</SPAN> to the new one at <SPANCLASS="acronym">NSI</SPAN>...).</P><PCLASS="para">The name servers in <EMCLASS="emphasis">hp.com</EM> aren't Internetroots, and haven't <EMCLASS="emphasis">ever</EM> been. So how did theseget into our cache? Here's how.</P><PCLASS="para">Remember when we describedwhat a name server does when queried for a name it isn't authoritativefor? It does its best to provide information that will be helpfulto the querier: <SPANCLASS="acronym">NS</SPAN> records that are as close as possible to thedomain name the querier is after. Sometimes the queried name server canonly get as close as the root name servers. And sometimes the nameserver has the <EMCLASS="emphasis">wrong</EM> list of roots, eitheraccidentally (because of incorrect configuration) or because noone went to the effort to keep the cache file up-to-date.</P><PCLASS="para">Sowhat does that have to do with caching? Well, say your name serverqueries what it thinks is a <EMCLASS="emphasis">10.in-addr.arpa</EM> nameserver, and the name server turns out to know nothing about <EMCLASS="emphasis">10.in-addr.arpa</EM>. Thename server, trying to be helpful, sends along its current listof root name servers in a response packet, but the list is wrong.<SPANCLASS="acronym">BIND</SPAN> (versions 4.8.3 and earlier), trusting as a newborn, gratefullycaches all this useless information. Later versions, older and wiser,flag this as a lame delegation and toss the bad data.</P><PCLASS="para">Whydid <EMCLASS="emphasis">nslookup</EM> return a record size error whenwe looked up your name server's list of root servers? The list of rootsexceeded the size of a <SPANCLASS="acronym">UDP</SPAN> response packet, but it was truncatedto fit into a response. The length field in the response indicatedthat more data was included, though, so <EMCLASS="emphasis">nslookup</EM> complained.</P><PCLASS="para">This infection can spread if the bogus <SPANCLASS="acronym">NS</SPAN> records point toreal&nbsp;- but nonroot&nbsp;- name servers. If these name servers give out morebogus data, your name server's cache may become polluted by moreand more erroneous records.</P><PCLASS="para">The only ways to track downthe source of these bogus roots are to turn name server debuggingway up (to level four or above) and watch for the receipt of these records,or to patch your name server so that it reports receiving bad rootinformation. With <SPANCLASS="acronym">BIND</SPAN> 4.9 and <SPANCLASS="acronym">BIND</SPAN> 8, you can see the source ofthe bad data in a database dump. Even when you think you've foundthe culprit, though, you may have only discovered another name serverthat was corrupted before yours, not the original source of thecorruption. To uncover the original sinner, you'd have to work backwards, togetherwith other administrators, to discover who made the first gaffe.If you don't have the tenacity to suffer through that process, it'sprobably easier just to upgrade to a <SPANCLASS="acronym">BIND</SPAN> 4.9 or <SPANCLASS="acronym">BIND</SPAN> 8 server.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="AUTOID-14858">13.6.8 Name Server Keeps Loading Old Data</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14861"></A><ACLASS="indexterm"NAME="AUTOID-14864"></A>Here's a weird class of problems relatedto the previous cache corruption problem. Sometimes, after decommissioninga name server, or changing a name server's <SPANCLASS="acronym">IP</SPAN> address, you'll findthe old address record lingering around. An old record may showup in a name server's cache or in a zone data file weeks, or evenmonths, later. The record clearly should have timed out of any caches bynow. So why's it still there? Well, there are a few reasons thishappens. We'll describe the simpler cases first.</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-14868">13.6.8.1 Old delegation information</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14871"></A><ACLASS="indexterm"NAME="AUTOID-14874"></A><ACLASS="indexterm"NAME="AUTOID-14878"></A>The first (and simplest) caseoccurs if a parent zone doesn't keep up with its children, or ifthe children don't inform the parent of changes to the authoritativename servers for the zone. If the <EMCLASS="emphasis">edu</EM> administratorshave this old delegation information for <EMCLASS="emphasis">movie.edu</EM>:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$<SPANCLASS="acronym">ORIGIN</SPAN> movie.edu.@    86400    in    ns    terminator     86400    in    ns    wormholeterminator    86400    in    a    192.249.249.3wormhole      86400    in    a    192.249.249.254 ; wormhole's former                                                  ; <SPANCLASS="acronym">IP</SPAN> address</PRE></BLOCKQUOTE><PCLASS="para">then the <EMCLASS="emphasis">edu</EM> name servers willgive out the bogus old address for <EMCLASS="emphasis">wormhole</EM>.</P><PCLASS="para">This is easily corrected once it's isolated to the parent nameservers: just contact the parent zone's administrator and ask tohave the delegation information updated. If any of the child zone'sservers have cached the bad data, kill them (to clear out theircaches), delete any data files that contain the bad data, then restartthem.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-14890">13.6.8.2 Unnecessary glue data</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14893"></A>When<ACLASS="indexterm"NAME="AUTOID-14895"></A><EMCLASS="emphasis">named-xfer</EM> pulls zone data over from a masterserver, it transfers more than it strictly needs. This is a bugin <SPANCLASS="acronym">BIND</SPAN> 4.8.3 and earlier. The main excess baggage <EMCLASS="emphasis">named-xfer</EM> retrievesis the addresses of name servers for the zone, when those serversare outside of the zone. If the name servers are in the zone, their addressesare necessary as glue data. But if they're not in the zone, theydon't belong in the zone's data file. So, for example, in a backupfile for <EMCLASS="emphasis">movie.edu</EM>, you'd find these partial contentsof file <EMCLASS="emphasis">db.movie</EM>:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$<SPANCLASS="acronym">ORIGIN</SPAN> edu.movie           <SPANCLASS="acronym">IN</SPAN>      <SPANCLASS="acronym">NS</SPAN>      terminator.movie.edu.$<SPANCLASS="acronym">ORIGIN</SPAN> movie.edu.terminator      <SPANCLASS="acronym">IN</SPAN>      A       192.249.249.3$<SPANCLASS="acronym">ORIGIN</SPAN> edu.movie           <SPANCLASS="acronym">IN</SPAN>      <SPANCLASS="acronym">NS</SPAN>      wormhole.movie.edu.$<SPANCLASS="acronym">ORIGIN</SPAN> movie.edu.wormhole        <SPANCLASS="acronym">IN</SPAN>      A       192.249.249.1                <SPANCLASS="acronym">IN</SPAN>      A       192.253.253.1                <SPANCLASS="acronym">IN</SPAN>      A       192.249.249.254</PRE></BLOCKQUOTE><PCLASS="para">But you'd also find similar records in <EMCLASS="emphasis">db.192.249.249</EM> and <EMCLASS="emphasis">db.192.253.253</EM>:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$<SPANCLASS="acronym">ORIGIN</SPAN> 249.192.in-addr.arpa.249             <SPANCLASS="acronym">IN</SPAN>      <SPANCLASS="acronym">NS</SPAN>      terminator.movie.edu.$<SPANCLASS="acronym">ORIGIN</SPAN> movie.edu.terminator      56422   <SPANCLASS="acronym">IN</SPAN>      A       192.249.249.3$<SPANCLASS="acronym">ORIGIN</SPAN> 249.192.in-addr.arpa.249             <SPANCLASS="acronym">IN</SPAN>      <SPANCLASS="acronym">NS</SPAN>      wormhole.movie.edu.$<SPANCLASS="acronym">ORIGIN</SPAN> movie.edu.wormhole        56422   <SPANCLASS="acronym">IN</SPAN>      A       192.249.249.1                56422   <SPANCLASS="acronym">IN</SPAN>      A       192.253.253.1                56422   <SPANCLASS="acronym">IN</SPAN>      A       192.249.249.254</PRE></BLOCKQUOTE><PCLASS="para">The last of <EMCLASS="emphasis">wormhole</EM>'s addressesis <EMCLASS="emphasis">wormhole</EM>'s former address.</P><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> <SPANCLASS="acronym">BIND</SPAN> name servers version 4.9 and newer do nothave this problem.</P></BLOCKQUOTE><PCLASS="para">There's no reason to includethe address records for <EMCLASS="emphasis">terminator</EM> or <EMCLASS="emphasis">wormhole</EM> ineither <EMCLASS="emphasis">in-addr.arpa</EM> backup file. They <EMCLASS="emphasis">should</EM> belisted in <EMCLASS="emphasis">db.movie</EM>, but since they're not necessaryas glue in either <EMCLASS="emphasis">in-addr.arpa</EM> subdomain, theyshouldn't appear in <EMCLASS="emphasis">db.192.249.249</EM> or <EMCLASS="emphasis">db.192.253.253</EM>.</P><PCLASS="para">When the slave loads the <EMCLASS="emphasis">in-addr.arpa</EM> backupfile, it also loads the address records for <EMCLASS="emphasis">terminator</EM> and <EMCLASS="emphasis">wormhole</EM>.If the address is old, then the name server loads&nbsp;- and gives out&nbsp;- thewrong address:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>nslookup wormhole</B></CODE>Server:  wormhole.movie.eduAddress:  192.249.249.1Name:    wormhole.movie.eduAddress:  192.249.249.1, 192.253.253.1, 192.249.249.254</PRE></BLOCKQUOTE><PCLASS="para">You might think, <SPANCLASS="quote">"If I clean the old address outof <EMCLASS="emphasis">db.movie</EM>,"</SPAN> (you can think in italics), <SPANCLASS="quote">"theslaves will time it out of the <EMCLASS="emphasis">in-addr.arpa</EM> subdomains.After all, there's a <SPANCLASS="acronym">TTL</SPAN> on the address records."</SPAN></P><PCLASS="para">Unfortunately,the slave servers don't age those records. They're given out withthe <SPANCLASS="acronym">TTL</SPAN> in the data file, but the slave never decrements the <SPANCLASS="acronym">TTL</SPAN>or times out the record. So the old address could linger as longas the <EMCLASS="emphasis">in-addr.arpa</EM> backup files remain unchanged.And <EMCLASS="emphasis">in-addr.arpa</EM> zones are very stable if noone's adding new hosts to the network or shuffling <SPANCLASS="acronym">IP</SPAN> addresses.There's no need to increment their serial numbers and have them reloadedby the slaves.</P><PCLASS="para">The secret is to increment <EMCLASS="emphasis">all</EM> ofthe zones' serial numbers at once when you make a change affectingthe zones' authoritative name servers. That way, you flush out anyold, stale records and ensure that the slaves all load up-to-date glue.<ACLASS="indexterm"NAME="AUTOID-14967"></A></P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-14970">13.6.8.3 Mutual infection</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14973"></A><ACLASS="indexterm"NAME="AUTOID-14976"></A><ACLASS="indexterm"NAME="AUTOID-14979"></A><ACLASS="indexterm"NAME="AUTOID-14981"></A>There'sone more scenario we're familiar with that can cause these symptoms.This one doesn't require old data in files at all&nbsp;- just two slavename servers. <SPANCLASS="acronym">BIND</SPAN> can run into problems when two name servers actas slave for each other, and when one zone is the child of the other;for example, when name server A loads <EMCLASS="emphasis">movie.edu</EM> fromname server B, and B loads <EMCLASS="emphasis">fx.movie.edu</EM> fromA.</P><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> <SPANCLASS="acronym">BIND</SPAN> name servers version 4.9 and newer are resistantto this problem.</P></BLOCKQUOTE><PCLASS="para">In these cases, certain datacan float back and forth between the two name servers indefinitely. Inparticular, the name servers can pass delegation data, which isreally part of the <SPANCLASS="quote">"child"</SPAN> zone, back and forth.</P><PCLASS="para">Howdoes this work? Say <EMCLASS="emphasis">terminator.movie.edu</EM> isthe primary master <EMCLASS="emphasis">movie.edu</EM> server and itbacks up <EMCLASS="emphasis">fx.movie.edu</EM> from <EMCLASS="emphasis">bladerunner</EM>. <EMCLASS="emphasis">bladerunner</EM> isthe primary master <EMCLASS="emphasis">fx.movie.edu</EM> name serverand backs up <EMCLASS="emphasis">movie.edu</EM> from <EMCLASS="emphasis">terminator</EM>.Then suppose you change <EMCLASS="emphasis">bladerunner</EM>'s <SPANCLASS="acronym">IP</SPAN> address.You remember to change <EMCLASS="emphasis">named.conf</EM> on <EMCLASS="emphasis">terminator</EM> toload <EMCLASS="emphasis">fx.movie.edu</EM> from <EMCLASS="emphasis">bladerunner</EM>'snew <SPANCLASS="acronym">IP</SPAN> address, and you change the <SPANCLASS="acronym">IP</SPAN> address in <EMCLASS="emphasis">db.fx</EM>.You even update the <EMCLASS="emphasis">fx</EM> subdomain's delegationdata in <EMCLASS="emphasis">db.movie</EM> on the primary to reflectthe address change. Isn't that enough?</P><PCLASS="para">Nope. Here'swhy: <EMCLASS="emphasis">terminator</EM> still has <EMCLASS="emphasis">bladerunner</EM>'sold <SPANCLASS="acronym">IP</SPAN> address in the backup file <EMCLASS="emphasis">db.fx</EM>, and <EMCLASS="emphasis">bladerunner</EM> stillhas its own old address in its backup copy of <EMCLASS="emphasis">db.movie</EM> (aglue record in the <EMCLASS="emphasis">fx</EM> delegation).</P><PCLASS="para">Nowlet's say you delete <EMCLASS="emphasis">db.fx</EM> on <EMCLASS="emphasis">terminator</EM> andkill and restart its name server. Won't that suffice? No, because <EMCLASS="emphasis">bladerunner</EM> stillhas the old address and will pass it along to <EMCLASS="emphasis">terminator</EM> inthe next <EMCLASS="emphasis">fx.movie.edu</EM> zone transfer. If youdelete <EMCLASS="emphasis">db.movie</EM> on <EMCLASS="emphasis">bladerunner</EM> andkill and restart the name server, something similar will happen: <EMCLASS="emphasis">bladerunner</EM> willget the old record back with the next <EMCLASS="emphasis">movie.edu</EM> zonetransfer.</P><PCLASS="para">That's a little complicated to follow&nbsp;- forus, too&nbsp;- so <ACLASS="xref"HREF="ch13_06.htm#DNS3-CHP-13-FIG-2"TITLE="Infection through zone transfer">Figure 13.2</A> will help you picture what's going on.</P><H4CLASS="figure"><ACLASS="title"NAME="DNS3-CHP-13-FIG-2">Figure 13.2: Infection through zone transfer</A></H4><IMGCLASS="graphic"SRC="figs/dns3_1302.gif"ALT="Figure 13.2"><PCLASS="para">You need to rid both name servers of theold record simultaneously. Our solution to this problem is to bringboth name servers down at the same time, clean out any backup files,and then start them both up again. That way, the caches can't re-infecteach other.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-15036">13.6.8.4 What have I got?</A></H4><PCLASS="para">How do you determinewhich of these problems is plaguing you? Pay attention to whichname servers are distributing the old data, and which domains the datarelate to:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Is the name server your parent nameserver? Check the parent for either old delegation information orparent-child infection.</P></LI><LICLASS="listitem"><PCLASS="para">Are both a name server and its parent affected?Then check for parent-child infection.</P></LI><LICLASS="listitem"><PCLASS="para">Are slaves affected, but not the primary? Checkfor stale data in backup files.<ACLASS="indexterm"NAME="AUTOID-15046"></A><ACLASS="indexterm"NAME="AUTOID-15049"></A></P></LI></UL><PCLASS="para">That's aboutall we can think to cover. It's certainly less than a comprehensivelist, but we hope it'll help you solve the more common problemsyou encounter with <SPANCLASS="acronym">DNS</SPAN>, and give you ideas about how to approachthe rest. Boy, if we'd only had a troubleshooting guide when <EMCLASS="emphasis">we</EM> started!<ACLASS="indexterm"NAME="AUTOID-15055"></A></P></DIV></DIV><ACLASS="indexterm"NAME="AUTOID-15057"></A><ACLASS="indexterm"NAME="AUTOID-15058"></A></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch13_05.htm"TITLE="13.5 Interoperability and Version Problems"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 13.5 Interoperability and Version Problems"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="DNS &amp; BIND"><IMGSRC="../gifs/txthome.gif"ALT="DNS &amp; BIND"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="CHAPTER"HREF="ch14_01.htm"TITLE="14. Programming with the Resolver and Name Server Library Routines"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 14. Programming with the Resolver and Name Server Library Routines"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">13.5 Interoperability and Version Problems</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">14. Programming with the Resolver and Name Server Library Routines</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>