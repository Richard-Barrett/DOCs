<HTML><HEAD><TITLE>[Appendix C] C.5 Internet Layer</TITLE><METANAME="DC.title"CONTENT="Building Internet Firewalls"><METANAME="DC.creator"CONTENT="D. Brent Chapman &amp; Elizabeth D. Zwicky"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:30:50Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-124-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="appc_01.htm"TITLE="C. TCP/IP Fundamentals"><LINKREL="prev"HREF="appc_04.htm"TITLE="C.4 Network Access Layer"><LINKREL="next"HREF="appc_06.htm"TITLE="C.6 Transport Layer"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Building Internet Firewalls"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Building Internet Firewalls"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/fsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="appc_04.htm"TITLE="C.4 Network Access Layer"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: C.4 Network Access Layer"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Appendix C<BR><SPANCLASS="acronym">TCP/IP</SPAN> Fundamentals</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="appc_06.htm"TITLE="C.6 Transport Layer"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: C.6 Transport Layer"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="FIRE-C-S1-5">C.5 Internet Layer</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="CILAY"></A>The layer above the Network Access Layer in the protocol hierarchy isthe Internet Layer. The Internet Protocol, <SPANCLASS="acronym">RFC</SPAN>791, is the heart of <SPANCLASS="acronym">TCP/IP</SPAN> and the most importantprotocol in the Internet Layer. <SPANCLASS="acronym">IP</SPAN> provides thebasic packet delivery service on which <SPANCLASS="acronym">TCP/IP</SPAN>networks are built. All protocols, in the layers above<SPANCLASS="acronym">IP</SPAN> (<SPANCLASS="acronym">TCP</SPAN>, <SPANCLASS="acronym">UPD</SPAN>)and below it (Ethernet, <SPANCLASS="acronym">FDDI</SPAN>,<SPANCLASS="acronym">ATM</SPAN>, etc.) use <SPANCLASS="acronym">IP</SPAN> to deliverdata. All <SPANCLASS="acronym">TCP/IP</SPAN> data flows through<SPANCLASS="acronym">IP</SPAN>, incoming and outgoing, regardless of its finaldestination.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-C-S2-4">C.5.1 Internet Protocol</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="CIP"></A><SPANCLASS="acronym">IP</SPAN> is the building block of the Internet. Itsfunctions include:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Defining the datagram, which is the basic unit of transmission in theInternet</P></LI><LICLASS="listitem"><PCLASS="para">Defining the Internet addressing scheme</P></LI><LICLASS="listitem"><PCLASS="para">Moving data between the Network Access Layer and the Host-to-HostTransport Layer</P></LI><LICLASS="listitem"><PCLASS="para">Routing datagrams to remote hosts</P></LI><LICLASS="listitem"><PCLASS="para">Performing fragmentation and reassembly of datagrams</P></LI></UL><PCLASS="para">But before describing these functions in more detail, let's look atsome of <SPANCLASS="acronym">IP</SPAN>'s characteristics. First,<SPANCLASS="acronym">IP</SPAN> is a <EMCLASS="emphasis">connectionlessprotocol</EM>. This means that <SPANCLASS="acronym">IP</SPAN> does notexchange control information (called a <EMCLASS="emphasis">handshake</EM>)to establish an end-to-end connection before transmitting data. Incontrast, a <EMCLASS="emphasis">connection-oriented protocol</EM>exchanges control information with the remote system to verify that itis ready to receive data before sending it. When the handshaking issuccessful, the systems are said to have established a<EMCLASS="emphasis">connection</EM>. <SPANCLASS="acronym">IP</SPAN> relies onprotocols in other layers to establish the connection if they requireconnection-oriented service.</P><PCLASS="para"><SPANCLASS="acronym">IP</SPAN> also relies on protocols in the other layers toprovide error detection and error recovery. The Internet Protocol issometimes called an <EMCLASS="emphasis">unreliable protocol </EM>becauseit contains no error detection and recovery code. This is not to saythat the <SPANCLASS="acronym">IP</SPAN> protocol cannot be reliedon&nbsp;- quite the contrary. <SPANCLASS="acronym">IP</SPAN> can be relied uponto accurately deliver your data to the connected network, but itdoesn't check whether the data was correctly received. Protocols inother layers of the <SPANCLASS="acronym">TCP/IP</SPAN> architecture providethis checking when it is required.</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-C-S3-1">C.5.1.1 The datagram</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="CDATA"></A>The <SPANCLASS="acronym">TCP/IP</SPAN> protocols were built to transmit dataover the <SPANCLASS="acronym">ARPANET</SPAN>, which was a <EMCLASS="emphasis">packetswitching network</EM>. A <EMCLASS="emphasis">packet</EM> is a blockof data that carries with it the information necessary to deliverit&nbsp;- in a manner similar to a postal letter, which has an addresswritten on its envelope. A packet switching network uses theaddressing information in the packets to switch packets from onephysical network to another, moving them toward their finaldestination. Each packet travels the network independently of anyother packet.</P><PCLASS="para">The <EMCLASS="emphasis">datagram</EM> is the packet format defined by<SPANCLASS="acronym">IP</SPAN>. <ACLASS="xref"HREF="appc_05.htm#FIRE-C-FIG-4"TITLE="IP datagram format">Figure 13.8</A> is a pictorialrepresentation of an <SPANCLASS="acronym">IP</SPAN> datagram. The first five orsix 32-bit words of the datagram are control information called the<EMCLASS="emphasis">header</EM>. By default, the header is five wordslong; the sixth word is optional. Because the header's length isvariable, it includes a field called Internet Header Length(<SPANCLASS="acronym">IHL</SPAN>) that indicates the header's length in words.The header contains all the information necessary to deliver thepacket.</P><DIVCLASS="sidebar"><H4CLASS="sidebar"><ACLASS="title"NAME="AUTOID-23690">A Note About Terminology</A></H4><PCLASS="para">This adapted appendix is very precise in its definitions and usageof terms such as <EMCLASS="emphasis">packet</EM> and<EMCLASS="emphasis">datagram</EM>. Throughout the rest of this book, wetend to be more relaxed about the terminology, and simply use the term&quot;packet&quot; regardless of what layer of the protocol stackwe're discussing.</P></DIV><H4CLASS="figure"><ACLASS="title"NAME="FIRE-C-FIG-4">Figure 13.8: <SPANCLASS="acronym">IP</SPAN> datagram format</A></H4><IMGCLASS="graphic"SRC="figs/firec04.gif"ALT="Figure 13.8"><PCLASS="para"><SPANCLASS="acronym">IP</SPAN> delivers the datagram by checking the<EMCLASS="emphasis">Destination Address</EM> in word 5 of the header. TheDestination Address is a standard 32-bit <SPANCLASS="acronym">IP</SPAN> addressthat identifies the destination network and the specific host on thatnetwork. (The format of <SPANCLASS="acronym">IP</SPAN> addresses is explainedlater in this appendix.) If the Destination Address is the address ofa host on the directly attached network, the packet is delivereddirectly to the destination. If the Destination Address is not on thelocal network, the packet is passed to a gateway for<ACLASS="indexterm"NAME="AUTOID-23704"></A>delivery. <EMCLASS="emphasis">Gateways</EM> are devices that switchpackets between the different physical networks. Deciding whichgateway to use is called<EMCLASS="emphasis">routing</EM>. <SPANCLASS="acronym">IP</SPAN> makes the routingdecision for each individual packet.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-C-S3-2">C.5.1.2 Routing datagrams</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-23712"></A>Internet gateways are commonly (and perhaps more accurately) referredto as <EMCLASS="emphasis">IP routers</EM> because they use<SPANCLASS="acronym">IP</SPAN> to route packets between networks. In traditional<SPANCLASS="acronym">TCP/IP</SPAN> jargon, there are only two types of networkdevices: <EMCLASS="emphasis">gateways </EM>and<EMCLASS="emphasis">hosts</EM>. Gateways forward packets between networksand hosts don't. However, if a host is connected to more than one<ACLASS="indexterm"NAME="AUTOID-23720"></A>network (called a <EMCLASS="emphasis">multi-homed host</EM>), it canforward packets between the networks. When a multi-homed host forwardspackets, it acts like any other gateway and is considered to be agateway. Current data communications terminology sometimes makes adistinction between gateways and routers,[2] but we'll use the terms gateway and <SPANCLASS="acronym">IP</SPAN>router interchangeably.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[2] In current terminology, a gateway moves data between differentprotocols and a router moves data between different networks. So asystem that moves mail between <SPANCLASS="acronym">TCP/IP</SPAN> and<SPANCLASS="acronym">OSI</SPAN> is a gateway, but a traditional<SPANCLASS="acronym">IP</SPAN> gateway is a router.</P></BLOCKQUOTE><PCLASS="para"><ACLASS="xref"HREF="appc_05.htm#FIRE-C-FIG-5"TITLE="Routing through gateways">Figure 13.9</A> shows the use of gateways to forwardpackets. The hosts (or <EMCLASS="emphasis">end systems</EM>) processpackets through all four protocol layers, while the gateways (or<EMCLASS="emphasis">intermediate systems</EM>) process the packets only upto the Internet Layer where the routing decisions are made.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-C-FIG-5">Figure 13.9: Routing through gateways</A></H4><IMGCLASS="graphic"SRC="figs/firec05.gif"ALT="Figure 13.9"><PCLASS="para">Systems can only deliver packets to other devices attached to the samephysical network. Packets from A1, destined for host C1, are forwardedthrough gateways G1 and G2. Host A1 first delivers the packet togateway G1, with which it shares network A. Gateway G1 delivers thepacket to G2, over network B. Gateway G2 then delivers the packetdirectly to host C1, because they are both attached to network C. HostA1 has no knowledge of any gateways beyond gateway G1. It sendspackets destined for both networks C and B to that local gateway, andthen relies on that gateway to properly forward the packets along thepath to their destinations. Likewise, host C1 would send its packetsto G2, in order to reach a host on network A, as well as any host onnetwork B.</P><PCLASS="para"><ACLASS="xref"HREF="appc_05.htm#FIRE-C-FIG-6"TITLE="Networks, gateways, and hosts">Figure 13.10</A> shows another view of routing. Thisfigure emphasizes that the underlying physical networks adatagram travels through may be different and even incompatible. HostA1 on the token ring network routes the datagram through gateway G1,to reach host C1 on the Ethernet. Gateway G1 forwards the data throughthe X.25 network to gateway G2, for delivery to C1. The datagramtraverses three physically different networks, but eventually arrivesintact at C1.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-C-FIG-6">Figure 13.10: Networks, gateways, and hosts</A></H4><IMGCLASS="graphic"SRC="figs/firec06.gif"ALT="Figure 13.10"></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-C-S3-3">C.5.1.3 Fragmenting datagrams</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-23745"></A><ACLASS="indexterm"NAME="AUTOID-23748"></A>As a datagram is routed through different networks, it may benecessary for the <SPANCLASS="acronym">IP</SPAN> module in a gateway to dividethe datagram into smaller pieces. A datagram received from one networkmay be too large to be transmitted in a single packet on a differentnetwork. This condition only occurs when a gateway interconnectsdissimilar physical networks.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-23752"></A><ACLASS="indexterm"NAME="AUTOID-23754"></A>Each type of network has a <EMCLASS="emphasis">maximum transmission unit(<SPANCLASS="acronym">MTU</SPAN>)</EM>, which is the largest packet itcan transfer. If the datagram received from one network is longer thanthe other network's <SPANCLASS="acronym">MTU</SPAN>, it is necessary to dividethe datagram into smaller fragments for transmission. This process iscalled <EMCLASS="emphasis">fragmentation</EM>. Think of a train deliveringa load of steel. Each railway car can carry more steel than the trucksthat will take it along the highway; so each railway car is unloadedonto many different trucks. In the same way that a railroad isphysically different from a highway, an Ethernet is physicallydifferent from an X.25 network; <SPANCLASS="acronym">IP</SPAN> must break anEthernet's relatively large packets into smaller packets before it cantransmit them over an X.25 network.</P><PCLASS="para">The format of each fragment is the same as the format of any normaldatagram. Header word 2 contains information that identifies eachdatagram fragment and provides information about how to reassemblethe fragments back into the original datagram. The Identificationfield identifies what datagram the fragment belongs to, and theFragmentation Offset field tells what piece of the datagram thisfragment is. The Flags field has a More Fragments bit that tells<SPANCLASS="acronym">IP</SPAN> if it has assembled all of the datagramfragments.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-C-S3-4">C.5.1.4 Passing datagrams to the transportlayer</A></H4><PCLASS="para">When <SPANCLASS="acronym">IP</SPAN> receives a datagram that is addressed tothe local host, it must pass the data portion of the datagram to thecorrect Transport Layer protocol. This is done by using the<EMCLASS="emphasis">Protocol Number</EM> from word 3 of the datagramheader. Each Transport Layer protocol has a unique protocol numberthat identifies it to IP. Protocol numbers are discussed later in thisappendix.</P><ACLASS="indexterm"NAME="AUTOID-23768"></A><ACLASS="indexterm"NAME="AUTOID-23769"></A></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-C-S2-5">C.5.2 Internet Control MessageProtocol</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-23773"></A>An integral part of <SPANCLASS="acronym">IP</SPAN> is the Internet ControlMessage Protocol (<SPANCLASS="acronym">ICMP</SPAN>) defined in<SPANCLASS="acronym">RFC</SPAN> 792. This protocol is closely associated with the InternetLayer and uses the <SPANCLASS="acronym">IP</SPAN> datagram delivery facility tosend its messages. <SPANCLASS="acronym">ICMP</SPAN> sends messages that performthe following control, error reporting, and informational functionsfor <SPANCLASS="acronym">TCP/IP</SPAN>:</P><DLCLASS="variablelist"><DTCLASS="term"><EMCLASS="emphasis">Flow control</EM></DT><DDCLASS="listitem"><PCLASS="para">When datagrams arrive too fast for processing, the destination host oran intermediate gateway sends an <SPANCLASS="acronym">ICMP</SPAN> Source QuenchMessage back to the sender. This tells the source to temporarily stopsending datagrams.</P></DD><DTCLASS="term"><EMCLASS="emphasis">Detecting unreachable destinations</EM></DT><DDCLASS="listitem"><PCLASS="para">When a destination is unreachable, the system detecting the problemsends a Destination Unreachable Message to the datagram's source. Ifthe unreachable destination is a network or host, the message is sentby an intermediate gateway. But if the destination is an unreachableport, the destination host sends the message. (We discuss ports laterin this appendix.)</P></DD><DTCLASS="term"><EMCLASS="emphasis">Redirecting routes</EM></DT><DDCLASS="listitem"><PCLASS="para">A gateway sends the <SPANCLASS="acronym">ICMP</SPAN>Redirect Message to tell a host to use another gateway, presumablybecause the other gateway is a better choice. This message can onlybe used when the source host is on the same network as bothgateways. To better understand this, refer to <ACLASS="xref"HREF="appc_05.htm#FIRE-C-FIG-6"TITLE="Networks, gateways, and hosts">Figure 13.10</A>. If a host on the X.25 network sent a datagramto G1, it would be possible for G1 to redirect that host to G2 becausethe host, G1, and G2 are all attached to the same network. On theother hand, if a host on the token ring network sent a datagram to G1,the host could not be redirected to use G2. This is because G2 is notattached to the token ring.</P></DD><DTCLASS="term"><EMCLASS="emphasis">Checking remote hosts</EM></DT><DDCLASS="listitem"><PCLASS="para">A host can send the <SPANCLASS="acronym">ICMP</SPAN> Echo Message to see if aremote system's <SPANCLASS="acronym">IP</SPAN> is up and operational. When asystem receives an echo message, it sends the same packet back to thesource host. The <SPANCLASS="acronym">UNIX</SPAN> <EMCLASS="emphasis">ping</EM>command uses this message.</P></DD></DL></DIV><ACLASS="indexterm"NAME="AUTOID-23809"></A><ACLASS="indexterm"NAME="AUTOID-23810"></A></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="appc_04.htm"TITLE="C.4 Network Access Layer"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: C.4 Network Access Layer"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Building Internet Firewalls"><IMGSRC="../gifs/txthome.gif"ALT="Building Internet Firewalls"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="appc_06.htm"TITLE="C.6 Transport Layer"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: C.6 Transport Layer"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">C.4 Network Access Layer</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_a.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">C.6 Transport Layer</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>