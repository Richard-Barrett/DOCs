<HTML><HEAD><TITLE>[Chapter 6] Packet Filtering</TITLE><METANAME="DC.title"CONTENT="Building Internet Firewalls"><METANAME="DC.creator"CONTENT="D. Brent Chapman &amp; Elizabeth D. Zwicky"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:15:39Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-124-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="part02.htm"TITLE="II. Building Firewalls"><LINKREL="prev"HREF="ch05_10.htm"TITLE="5.10 Protecting the Machine and Backups"><LINKREL="next"HREF="ch06_02.htm"TITLE="6.2 Configuring a Packet Filtering Router"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Building Internet Firewalls"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Building Internet Firewalls"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/fsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch05_10.htm"TITLE="5.10 Protecting the Machine and Backups"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 5.10 Protecting the Machine and Backups"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 6</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_02.htm"TITLE="6.2 Configuring a Packet Filtering Router"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 6.2 Configuring a Packet Filtering Router"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="CHAPTER"><H1CLASS="chapter"><ACLASS="title"NAME="FIRE-06-CHP">6. Packet Filtering</A></H1><DIVCLASS="htmltoc"><P><B>Contents:</B><BR><ACLASS="SECT1"HREF="#FIRE-06-S1-1"TITLE="6.1 Why Packet Filtering?">Why Packet Filtering?</A><BR><ACLASS="SECT1"HREF="ch06_02.htm"TITLE="6.2 Configuring a Packet Filtering Router">Configuring a Packet FilteringRouter</A><BR><ACLASS="SECT1"HREF="ch06_03.htm"TITLE="6.3 What Does a Packet Look Like?">What Does a Packet Look Like?</A><BR><ACLASS="SECT1"HREF="ch06_04.htm"TITLE="6.4 What Does the Router Do with Packets?">What Does the Router Do withPackets?</A><BR><ACLASS="SECT1"HREF="ch06_05.htm"TITLE="6.5 Conventions for Packet Filtering Rules">Conventions for Packet FilteringRules</A><BR><ACLASS="SECT1"HREF="ch06_06.htm"TITLE="6.6 Filtering by Address">Filtering by Address</A><BR><ACLASS="SECT1"HREF="ch06_07.htm"TITLE="6.7 Filtering by Service">Filtering by Service</A><BR><ACLASS="SECT1"HREF="ch06_08.htm"TITLE="6.8 Choosing a Packet Filtering Router">Choosing a Packet FilteringRouter</A><BR><ACLASS="SECT1"HREF="ch06_09.htm"TITLE="6.9 Where to Do Packet Filtering">Where to Do Packet Filtering</A><BR><ACLASS="SECT1"HREF="ch06_10.htm"TITLE="6.10 Putting It All Together">Putting It All Together</A></P><P></P></DIV><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4021"></A><ACLASS="indexterm"NAME="AUTOID-4024"></A><ACLASS="indexterm"NAME="CH06PACKFILT"></A><ACLASS="indexterm"NAME="AUTOID-4029"></A><ACLASS="indexterm"NAME="CH06DATATRANS"></A>Packet filtering is a network security mechanism that works bycontrolling what data can flow to and from a network. We provide avery brief introduction to high-level <SPANCLASS="acronym">IP</SPAN> networkingconcepts (a necessity for understanding packet filtering)here, but if you're not already familiar with the topic, thenbefore continuing, you should refer to <ACLASS="xref"HREF="appc_01.htm"TITLE="TCP/IP Fundamentals">Appendix C, <CITECLASS="appendix"><SPANCLASS="acronym">TCP/IP</SPAN> Fundamentals</CITE></A> fora more detailed discussion.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4039"></A>To transfer information across a network, the information has to bebroken up into small pieces, each of which is sentseparately. Breaking the information into pieces allows many systemsto share the network, each sending pieces in turn. In<SPANCLASS="acronym">IP</SPAN> networking, those small pieces of data arecalled <EMCLASS="emphasis">packets</EM>. All data transfer across <SPANCLASS="acronym">IP</SPAN> networks happens in the form of packets.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4045"></A><ACLASS="indexterm"NAME="AUTOID-4047"></A><ACLASS="indexterm"NAME="AUTOID-4051"></A>The basic device that interconnects <SPANCLASS="acronym">IP</SPAN> networks iscalled a <EMCLASS="emphasis">router</EM>. A router may be a dedicatedpiece of hardware that has no other purpose, or it may be a piece ofsoftware that runs on a general-purpose <SPANCLASS="acronym">UNIX</SPAN> or<SPANCLASS="acronym">PC</SPAN> (<SPANCLASS="acronym">MS-DOS</SPAN>, Windows, Macintosh,or other) system. Packets traversing an internetwork (a network ofnetworks) travel from router to router until they reach theirdestination. The Internet itself is sort of the granddaddy ofinternetworks&nbsp;- the ultimate &quot;network of networks.&quot;</P><PCLASS="para">A router has to make a routing decision about each packet it receives;it has to decide how to send that packet on towards its ultimatedestination. In general, a packet carries no information to help therouter in this decision, other than the <SPANCLASS="acronym">IP</SPAN> addressof the packet's ultimate destination. The packet tells the routerwhere it wants to go, but not how to get there. Routers communicatewith each other using &quot;routing protocols&quot; such as the RoutingInformation Protocol (<SPANCLASS="acronym">RIP</SPAN>) and Open Shortest PathFirst (<SPANCLASS="acronym">OSPF</SPAN>) to build <EMCLASS="emphasis">routingtables</EM> in memory to determine how to get the packets totheir destinations. When routing a packet, a router compares thepacket's destination address to entries in the routing table and sendsthe packet onward as directed by the routing table. Often, there won'tbe a specific route for a particular destination, and the router willuse a &quot;default route;&quot; generally, such a route directs thepacket towards smarter or better-connected routers. (The defaultroutes at most sites point towards the Internet.)</P><PCLASS="para">In determining how to forward a packet towards its destination, anormal router looks only at a normal packet's destination address andasks only &quot;<EMCLASS="emphasis">How</EM> can I forward thispacket?&quot; A packet filtering router also considers the question&quot;<EMCLASS="emphasis">Should</EM> I forward this packet?&quot; Thepacket filtering router answers that question according to thesecurity policy programmed into the router via the packet filteringrules.</P><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> Some unusual packets do contain routing information about how they areto reach their destination, using the &quot;source route&quot;<SPANCLASS="acronym">IP</SPAN> option. These packets, called<EMCLASS="emphasis">source-routed packets</EM>, are discussed in thesection called &quot;<SPANCLASS="acronym">IP</SPAN> Options&quot; below.</P></BLOCKQUOTE><DIVCLASS="sect1"><H2CLASS="sect1"><ACLASS="title"NAME="FIRE-06-S1-1">6.1 Why Packet Filtering?</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4076"></A>Packet filtering lets you control (allow or disallow) data transferbased on: <ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The address the data is (supposedly) coming from</P></LI><LICLASS="listitem"><PCLASS="para">The address the data is going to</P></LI><LICLASS="listitem"><PCLASS="para">The session and application protocols being used to transfer the data</P></LI></UL></P><PCLASS="para">Most packet filtering systems don't do anything based on the dataitself; they don't make content-based decisions.[1]Packet filtering will let you say:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[1] Some packages, likeCheckPoint's FireWall-1 product, are limited exceptions to this rule.</P></BLOCKQUOTE><BLOCKQUOTECLASS="blockquote"><PCLASS="para">Don't let anybody use Telnet (an application protocol) to log in fromthe outside.</P></BLOCKQUOTE><PCLASS="para">or:</P><BLOCKQUOTECLASS="blockquote"><PCLASS="para">Let everybody send us email via <SPANCLASS="acronym">SMTP</SPAN> (anotherapplication protocol).</P></BLOCKQUOTE><PCLASS="para">or even:</P><BLOCKQUOTECLASS="blockquote"><PCLASS="para">That machine can send us news via <SPANCLASS="acronym">NNTP</SPAN> (yet anotherapplication protocol), but no other machines can do so.</P></BLOCKQUOTE><PCLASS="para">However, it won't let you say:</P><BLOCKQUOTECLASS="blockquote"><PCLASS="para">This user can Telnet in from outside, but no other users can do so.</P></BLOCKQUOTE><PCLASS="para">because &quot;user&quot; isn't something a packet filtering system canidentify. And, it won't let you say:</P><BLOCKQUOTECLASS="blockquote"><PCLASS="para">You can transfer these files but not those files.</P></BLOCKQUOTE><PCLASS="para">because &quot;file&quot; also isn't something the packet filteringsystem can identify.</P><PCLASS="para">The main advantage of packet filtering is leverage: it allows you toprovide, in a single place, particular protections for an entirenetwork. Consider the Telnet service as an example. If you disallowTelnet by turning off the Telnet server on all your hosts, you stillhave to worry about someone in your organization installing a newmachine (or reinstalling an old one) with the Telnet server turned on.On the other hand, if Telnet is not allowed by your filtering router,such a new machine would be protected right from the start, regardlessof whether or not its Telnet server was actually running. This is anexample of the kind of &quot;fail safe&quot; stance we discussed in<ACLASS="xref"HREF="ch03_01.htm"TITLE="Security Strategies">Chapter 3, <CITECLASS="chapter">Security Strategies</CITE></A>.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4110"></A><ACLASS="indexterm"NAME="AUTOID-4113"></A>Routers also present a useful choke point (also discussed in <ACLASS="xref"HREF="ch03_01.htm"TITLE="Security Strategies">Chapter 3</A>) for all of the traffic entering or leaving anetwork. Even if you have multiple routers for redundancy, youprobably have far fewer routers, under much tighter control, than youhave host machines.</P><PCLASS="para">Certain protections can be provided <EMCLASS="emphasis">only</EM> byfiltering routers, and then only if they are deployed in particularlocations in your network. For example, it's a good idea to reject allpackets that have internal source addresses&nbsp;- that is, packets thatclaim to be coming from internal machines but that are actually comingin from the outside&nbsp;- because such packets are usually part ofaddress-spoofing attacks. In such attacks, an attacker is pretendingto be coming from an internal machine. Decision-making of this kindcan be done only in a filtering router at the perimeter of yournetwork. Only a filtering router in that location (which is, bydefinition, the boundary between &quot;inside&quot; and&quot;outside&quot;) is able to recognize such a packet, by lookingat the source address and whether the packet came from the inside (theinternal network connection) or the outside (the external networkconnection).<ACLASS="xref"HREF="ch06_01.htm#FIRE-06-FIG-1"TITLE="Source address forgery">Figure 6.1</A> illustrates this type of sourceaddress forgery. </P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-06-FIG-1">Figure 6.1: Source address forgery</A></H4><IMGCLASS="graphic"SRC="figs/fire0601.gif"ALT="Figure 6.1"><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-06-S2-1">6.1.1 Advantages of Packet Filtering</A></H3><PCLASS="para">Packet filtering has a number of advantages.</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-4126">6.1.1.1 One screening router can help protect an entirenetwork</A></H4><PCLASS="para">One of the key advantages of packet filtering is that a single,strategically placed packet filtering router can help protect anentire network. If there is only one router that connects your site tothe Internet, you gain tremendous leverage on network security,regardless of the size of your site, by doing packet filtering on thatrouter.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-4129">6.1.1.2 Packet filtering doesn't require user knowledge orcooperation</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4132"></A><ACLASS="indexterm"NAME="AUTOID-4135"></A><ACLASS="indexterm"NAME="AUTOID-4138"></A>Unlike proxying, described in <ACLASS="xref"HREF="ch07_01.htm"TITLE="Proxy Systems">Chapter 7, <CITECLASS="chapter">Proxy Systems</CITE></A>, packetfiltering doesn't require any custom software or configuration ofclient machines, nor does it require any special training orprocedures for users. When a packet filtering router decides to let apacket through, the router is indistinguishable from a normalrouter. Ideally, users won't even realize it's there, unless they tryto do something that is prohibited (presumably because it is asecurity problem) by the packet filtering router's filtering policy.</P><PCLASS="para">This &quot;transparency&quot; means that packet filtering can bedone without the cooperation, and often without the knowledge, ofusers. The point is not that you can do this subversively, behindyour users' backs (while actions like that are sometimes necessary&nbsp;- itall depends on the circumstances&nbsp;- they can be highly political). Thepoint is that you can do packet filtering without their having tolearn anything new to make it work, and without your having to dependon them to do (or not do) anything to make it work.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-4143">6.1.1.3 Packet filtering is widely available in manyrouters</A></H4><PCLASS="para">Packet filtering capabilities are available in many hardware andsoftware routing products, both commercial and freely available overthe Internet. Most sites already have packet filtering capabilitiesavailable in the routers they use.</P><PCLASS="para">Most commercial router products, such as the routers from LivingstonEnterprises and Cisco Systems, include packet filtering capabilities.Packet filtering capabilities are also available in a number ofpackages, such as Drawbridge, KarlBridge, and<EMCLASS="emphasis">screend</EM>, that are freely distributed on theInternet; these are discussed in <ACLASS="xref"HREF="appb_01.htm"TITLE="Tools">Appendix B, <CITECLASS="appendix">Tools</CITE></A>.</P><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> In this book, it's impossible to give a complete list of commercialand publicly available packages, because new products are constantlybeing introduced and packet filtering capabilities are constantlybeing added to existing products. Instead, in this chapter weconcentrate on discussing generic packet filtering features andcapabilities, and the consequences of having&nbsp;- or nothaving&nbsp;- particular capabilities, so that you can make your ownevaluation of the products currently available to you.</P></BLOCKQUOTE></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-06-S2-2">6.1.2 Disadvantages of PacketFiltering</A></H3><PCLASS="para">Although packet filtering provides many advantages, thereare some disadvantages to using packet filtering as well:</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-4154">6.1.2.1 Current filtering tools are not perfect</A></H4><PCLASS="para">Despite the widespread availability of packet filtering in varioushardware and software packages, packet filtering is still not a perfecttool. The packet filtering capabilities of many of these productsshare, to a greater or lesser degree, common limitations:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The packet filtering rules tend to be hard to configure. Althoughthere is a range of difficulty, it mostly runs from slightlymind-twisting to brain-numbingly impossible.</P></LI><LICLASS="listitem"><PCLASS="para">Once configured, the packet filtering rules tend to be hard totest. </P></LI><LICLASS="listitem"><PCLASS="para">The packet filtering capabilities of many of the products areincomplete, making implementation of certain types of highly desirablefilters difficult or impossible.</P></LI><LICLASS="listitem"><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4166"></A><ACLASS="indexterm"NAME="AUTOID-4169"></A><ACLASS="indexterm"NAME="AUTOID-4172"></A>Like anything else, packet filtering packages may have bugs in them;these bugs are more likely than proxying bugs to result in securityproblems. Usually, a proxy that fails simply stops passing data, whilea failed packet filtering implementation may allow packets it shouldhave denied.</P></LI></UL></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-4175">6.1.2.2 Some protocols are not well suited to packetfiltering</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-4178"></A><ACLASS="indexterm"NAME="AUTOID-4181"></A><ACLASS="indexterm"NAME="AUTOID-4184"></A>Even with perfect packet filtering implementations, you will find thatsome protocols just aren't well suited to security via packetfiltering, for reasons we'll discuss later in this book. Suchprotocols include the Berkeley &quot;r&quot; commands(<EMCLASS="emphasis">rcp</EM>, <EMCLASS="emphasis">rlogin</EM>,<EMCLASS="emphasis">rdist</EM>, <EMCLASS="emphasis">rsh</EM>, etc.) and<SPANCLASS="acronym">RPC</SPAN>-based protocols such as <SPANCLASS="acronym">NFS</SPAN>and <SPANCLASS="acronym">NIS/YP</SPAN>.(The problems of using packet filtering to deal with these protocols arediscussed in <ACLASS="xref"HREF="ch08_01.htm"TITLE="Configuring Internet Services">Chapter 8, <CITECLASS="chapter">Configuring Internet Services</CITE></A>.)</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="AUTOID-4195">6.1.2.3 Some policies can't readily be enforced by normal packetfiltering routers</A></H4><PCLASS="para">The information that a packet filtering router has available to itdoesn't allow you to specify some rules you might like to have. Forexample, packets say what host they come from, but generally not whatuser. Therefore, you can't enforce restrictions on particular users.Similarly, packets say what port they're going to, but not whatapplication; when you enforce restrictions on higher-level protocols,you do it by port number, hoping that nothing else is running on theport assigned to that protocol. Malicious insiders can easily subvertthis kind of control.</P></DIV></DIV></DIV><ACLASS="indexterm"NAME="AUTOID-7070"></A></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch05_10.htm"TITLE="5.10 Protecting the Machine and Backups"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 5.10 Protecting the Machine and Backups"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Building Internet Firewalls"><IMGSRC="../gifs/txthome.gif"ALT="Building Internet Firewalls"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_02.htm"TITLE="6.2 Configuring a Packet Filtering Router"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 6.2 Configuring a Packet Filtering Router"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">5.10 Protecting the Machine and Backups</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_a.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">6.2 Configuring a Packet Filtering Router</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>