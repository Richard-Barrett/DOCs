<HTML><HEAD><TITLE>[Chapter 6] 6.4 What Does the Router Do with Packets?</TITLE><METANAME="DC.title"CONTENT="Building Internet Firewalls"><METANAME="DC.creator"CONTENT="D. Brent Chapman &amp; Elizabeth D. Zwicky"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:16:58Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-124-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch06_01.htm"TITLE="6. Packet Filtering"><LINKREL="prev"HREF="ch06_03.htm"TITLE="6.3 What Does a Packet Look Like?"><LINKREL="next"HREF="ch06_05.htm"TITLE="6.5 Conventions for Packet Filtering Rules"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Building Internet Firewalls"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Building Internet Firewalls"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/fsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_03.htm"TITLE="6.3 What Does a Packet Look Like?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 6.3 What Does a Packet Look Like?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 6<BR>Packet Filtering</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_05.htm"TITLE="6.5 Conventions for Packet Filtering Rules"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 6.5 Conventions for Packet Filtering Rules"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="FIRE-06-S1-4">6.4 What Does the Router Do withPackets?</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="CH06ROUTHAND"></A><ACLASS="indexterm"NAME="CH06PACKHAND"></A>Once a packet filtering router has finished examining a specific packet,what can it do with that packet? There are two choices:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Pass the packet on. Normally, if the packet passes the criteriain the packet filtering configuration, the router will forward thepacket on towards its destination, just as a normal router (not a packetfiltering router) would do. </P></LI><LICLASS="listitem"><PCLASS="para">Drop the packet. The other obvious action to take is to drop thepacket if it fails the criteria in the packet filtering configuration.</P></LI></UL><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-06-S2-13">6.4.1 Logging Actions</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-5056"></A><ACLASS="indexterm"NAME="AUTOID-5059"></A>Regardless of whether the packet is forwarded or dropped(&quot;permitted&quot; or &quot;denied&quot; in some packetfiltering implementations), you might want the router to log theaction that has been taken. This is especially true if you drop thepacket because it runs afoul of your packet filtering rules. In thiscase, you'd like to know what's being tried that isn't allowed.</P><PCLASS="para">You probably aren't going to log every packet that is allowed, but youmight want to log some of these packets. For example, you might wantto log start-of-connection <SPANCLASS="acronym">TCP</SPAN> packets, so that youcan keep track of incoming and outgoing <SPANCLASS="acronym">TCP</SPAN>connections. Not all packet filters will log allowed packets.</P><PCLASS="para">Different packet filtering implementations support different forms oflogging. Some will log only specific information about a packet, andothers will forward or log an entire dropped packet. Generally, yourpacket filter will need to be configured to log to a host somewherevia the <EMCLASS="emphasis">syslog</EM> service. You don't want the onlycopy of the logs to be on the packet filter if it is compromised. Mostpacket filtering also occurs on dedicated routers, which rarely havelarge amounts of disk space to dedicate to logging. See the discussionof setting up logging in <ACLASS="xref"HREF="ch05_01.htm"TITLE="Bastion Hosts">Chapter 5, <CITECLASS="chapter">Bastion Hosts</CITE></A> and <ACLASS="xref"HREF="ch12_01.htm"TITLE="Maintaining Firewalls">Chapter 12, <CITECLASS="chapter">Maintaining Firewalls</CITE></A>.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-06-S2-14">6.4.2 Returning <SPANCLASS="acronym">ICMP</SPAN>Error Codes</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="CH06ERRORCODES"></A><ACLASS="indexterm"NAME="CH06ICMPRETURN"></A><ACLASS="indexterm"NAME="CH06ROUTRETURN"></A><ACLASS="indexterm"NAME="AUTOID-5081"></A><ACLASS="indexterm"NAME="AUTOID-5084"></A><ACLASS="indexterm"NAME="AUTOID-5087"></A>If a packet is to be dropped, the router may or may not send back an<SPANCLASS="acronym">ICMP</SPAN> error code indicating what happened. Sendingback an <SPANCLASS="acronym">ICMP</SPAN> error code has the effect of warningthe sending machine not to retry sending the packet; thereby savingsome network traffic and some time for the user on the remoteside. (If you send back an <SPANCLASS="acronym">ICMP</SPAN> error code, theuser's connection attempt will fail immediately; otherwise it willtime out, which may take several minutes.)</P><PCLASS="para">There are two sets of relevant <SPANCLASS="acronym">ICMP</SPAN> codes to choosefrom:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The generic &quot;destination unreachable&quot; codes&nbsp;- inparticular, the &quot;host unreachable&quot; and&quot;network unreachable&quot; codes.</P></LI><LICLASS="listitem"><PCLASS="para">The &quot;destination administratively unreachable&quot; codes&nbsp;- inparticular, the &quot;host administratively unreachable&quot;and &quot;network administratively unreachable&quot; codes.</P></LI></UL><PCLASS="para"><SPANCLASS="acronym">ICMP</SPAN>'s designers intended the first pair of<SPANCLASS="acronym">ICMP</SPAN> error codes that the router might return,&quot;host unreachable&quot; or &quot;network unreachable&quot;,to indicate serious network problems: the destination host isdown or something in the only path to the host is down. Theseerror codes predate firewalls and packet filtering. The problem withreturning one of these error codes is that some hosts (particularly ifthey're running older versions of <SPANCLASS="acronym">UNIX</SPAN>) take themquite literally. If these machines get back a &quot;hostunreachable&quot; for a given host, they will assume that the host istotally unreachable and will close all currentlyopen connections to it, even if the other connections were permittedby the packet filtering.</P><PCLASS="para">The second set of <SPANCLASS="acronym">ICMP</SPAN> error codes the router mightreturn, &quot;host administratively unreachable&quot; and &quot;networkadministratively unreachable&quot;, were added to the official listof <SPANCLASS="acronym">ICMP</SPAN> message types a few years ago, specificallyto give packet filtering systems something to return when they droppeda packet. Many systems do not yet recognize these codes, although thatshould not cause your system problems. Systems are supposed to simplyignore <SPANCLASS="acronym">ICMP</SPAN> error codes they don't understand, sothis should be equivalent to returning no error code to suchsystems. On the other hand, many devices comply poorly with standards,and this is the kind of boundary condition some of them may not handlegracefully. The fact that the standard requires a system to ignoreunknown error codes does not ensure that a system will not, in fact,react fatally to such an error code. It simply ensures that you willbe able to argue persuasively that it is not your fault if they do so!</P><PCLASS="para">There are several issues to consider when you are deciding whether ornot your packet filtering system should return <SPANCLASS="acronym">ICMP</SPAN>error codes.</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Which message should you send?</P></LI><LICLASS="listitem"><PCLASS="para">Can you afford the overhead of generating and returning errorcodes?</P></LI><LICLASS="listitem"><PCLASS="para">Will returning these codes enable attackers to get too muchinformation about your packet filtering?</P></LI></UL><PCLASS="para">Which set of error codes makes sense for your site? </P><PCLASS="para">Returning the old &quot;host unreachable&quot; and &quot;network unreachable&quot; codes istechnically incorrect (remember that the host may or may not beunreachable, according to the packet filtering policy, depending onwhat host is attempting to access what service). Also, these errorcodes can cause many systems to react excessively (shutting down allconnections to that host or network).</P><PCLASS="para">Returning the new &quot;host administratively unreachable&quot; or &quot;networkadministratively unreachable&quot; codes advertises the fact that there is apacket filtering system at your site, which you may or may not want todo. These codes may also cause excessive reactions in faulty<SPANCLASS="acronym">IP</SPAN> implementations.</P><PCLASS="para">There is another consideration as well. Generating and returning<SPANCLASS="acronym">ICMP</SPAN> error codes takes a certain small amount ofeffort on the part of the packet filtering router. An attacker couldconceivably mount a denial of service attack by flooding the routerwith packets the router would reject, and for which it would try togenerate <SPANCLASS="acronym">ICMP</SPAN> error packets. The issue isn'tnetwork bandwidth; it's CPU load on the router. (While it's busygenerating <SPANCLASS="acronym">ICMP</SPAN> packets, it's not able to do otherthings as quickly, like make filtering decisions.) On the other hand,not returning <SPANCLASS="acronym">ICMP</SPAN> error codes will cause a smallamount of excess network traffic, as the sending system tries andretries to send the packet being dropped. This traffic shouldn'tamount to much, because the number of packets blocked by a packetfiltering system should be a fraction of the total number of packetsprocessed. (If it's not a small fraction, you've got more seriousproblems, because people are apparently trying lots of things that&quot;aren't allowed.&quot;) </P><PCLASS="para">If your router returns an <SPANCLASS="acronym">ICMP</SPAN> error code for everypacket that violates your filtering policy, you're also giving anattacker a way to probe your filtering system. By observing whichpackets evoke an <SPANCLASS="acronym">ICMP</SPAN> error response, attackers candiscover what types of packets do and don't violate your policy (andthus what types of packets are and are not allowed into yournetwork). You should not give this information away, because itgreatly simplifies the attacker's job. The attacker knows that packetsthat don't get the <SPANCLASS="acronym">ICMP</SPAN> error are going somewhere,and can concentrate on those protocols, where you actually havevulnerabilities. You'd rather that the attacker spent plenty of timesending you packets that you happily throw away. Returning<SPANCLASS="acronym">ICMP</SPAN> error codes speeds up attack programs; if theyget back an <SPANCLASS="acronym">ICMP</SPAN> error for something they try, theydon't have to wait for a timeout.</P><PCLASS="para">All in all, the safest thing to do seems to be to drop packets withoutreturning any <SPANCLASS="acronym">ICMP</SPAN> error codes. If your routeroffers enough flexibility, it might make sense to configure it toreturn <SPANCLASS="acronym">ICMP</SPAN> error codes to internal systems (whichwould like to know immediately that something is going to fail, ratherthan wait for a timeout), but not to external systems (where theinformation would give an attacker a means to probe the filteringconfiguration of the firewall). Even if your router doesn't seem tooffer such flexibility, you may be able to accomplish the same resultby specifying packet filtering rules to allow the relevant inbound<SPANCLASS="acronym">ICMP</SPAN> packets and disallow the relevant outbound<SPANCLASS="acronym">ICMP</SPAN> packets.<ACLASS="indexterm"NAME="AUTOID-5137"></A><ACLASS="indexterm"NAME="AUTOID-5138"></A><ACLASS="indexterm"NAME="AUTOID-5139"></A><ACLASS="indexterm"NAME="AUTOID-5140"></A><ACLASS="indexterm"NAME="AUTOID-5141"></A></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_03.htm"TITLE="6.3 What Does a Packet Look Like?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 6.3 What Does a Packet Look Like?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Building Internet Firewalls"><IMGSRC="../gifs/txthome.gif"ALT="Building Internet Firewalls"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_05.htm"TITLE="6.5 Conventions for Packet Filtering Rules"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 6.5 Conventions for Packet Filtering Rules"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">6.3 What Does a Packet Look Like?</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_a.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">6.5 Conventions for Packet Filtering Rules</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>