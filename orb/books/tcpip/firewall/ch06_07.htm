<HTML><HEAD><TITLE>[Chapter 6] 6.7 Filtering by Service</TITLE><METANAME="DC.title"CONTENT="Building Internet Firewalls"><METANAME="DC.creator"CONTENT="D. Brent Chapman &amp; Elizabeth D. Zwicky"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:17:28Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-124-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch06_01.htm"TITLE="6. Packet Filtering"><LINKREL="prev"HREF="ch06_06.htm"TITLE="6.6 Filtering by Address"><LINKREL="next"HREF="ch06_08.htm"TITLE="6.8 Choosing a Packet Filtering Router"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Building Internet Firewalls"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Building Internet Firewalls"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/fsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_06.htm"TITLE="6.6 Filtering by Address"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 6.6 Filtering by Address"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 6<BR>Packet Filtering</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_08.htm"TITLE="6.8 Choosing a Packet Filtering Router"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 6.8 Choosing a Packet Filtering Router"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="FIRE-06-S1-7">6.7 Filtering by Service</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="CH06PFSERV"></A><ACLASS="indexterm"NAME="CH06SERVINTFILT"></A>Blocking incoming forged packets, as discussed previously, is justabout the only common use of filtering solely by address. Most otheruses of packet filtering involve filtering by service, which issomewhat more complicated.</P><PCLASS="para">From a packet filtering point of view, what do the packets associatedwith particular services look like? As an example, we're going to takea detailed look at Telnet. Telnet allows a user to log in to anothersystem, as if the user had a terminal directly connected to thatsystem. We use Telnet as an example because it is fairly common,fairly simple, and from a packet filtering point of viewrepresentative of several other protocols such as<SPANCLASS="acronym">SMTP</SPAN> and <SPANCLASS="acronym">NNTP</SPAN>. We need to lookat both outbound and inbound Telnet service.</P><PCLASS="para">For detailed discussions of the packet filtering characteristics ofother protocols, see <ACLASS="xref"HREF="ch08_01.htm"TITLE="Configuring Internet Services">Chapter 8</A>.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-06-S2-16">6.7.1 Outbound Telnet Service</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="CH06TELNET"></A><ACLASS="indexterm"NAME="AUTOID-5366"></A><ACLASS="indexterm"NAME="AUTOID-5370"></A><ACLASS="indexterm"NAME="AUTOID-5373"></A>Let's look first at outbound Telnet service, in which a local client (auser) is talking to a remote server. We need to handle both outgoingand incoming packets. (<ACLASS="xref"HREF="ch06_07.htm#FIRE-06-FIG-8"TITLE="Outbound Telnet">Figure 6.8</A> shows asimplified view of outbound Telnet.)</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-06-FIG-8">Figure 6.8: Outbound Telnet</A></H4><IMGCLASS="graphic"SRC="figs/fire0608.gif"ALT="Figure 6.8"><PCLASS="para">The outgoing packets for this outbound service contain the user'skeystrokes and have the following characteristics:<ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> source address of the outgoingpackets is the local host's <SPANCLASS="acronym">IP</SPAN> address.</P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> destination address is the remote host's<SPANCLASS="acronym">IP</SPAN> address.</P></LI><LICLASS="listitem"><PCLASS="para">Telnet is a <SPANCLASS="acronym">TCP</SPAN>-based service, so the<SPANCLASS="acronym">IP</SPAN> packet type is <SPANCLASS="acronym">TCP</SPAN>.</P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP</SPAN> destination port is 23; that's thewell-known port number Telnet servers use.</P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP</SPAN> source port number (whichwe'll call &quot;Y&quot; in this example) is some seemingly randomnumber greater than 1023. </P></LI><LICLASS="listitem"><PCLASS="para">The first outgoing packet, establishingthe connection, will not have the <SPANCLASS="acronym">ACK</SPAN> bit set; therest of the outgoing packets will.</P></LI></UL></P><PCLASS="para">The incoming packets for this outbound service contain the data to bedisplayed on the user's screen (for example, the &quot;login:&quot;prompt) and have the following characteristics:<ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> source address of the incomingpackets is the remote host's <SPANCLASS="acronym">IP</SPAN> address.</P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> destination address is the local host's<SPANCLASS="acronym">IP</SPAN> address. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> packet typeis <SPANCLASS="acronym">TCP</SPAN>. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP</SPAN> source port is23; that's the port the server uses. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP</SPAN>destination port is the same &quot;Y&quot; we used as thesource port for the outgoing packets. </P></LI><LICLASS="listitem"><PCLASS="para">All incoming packets will have the<SPANCLASS="acronym">ACK</SPAN> bit set (again, only the first packet,establishing a connection, does not have the <SPANCLASS="acronym">ACK</SPAN>bit set; in this example, that first packet was an outgoing packet,not an incoming packet).</P></LI></UL></P><PCLASS="para">Note the similarities between the header fields of the outgoing andincoming packets for Telnet. The same addresses and port numbers are used; they'rejust exchanged between source and destination. If you compare anoutgoing packet to an incoming packet, the source and destinationaddresses are exchanged, and the source and destination port numbers areexchanged.</P><PCLASS="para">Why is the client port&nbsp;- the source port for the outgoing packets, andthe destination port for the incoming packets&nbsp;- restricted to beinggreater than 1023? This is a legacy of the <SPANCLASS="acronym">BSD</SPAN>versions of <SPANCLASS="acronym">UNIX</SPAN>, to which almost all<SPANCLASS="acronym">UNIX</SPAN> networking code can trace itsorigins. <SPANCLASS="acronym">BSD UNIX</SPAN> reserved ports from 0 to 1023 forlocal use only by root. These ports are normally used only by servers,not clients. (The major exceptions are the <SPANCLASS="acronym">BSD</SPAN>&quot;r commands&quot; like <EMCLASS="emphasis">rcp</EM> and<EMCLASS="emphasis">rlogin</EM>, as we'll discuss in <ACLASS="xref"HREF="ch08_01.htm"TITLE="Configuring Internet Services">Chapter 8</A>.) Other operating systems, even those that haveno concept analogous to a privileged root user, e.g., Macintosh and<SPANCLASS="acronym">MS-DOS</SPAN> systems, have followed this convention. Whenclient programs need a port number for their own use, and any old portnumber will do, the programs are assigned a port above 1023.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-06-S2-17">6.7.2 Inbound Telnet Service</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-5443"></A><ACLASS="indexterm"NAME="AUTOID-5446"></A>Next, let's look at inbound Telnet service, in which a remote client(a remote user) communicates with a local Telnet server. Again, weneed to handle both incoming and outgoing packets. </P><PCLASS="para">The incoming packets for the inbound Telnet service contain the user'skeystrokes and have the following characteristics:<ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> source address of these packetsis the remote host's address.</P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> destinationaddress is the local host's address. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> packettype is <SPANCLASS="acronym">TCP</SPAN>. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP</SPAN> source portis some random port number greater than 1023 (which we'll call&quot;Z&quot; in this example). </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP</SPAN> destination port is 23. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP</SPAN> <SPANCLASS="acronym">ACK</SPAN> bit will not be set onthe very first inbound packet, establishing the connection, but itwill be set on all other inbound packets.</P></LI></UL></P><PCLASS="para">The outgoing packets for this inbound Telnet service contain theserver responses (the data to be displayed for the user) and have thefollowing characteristics:<ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> source address is the local host's address. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> destination address is the remote host'saddress. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">IP</SPAN> packet type is<SPANCLASS="acronym">TCP</SPAN>. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP</SPAN> source port is 23(these packets are from the Telnet server).</P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP</SPAN> destination port is the same random port&quot;Z&quot; that was used as the source port for the inboundpackets. </P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">TCP ACK</SPAN> bit will be set on alloutgoing packets.</P></LI></UL></P><PCLASS="para">Again, note the similarities between the relevant headers of theincoming and the outgoing packets: the source and destinationaddresses are exchanged and that the source and destination ports areexchanged.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-06-S2-18">6.7.3 Telnet Summary</A></H3><PCLASS="para">The following table illustrates the various types of packets involved ininbound and outbound Telnet services.</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Service</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Packet</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Packet</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">ACK</TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direction</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direction</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Type</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Set</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Outbound</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Outgoing</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Y</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">23</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">[5]</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Outbound</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Incoming</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">23</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Y</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Yes</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Inbound</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Incoming</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Z</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">23</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">[5]</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Inbound</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Outgoing</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">23</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Z</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Yes</TD></TR></TBODY></TABLE><BLOCKQUOTECLASS="footnote"><PCLASS="para">[5] The <SPANCLASS="acronym">TCP ACK</SPAN> bit will be set on all but the firstof these packets, which establishes the connection.</P></BLOCKQUOTE><PCLASS="para">Note that Y and Z are both random (from the packet filtering system'spoint of view) port numbers above 1023.</P><PCLASS="para">If you want to allow outgoing Telnet, but nothing else, you would set upyour packet filtering like this:</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">ACK</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Rule</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Set</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">A</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">23</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Either</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">B</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">23</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Yes</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">C</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Either</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Either</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Deny</TD></TR></TBODY></TABLE><PCLASS="para"><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Rule A allows packets out to remote Telnet servers. </P></LI><LICLASS="listitem"><PCLASS="para">Rule B allows the returning packets to come back in. Because itverifies that the <SPANCLASS="acronym">ACK</SPAN> bit is set, rule B can't beabused by an attacker to allow incoming <SPANCLASS="acronym">TCP</SPAN>connections from port 23 on the attacker's end to ports above 1023 onyour end, e.g., an X11 server on port 6000.</P></LI><LICLASS="listitem"><PCLASS="para">Rule C is the default rule. If none of the preceding rules apply, thepacket is blocked. Remember from our discussion above that anyblocked packet should be logged, and that it may or may not cause an<SPANCLASS="acronym">ICMP</SPAN> message to be returned to the originator.</P></LI></UL><ACLASS="indexterm"NAME="AUTOID-5649"></A></P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-06-S2-19">6.7.4 Risks of Filtering by SourcePort</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-5653"></A><ACLASS="indexterm"NAME="AUTOID-5656"></A><ACLASS="indexterm"NAME="AUTOID-5658"></A>Making filtering decisions based on source port is not without itsrisks. There is one fundamental problem with this type of filtering:you can trust the source port only as much as you trust the sourcemachine. </P><PCLASS="para">Suppose you mistakenly assume the source port is associated with aparticular service. Someone who is in control of the source machine,e.g., someone with root access on a <SPANCLASS="acronym">UNIX</SPAN> system (oranyone at all with a networked <SPANCLASS="acronym">PC</SPAN>), could runwhatever client or server they wanted on a &quot;source port&quot;that you're allowing through your carefully configured packetfiltering system. Furthermore, as we've discussed above, you can'tnecessarily trust the source address to tell you for certain what thesource machine is; you can't tell for sure if you're talking to thereal machine with that address, or to an attacker who is pretending tobe that machine.</P><PCLASS="para">What can you do about this situation? You want to restrict the localport numbers as much as possible, regardless of how few remote portsyou allow to access them. If you only allow inbound connections toport 23, and if port 23 has a Telnet server on it that is trustworthy(a server that will only do things that a Telnet client should be ableto tell it to do), it doesn't actually matter whether the program thatis talking to it is a genuine Telnet client or not. Your concern is tolimit inbound connections to only ports where you are runningtrustworthy servers, and to be sure that your servers are genuinelytrustworthy. <ACLASS="xref"HREF="ch08_01.htm"TITLE="Configuring Internet Services">Chapter 8</A> discusses how you canachieve these ends for various services.</P><PCLASS="para">Because many services use random ports above 1023 for clients, andbecause some services use ports above 1023 for servers, you will oftenneed to accept inbound packets for ports that might haveuntrustworthy servers on them. In <SPANCLASS="acronym">TCP</SPAN>, you canaccept inbound packets without accepting inbound connections byrequiring the <SPANCLASS="acronym">ACK</SPAN> bit to be set. With<SPANCLASS="acronym">UDP</SPAN>, you have no such option, because there is noequivalent to the <SPANCLASS="acronym">ACK</SPAN> bit. Fortunately, very fewprotocols used across the Internet are <SPANCLASS="acronym">UDP</SPAN>-based.<ACLASS="indexterm"NAME="AUTOID-5671"></A><ACLASS="indexterm"NAME="AUTOID-5672"></A></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_06.htm"TITLE="6.6 Filtering by Address"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 6.6 Filtering by Address"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Building Internet Firewalls"><IMGSRC="../gifs/txthome.gif"ALT="Building Internet Firewalls"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_08.htm"TITLE="6.8 Choosing a Packet Filtering Router"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 6.8 Choosing a Packet Filtering Router"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">6.6 Filtering by Address</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_a.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">6.8 Choosing a Packet Filtering Router</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>