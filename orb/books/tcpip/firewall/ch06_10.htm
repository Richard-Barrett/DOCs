<HTML><HEAD><TITLE>[Chapter 6] 6.10 Putting It All Together</TITLE><METANAME="DC.title"CONTENT="Building Internet Firewalls"><METANAME="DC.creator"CONTENT="D. Brent Chapman &amp; Elizabeth D. Zwicky"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:18:26Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-124-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch06_01.htm"TITLE="6. Packet Filtering"><LINKREL="prev"HREF="ch06_09.htm"TITLE="6.9 Where to Do Packet Filtering"><LINKREL="next"HREF="ch07_01.htm"TITLE="7. Proxy Systems"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Building Internet Firewalls"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Building Internet Firewalls"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/fsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_09.htm"TITLE="6.9 Where to Do Packet Filtering"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 6.9 Where to Do Packet Filtering"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 6<BR>Packet Filtering</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="CHAPTER"HREF="ch07_01.htm"TITLE="7. Proxy Systems"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 7. Proxy Systems"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="FIRE-06-S1-10">6.10 Putting It All Together</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="CH06PACKFILTEX"></A>This section works through a few more examples to show how many of theconcepts we've talked about in this chapter come together in the realworld. For detailed discussions of the packet filteringcharacteristics of particular protocols, see <ACLASS="xref"HREF="ch08_01.htm"TITLE="Configuring Internet Services">Chapter 8</A>.</P><PCLASS="para">This section is designed to demonstrate the process of developing afilter set; filters are elaborated as we go on, rather than beingproduced in final form. We aren't attempting to show a complete filterset for any site. Every site is different, and you can get burned bypacket filtering if you don't understand all the details andimplications of its use in your particular environment. We want peopleto carefully consider and understand what they're doing&nbsp;- not blindlycopy something out of a book (even ours!) without a carefulconsideration of how relevant and appropriate it is for their ownsituation. In any case, a full solution for a site requiresconsidering packet filtering, proxying, and configuration issues. Thatprocess is illustrated in <ACLASS="xref"HREF="ch09_01.htm"TITLE="Two Sample Firewalls">Chapter 9, <CITECLASS="chapter">Two Sample Firewalls</CITE></A>.</P><PCLASS="para">Let's start with a simple example: allowing inbound and outbound<SPANCLASS="acronym">SMTP</SPAN> (so that you can send and receive electronicmail) and nothing else. You might start with the following rule set.</P><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> We assume in this example that, for each packet, your filtering systemlooks at the rules in order. It starts at the top until it finds arule that matches the packet, and then it takes the action specified.</P></BLOCKQUOTE><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Rule</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">A</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">B</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">C</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">D</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">E</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Either</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Deny</TD></TR></TBODY></TABLE><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Rules A and B allow inbound <SPANCLASS="acronym">SMTP</SPAN> connections(incoming email).</P></LI><LICLASS="listitem"><PCLASS="para">Rules C and D allow outbound <SPANCLASS="acronym">SMTP</SPAN> connections(outgoing email).</P></LI><LICLASS="listitem"><PCLASS="para">Rule E is the default rule that applies if all else fails.</P></LI></UL><PCLASS="para">Now, let's consider some sample packets to see what happens. Let's saythat your host has <SPANCLASS="acronym">IP</SPAN> address 172.16.1.1, and thatsomeone is trying to send you mail from the remote host with<SPANCLASS="acronym">IP</SPAN> address 192.168.3.4. Further, let's say the sender's <SPANCLASS="acronym">SMTP</SPAN> client uses port 1234 to talk toyour <SPANCLASS="acronym">SMTP</SPAN> server, which is on port25. (<SPANCLASS="acronym">SMTP</SPAN> servers are always assumed to be on port25; see the discussion of <SPANCLASS="acronym">SMTP</SPAN> in <ACLASS="xref"HREF="ch08_01.htm"TITLE="Configuring Internet Services">Chapter 8</A>):</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action</TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Packet</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">(Rule)</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">192.168.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.1.1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit (A)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">2</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.1.1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">192.168.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">1234</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit (B)</TD></TR></TBODY></TABLE><PCLASS="para"><ACLASS="xref"HREF="ch06_10.htm#FIRE-06-FIG-10"TITLE="Packet filtering: inbound SMTP (sample packets 1 and 2)">Figure 6.10</A> shows this case.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-06-FIG-10">Figure 6.10: Packet filtering: inbound <SPANCLASS="acronym">SMTP</SPAN> (samplepackets 1 and 2)</A></H4><IMGCLASS="graphic"SRC="figs/fire0610.gif"ALT="Figure 6.10"><PCLASS="para">In this case, the packet filtering rules permit your incoming email:<ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Rule A permits incoming packets from the sender's<SPANCLASS="acronym">SMTP</SPAN> client to your <SPANCLASS="acronym">SMTP</SPAN> server(represented by packet number 1 above). </P></LI><LICLASS="listitem"><PCLASS="para">Rule B permits the responses from your server back to the sender'sclient (represented by packet number 2 above). </P></LI></UL></P><PCLASS="para">What about outgoing email from you to them? Let's say that your<SPANCLASS="acronym">SMTP</SPAN> client uses port 1357 to talk to their<SPANCLASS="acronym">SMTP</SPAN> server:</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action </TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Packet</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">(Rule)</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">3</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.1.1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">192.168.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit (C)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">192.168.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.1.1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">1357</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit (D)</TD></TR></TBODY></TABLE><PCLASS="para"><ACLASS="xref"HREF="ch06_10.htm#FIRE-06-FIG-11"TITLE="Packet filtering: outbound SMTP (sample packets 3 and 4)">Figure 6.11</A> shows this case.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-06-FIG-11">Figure 6.11: Packet filtering: outbound <SPANCLASS="acronym">SMTP</SPAN> (samplepackets 3 and 4)</A></H4><IMGCLASS="graphic"SRC="figs/fire0611.gif"ALT="Figure 6.11"><PCLASS="para">Again, in this case, the packet filtering rules permit your outgoingemail:<ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Rule C permits outgoing packets from your <SPANCLASS="acronym">SMTP</SPAN>client to their <SPANCLASS="acronym">SMTP</SPAN> server (represented by packetnumber 3 above).</P></LI><LICLASS="listitem"><PCLASS="para">Rule D permits the responses from their server back to your client(represented by packet number 4 above).</P></LI></UL></P><PCLASS="para">Now, let's stir things up. What happens if someone in the outside world(for example, someone on on host 10.1.2.3) attempts to open a connectionfrom port 5150 on his end to the X11 server on port 6000 on one ofyour internal systems (for example, 172.16.3.4) in order to carry out anattack? (See <ACLASS="xref"HREF="ch08_01.htm"TITLE="Configuring Internet Services">Chapter 8</A> for a discussionof X11 and some of its vulnerabilities.)</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action</TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Packet</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">-tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">(Rule)</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">5</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">10.1.2.3</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">6000</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><BCLASS="emphasis.bold">Permit (D)</B></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">6</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">10.1.2.3</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">5150</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><BCLASS="emphasis.bold">Permit (B)</B></TD></TR></TBODY></TABLE><PCLASS="para"><ACLASS="xref"HREF="ch06_10.htm#FIRE-06-FIG-12"TITLE="Packet filtering: inbound SMTP (sample packets 5 and 6)">Figure 6.12</A> shows this case.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-06-FIG-12">Figure 6.12: Packet filtering: inbound <SPANCLASS="acronym">SMTP</SPAN> (samplepackets 5 and 6)</A></H4><IMGCLASS="graphic"SRC="figs/fire0612.gif"ALT="Figure 6.12"><PCLASS="para">The rule set shown above allows this connection totake place! In fact, the rule set shown above allowsany connection to take place as long as both endsof the connection are using ports above 1023. Why?<ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Rules A and B together do what you want to allowinbound <SPANCLASS="acronym">SMTP</SPAN> connections.</P></LI><LICLASS="listitem"><PCLASS="para">Rules C and D together do what you want to allowoutbound <SPANCLASS="acronym">SMTP</SPAN> connections.</P></LI><LICLASS="listitem"><PCLASS="para">But Rules B and D together end up allowing<EMCLASS="emphasis">all</EM> connections where both ends are using portsabove 1023, and this is certainly not what you intended. </P></LI></UL></P><PCLASS="para">There are probably lots of vulnerable servers listening on ports above1023 at your site. Examples are X11 (port 6000), OpenWindows (port2000), databases (Sybase, Oracle, Informix, and other databasescommonly use site-chosen ports above 1023), and so on. This is why youneed to consider a rule set as a whole, instead of assuming that ifeach rule or group of rules is <SPANCLASS="acronym">OK</SPAN>, the whole set isalso <SPANCLASS="acronym">OK</SPAN>.</P><PCLASS="para">What can you do about this? Well, what if you also looked at the sourceport in making your filtering decisions? Here are those same five basicrules with the source port added as a criterion:</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Rule</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">A</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">B</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">C</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">D</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">E</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Either</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Deny</TD></TR></TBODY></TABLE><PCLASS="para">And here are those same six sample packets, filtered by the new rules:</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action</TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Packet</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">(Rule)</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">192.168.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.1.1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">1234</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit (A)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">2</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.1.1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">192.168.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">1234</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit (B)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">3</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.1.1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">192.168.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">1357</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit (C)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">192.168.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.1.1</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">1357</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit (D)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">5</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">10.1.2.3</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">5150</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">6000</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Deny (E)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">6</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">10.1.2.3</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">6000</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">5150</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Deny (E)</TD></TR></TBODY></TABLE><PCLASS="para">As you can see, when the source port is also considered as a criterion, theproblem packets (numbers 5 and 6, representing an attack on one of yourX11 servers) no longer meet any of the rules for packets to be permitted(rules A through D). The problem packets end up being denied by thedefault rule.</P><PCLASS="para">OK, now what if you're dealing with a slightly smarter attacker? Whatif the attacker uses port 25 as the client porton his end (he might do this by killing off the<SPANCLASS="acronym">SMTP</SPAN> server on a machine he controls and using itsport, or by carrying out the attack from a machine that never had an<SPANCLASS="acronym">SMTP</SPAN> server in the first place, like a<SPANCLASS="acronym">PC</SPAN>), and then attempts to open a connection to yourX11 server? Here are the packets you'd see:</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action</TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Packet</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">(Rule)</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">7</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">10.1.2.3</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">6000</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><BCLASS="emphasis.bold">Permit (D)</B></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">8</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">10.1.2.3</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">6000</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><BCLASS="emphasis.bold">Permit (C)</B></TD></TR></TBODY></TABLE><PCLASS="para"><ACLASS="xref"HREF="ch06_10.htm#FIRE-06-FIG-13"TITLE="Packet filtering: inbound SMTP (sample packets 7 and 8)">Figure 6.13</A> shows this case.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-06-FIG-13">Figure 6.13: Packet filtering: inbound <SPANCLASS="acronym">SMTP</SPAN> (samplepackets 7 and 8)</A></H4><IMGCLASS="graphic"SRC="figs/fire0613.gif"ALT="Figure 6.13"><PCLASS="para">As you can see, the packets would be permitted, andthe attack would likely succeed (X11 security being as weak as it is).</P><PCLASS="para">So what can you do? The solution is to also consider the<SPANCLASS="acronym">ACK</SPAN> bit as a filtering criterion. Again, here arethose same five rules with the <SPANCLASS="acronym">ACK</SPAN> bit also added asa criterion:</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">ACK</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Rule</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Set</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">A</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">B</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Yes</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">C</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Out</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">D</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">External</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">&gt;1023</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Yes</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Permit</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">E</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Either</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Any</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Deny</TD></TR></TBODY></TABLE><PCLASS="para">Now, packet 7 (the attacker attempting to open a connection to your X11client) will fail:</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">ACK</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Action</TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Packet</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Address</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Set</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">(Rule)</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">7</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">In</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">10.1.2.3</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">172.16.3.4</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">TCP</SPAN></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">25</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">6000</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">No</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Deny (E)</TD></TR></TBODY></TABLE><PCLASS="para">The only difference in this rule set are in rules B and D. Of these,rule D is the most important, because it controls incoming connectionsto your site. Rule B applies to connections outgoing from your site,and sites are generally more interested in controlling incomingconnections than outgoing connections.</P><PCLASS="para">Rule D now says to accept incoming packets from things that aresupposedly <SPANCLASS="acronym">SMTP</SPAN> servers (because the packets arecoming from port 25) only if the packets have the<SPANCLASS="acronym">ACK</SPAN> bit set; that is, only if the packets are partof a connection started from the inside (from your client to his server).</P><PCLASS="para">If someone attempts to open a <SPANCLASS="acronym">TCP</SPAN> connection fromthe outside, the very first packet that he sends willnot have the <SPANCLASS="acronym">ACK</SPAN> bit set;that's what's involved in &quot;opening a <SPANCLASS="acronym">TCP</SPAN>connection.&quot; (See the discussion of the <SPANCLASS="acronym">ACK</SPAN>bit in the &quot;<SPANCLASS="acronym">TCP</SPAN>&quot; section of&quot;Protocols above IP&quot; earlier in this chapter.) If youblock that very first packet (packet 7 in the example above), youblock the whole <SPANCLASS="acronym">TCP</SPAN> connection. Without certaininformation in the headers of the first packet&nbsp;- in particular, the<SPANCLASS="acronym">TCP</SPAN> sequence numbers&nbsp;- the connection can't beestablished.</P><PCLASS="para">Why can't an attacker get around this by simply setting the<SPANCLASS="acronym">ACK</SPAN> bit on the first packet? If he does, the packetwill get past the filters, but the destination will believe the packetbelongs to an existing connection (instead of the one with which thepacket is trying to establish a new connection). When the destinationtries to match the packet up with the supposed existing connection, itwill fail because there isn't one, and the packet will be ignored.</P><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> As a basic rule of thumb, any filtering rule that permits incoming<SPANCLASS="acronym">TCP</SPAN> packets for outgoing connections (that is,connections initiated by internal clients) should require that the<SPANCLASS="acronym">ACK</SPAN> bit be set.</P><ACLASS="indexterm"NAME="AUTOID-7066"></A><ACLASS="indexterm"NAME="AUTOID-7067"></A><ACLASS="indexterm"NAME="AUTOID-7068"></A><ACLASS="indexterm"NAME="AUTOID-7069"></A></BLOCKQUOTE></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch06_09.htm"TITLE="6.9 Where to Do Packet Filtering"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 6.9 Where to Do Packet Filtering"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Building Internet Firewalls"><IMGSRC="../gifs/txthome.gif"ALT="Building Internet Firewalls"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="CHAPTER"HREF="ch07_01.htm"TITLE="7. Proxy Systems"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 7. Proxy Systems"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">6.9 Where to Do Packet Filtering</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_a.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">7. Proxy Systems</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>