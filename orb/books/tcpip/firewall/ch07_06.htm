<HTML><HEAD><TITLE>[Chapter 7] 7.6 Using SOCKS for Proxying</TITLE><METANAME="DC.title"CONTENT="Building Internet Firewalls"><METANAME="DC.creator"CONTENT="D. Brent Chapman &amp; Elizabeth D. Zwicky"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:19:05Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-124-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch07_01.htm"TITLE="7. Proxy Systems"><LINKREL="prev"HREF="ch07_05.htm"TITLE="7.5 Proxying Without a Proxy Server"><LINKREL="next"HREF="ch07_07.htm"TITLE="7.7 Using the TIS Internet Firewall Toolkit for Proxying"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Building Internet Firewalls"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Building Internet Firewalls"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/fsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch07_05.htm"TITLE="7.5 Proxying Without a Proxy Server"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 7.5 Proxying Without a Proxy Server"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 7<BR>Proxy Systems</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch07_07.htm"TITLE="7.7 Using the TIS Internet Firewall Toolkit for Proxying"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 7.7 Using the TIS Internet Firewall Toolkit for Proxying"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="FIRE-07-S1-6">7.6 Using <SPANCLASS="acronym">SOCKS</SPAN> forProxying</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="CH07PSSOCKS"></A><ACLASS="indexterm"NAME="CH07SOCKS"></A>The <SPANCLASS="acronym">SOCKS</SPAN> package, originally written by DavidKoblas and Michelle Koblas, and currently maintained by Ying-Da Lee,is an example of the type of proxy system that requires customclients. <SPANCLASS="acronym">SOCKS</SPAN> is freely available, and it hasbecome the de facto standard proxying package on the Internet. Thepackage is on track to become an official Internet standard: a RequestFor Comments (<SPANCLASS="acronym">RFC</SPAN>) has been written and iscurrently undergoing the approval process. <ACLASS="xref"HREF="appb_01.htm"TITLE="Tools">Appendix B, <CITECLASS="appendix">Tools</CITE></A>tells you how to get <SPANCLASS="acronym">SOCKS</SPAN>.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-7460"></A>In order to make it easy to support new clients,<SPANCLASS="acronym">SOCKS</SPAN> is extremely generic. This is part of whatmakes it so popular, but it has the disadvantage that<SPANCLASS="acronym">SOCKS</SPAN> can't provide intelligent logging or accesscontrol. It provides logging, but most of the logging is done on theclient, making it difficult to collect the information in a singleplace for examination. <SPANCLASS="acronym">SOCKS</SPAN> does log connectionrequests on the server; provides access control by source, anddestination host and protocol; and allows configurable responses toaccess denials. For example, it can be configured to notify anadministrator of incoming access attempts and to let users know whytheir outgoing access attempts were denied.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-7467"></A>One drawback of <SPANCLASS="acronym">SOCKS</SPAN> is that it works only for<SPANCLASS="acronym">TCP</SPAN>-based clients; it doesn't work for<SPANCLASS="acronym">UDP</SPAN>-based clients (like Archie clients, forexample). If you are using a <SPANCLASS="acronym">UDP</SPAN>-based client, youmay want to get another package, the <SPANCLASS="acronym">UDP</SPAN> PacketRelayer.  This program serves much the same function for<SPANCLASS="acronym">UDP</SPAN>-based clients as <SPANCLASS="acronym">SOCKS</SPAN>serves for <SPANCLASS="acronym">TCP</SPAN>-based clients. Like<SPANCLASS="acronym">SOCKS</SPAN>, the <SPANCLASS="acronym">UDP</SPAN> Packet Relayer is freelyavailable on the Internet.</P><PCLASS="para">The prime advantage of <SPANCLASS="acronym">SOCKS</SPAN> is itspopularity. Because <SPANCLASS="acronym">SOCKS</SPAN> is widely used, serverimplementations and <SPANCLASS="acronym">SOCKS</SPAN>-ified clients (i.e., versionsof programs like <SPANCLASS="acronym">FTP</SPAN> and Telnet that have alreadybeen converted to use <SPANCLASS="acronym">SOCKS</SPAN>) are commonlyavailable, and help is easy to find. This can be a double-edged sword;cases have been reported where intruders to firewalled sites haveinstalled their own <SPANCLASS="acronym">SOCKS</SPAN>-knowledgeable clients.</P><PCLASS="para">The <SPANCLASS="acronym">SOCKS</SPAN> package includes the followingcomponents:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">SOCKS</SPAN> server. This server must run on a<SPANCLASS="acronym">UNIX</SPAN> system, although it has been ported to manydifferent variants of <SPANCLASS="acronym">UNIX</SPAN>.</P></LI><LICLASS="listitem"><PCLASS="para">The <SPANCLASS="acronym">SOCKS</SPAN> client library for<SPANCLASS="acronym">UNIX</SPAN> machines.</P></LI><LICLASS="listitem"><PCLASS="para"><SPANCLASS="acronym">SOCKS</SPAN>-ified versions of several standard<SPANCLASS="acronym">UNIX</SPAN> client programs such as <SPANCLASS="acronym">FTP</SPAN>and Telnet.</P></LI></UL><PCLASS="para">In addition, client libraries for Macintosh and Windows systems areavailable as separate packages. </P><PCLASS="para"><ACLASS="xref"HREF="ch07_06.htm#FIRE-07-FIG-3"TITLE="Using SOCKS for proxying">Figure 7.3</A> shows the use of<SPANCLASS="acronym">SOCKS</SPAN> for proxying.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-07-FIG-3">Figure 7.3: Using <SPANCLASS="acronym">SOCKS</SPAN> for proxying</A></H4><IMGCLASS="graphic"SRC="figs/fire0703.gif"ALT="Figure 7.3"><PCLASS="para">Many Internet client programs (both commercial and freely available)already have <SPANCLASS="acronym">SOCKS</SPAN> support built in to them asa compile-time or a run-time option.</P><PCLASS="para">How do you convert a client program to use <SPANCLASS="acronym">SOCKS</SPAN>?You need to modify the program so it talks to the<SPANCLASS="acronym">SOCKS</SPAN> server, rather than trying to talk to thereal world directly. You do this by recompiling the program with the<SPANCLASS="acronym">SOCKS</SPAN> library.</P><PCLASS="para">Converting a client program to use <SPANCLASS="acronym">SOCKS</SPAN> is usuallypretty easy. The <SPANCLASS="acronym">SOCKS</SPAN> package makes certainassumptions about how client programs work, and most client programsalready follow these assumptions. For a complete summary of theseassumptions, see the file in the <SPANCLASS="acronym">SOCKS</SPAN> releasecalled <EMCLASS="emphasis">What_SOCKS_expects</EM>.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-7524"></A><ACLASS="indexterm"NAME="AUTOID-7527"></A><ACLASS="indexterm"NAME="AUTOID-7529"></A>To convert a client program, you must replace all calls to standardnetwork functions with calls to the <SPANCLASS="acronym">SOCKS</SPAN> versionsof those functions. Here are the calls:<TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Standard Network Function</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"><SPANCLASS="acronym">SOCKS</SPAN> Version</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">connect()</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Rconnect()</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">getsockname()</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Rgetsockname()</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">bind()</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Rbind()</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">accept()</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Raccept()</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">listen()</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Rlisten()</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">select()</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Rselect()</TD></TR></TBODY></TABLE>You can usually do this simply by adding the following to the&quot;CFLAGS=&quot; line of the program's Makefile.</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">-Dconnect=Rconnect      -Dgetsockname=Rgetsockname      -Dbind=Rbind      -Daccept=Raccept      -Dlisten=Rlisten      -Dselect=Rselect &#13;</PRE></BLOCKQUOTE><PCLASS="para">Then, recompile and link the program with the <SPANCLASS="acronym">SOCKS</SPAN> client library.</P><PCLASS="para">The client machine needs to have not only the<SPANCLASS="acronym">SOCKS</SPAN>-modified clients, but also something to tellit what <SPANCLASS="acronym">SOCKS</SPAN> server to contact for what services(on <SPANCLASS="acronym">UNIX</SPAN> machines, the<EMCLASS="emphasis">/etc/socks.conf</EM> file). In addition, if you wantto control access by user, the client machines must be running<EMCLASS="emphasis">identd</EM>, which will allow the<SPANCLASS="acronym">SOCKS</SPAN> server to identify what user is controllingthe port that the connection comes from. Because there's no way forthe <SPANCLASS="acronym">SOCKS</SPAN> server to verify that the<EMCLASS="emphasis">identd</EM> server is reliable, <EMCLASS="emphasis">identd</EM> can't be trusted if there is anybody who mightintentionally be circumventing it.<ACLASS="indexterm"NAME="AUTOID-7574"></A><ACLASS="indexterm"NAME="AUTOID-7575"></A></P></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch07_05.htm"TITLE="7.5 Proxying Without a Proxy Server"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 7.5 Proxying Without a Proxy Server"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Building Internet Firewalls"><IMGSRC="../gifs/txthome.gif"ALT="Building Internet Firewalls"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch07_07.htm"TITLE="7.7 Using the TIS Internet Firewall Toolkit for Proxying"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 7.7 Using the TIS Internet Firewall Toolkit for Proxying"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">7.5 Proxying Without a Proxy Server</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_a.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">7.7 Using the TIS Internet Firewall Toolkit for Proxying</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>