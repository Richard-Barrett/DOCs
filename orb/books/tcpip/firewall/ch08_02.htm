<HTML><HEAD><TITLE>[Chapter 8] 8.2 File Transfer</TITLE><METANAME="DC.title"CONTENT="Building Internet Firewalls"><METANAME="DC.creator"CONTENT="D. Brent Chapman &amp; Elizabeth D. Zwicky"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:21:13Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-124-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch08_01.htm"TITLE="8. Configuring Internet Services"><LINKREL="prev"HREF="ch08_01.htm"TITLE="8.1 Electronic Mail"><LINKREL="next"HREF="ch08_03.htm"TITLE="8.3 Terminal Access (Telnet)"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Building Internet Firewalls"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Building Internet Firewalls"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/fsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_01.htm"TITLE="8.1 Electronic Mail"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 8.1 Electronic Mail"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 8<BR>Configuring Internet Services</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_03.htm"TITLE="8.3 Terminal Access (Telnet)"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 8.3 Terminal Access (Telnet)"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="FIRE-08-S1-2">8.2 File Transfer</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="CH08FILETRANS"></A><ACLASS="indexterm"NAME="AUTOID-8503"></A><SPANCLASS="acronym">FTP</SPAN> is the de facto standard for file transfer onthe Internet. In addition, there are some specialized protocols usedfor applications where <SPANCLASS="acronym">FTP</SPAN> is not suitable.<SPANCLASS="acronym">TFTP</SPAN> is used by dedicated devices to transferconfiguration files. <SPANCLASS="acronym">FSP</SPAN> is a<SPANCLASS="acronym">UDP</SPAN>-based protocol used when<SPANCLASS="acronym">TCP</SPAN>-based connections won't work or aren'tallowed. <SPANCLASS="acronym">UUCP</SPAN> is used for batch transfers,particularly across phone lines.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-08-S2-4">8.2.1 File Transfer Protocol(<SPANCLASS="acronym">FTP</SPAN>)</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="CH08CONFFTP"></A><ACLASS="indexterm"NAME="CH08FTPCONF"></A><SPANCLASS="acronym">FTP</SPAN> is used to transfer files from one machine toanother. You can use <SPANCLASS="acronym">FTP</SPAN> to transfer any type offile, including executable binaries, graphics images,<SPANCLASS="acronym">ASCII</SPAN> text, PostScript, sound and video files, andmore. There are two types of <SPANCLASS="acronym">FTP</SPAN> access: user<SPANCLASS="acronym">FTP</SPAN> and anonymous <SPANCLASS="acronym">FTP</SPAN>. User<SPANCLASS="acronym">FTP</SPAN> requires an account on the server and lets users access any files they could access if they were loggedin. Anonymous <SPANCLASS="acronym">FTP</SPAN> is for people who don't have anaccount and is used to provide access to specific files to the worldat large.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-8532"></A>Anonymous <SPANCLASS="acronym">FTP</SPAN> is by far the most common use of<SPANCLASS="acronym">FTP</SPAN> on the Internet. Anonymous<SPANCLASS="acronym">FTP</SPAN> servers are the standard mechanism fordistributing programs, information, and other files that sites wish tomake available to the Internet at large. If a site provides ananonymous <SPANCLASS="acronym">FTP</SPAN> server, anyone on the Internet caninitiate an <SPANCLASS="acronym">FTP</SPAN> connection to the site, tell the<SPANCLASS="acronym">FTP</SPAN> server that their login name is&quot;anonymous&quot;, and access whatever files the server'sowners have chosen to make available in a restricted area.</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-11">8.2.1.1 Packet filtering characteristics of<SPANCLASS="acronym">FTP</SPAN></A></H4><PCLASS="para"><ACLASS="indexterm"NAME="CH08PACKFILTFTP"></A><SPANCLASS="acronym">FTP</SPAN> uses two separate <SPANCLASS="acronym">TCP</SPAN>connections: one to carry commands and results between the client andthe server (commonly called the <EMCLASS="emphasis">commandchannel</EM>), and the other to carry any actual filesand directory listings transferred (the <EMCLASS="emphasis">datachannel</EM>). On the server end, the command channeluses well-known port 21, and the data channel normally uses well-knownport 20. The client uses ports above 1023 for both the command anddata channels.</P><PCLASS="para">To start an <SPANCLASS="acronym">FTP</SPAN> session, a client first allocatestwo <SPANCLASS="acronym">TCP</SPAN> ports for itself, each of them with a portnumber above 1024. It uses the first to open the command channelconnection to the server and then issues <SPANCLASS="acronym">FTP</SPAN>'s<SPANCLASS="acronym">PORT</SPAN> command to tell the server the number of thesecond port, which the client wants to use for the data channel. Theserver then opens the data channel connection. This data channelconnection is backwards from most protocols, which open connectionsfrom the client to the server. This backwards open complicates thingsfor sites that are attempting to do &quot;start-of-connection&quot;packet filtering to ensure that all <SPANCLASS="acronym">TCP</SPAN> connectionsare initiated from the inside, because external <SPANCLASS="acronym">FTP</SPAN>servers will attempt to initiate data connections to internal clients,in response to command connections opened from those internalclients. Furthermore, these connections will be going to ports knownto be in an unsafe range. <ACLASS="xref"HREF="ch08_02.htm#FIRE-08-FIG-6"TITLE="A normal-mode FTP connection">Figure 8.6</A> shows thiskind of <SPANCLASS="acronym">FTP</SPAN> connection.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-08-FIG-6">Figure 8.6: A normal-mode <SPANCLASS="acronym">FTP</SPAN> connection</A></H4><IMGCLASS="graphic"SRC="figs/fire0806.gif"ALT="Figure 8.6"><PCLASS="para"><ACLASS="indexterm"NAME="CH08PASV"></A><ACLASS="indexterm"NAME="CH08FTPPASV"></A>Most <SPANCLASS="acronym">FTP</SPAN> servers (particularly those used at majoranonymous <SPANCLASS="acronym">FTP</SPAN> sites on the Internet) and many<SPANCLASS="acronym">FTP</SPAN> clients support an alternative mode that allowsthe client to open both the command and the data channels to theserver. This mode is called &quot;passive mode&quot; or &quot;PASVmode&quot; (after the <SPANCLASS="acronym">FTP</SPAN> command the clientsends to the server to initiate this mode). If both your<SPANCLASS="acronym">FTP</SPAN> client and the <SPANCLASS="acronym">FTP</SPAN> serveryou're trying to connect to support passive mode, you can use itinstead of the regular mode. This way, you can avoid start-of-connection filtering problems, because all connections will beopened from the inside, by the client.</P><PCLASS="para">To use passive mode, an <SPANCLASS="acronym">FTP</SPAN> client allocates two<SPANCLASS="acronym">TCP</SPAN> ports for its own use, and uses the first portto contact the <SPANCLASS="acronym">FTP</SPAN> server, just as when usingnormal mode. However, instead of issuing the <SPANCLASS="acronym">PORT</SPAN>command to tell the server the client's second port, the client issuesthe <SPANCLASS="acronym">PASV</SPAN> command. This causes the server toallocate a second port of its own for the data channel (forarchitectural reasons, servers use random ports above 1023 for this,not port 20 as in normal mode; you couldn't have two servers on thesame machine simultaneously listening for incoming<SPANCLASS="acronym">PASV</SPAN>-mode data connections on port 20), and tellthe client the number of that port. The client then opens the dataconnection from its port to the data port the server has just told itabout. <ACLASS="xref"HREF="ch08_02.htm#FIRE-08-FIG-7"TITLE="A passive-mode FTP connection">Figure 8.7</A> shows a passive-mode<SPANCLASS="acronym">FTP</SPAN> connection.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-08-FIG-7">Figure 8.7: A passive-mode <SPANCLASS="acronym">FTP</SPAN> connection</A></H4><IMGCLASS="graphic"SRC="figs/fire0807.gif"ALT="Figure 8.7"><PCLASS="para">Not all <SPANCLASS="acronym">FTP</SPAN> clients support passive mode. If agiven client does support passive mode, it will usually mention thisas a feature in the documentation or description. Some clients supportboth normal and passive modes and provide the user some way to specifywhich mode to use. If you're having trouble finding passive-mode<ACLASS="indexterm"NAME="AUTOID-8592"></A><ACLASS="indexterm"NAME="AUTOID-8595"></A>clients, it's useful to know that the built-in <SPANCLASS="acronym">FTP</SPAN>clients in many <SPANCLASS="acronym">WWW</SPAN> browsers (Netscape Navigator,for example) use passive mode. Chances are, your users will want tohave these browsers anyway for <SPANCLASS="acronym">WWW</SPAN> access, and youcan show them how to use the browsers as <SPANCLASS="acronym">FTP</SPAN>clients as well.</P><PCLASS="para">Because passive mode has only recently become popular, many timeseven servers that support passive mode have problems with it. You mayfind that combinations of servers and clients that work well withnormal-mode transfers hang periodically when you do passive-modetransfers.</P><PCLASS="para">If your <SPANCLASS="acronym">FTP</SPAN> client (or one of the<SPANCLASS="acronym">FTP</SPAN> servers you wish to communicate with) does notsupport passive mode, and you still want to allow<SPANCLASS="acronym">FTP</SPAN> via packet filtering (rather than via proxy),you'll have to put a special-case exception in your packet filteringrules to allow the server to open the data channel back in to theclient. If you do so, you will still be vulnerable to attackerslaunching a connection from port 20 on the attacker's end (nominallythe <SPANCLASS="acronym">FTP</SPAN> data channel, but you have no way toguarantee that on a machine you don't control) to a port above 1023 onyour end (such as an X server, for example). Therefore, you shouldrestrict this special-case exception as much as possible, e.g., bytying it to the address of the particular client or server thatdoesn't support passive mode. (Even an exception for a single servermakes you vulnerable to forged connections from that server).</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-8610"></A>Some dynamic packet filtering implementations (such as FireWall-1 fromCheckPoint Software) monitor the commands sent over the<SPANCLASS="acronym">FTP</SPAN> command channel and notice the<SPANCLASS="acronym">PORT</SPAN> command the client sends to the server;This commandtells the server on which port the client is listening for the serverto open the data channel. These implementations also put in place atemporary (time-limited) exception in the packet filtering rules toallow the server to open the data channel back to the client.</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">ACK</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Set</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Notes</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">21</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[6]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Incoming <SPANCLASS="acronym">FTP</SPAN> request</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">21</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Yes</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Response to incoming request</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">20</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[6]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Data channel creation for incoming <SPANCLASS="acronym">FTP</SPAN> request, normal mode</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">20</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Yes</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Data channel responses for incoming <SPANCLASS="acronym">FTP</SPAN> request, normal mode</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[6]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Data channel creation for incoming <SPANCLASS="acronym">FTP</SPAN> request, passive mode</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Yes</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Data channel responses for incoming <SPANCLASS="acronym">FTP</SPAN> request, passive mode</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">21</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[6]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Outgoing <SPANCLASS="acronym">FTP</SPAN> request</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">21</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Yes</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Response to outgoing request</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">20</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[6]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Data channel creation for outgoing <SPANCLASS="acronym">FTP</SPAN> request, normal mode</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">20</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Yes</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Data channel responses for outgoing <SPANCLASS="acronym">FTP</SPAN> request, normal mode</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[6]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Data channel creation for outgoing <SPANCLASS="acronym">FTP</SPAN> request, passive mode</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Yes</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Data channel responses for outgoing <SPANCLASS="acronym">FTP</SPAN> request, passive mode</P></TD></TR></TBODY></TABLE><BLOCKQUOTECLASS="footnote"><PCLASS="para">[6] <SPANCLASS="acronym">ACK</SPAN> is not set on the first packet of this type (establishing connection)but will be set on the rest.</P></BLOCKQUOTE><ACLASS="indexterm"NAME="AUTOID-8879"></A><ACLASS="indexterm"NAME="AUTOID-8880"></A><ACLASS="indexterm"NAME="AUTOID-8881"></A></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-99">8.2.1.2 Proxying characteristics of<SPANCLASS="acronym">FTP</SPAN></A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-8886"></A>Because of the problems with passive mode, and because ofcomplications introduced in name service (the &quot;double-reverselookups&quot; discussed in the &quot;Domain Name Service(<SPANCLASS="acronym">DNS</SPAN>)&quot; section below), proxying is aparticularly attractive solution for outbound<SPANCLASS="acronym">FTP</SPAN>. Using a normal-mode proxied client allows youto talk reliably to external servers without having to allow incoming<SPANCLASS="acronym">TCP</SPAN> connections for the data channel to any hostexcept the bastion host doing the proxying. For this reason, you maychoose to proxy <SPANCLASS="acronym">FTP</SPAN> even if you allow most otherprotocols directly through the firewall via packet filtering. Bothmodified-client and modified-procedure proxies are available for<SPANCLASS="acronym">FTP</SPAN>.</P><PCLASS="para">The <SPANCLASS="acronym">SOCKS</SPAN> package includes an<SPANCLASS="acronym">FTP</SPAN> client for <SPANCLASS="acronym">UNIX</SPAN> that hasbeen modified to use <SPANCLASS="acronym">SOCKS</SPAN>. Because of the multiplesimultaneous <SPANCLASS="acronym">TCP</SPAN> connections involved in<SPANCLASS="acronym">FTP</SPAN>, modifying other <SPANCLASS="acronym">FTP</SPAN> clientsyourself requires some work (more than modifying clients forstraightforward single-connection protocols like<SPANCLASS="acronym">SMTP</SPAN> and <SPANCLASS="acronym">POP</SPAN>).</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-8906"></A>The <SPANCLASS="acronym">TIS FWTK</SPAN> provides a proxy<SPANCLASS="acronym">FTP</SPAN> server that operates with modifiedclients or modified user procedures. It provides additional logging,operation denial, and user authentication features, giving you finercontrol than you can achieve with packet filters or<SPANCLASS="acronym">SOCKS</SPAN> proxying.</P><PCLASS="para">If you want to use modified clients with the <SPANCLASS="acronym">TIS</SPAN><SPANCLASS="acronym">FWTK</SPAN> <SPANCLASS="acronym">FTP</SPAN> proxy server, you willneed to do all of the modification yourself; they do not provide amodified client or even a client library. Using modified clients withthe <SPANCLASS="acronym">TIS FWTK</SPAN> <SPANCLASS="acronym">FTP</SPAN>proxy server will also prevent you from running a standard<SPANCLASS="acronym">FTP</SPAN> server on the machine you're using as the proxyserver. Some versions of the <SPANCLASS="acronym">FWTK</SPAN> have had an<SPANCLASS="acronym">FTP</SPAN> server that could act as a proxy serverand a regular <SPANCLASS="acronym">FTP</SPAN> server, but there have been someproblems with it, and it's not clear that it will continue to beincluded with newer releases of the toolkit.</P><PCLASS="para">Some <SPANCLASS="acronym">FTP</SPAN> clients are not sufficiently flexible tobe used with modified user procedures involving the<SPANCLASS="acronym">TIS FWTK</SPAN> <SPANCLASS="acronym">FTP</SPAN>proxy server. The custom procedure users have to follow involveopening an <SPANCLASS="acronym">FTP</SPAN> connection to the machine where theproxy server is running, and then logging into the<SPANCLASS="acronym">FTP</SPAN> proxy server as<EMCLASS="emphasis">anonymous@host.some.net</EM>, specifyingthe name of the host they really want to connect to as part ofthe login. Some <SPANCLASS="acronym">FTP</SPAN> clients have&quot;anonymous&quot; simply hardcoded in, or limit the length ofthe login field to something too short to contain&quot;anonymous@&quot; plus a reasonably long hostname.</P><PCLASS="para">Any commercial proxying packages will almost certainly supportoutbound <SPANCLASS="acronym">FTP</SPAN> proxying, because<SPANCLASS="acronym">FTP</SPAN> is such a commonly used protocol on theInternet.</P><PCLASS="para">Many sites use both proxy and packet filtering solutions for<SPANCLASS="acronym">FTP</SPAN>. You can sometimes reduce the number ofmodified clients you need by using proxying to support normal-modeconnections, and packet filtering to support passive-modeconnections. You can also use a combined solution for added securityby using a proxy <SPANCLASS="acronym">FTP</SPAN> server that uses passive modeto make external connections, regardless of the mode it uses to talkto the internal hosts; this converts all connections that cross thefirewall to passive mode and allows you to tighten the packet filtersthat protect the host doing the proxying. On the other hand, it keepsyou from using servers that don't support passive mode.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-12">8.2.1.3 Providing anonymous<SPANCLASS="acronym">FTP</SPAN> service</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="CH08ANON"></A>With anonymous <SPANCLASS="acronym">FTP</SPAN>, a user logs in to the<SPANCLASS="acronym">FTP</SPAN> server as &quot;anonymous&quot;. The user isthen asked for a password and is expected to enter his or her fullemail address in response. At most sites, this request is notenforced, however, and users can enter whatever they want, as long asit looks like an email address; even if the information is entered,it's usually just logged, not verified in any way beyond a superficialplausibility check (i.e., does it contain an at (@)sign?). Many standard <SPANCLASS="acronym">FTP</SPAN> servers, like theones shipped with most versions of <SPANCLASS="acronym">UNIX</SPAN>, don't evenlog the information.</P><PCLASS="para">If you are providing anonymous <SPANCLASS="acronym">FTP</SPAN> service, thechallenge is to ensure that the anonymous <SPANCLASS="acronym">FTP</SPAN>server makes available only the information thatyou want made available and that it doesn't give an outsider accessto other, supposedly private, information on the machine.</P><PCLASS="para">In setting up anonymous <SPANCLASS="acronym">FTP</SPAN>, one precaution you cantake is to limit what other information is available on the machinethat's providing anonymous <SPANCLASS="acronym">FTP</SPAN> service. In thisway, even if attackers get &quot;outside&quot; the anonymous<SPANCLASS="acronym">FTP</SPAN> area on the machine, there is nothing ofinterest to them elsewhere on the machine (or reachable from themachine via <SPANCLASS="acronym">NFS</SPAN> or some other mechanism).</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-8956"></A>Many <SPANCLASS="acronym">FTP</SPAN> servers perform a<EMCLASS="emphasis">chroot</EM> to the anonymous <SPANCLASS="acronym">FTP</SPAN>area before the <SPANCLASS="acronym">FTP</SPAN> server starts processingcommands from an anonymous user. To support both anonymous and user<SPANCLASS="acronym">FTP</SPAN>, however, <SPANCLASS="acronym">FTP</SPAN> servers needaccess to all files. This means that <EMCLASS="emphasis">chroot</EM>,which is normally regarded as extremely safe, doesn't guarantee asmuch for an <SPANCLASS="acronym">FTP</SPAN> server, because the server is notalways running in the <EMCLASS="emphasis">chroot</EM>'d environment.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-8968"></A>To deal with this problem, you can modify<EMCLASS="emphasis">inetd</EM>'s configuration so that instead ofstarting the <SPANCLASS="acronym">FTP</SPAN> server directly, it <EMCLASS="emphasis">chroot</EM>s (usingsomething like the <EMCLASS="emphasis">chrootuid</EM> program described in<ACLASS="xref"HREF="appb_01.htm"TITLE="Tools">Appendix B</A>) and then starts the<SPANCLASS="acronym">FTP</SPAN> server. Normally, <SPANCLASS="acronym">FTP</SPAN> runswith limited access only for anonymous users, and nonanonymous usershave their normal access permissions. Doing the <EMCLASS="emphasis">chroot </EM> before startingup the <SPANCLASS="acronym">FTP</SPAN> server means that the nonanonymoususers will also be limited; if you don't have any nonanonymous usersof your <SPANCLASS="acronym">FTP</SPAN> server (and you probably shouldn't),this is irrelevant.</P><PCLASS="para">The details of setting up an anonymous <SPANCLASS="acronym">FTP</SPAN> systemvary depending on the operating system and the particular<SPANCLASS="acronym">FTP</SPAN> daemon code in use. Start with the instructions(if any) in the manual pages for your <SPANCLASS="acronym">FTP</SPAN> daemon;this should get you through most of the vendor-specific steps. Then,once you've performed all the steps there, obtain and follow<SPANCLASS="acronym">CERT</SPAN> Advisory 93:10 (for information on obtaining<SPANCLASS="acronym">CERT</SPAN> advisories, see <ACLASS="xref"HREF="appa_01.htm"TITLE="Resources">Appendix A</A>),which addresses setting up anonymous <SPANCLASS="acronym">FTP</SPAN> servers toclose the holes left by most of the vendor instructions.[7]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[7] Many vendors ship instructions containing critical problems, ranging fromsecurity holes to missing steps that disable parts of<SPANCLASS="acronym">FTP</SPAN>'s functionality.)</P></BLOCKQUOTE><PCLASS="para">Unfortunately, one of the most common ways that anonymous users getaccess to files they shouldn't be able to see is that an internal userinnocently puts the files up for anonymous <SPANCLASS="acronym">FTP</SPAN>, onthe assumption that this is somehow safe. Usually, the internal useris relying on security through obscurity; he assumes that nobody willnotice the files. This does not work well. People do notice,especially if the names of the new files are meaningful. At popular<SPANCLASS="acronym">FTP</SPAN> sites, curious people poke around randomly, andthey notice new files almost immediately and may transfer them out ofpure curiosity. On less-visited <SPANCLASS="acronym">FTP</SPAN> sites, filesmay remain unnoticed until an Archie server indexes them. Unless youhave explicitly arranged to have your <SPANCLASS="acronym">FTP</SPAN> siteskipped, you should assume that it is being indexed; Archie is quitetalented at finding sites.</P><PCLASS="para">It's best to avoid putting files up for anonymous<SPANCLASS="acronym">FTP</SPAN> if you don't want the entire world to readthem. Use other methods of file transfer if possible. If not, you maywant to use a modified <SPANCLASS="acronym">FTP</SPAN> server, like the<EMCLASS="emphasis">wuarchive</EM> server, which allows semianonymous accessthat requires an anonymous user to provide an additional password toget access to certain directories. You can also put up files indirectories that have execute permission but not readpermission. Doing so will let people who know the names transfer thefiles, but won't let people look to see what files exist.</P><PCLASS="para">Whatever method you choose, be sure that everybody at your site whocan put files in the anonymous <SPANCLASS="acronym">FTP</SPAN> directoriesknows not to put confidential files where they're world-readable. Aneasy way to do this is to prevent your internal users from writing tothe anonymous <SPANCLASS="acronym">FTP</SPAN> directories and to require themto ask a system administrator to make a file available.<ACLASS="indexterm"NAME="AUTOID-9004"></A></P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-13">8.2.1.4 Using the wuarchive<SPANCLASS="acronym">FTP</SPAN> daemon</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9009"></A><ACLASS="indexterm"NAME="AUTOID-9011"></A><ACLASS="indexterm"NAME="AUTOID-9014"></A>Many Internet sites&nbsp;- both major and minor&nbsp;- that provide anonymous<SPANCLASS="acronym">FTP</SPAN> run the <EMCLASS="emphasis">wuarchive</EM> version of the<SPANCLASS="acronym">UNIX</SPAN> <SPANCLASS="acronym">FTP</SPAN> server, developed atWashington University (the &quot;wu&quot; in the name) inSt. Louis. This server provides a number of features that areespecially useful for anonymous <SPANCLASS="acronym">FTP</SPAN> servers. Theseinclude the following features and many others:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Better and more complete logging. It can log uploads, downloads, orevery command sent to it; it can also keep track of the number ofaccesses by user classes (e.g., by anonymous users).</P></LI><LICLASS="listitem"><PCLASS="para">Per-directory message files; these are shown to a userwhen he visits that directory to provide relevant information aboutthe directory's contents (for example,&quot;This version is nowobsolete&quot;).</P></LI><LICLASS="listitem"><PCLASS="para">The ability to define classes of users; based on the account theylog in to the server with, and/or the host from which they access, youcan determine what files they have access to and when they can log in.</P></LI><LICLASS="listitem"><PCLASS="para">Restrictions on certain classes of users. For example, <EMCLASS="emphasis">wuarchive</EM> canlimit the number of simultaneous anonymous users who are accessing theserver; the limit can vary by time of day and day of the week. Byusing these restrictions, you control the load generated by the<SPANCLASS="acronym">FTP</SPAN> server.</P></LI><LICLASS="listitem"><PCLASS="para">The ability to compress, tar, and otherwise manipulate filesautomatically as they are transferred.</P></LI><LICLASS="listitem"><PCLASS="para">Nonanonymous <EMCLASS="emphasis">chroot</EM>'ed access, for users who need only limitedaccess to your machines. This allows you to give a specific accountaccess to files that are not accessible to &quot;anonymous&quot;without giving them the ability to look around at everything on yourdisks.</P></LI></UL><PCLASS="para">For information about obtaining the <EMCLASS="emphasis">wuarchive</EM> <SPANCLASS="acronym">FTP</SPAN>daemon, see <ACLASS="xref"HREF="appb_01.htm"TITLE="Tools">Appendix B</A>. Be sure that you areinstalling the genuine, most recent version. This program has in thepast been distributed by attackers with added trap doors, and olderversions may have security problems that have since been fixed.</P><PCLASS="para">Be awarethat one cost of the additional power and complexity offered by<EMCLASS="emphasis">wuarchive</EM> is a biggerpotential for security problems. The bigger and more complex a programis, the more likely it is to contain bugs. If the program issecurity-critical (as the <SPANCLASS="acronym">FTP</SPAN> server is), many ofthose bugs are likely to have security impacts. Some features of the<EMCLASS="emphasis">wuarchive</EM> server may also interact badly with some clients (inparticular, some clients do not deal well with the displayed messagesand hang). There are workarounds available, but if a significantpercentage of your users have these clients, you may want to avoid<EMCLASS="emphasis">wuarchive</EM>.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-14">8.2.1.5 Using the <SPANCLASS="acronym">TIS FWTK FTP</SPAN> daemon</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9051"></A>Instead of using the <EMCLASS="emphasis">wuarchive</EM> version of the<SPANCLASS="acronym">FTP</SPAN> server, you might consider using the<SPANCLASS="acronym">FTP</SPAN> server from the<SPANCLASS="acronym">TIS</SPAN> Internet Firewall Toolkit. The <SPANCLASS="acronym">TIS FWTK FTP</SPAN> daemon has an emphasis different from that of the<EMCLASS="emphasis">wuarchive</EM> daemon. The <EMCLASS="emphasis">wuarchive</EM> version adds codein order to add features that support anonymous<SPANCLASS="acronym">FTP</SPAN>. The <SPANCLASS="acronym">TIS FWTK</SPAN> version, bycontrast, concentrates on simplifying the server and making it moresecure, stripping it down to the bare minimum capabilities necessaryto provide anonymous <SPANCLASS="acronym">FTP</SPAN> service. However, themaintainers of the <SPANCLASS="acronym">FWTK</SPAN> have been consideringremoving it from the <SPANCLASS="acronym">FWTK</SPAN> release, because despiteall the work they've done on it, they're still not convinced that it'sas secure as they'd like it to be (though it is almost certainly moresecure than any alternative). It's possible that it will have beenremoved from the release by the time you read this.</P><PCLASS="para">You'll have to decide for yourself whether you really need theenhanced features provided by the <EMCLASS="emphasis">wuarchive</EM>server (and are willing to accept the potential security implicationsof those features), or whether you'd rather have the enhanced securityprovided by the <SPANCLASS="acronym">TIS FWTK</SPAN> server (assuming it'sstill available), at a cost of fewer features. Many users areaccustomed to using <EMCLASS="emphasis">wuarchive</EM><SPANCLASS="acronym">FTP</SPAN> and have come to depend on its features; it isprobably not reasonable to attempt to run a major anonymous<SPANCLASS="acronym">FTP</SPAN> site with the <SPANCLASS="acronym">TIS FWTK</SPAN>server. For a site that provides only occasional anonymous<SPANCLASS="acronym">FTP</SPAN>, however, the <SPANCLASS="acronym">FWTK</SPAN> server isprobably a more secure and reliable option.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-15">8.2.1.6 Be careful of writabledirectories in the anonymous <SPANCLASS="acronym">FTP</SPAN> area</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="CH08ANONWRIT"></A><ACLASS="indexterm"NAME="CH08WRIT"></A><ACLASS="indexterm"NAME="CH08INC"></A>Regardless of which <SPANCLASS="acronym">FTP</SPAN> daemon you use, you'll haveto confront a particularly troublesome issue raised by anonymous<SPANCLASS="acronym">FTP</SPAN> servers: writable directories in the anonymous<SPANCLASS="acronym">FTP</SPAN> area. Sites frequently provide writable spacein this area, so that outsiders can upload files to them as well asdownload files from them; for example, a software company's customersmight be asked to upload crash dump files (which are too big toconveniently send through email) so the company can do a crashanalysis on them.</P><PCLASS="para">Writable areas can be very useful, but they have a dark side. Suchwritable directories <EMCLASS="emphasis">will</EM> (notice that we didn'tsay <EMCLASS="emphasis">may</EM>) be found and used by &quot;theunderground&quot; on the Internet as storage space and distributionareas for illicit material; generally this means pirated softwarepackages and pornographic image files.</P><PCLASS="para">The folks who do this are amazingly well organized and hard to trackdown. They have their own communication mechanisms for telling eachother about new sites&nbsp;- places they've found to store theirstuff&nbsp;- without revealing who they are. When they find a new site, theytypically create a hidden subdirectory in which to store their filesand images. They give the subdirectory an innocuous name such as&quot;.. &quot; (that's &quot;dot dot space space&quot;). Whencasually looking around an anonymous <SPANCLASS="acronym">FTP</SPAN> area, youprobably won't notice a name like this. It's particularly easy to missbecause file and directory names beginning with &quot;.&quot; areignored by the <SPANCLASS="acronym">UNIX</SPAN><EMCLASS="emphasis"> ls</EM>command, unless you give the command a special argument or run it asroot.</P><PCLASS="para">On some sites in which intruders play this game, you can see a bartereconomy in operation. Someone leaves a note saying they're seeking acertain package or file, and listing what they have to offer inexchange. A short time later, someone else comes along, uploads therequested files, and leaves another note telling the original posterwhat they want in return.</P><PCLASS="para">What's wrong with this misuse of your anonymous <SPANCLASS="acronym">FTP</SPAN>areas? There are several problems:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">It consumes your resources, such as disk space and network bandwidth(particularly on your Internet connection), and it interferes with thelegitimate use of those resources: it's a denial of service attack.</P></LI><LICLASS="listitem"><PCLASS="para">It potentially exposes your site to legal action for assisting (evenunwittingly) in software piracy, or perhaps sexual harassment, or evensexual exploitation of minors. Even if such actions are unlikely to succeed, your attorneys will probably tell you that they'd ratheravoid the issue and not have to fight the battle in the first place.</P></LI><LICLASS="listitem"><PCLASS="para">Even if no legal actions are undertaken, such an incident couldgenerate significant negative publicity and embarrassment for yoursite or organization. Once your name has been linked to softwarepiracy or child pornography in any way, you are in bad troubleregardless of how innocent your involvement was.</P></LI></UL><PCLASS="para">How can you protect your anonymous <SPANCLASS="acronym">FTP</SPAN> areas fromsuch misuse? The first question to ask yourself is this: do you reallyneed to provide writable space in your anonymous<SPANCLASS="acronym">FTP</SPAN> area? Often there are other acceptable ways(electronic mail, for example) for folks to send files to you. If youdecide that you must provide writable space in your anonymous<SPANCLASS="acronym">FTP</SPAN> area, there are a number of ways to limit yourvulnerability, as we describe below.</P>Making your incoming directorywrite-only<PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9113"></A>The most obvious approach, if you're using a <SPANCLASS="acronym">UNIX</SPAN>machine as your bastion host, is to make your &quot;incoming&quot;directory write-only (directory permissions 773 or 733&nbsp;- that is,&quot;rwxrwx-wx&quot; or &quot;rwx-wx-wx&quot;). Make sure thatthe directory is owned by some user other than &quot;ftp&quot; (orwhatever your anonymous <SPANCLASS="acronym">FTP</SPAN> server runs as whendoing anonymous <SPANCLASS="acronym">FTP</SPAN>). If the mode is 773 instead of733, then also make sure that the group of the directory is somethingother than the default group of the &quot;ftp&quot; login.</P><PCLASS="para">The problem with this approach is that all you're doing is keepingpeople from being able to see what's in the top-level directory. Theycan still see what's in subdirectories, and they can still accessfiles and directories they create in the top-level directory if theycommunicate exact filenames among themselves. (Unfortunately, theycan, via their mailing lists and other communications channels.)<ACLASS="indexterm"NAME="AUTOID-9120"></A></P>Disabling the creation of directoriesand certain files<PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9124"></A>Another approach is to disable the creation ofdirectories and files with funny names (for example, files that beginwith &quot;.&quot;) in your anonymous <SPANCLASS="acronym">FTP</SPAN>server. Depending on your server, you may be able to do this with aconfiguration file (for example, the <EMCLASS="emphasis">wuarchive</EM> server lets yourestrict anonymous users from deleting, overwriting, or creatingcertain types of files), or you may have to modify the server sourcecode. (This is a nontrivial modification, which requires a reasonablycompetent C programmer.)</P><PCLASS="para">This approach doesn't keep people from uploading stuff to the writabledirectory you provide; it simply makes it more difficult for them tohide that stuff so that it escapes your notice. If you do this, youwill still need to look at the writable area every day (and look atthe content of files, not just the names) to be sure everything issomething that belongs there.</P>Uploading by prearrangement<PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9132"></A><ACLASS="indexterm"NAME="AUTOID-9135"></A>Another approach is used frequently by sites that want people to be ableto upload files, but only by prearrangement. These sites takea page from the underground's own book by creating hidden writablesubdirectories that you can only access if you know they're there. Theattackers can't see them; they're unaware that there's a&quot;there&quot; there for theirwares.</P><PCLASS="para">Here's what you do, assuming you're using a <SPANCLASS="acronym">UNIX</SPAN>system for your <SPANCLASS="acronym">FTP</SPAN> server:</P><OLCLASS="orderedlist"><LICLASS="listitem"><PCLASS="para">Make an &quot;incoming&quot; directory. </P></LI><LICLASS="listitem"><PCLASS="para">Make a subdirectory there with a &quot;secret&quot; name, chosen inmuch the same way you'd choose a password&nbsp;- that is, somethingunguessable.</P></LI><LICLASS="listitem"><PCLASS="para">Make the subdirectory with the secret name be writable.</P></LI><LICLASS="listitem"><PCLASS="para">&#13;Make the parent directory (the incoming directory) mode execute-only(mode 111&nbsp;- that is,<CODECLASS="literal">--x--x--x</CODE>).&#13;</P></LI></OL><PCLASS="para">For example:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">unix# cd ~ftp/pubunix# mkdir incomingunix# cd incomingunix# mkdir b2b_Freeunix# chmod a+w b2b_Free # or &quot;chmod 0777 b2b_Free&quot;unix# cd ..unix# chmod a=x incoming # or &quot;chmod 0111 incoming&quot;</PRE></BLOCKQUOTE><PCLASS="para">Users can now upload files to the writable directory only if they know(presumably because you've told them) its secret, password-like name.You can create as many of these secret subdirectories as necessary,and you can change or delete them as often as necessary. If your sitecreates a top-level index of your <SPANCLASS="acronym">FTP</SPAN> area (such asa file containing the output of &quot;ls -lR ~ftp&quot;), you need to make surethat the hidden directories don't appear in the index. The easiest wayto do that is to run the indexing command as the &quot;ftp&quot; user, so thatit has the same permissions that someone using anonymous<SPANCLASS="acronym">FTP</SPAN> would have.</P><PCLASS="para">Beware that some <SPANCLASS="acronym">FTP</SPAN> clients with graphical userinterfaces will only let a user access a directory that the<SPANCLASS="acronym">FTP</SPAN> client can see; they don't provide a way forthe user to jump blindly to a directory that doesn'tappear in a directory listing. Such clients won't work with thisscheme because, by design, the client can't see the names of thesubdirectories containing the actual data. This is not usually aproblem for people coming in from <SPANCLASS="acronym">UNIX</SPAN> machines,and there are publicly available clients for most platforms that donot have this problem, so you may be able to work around thislimitation.</P>Removing the files<PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9162"></A><ACLASS="indexterm"NAME="AUTOID-9165"></A>There is one other approach you might take, particularly if you findthat your anonymous <SPANCLASS="acronym">FTP</SPAN> area is already beingabused and you're curious to see what people are uploadingthere. Basically, you run a short shell script once a minute as a<EMCLASS="emphasis">cron</EM> job that moves files from the writableincoming directory to another directory outside theanonymous <SPANCLASS="acronym">FTP</SPAN> area. This will ensure that theintruders won't be able to see what's been uploaded. You may need torename files when you move them to avoid overwriting files with thesame name. Because the files aren't there to look at, it's easy forpeople to unintentionally create name conflicts (particularly ifthey're sending you crash dumps, which probably all start out havingthe same name).</P><PCLASS="para">Make sure that the new directory is on the same filesystem, so theoperating system doesn't have to copy the data. Because of the waythat the <SPANCLASS="acronym">UNIX</SPAN> filesystem works, this approach workseven if the file is still being written when the &quot;move&quot;takes place, as long as the directory you're moving it to is on thesame filesystem as the original directory (&quot;moving&quot; a filein such a case doesn't actually move the data; it merely renames thefile).</P><PCLASS="para">This doesn't avoid denial of service attacks; people can still fill upyour disk space. In fact, they may retry downloads multiple times(because the files keep mysteriously disappearing) and unintentionallyfill up your disks.<ACLASS="indexterm"NAME="AUTOID-9174"></A><ACLASS="indexterm"NAME="AUTOID-9175"></A></P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-16">8.2.1.7 Summary of recommendations for<SPANCLASS="acronym">FTP</SPAN></A></H4><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">If you have <SPANCLASS="acronym">FTP</SPAN> clients that properly supportpassive mode, then allow internal hosts to contact external<SPANCLASS="acronym">FTP</SPAN> servers via packet filtering. This is only safeif you can filter on the <SPANCLASS="acronym">TCP ACK</SPAN> bit, so that youcan allow only outgoing <SPANCLASS="acronym">TCP</SPAN>connections from ports above 1023 to ports above 1023.</P></LI><LICLASS="listitem"><PCLASS="para">If you have <SPANCLASS="acronym">FTP</SPAN> clients that don't support passivemode, then use an <SPANCLASS="acronym">FTP</SPAN> proxy server such as the onein the <SPANCLASS="acronym">TIS</SPAN> Internet Firewall Toolkit.</P></LI><LICLASS="listitem"><PCLASS="para">Consider providing <SPANCLASS="acronym">FTP</SPAN> access via both packetfiltering and proxies, supporting passive mode via packet filteringand normal mode via proxies.</P></LI><LICLASS="listitem"><PCLASS="para">If you want to allow incoming <SPANCLASS="acronym">FTP</SPAN>, use packetfilters to allow incoming <SPANCLASS="acronym">FTP</SPAN> only to your bastionhost.</P></LI><LICLASS="listitem"><PCLASS="para">If you allow incoming <SPANCLASS="acronym">FTP</SPAN> (anonymous or user), usean up-to-date <SPANCLASS="acronym">FTP</SPAN> server.</P></LI><LICLASS="listitem"><PCLASS="para">If you allow anonymous <SPANCLASS="acronym">FTP</SPAN> users to write files,protect the writable area so it can't be used to transfer filesbetween third parties.</P></LI><LICLASS="listitem"><PCLASS="para">Be careful about who within your organization can put up files foranonymous <SPANCLASS="acronym">FTP</SPAN>, and make sure they understand whatthey're doing.</P></LI><LICLASS="listitem"><PCLASS="para">If you want to allow nonanonymous <SPANCLASS="acronym">FTP</SPAN>, see <ACLASS="xref"HREF="ch10_01.htm"TITLE="Authentication and Inbound Services">Chapter 10, <CITECLASS="chapter">Authentication and InboundServices</CITE></A> for a discussion of the password andauthentication issues involved.  </P></LI></UL></DIV><ACLASS="indexterm"NAME="AUTOID-9212"></A><ACLASS="indexterm"NAME="AUTOID-9213"></A></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-08-S2-5">8.2.2 Trivial File Transfer Protocol(<SPANCLASS="acronym">TFTP</SPAN>)</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9218"></A><ACLASS="indexterm"NAME="CH08TFTP"></A><ACLASS="indexterm"NAME="CH08CONFTFTP"></A><SPANCLASS="acronym">TFTP</SPAN> is a simplified file transfer protocol; it issimpler than <SPANCLASS="acronym">FTP</SPAN>, and is designed to be implementedin <SPANCLASS="acronym">ROM</SPAN> for booting diskless systems like Xterminals, diskless workstations, and routers. There is noauthentication with <SPANCLASS="acronym">TFTP</SPAN>; a <SPANCLASS="acronym">TFTP</SPAN>client simply connects to the server and asks for a file, withoutsaying who the file is for. If the file is one that the server canaccess, the server gives the client the file. For this reason, youneed to be very careful about what your <SPANCLASS="acronym">TFTP</SPAN> server(if you have one) can access, and what clients can access the server.</P><PCLASS="para">Generally, there's no reason at all to allow <SPANCLASS="acronym">TFTP</SPAN>across your firewall, even if you use it internally. You do not wantto boot diskless systems across the Internet, and people do nottransfer files with <SPANCLASS="acronym">TFTP</SPAN>.</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-17">8.2.2.1 Packet filtering characteristics of<SPANCLASS="acronym">TFTP</SPAN></A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9239"></A><SPANCLASS="acronym">TFTP</SPAN> is a <SPANCLASS="acronym">UDP</SPAN>-basedprotocol. Servers listen on port 69 for the initial client-to-server packet to establish the TFTP session, then use a port above 1023 for all further packets during that session. Clients use ports above 1023.</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">ACK</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Set</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Notes</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">69</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[8]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Incoming <SPANCLASS="acronym">TFTP</SPAN> request (first packet from client)</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[8]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Response to incoming request</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">UDP</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[8]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Subsequent packets from client</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">69</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[8]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Outgoing <SPANCLASS="acronym">TFTP</SPAN> request (first packet from client)</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[8]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Response to outgoing request</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">UDP</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[8]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Subsequent packets from client</P></TD></TR></TBODY></TABLE><BLOCKQUOTECLASS="footnote"><PCLASS="para">[8] <SPANCLASS="acronym">UDP</SPAN> packets do not have <SPANCLASS="acronym">ACK</SPAN> bits.</P></BLOCKQUOTE></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-18">8.2.2.2 Proxying characteristics of<SPANCLASS="acronym">TFTP</SPAN></A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9396"></A><SPANCLASS="acronym">TFTP</SPAN> does not lend itself well to proxying.Because <SPANCLASS="acronym">TFTP</SPAN> clients are often implemented in hardware,with no users involved, neither modified clients nor modified userprocedures are generally implementable. A transparent proxy couldeasily support <SPANCLASS="acronym">TFTP</SPAN>, providing the same extremelyminimal amount of security achievable if you allow<SPANCLASS="acronym">TFTP</SPAN> through packet filters.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-19">8.2.2.3 Summary of <SPANCLASS="acronym">TFTP</SPAN>recommendations</A></H4><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Do not allow <SPANCLASS="acronym">TFTP</SPAN> across your firewall.</P></LI></UL></DIV><ACLASS="indexterm"NAME="AUTOID-9411"></A><ACLASS="indexterm"NAME="AUTOID-9412"></A></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-08-S2-6">8.2.3 File Service Protocol (<SPANCLASS="acronym">FSP</SPAN>)</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="CH08FSP"></A><ACLASS="indexterm"NAME="CH08CONFFSP"></A><SPANCLASS="acronym">FSP</SPAN> is a file transfer protocol that was designedto circumvent <SPANCLASS="acronym">FTP</SPAN> restrictions. Very few sitesprovide supported <SPANCLASS="acronym">FSP</SPAN> service; most<SPANCLASS="acronym">FSP</SPAN> servers are set up by users or attackers,without the knowledge or consent of a machine's managers. <SPANCLASS="acronym">FSP</SPAN> activity is often a clue that attackers havecompromised a site; attackers often use <SPANCLASS="acronym">FSP</SPAN> to movetheir files from site to site. <SPANCLASS="acronym">FSP</SPAN> activity can bedifficult to detect, however, because, as we discuss below, there are nostandard port numbers that <SPANCLASS="acronym">FSP</SPAN> clients and serversuse.</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-20">8.2.3.1 Packet filtering characteristics of<SPANCLASS="acronym">FSP</SPAN></A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9435"></A><SPANCLASS="acronym">FSP</SPAN> is intentionally difficult to suppress withpacket filtering. Filtering out all <SPANCLASS="acronym">UDP</SPAN> servicesexcept those you need, and restricting those to specific hosts, willpretty well get rid of it except on the hosts you're allowing other<SPANCLASS="acronym">UDP</SPAN> services to. If you want to allow FSP, that'sextremely simple; allowing <SPANCLASS="acronym">UDP</SPAN> packets to and froma host, at any port number, will allow it to be an<SPANCLASS="acronym">FSP</SPAN> server and/or client.</P><PCLASS="para"><SPANCLASS="acronym">FSP</SPAN> is a <SPANCLASS="acronym">UDP</SPAN>-basedprotocol. There is no &quot;standard&quot; port number that theserver runs on; anyone running a server chooses the port that serverwill use. If they have root access, they often choose port 21, the<SPANCLASS="acronym">UDP</SPAN> equivalent of the <SPANCLASS="acronym">TCP</SPAN> portused by <SPANCLASS="acronym">FTP</SPAN>; if they don't have root access, theyhave to use a port above 1023, and there's no predicting what it willbe. Clients generally use ports above 1023.</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">ACK</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Set</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Notes</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023[9] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[9] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[10]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Incoming <SPANCLASS="acronym">FSP</SPAN> request</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[9] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023[9] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[10] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Response to incoming request</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023[9] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[9] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[10] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Outgoing <SPANCLASS="acronym">FSP</SPAN> request</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[9] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023[9] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[10] </P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Response to outgoing request</P></TD></TR></TBODY></TABLE><BLOCKQUOTECLASS="footnote"><PCLASS="para">[9] <SPANCLASS="acronym">FSP</SPAN> does not have standard port numbers, althoughpeople running <SPANCLASS="acronym">FSP</SPAN> servers often put them on port21 if they have root access (paralleling <SPANCLASS="acronym">FTP</SPAN>servers, which use <SPANCLASS="acronym">TCP</SPAN> port 21). Clients usuallyuse ports above 1023, but not always.</P><PCLASS="para">[10] <SPANCLASS="acronym">UDP</SPAN> packets do not have <SPANCLASS="acronym">ACK</SPAN> bits.</P></BLOCKQUOTE></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-21">8.2.3.2 Proxying characteristics of<SPANCLASS="acronym">FSP</SPAN></A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9578"></A>Using generic proxies to proxy a <SPANCLASS="acronym">UDP</SPAN>-basedapplication with no standard port number is as difficult as trying tosuppress it with packet filters. No standard proxy package supports<SPANCLASS="acronym">FSP</SPAN>. A dedicated <SPANCLASS="acronym">FSP</SPAN> proxy wouldbe possible to write.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-22">8.2.3.3 Summary of <SPANCLASS="acronym">FSP</SPAN> recommendations</A></H4><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Do not allow <SPANCLASS="acronym">FSP</SPAN> across your firewall. Block all<SPANCLASS="acronym">UDP</SPAN> except for specific services you wish tointentionally allow, such as <SPANCLASS="acronym">DNS</SPAN>.</P></LI></UL><ACLASS="indexterm"NAME="AUTOID-9594"></A><ACLASS="indexterm"NAME="AUTOID-9595"></A></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-08-S2-7">8.2.4 <SPANCLASS="acronym">UNIX</SPAN>-to-<SPANCLASS="acronym">UNIX</SPAN>Copy Protocol (<SPANCLASS="acronym">UUCP</SPAN>)</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="CH08UUCP"></A><ACLASS="indexterm"NAME="CH08CONFUUCP"></A><ACLASS="indexterm"NAME="AUTOID-9608"></A><SPANCLASS="acronym">UUCP</SPAN> was designed for transferring files, includingelectronic mail and news, between <SPANCLASS="acronym">UNIX</SPAN> machines; itis the original <SPANCLASS="acronym">UNIX</SPAN> networkingsystem. <SPANCLASS="acronym">UUCP</SPAN> is primarily used as a dial-upprotocol (as the sole protocol over a modem connection), but somesites, particularly those with intermittent dial-up Internet service,use <SPANCLASS="acronym">UUCP</SPAN> over <SPANCLASS="acronym">TCP</SPAN> to transfermail and news from their service provider. <SPANCLASS="acronym">UUCP</SPAN>allows the service provider to collect and hold all of the site's mailand news; when the site brings up its Internet connection and contactsthe service provider using <SPANCLASS="acronym">UUCP</SPAN>, the serviceprovider transfers all of the accumulated mail and news at once.</P><PCLASS="para"><SPANCLASS="acronym">UUCP</SPAN> over <SPANCLASS="acronym">TCP</SPAN> is also used bysome sites that have much faster permanent Internet connections (56Kb/s lines, for example) to transfer Usenet news,because <SPANCLASS="acronym">UUCP</SPAN> over <SPANCLASS="acronym">TCP</SPAN> is morebandwidth-efficient than <SPANCLASS="acronym">NNTP</SPAN> for this purpose. (Ithas recently become difficult or impossible to keep up with the newsin every group over a 56 Kb/s line using NNTP, for example; thereisn't enough bandwidth. As the volume of Usenet news continues togrow, this problem is going to get worse.)</P><PCLASS="para">One of the nice features of <SPANCLASS="acronym">UUCP</SPAN> is that, once aconnection between two sites is established, that connection is usedto transfer all the pending data between the two sites, regardless ofwhich site initiated the connection. This means that you could allowonly outgoing <SPANCLASS="acronym">UUCP</SPAN> connections, and poll yourservice provider on a regular basis (hourly, for example) to bothsend your outgoing messages and collect your incoming messages.</P><PCLASS="para">Most sites do not use <SPANCLASS="acronym">UUCP</SPAN> in any form any more. Ifyou don't have any special needs, you can simply not allow it acrossyour firewall.</P><PCLASS="para">Because <SPANCLASS="acronym">UUCP</SPAN> uses reusable passwords, someone whosnoops on one of your <SPANCLASS="acronym">UUCP</SPAN> sessions will later beable to connect to your service provider and impersonate you, or connectto you and impersonate your service provider. The passwords are alsogenerally stored unencrypted in the configuration files on the callingmachine, so it may be possible to do this without even snooping on aconnection first. You may be able to defend against this with variousmechanisms that depend on what version of <SPANCLASS="acronym">UUCP</SPAN> youand your service provider are using.[11]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[11] For a more detailed discussion, see the book <CITECLASS="citetitle">Managing <SPANCLASS="acronym">UUCP</SPAN>and Usenet</CITE> by Tim O'Reilly and Grace Todino (O'Reilly&amp; Associates, 1992).</P></BLOCKQUOTE><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-23">8.2.4.1 Packet filtering characteristics of<SPANCLASS="acronym">UUCP</SPAN></A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9643"></A><SPANCLASS="acronym">UUCP</SPAN> over <SPANCLASS="acronym">TCP</SPAN> is obviously a <SPANCLASS="acronym">TCP</SPAN>-based service. Servers use port 540. Clients use ports above 1023.</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">ACK</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Set</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Notes</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">540</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[12]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Incoming <SPANCLASS="acronym">UUCP</SPAN> connection, client to server</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">540</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Yes</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Incoming <SPANCLASS="acronym">UUCP</SPAN> connection, server to client</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">540</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[12]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Outgoing <SPANCLASS="acronym">UUCP</SPAN> connection, client to server</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">TCP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">540</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Yes</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Outgoing <SPANCLASS="acronym">UUCP</SPAN> connection, server to client</P></TD></TR></TBODY></TABLE><BLOCKQUOTECLASS="footnote"><PCLASS="para">[12] <SPANCLASS="acronym">ACK</SPAN> is not set on the first packet of this type (establishing connection) but will be set on the rest.</P></BLOCKQUOTE></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-24">8.2.4.2 Proxying characteristics of <SPANCLASS="acronym">UUCP</SPAN></A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-9764"></A><SPANCLASS="acronym">UUCP</SPAN> is a store-and-forward protocol, and as suchis not used with general-purpose proxies; instead, it's configured toeffectively do its own proxying. It is a straightforwardsingle-connection protocol used with a small number of clients, andthus is well-suited to both modified-client and modified-procedureproxying. On the other hand, it is rare for people to want to proxyit, so there are no widely available proxies specifically written forit. Generic proxy servers, such as the <EMCLASS="emphasis">plug-gw</EM>program in the <SPANCLASS="acronym">TIS FWTK</SPAN>, should work if you candecide which real server to connect to based on which client theconnection request is coming from (in other words, if all connectionsare to the same server, or if a given client host always connects tothe same server).</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="FIRE-08-S3-25">8.2.4.3 Summary of <SPANCLASS="acronym">UUCP</SPAN> recommendations</A></H4><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">You probably do not need to allow <SPANCLASS="acronym">UUCP</SPAN> over<SPANCLASS="acronym">TCP</SPAN> at your site. If you do wish to use it, usepacket filters to limit access to a bastion host.</P></LI></UL><ACLASS="indexterm"NAME="AUTOID-9779"></A><ACLASS="indexterm"NAME="AUTOID-9780"></A></DIV></DIV><ACLASS="indexterm"NAME="AUTOID-9781"></A></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_01.htm"TITLE="8.1 Electronic Mail"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 8.1 Electronic Mail"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Building Internet Firewalls"><IMGSRC="../gifs/txthome.gif"ALT="Building Internet Firewalls"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_03.htm"TITLE="8.3 Terminal Access (Telnet)"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 8.3 Terminal Access (Telnet)"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">8.1 Electronic Mail</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_a.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">8.3 Terminal Access (Telnet)</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>