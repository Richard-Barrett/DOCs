<HTML><HEAD><TITLE>[Chapter 8] 8.13 Network Time Protocol (NTP)</TITLE><METANAME="DC.title"CONTENT="Building Internet Firewalls"><METANAME="DC.creator"CONTENT="D. Brent Chapman &amp; Elizabeth D. Zwicky"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:26:09Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-124-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch08_01.htm"TITLE="8. Configuring Internet Services"><LINKREL="prev"HREF="ch08_12.htm"TITLE="8.12 Network Management Services"><LINKREL="next"HREF="ch08_14.htm"TITLE="8.14 Network File System (NFS)"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Building Internet Firewalls"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Building Internet Firewalls"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/fsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_12.htm"TITLE="8.12 Network Management Services"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 8.12 Network Management Services"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 8<BR>Configuring Internet Services</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_14.htm"TITLE="8.14 Network File System (NFS)"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 8.14 Network File System (NFS)"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="FIRE-08-S1-13">8.13 Network Time Protocol (<SPANCLASS="acronym">NTP</SPAN>)</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="CH08NTP"></A><ACLASS="indexterm"NAME="CH08CONFNTP"></A><ACLASS="indexterm"NAME="AUTOID-15858"></A><ACLASS="indexterm"NAME="CH08CLOCKS"></A><ACLASS="indexterm"NAME="CH08CONFCLOCKS"></A><SPANCLASS="acronym">NTP</SPAN> allows you to setthe clocks on your systems very accurately, to within 100ms andsometimes even 10ms. Knowing the exact time is extremely importantfor certain types of applications and protocols:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">It's much easier to correlate information from multiple machines(log files, for example, when analyzing a break-in attempt) when theclocks on those machines are all synchronized. It's helpful to knowexactly who was attacked, and in what order, if you're going tounderstand what the attacker was after&nbsp;- and what he might do next.</P></LI><LICLASS="listitem"><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-15874"></A><ACLASS="indexterm"NAME="AUTOID-15877"></A>Some security protocols depend on an accurate source of timeinformation in order to prevent &quot;playback&quot; attacks. Suchprotocols tag their communications with the current time,so that those same communications, e.g., a login/passwordinteraction or even an entire communication, can't be replayed at alater date as part of an attack. This tagging can be circumvented ifthe clock can be set back to the time the communication was recorded.</P></LI></UL><PCLASS="para"><SPANCLASS="acronym">NTP</SPAN> servers communicate with other<SPANCLASS="acronym">NTP</SPAN> servers in a hierarchy to distribute clockinformation. The closer a system is to a reference clock (an atomicclock, radio clock, or some other definitive clock), the higher it isin the hierarchy. Servers communicate with each other frequently toestimate and track network delay between themselves, so that thisdelay can be compensated for. <SPANCLASS="acronym">NTP</SPAN> clients simply askservers for the current time without worrying about compensating forcommunications delays.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-08-S2-47">8.13.1 Packet Filtering Characteristics of<SPANCLASS="acronym">NTP</SPAN></A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-15888"></A><SPANCLASS="acronym">NTP</SPAN> is a <SPANCLASS="acronym">UDP</SPAN>-basedservice. <SPANCLASS="acronym">NTP</SPAN> servers use well-known port 123 totalk to each other and to <SPANCLASS="acronym">NTP</SPAN>clients. <SPANCLASS="acronym">NTP</SPAN> clients use random ports above1023. As with <SPANCLASS="acronym">DNS</SPAN>, you can tell the differencebetween:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">An <SPANCLASS="acronym">NTP</SPAN> client-to-server query&nbsp;- source port above1023, destination port 123.</P></LI><LICLASS="listitem"><PCLASS="para">An <SPANCLASS="acronym">NTP</SPAN> server-to-client response&nbsp;- source port 123,destination port above 1023.</P></LI><LICLASS="listitem"><PCLASS="para">An <SPANCLASS="acronym">NTP</SPAN> server-to-server query or response&nbsp;- sourceand destination ports both 123.</P></LI></UL><PCLASS="para">Unlike <SPANCLASS="acronym">DNS</SPAN>, <SPANCLASS="acronym">NTP</SPAN> never uses<SPANCLASS="acronym">TCP</SPAN>, and <SPANCLASS="acronym">NTP</SPAN> has no analog tothe <SPANCLASS="acronym">DNS</SPAN> zone transfer operation.</P><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Direc-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Pro-</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Source</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Dest.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">ACK</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH></TR><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tion</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Addr.</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">tocol</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Port</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Set</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Notes</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">123</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[51]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Incoming query, client to server</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">123</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[51]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Answer to incoming <SPANCLASS="acronym">UDP</SPAN> query, server to client</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">123</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[51]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Outgoing query, client to server</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">123</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">&gt;1023</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[51]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Answer to outgoing <SPANCLASS="acronym">UDP</SPAN> query, server to client</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">In</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">123</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">123</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[51]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Query or response between two servers</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Out</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Int</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Ext</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><SPANCLASS="acronym">UDP</SPAN></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">123</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">123</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">[51]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Query or response between two servers</P></TD></TR></TBODY></TABLE><BLOCKQUOTECLASS="footnote"><PCLASS="para">[51] <SPANCLASS="acronym">UDP</SPAN> packets do not have <SPANCLASS="acronym">ACK</SPAN> bits.</P></BLOCKQUOTE><PCLASS="para"><ACLASS="xref"HREF="ch08_13.htm#FIRE-08-FIG-19"TITLE="NTP with packet filtering">Figure 8.19</A> shows how packet filtering works with<SPANCLASS="acronym">NTP</SPAN>.</P><H4CLASS="figure"><ACLASS="title"NAME="FIRE-08-FIG-19">Figure 8.19: <SPANCLASS="acronym">NTP</SPAN> with packet filtering</A></H4><IMGCLASS="graphic"SRC="figs/fire0819.gif"ALT="Figure 8.19"></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-08-S2-49">8.13.2 Proxying Characteristics of<SPANCLASS="acronym">NTP</SPAN></A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-16074"></A>As a <SPANCLASS="acronym">UDP</SPAN>-based application, <SPANCLASS="acronym">NTP</SPAN>can't be proxied by <SPANCLASS="acronym">SOCKS</SPAN>, but can be used with the<SPANCLASS="acronym">UDP</SPAN> Packet Relayer. Because <SPANCLASS="acronym">NTP</SPAN> employsa hierarchy of servers, it can be configured to run on a bastion hostwithout using explicit proxying, as shown below.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-08-S2-50">8.13.3 Configuring <SPANCLASS="acronym">NTP</SPAN> toWork with a Firewall</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-16087"></A>Do you really need to configure <SPANCLASS="acronym">NTP</SPAN> to work with afirewall? That's your first decision. You may not need to if either ofthe following cases is true at your site:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">If you have an accurate source of time within your internalnetwork&nbsp;- for example, a radio clock receiving time signals from theNational Bureau of Standards atomic clocks on one of their radiostations (or the equivalent from non-U.S. standards organizations), or asatellite clock receiving data from the Global Positioning System(<SPANCLASS="acronym">GPS</SPAN>) satellites.</P></LI><LICLASS="listitem"><PCLASS="para">If you're more worried about having time be consistent<EMCLASS="emphasis">within</EM> your network than<EMCLASS="emphasis">between</EM> your network and the outside world.</P></LI></UL><PCLASS="para">In either of these cases, you don't need to run <SPANCLASS="acronym">NTP</SPAN>across your firewall; you can simply run it internally.</P><PCLASS="para">If you do want to run <SPANCLASS="acronym">NTP</SPAN> across your firewall, the best way is to set up an <SPANCLASS="acronym">NTP</SPAN> server on a bastionhost that talks to multiple external <SPANCLASS="acronym">NTP</SPAN> servers andanother <SPANCLASS="acronym">NTP</SPAN> server on some internal host that talksto the bastion host. (You want the bastion host to talk to multipleexternal <SPANCLASS="acronym">NTP</SPAN> servers because it increases accuracyand makes it harder to fool.) Next, configure internal<SPANCLASS="acronym">NTP</SPAN> clients and other internal <SPANCLASS="acronym">NTP</SPAN>servers to talk to the internal server that talks to the bastionserver. You need to configure any packet filtering system between theinternal server and the bastion host to allow the following:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Queries from the internal <SPANCLASS="acronym">NTP</SPAN> server to the bastionhost <SPANCLASS="acronym">NTP</SPAN> server: <SPANCLASS="acronym">UDP</SPAN>packets from port 123 on the internal server to port 123 on thebastion host.</P></LI><LICLASS="listitem"><PCLASS="para">Answers from the bastion host <SPANCLASS="acronym">NTP</SPAN> server to theinternal <SPANCLASS="acronym">NTP</SPAN> server: <SPANCLASS="acronym">UDP</SPAN>packets from port 123 on the bastion host to port 123 on the internalhost.</P></LI></UL></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="FIRE-08-S2-51">8.13.4 Summary of <SPANCLASS="acronym">NTP</SPAN>Recommendations</A></H3><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Consider running <SPANCLASS="acronym">NTP</SPAN> purely internally.</P></LI><LICLASS="listitem"><PCLASS="para">If you run <SPANCLASS="acronym">NTP</SPAN> to the Internet, use an<SPANCLASS="acronym">NTP</SPAN> server on a bastion host as a proxy for aninternal server.</P></LI></UL><ACLASS="indexterm"NAME="AUTOID-16131"></A><ACLASS="indexterm"NAME="AUTOID-16132"></A><ACLASS="indexterm"NAME="AUTOID-16133"></A><ACLASS="indexterm"NAME="AUTOID-16134"></A></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_12.htm"TITLE="8.12 Network Management Services"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 8.12 Network Management Services"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Building Internet Firewalls"><IMGSRC="../gifs/txthome.gif"ALT="Building Internet Firewalls"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch08_14.htm"TITLE="8.14 Network File System (NFS)"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 8.14 Network File System (NFS)"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">8.12 Network Management Services</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_a.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">8.14 Network File System (NFS)</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>