<HTML><HEAD><TITLE>[Chapter 10] Auditing and Logging</TITLE><METANAME="DC.title"CONTENT="Practical UNIX &amp; Internet Security"><METANAME="DC.creator"CONTENT="Simson Garfinkel &amp; Gene Spafford"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:07:17Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-148-8"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="part03.htm"TITLE="III. System Security"><LINKREL="prev"HREF="ch09_03.htm"TITLE="9.3 A Final Note"><LINKREL="next"HREF="ch10_02.htm"TITLE="10.2 The acct/pacct Process Accounting File"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Practical UNIX &amp; Internet Security"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Practical UNIX &amp; Internet Security"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch09_03.htm"TITLE="9.3 A Final Note"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 9.3 A Final Note"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 10</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_02.htm"TITLE="10.2 The acct/pacct Process Accounting File"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 10.2 The acct/pacct Process Accounting File"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="CHAPTER"><H1CLASS="chapter"><ACLASS="title"NAME="PUIS-CHP-10">10. Auditing and Logging</A></H1><DIVCLASS="htmltoc"><P><B>Contents:</B><BR><ACLASS="SECT1"HREF="#PUIS-CHP-10-SECT-1"TITLE="10.1 The Basic Log Files">The Basic Log Files</A><BR><ACLASS="SECT1"HREF="ch10_02.htm"TITLE="10.2 The acct/pacct Process Accounting File">The acct/pacct Process Accounting File</A><BR><ACLASS="SECT1"HREF="ch10_03.htm"TITLE="10.3 Program-Specific Log Files">Program-Specific Log Files</A><BR><ACLASS="SECT1"HREF="ch10_04.htm"TITLE="10.4 Per-User Trails in the Filesystem">Per-User Trails in the Filesystem</A><BR><ACLASS="SECT1"HREF="ch10_05.htm"TITLE="10.5 The UNIX System Log (syslog) Facility">The UNIX System Log (syslog) Facility</A><BR><ACLASS="SECT1"HREF="ch10_06.htm"TITLE="10.6 Swatch: A Log File Tool">Swatch: A Log File Tool</A><BR><ACLASS="SECT1"HREF="ch10_07.htm"TITLE="10.7 Handwritten Logs">Handwritten Logs</A><BR><ACLASS="SECT1"HREF="ch10_08.htm"TITLE="10.8 Managing Log Files">Managing Log Files</A></P><P></P></DIV><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-12462"></A><ACLASS="indexterm"NAME="AUTOID-12464"></A><ACLASS="indexterm"NAME="AUTOID-12467"></A><ACLASS="indexterm"NAME="AUTOID-12471"></A><ACLASS="indexterm"NAME="AUTOID-12475"></A>After you haveestablished the protection mechanisms on your system, you will needto monitor them. You want to be sure that your protection mechanismsactually work. You will also want to observe any indications ofmisbehavior or other problems. This process of monitoring the behaviorof the system is known as <ICLASS="firstterm">auditing</I>. It ispart of a defense-in-depth strategy: to borrow a phrase from severalyears ago, you should trust, but you should also verify.</P><PCLASS="para"><SPANCLASS="acronym">UNIX</SPAN> maintains a number of log files thatkeep track of what's been happening to the computer. Earlyversions of <SPANCLASS="acronym">UNIX</SPAN> used the log files to recordwho logged in, who logged out, and what they did. Newer versionsof <SPANCLASS="acronym">UNIX</SPAN> provide expanded logging facilities thatrecord such information as files that are transferred over the network,attempts by users to become the superuser, electronic mail, andmuch more.</P><PCLASS="para">Log files are an important building block of a secure system:they form a recorded history, or <EMCLASS="emphasis">audit trail</EM>,of your computer's past, making it easier for you to trackdown intermittent problems or attacks. Using log files, you maybe able to piece together enough information to discover the causeof a bug, the source of a break-in, and the scope of the damageinvolved. In cases where you can't stop damage from occurring,at least you will have some record of it. Those logs may be exactlywhat you need to rebuild your system, conduct an investigation,give testimony, recover insurance money, or get accurate field serviceperformed.</P><PCLASS="para">But beware: Log files also have a fundamental vulnerability.Because they are often recorded on the system itself, they are subjectto alteration or deletion. As we shall see, there are techniquesthat may help you to mitigate this problem, but no technique cancompletely remove it unless you log to a different machine.</P><PCLASS="para">Locating to a different machine is actually a good idea evenif your system supports some other techniques to store the logs.Consider some method of automatically sending log files to a systemon your network in a physically secured location. For example, sendinglogging information to a PC or Apple Macintosh provides a way ofstoring the logs in a machine that is considerably more difficultto break into and disturb. We have heard good reports from peoplewho are able to use &quot;outmoded&quot; 80486 or 80386PCs as log machines. For a diagram of such a setup, see <ACLASS="xref"HREF="ch10_01.htm#PUIS-CHP-10-FIG-1"TITLE="Secure logging host.">Figure 10.1</A>.</P><H4CLASS="figure"><ACLASS="title"NAME="PUIS-CHP-10-FIG-1">Figure 10.1: Secure logging host.</A></H4><IMGCLASS="graphic"SRC="figs/puis_1001.gif"ALT="Figure 10.1"><DIVCLASS="sect1"><H2CLASS="sect1"><ACLASS="title"NAME="PUIS-CHP-10-SECT-1">10.1 The Basic Log Files</A></H2><PCLASS="para">Most log files are text files that are written line by lineby system programs. For example, each time a user on your systemtries to become the superuser by using the <EMCLASS="emphasis">su</EM>command, the <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-12497"></A>su</EM>program may append a single line to the log file <EMCLASS="emphasis">sulog</EM>,which records whether the <EMCLASS="emphasis">su</EM> attempt was successfulor not.</P><PCLASS="para">Different versions of <SPANCLASS="acronym">UNIX</SPAN> store log filesin different directories. The most common locations are:</P><TABLECLASS="informaltable"><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">/usr/adm</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Used by early versions of <SPANCLASS="acronym">UNIX</SPAN></P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">/var/adm</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Used by newer versions of <SPANCLASS="acronym">UNIX</SPAN>,so that the <EMCLASS="emphasis">/usr</EM> partition can be mounted read-only</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">/var/log</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Used by some versions of Solaris, Linux,<SPANCLASS="acronym">BSD</SPAN>, and free <SPANCLASS="acronym">BSD</SPAN> to storelog files</P></TD></TR></TBODY></TABLE><PCLASS="para">Within one of these directories (or a subdirectory in oneof them) you may find variants of some or all of the following files:</P><TABLECLASS="informaltable"><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">acct</I> or <ICLASS="filename">pacct</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Records commands run by every user</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">aculog</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Records of dial-out modems (automaticcall units)</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">lastlog</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Logs each user's most recentsuccessful login time, and possibly the last unsuccessful logintoo</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">loginlog</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Records bad login attempts</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">messages</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Records output to the system's&quot;console&quot; and other messages generated from the<ICLASS="filename">syslog </I>facility</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">sulog</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Logs use of the <EMCLASS="emphasis">su</EM>command</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">utmp</I>[1]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Records each user currently logged in</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">utmpx</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Extended <ICLASS="filename">utmp</I></P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">wtmp</I>[2]</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Provides a permanent record of each timea user logged in and logged out. Also records system shutdowns andstartups</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">wtmpx</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Extended <EMCLASS="emphasis">wtmp</EM></P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">vold.log</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Logs errors encountered with the useof external media, such as floppy disks or <SPANCLASS="acronym">CD-ROMS</SPAN></P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para"><ICLASS="filename">xferlog</I></P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Logs FTP access</P></TD></TR></TBODY></TABLE><BLOCKQUOTECLASS="footnote"><PCLASS="para">[1] Most versions ofUNIX store the <ICLASS="filename">utmp</I> file in the <ICLASS="filename">/etc</I>directory<ICLASS="filename">.</I></P><PCLASS="para">[2] Early versions ofSystem V UNIX stored the w<ICLASS="filename">tmp</I> file in the <ICLASS="filename">/etc</I>directory</P></BLOCKQUOTE><PCLASS="para">The following sections describe some of these files and howto use the <SPANCLASS="acronym">UNIX</SPAN> <EMCLASS="emphasis">syslog</EM> facility.</P><DIVCLASS="sidebar"><H4CLASS="sidebar"><ACLASS="title"NAME="AUTOID-12624">C2 Audit</A></H4><PCLASS="para">Many <SPANCLASS="acronym">UNIX</SPAN> systems allow the administratorto enable a comprehensive type of auditing (logging) known as &quot;<ACLASS="indexterm"NAME="AUTOID-12628"></A><ACLASS="indexterm"NAME="AUTOID-12630"></A><ACLASS="indexterm"NAME="AUTOID-12633"></A>C2 audit.&quot;This is so-named because it is logging of the form specified byU.S. Department of Defense regulations to meet the certificationat the C2 level of trust. These regulations are specified in a documentcalled the <EMCLASS="emphasis">Trusted Computer System Evaluation Criteria</EM>(often referred to as the &quot;Orange Book&quot; in the&quot;Rainbow Series&quot;).</P><PCLASS="para">C2 auditing generally means assigning an <ICLASS="firstterm"><ACLASS="indexterm"NAME="AUTOID-12639"></A>audit ID</I> to each group of related processes,starting at login. Thereafter, certain forms of system calls performedby every process are logged with the audit ID. This includes callsto open and close files, change directory, alter user process parameters,and so on.</P><PCLASS="para">Despite the mandate for the general content of such logging,there is no generally accepted standard for the format. Thus, eachvendor that provides C2-style logging seems to have a differentformat, different controls, and different locations for the logs.If you feel the need to set such logging on your machine, we recommendthat you read the documentation carefully. Furthermore, we recommendthat you be careful about what you log so as not to generate lotsof extraneous information, and that you log to a disk partitionwith lots of space.</P><PCLASS="para">The last suggestion, above, reflects one of the biggest problemswith C2 audit: it can consume a huge amount of space on an activesystem in a short amount of time. The other main problem with C2audit is that it is useless without some interpretation and reductiontools, and these are not generally available from vendors&nbsp;- theDoD regulations only require that the logging be done, not thatit be usable! Vendors have generally provided only as much as isrequired to meet the regulations and no more.</P><PCLASS="para">Only a few third-party companies provide intrusion detectionor audit-analysis tools: <EMCLASS="emphasis">Stalker, </EM>from HaystackLaboratories, is one such product with some sophisticated features.Development of more sophisticated tools is an ongoing, current areaof research for many people. We hope to be able to report somethingmore positive in a third edition of this book.</P><PCLASS="para">In the meantime, if you are not using one of these products,and you aren't at a DoD site that requires C2 logging,you may not want to enable C2 logging (unless you like filling upyour disks with data you may not be able to interpret). On the otherhand, if you have a problem, the more logging you have, the morelikely you will be able to determine what happened. Therefore, reviewthe documentation for the audit tools provided with your systemif it claims C2 audit capabilities, and experiment with them todetermine if you want to enable the data collection.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-10-SECT-1.1">10.1.1 lastlog File</A></H3><PCLASS="para"><SPANCLASS="acronym">UNIX</SPAN><ACLASS="indexterm"NAME="AUTOID-12650"></A><ACLASS="indexterm"NAME="AUTOID-12652"></A><ACLASS="indexterm"NAME="AUTOID-12655"></A><ACLASS="indexterm"NAME="AUTOID-12658"></A><ACLASS="indexterm"NAME="AUTOID-12661"></A><ACLASS="indexterm"NAME="AUTOID-12664"></A>records the last time that each user logged into the system in the<EMCLASS="emphasis">lastlog</EM> log file. <ACLASS="indexterm"NAME="AUTOID-12668"></A><ACLASS="indexterm"NAME="AUTOID-12670"></A>This time isdisplayed each time you log in:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">login: tipassword: <ICLASS="systemitem.password">books2sell</I>Last login: Tue Jul 12 07:49:59 on tty01 </PRE></BLOCKQUOTE><PCLASS="para"></P><PCLASS="para">This time is also reported when the <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-12678"></A>finger</EM> command is used:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% finger timLogin name: tim           In real life: Tim HackDirectory: /Users/tim     Shell: /bin/cshLast login Tue Jul 12 07:49:59 on tty01No unread mailNo Plan.% </PRE></BLOCKQUOTE><PCLASS="para">Some versions of <ACLASS="indexterm"NAME="AUTOID-12682"></A>SystemV <SPANCLASS="acronym">UNIX</SPAN> display both the last successful loginand the last unsuccessful login when a user logs into the system:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">login: timpassword: <ICLASS="systemitem.password">books2sell</I>Last successful login for tim : Tue Jul 12 07:49:59 on tty01Last unsuccessful login for tim : Tue Jul 06 09:22:10 on tty01</PRE></BLOCKQUOTE><PCLASS="para">Teach your users to check the last login time each time theylog in. If the displayed time doesn't correspond to thelast time they used the system, somebody else might have been usingtheir account. If this happens, the user should immediately changethe account's password and notify the system administrator.</P><PCLASS="para">Unfortunately, the design of the <EMCLASS="emphasis">lastlog</EM>mechanism is such that the previous contents of the file are overwrittenat each login. As a result, if a user is inattentive for even amoment, or if the login message clears the screen, the user maynot notice a suspicious time. Furthermore, even if a suspicioustime is noted, it is no longer available for the system administratorto examine.</P><PCLASS="para">One way to compensate for this design flaw is to have a <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-12693"></A>cron</EM>-spawnedtask periodically make an on-disk copy of the file that can be examinedat a later time. For instance, you could have a shell file run everysix hours to do the following:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">mv /var/adm/lastlog.3 /var/adm/lastlog.4mv /var/adm/lastlog.2 /var/adm/lastlog.3mv /var/adm/lastlog.1 /var/adm/lastlog.2cp /var/adm/lastlog /var/adm/lastlog.1</PRE></BLOCKQUOTE><PCLASS="para">This will preserve the contents of the file in six-hour periods.If backups are done every day, then they will also be preservedto the backups for examination later.</P><PCLASS="para">If you have saved copies of the <ICLASS="systemitem">lastlog</I>file, you will need a way to read the contents. Unfortunately, thereis no utility under standard versions of <SPANCLASS="acronym">UNIX</SPAN>that allows you to read one of these files and print all the information.Therefore, you need to write your own. The following <ACLASS="indexterm"NAME="AUTOID-12701"></A>Perlscript will work on SunOS systems, and you can modify it to workon others.[3]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[3] The layout of the <ICLASS="filename">lastlog</I> fileis usually documented in an include file such as <ICLASS="filename">/usr/include/lastlog.h</I></P></BLOCKQUOTE><DIVCLASS="example"><H4CLASS="example"><ACLASS="title"NAME="PUIS-CHP-10-EX-1">Example 10.1: Script that Reads lastlog File.</A></H4><PRECLASS="programlisting">#!/usr/local/bin/perl$fname = (shift || &quot;/var/adm/lastlog&quot;);$halfyear = 60*60*24*365.2425/2; # pedantry aboundssetpwent;while (($name, $junk, $uid) = getpwent) {		$names{$uid} = $name;}endpwent;open(LASTL, $fname);for (uid = 0; read(LASTL, $record, 28); $uid++) {	(	$time, $line, $host) = unpack('l A8 A16', $record);		next unless $time;		$host = &quot;($host)&quot; if $host;		($sec, $min, $hour, $mday, $mon, $year) = localtime($time);    $year += 1900 + ($year &lt; 70 ? 100 : 0);		print $names{$uid}, $line, &quot;$mday/$mon&quot;;		print (time - $time &gt; $halfyear) ? &quot;/$year&quot; : &quot;  &quot;$hour:$min&quot;;		print &quot;   $host\n&quot;;}close LASTL;</PRE></DIV><PCLASS="para">This program starts by checking for a command-line argument(the &quot;shift&quot;); if none is present, it uses thedefault. It then calculates the number of seconds in half a year,to be used to determine the format of the output (logins more thansix months in the past are printed differently). Next, it buildsan associative array of <SPANCLASS="acronym">UIDS</SPAN> to login names.</P><PCLASS="para">After this initialization, the program reads a record at atime from the <EMCLASS="emphasis">lastlog</EM> file. Each binary recordis then unpacked and decoded. The stored time is decoded into somethingmore understandable, and then the output is printed.</P><PCLASS="para">While the <EMCLASS="emphasis">lastlog</EM> file is designed toprovide quick access to the last time that a person logged intothe system, it does not provide a detailed history recording theuse of each account. For that, <SPANCLASS="acronym">UNIX</SPAN> uses the<EMCLASS="emphasis">wtmp</EM> log file.<ACLASS="indexterm"NAME="AUTOID-12719"></A><ACLASS="indexterm"NAME="AUTOID-12721"></A><ACLASS="indexterm"NAME="AUTOID-12724"></A><ACLASS="indexterm"NAME="AUTOID-12727"></A><ACLASS="indexterm"NAME="AUTOID-12730"></A><ACLASS="indexterm"NAME="AUTOID-12733"></A></P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-10-SECT-1.2">10.1.2 utmp and wtmp Files</A></H3><PCLASS="para"><SPANCLASS="acronym">UNIX</SPAN><ACLASS="indexterm"NAME="AUTOID-12740"></A><ACLASS="indexterm"NAME="AUTOID-12743"></A><ACLASS="indexterm"NAME="AUTOID-12745"></A><ACLASS="indexterm"NAME="AUTOID-12748"></A><ACLASS="indexterm"NAME="AUTOID-12750"></A><ACLASS="indexterm"NAME="AUTOID-12752"></A><ACLASS="indexterm"NAME="AUTOID-12755"></A><ACLASS="indexterm"NAME="AUTOID-12758"></A>keeps track of who is currently loggedinto the system with a special file called <EMCLASS="emphasis">/etc/utmp</EM>.This is a binary file that contains a record for every active <EMCLASS="emphasis">tty</EM>line, and generally does not grow to be more than a few kilobytesin length (at the most). A second file, <EMCLASS="emphasis">/var/adm/wtmp</EM>,keeps track of both logins and logouts. This file grows every timea user logs in or logs out, and can grow to be many megabytes inlength unless it is pruned.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-12765"></A>In Berkeley-derivedversions of <SPANCLASS="acronym">UNIX</SPAN>, the entries in the <EMCLASS="emphasis">utmp</EM>and <EMCLASS="emphasis">wtmp</EM> files contain:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Name of the terminal device used forlogin</P></LI><LICLASS="listitem"><PCLASS="para">Username</P></LI><LICLASS="listitem"><PCLASS="para">Hostname that the connection originated from, ifthe login was made over a network</P></LI><LICLASS="listitem"><PCLASS="para">Time that the user logged on</P></LI></UL><PCLASS="para">In <ACLASS="indexterm"NAME="AUTOID-12781"></A>SystemV <SPANCLASS="acronym">UNIX</SPAN>, the <ICLASS="systemitem">wtmp</I>file is placed in <EMCLASS="emphasis">/etc/wtmp</EM> and is also usedfor accounting. The AT&amp;T System V.3.2 <EMCLASS="emphasis">utmp</EM>and <EMCLASS="emphasis">wtmp</EM> entries contain:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Username</P></LI><LICLASS="listitem"><PCLASS="para">Terminal line number</P></LI><LICLASS="listitem"><PCLASS="para">Device name</P></LI><LICLASS="listitem"><PCLASS="para">Process ID of the login shell</P></LI><LICLASS="listitem"><PCLASS="para">Code that denotes the type of entry</P></LI><LICLASS="listitem"><PCLASS="para">Exit status of the process</P></LI><LICLASS="listitem"><PCLASS="para">Time that the entry was made</P></LI></UL><PCLASS="para">The extended <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-12806"></A><ACLASS="indexterm"NAME="AUTOID-12808"></A><ACLASS="indexterm"NAME="AUTOID-12811"></A><ACLASS="indexterm"NAME="AUTOID-12813"></A>wtmpx</EM>file used by Solaris, <SPANCLASS="acronym">IRIX</SPAN> and other <SPANCLASS="acronym">SVR4</SPAN><SPANCLASS="acronym">UNIX</SPAN> operating systems, includes the following:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Username (32 characters instead of8)</P></LI><LICLASS="listitem"><PCLASS="para"><EMCLASS="emphasis">inittab</EM> id (indicates the typeof connection; see <ACLASS="xref"HREF="appc_01.htm"TITLE="UNIX Processes">Appendix C, <CITECLASS="appendix">UNIX Processes</CITE></A>)</P></LI><LICLASS="listitem"><PCLASS="para">Terminal name (32 characters instead of 12)</P></LI><LICLASS="listitem"><PCLASS="para">Device name</P></LI><LICLASS="listitem"><PCLASS="para">Process ID of the login shell</P></LI><LICLASS="listitem"><PCLASS="para">Code that denotes the type of entry</P></LI><LICLASS="listitem"><PCLASS="para">Exit status of the process</P></LI><LICLASS="listitem"><PCLASS="para">Time that the entry was made</P></LI><LICLASS="listitem"><PCLASS="para">Session ID</P></LI><LICLASS="listitem"><PCLASS="para">Unused bytes for future expansions</P></LI><LICLASS="listitem"><PCLASS="para">Remote host name (for logins that originated overa network)</P></LI></UL><PCLASS="para"><SPANCLASS="acronym">UNIX</SPAN> programs that report the users thatare currently logged into the system (<EMCLASS="emphasis">who, whodo, w, <ACLASS="indexterm"NAME="AUTOID-12847"></A><ACLASS="indexterm"NAME="AUTOID-12849"></A><ACLASS="indexterm"NAME="AUTOID-12851"></A><ACLASS="indexterm"NAME="AUTOID-12853"></A><ACLASS="indexterm"NAME="AUTOID-12855"></A>users, </EM>and <EMCLASS="emphasis">finger</EM>),do so by scanning the <EMCLASS="emphasis">/etc/utmp</EM> file. The <ICLASS="systemitem">write</I> command checks this fileto see if a user is currently logged in, and determines which terminalhe is.</P><PCLASS="para">The <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-12862"></A>last</EM>program, which prints a detailed report of the times of the mostrecent user logins, does so by scanning the <EMCLASS="emphasis">wtmp</EM>file.</P><PCLASS="para">The <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-12867"></A>ps</EM>command gives you a more accurate account of who is currently usingyour system than the <EMCLASS="emphasis">who</EM>, <EMCLASS="emphasis">whodo</EM>,<EMCLASS="emphasis">users</EM>, and <EMCLASS="emphasis">finger</EM> commandsbecause under some circumstances, users can have processes runningwithout having their usernames appear in the <EMCLASS="emphasis">/etc/utmp</EM>or <EMCLASS="emphasis">/var/adm/wtmp</EM> files. (For example, a usermay have left a program running and then logged out, or used the<EMCLASS="emphasis">rsh</EM> command instead of <EMCLASS="emphasis">rlogin</EM>.)</P><PCLASS="para">However, the commands <EMCLASS="emphasis">who</EM>, <EMCLASS="emphasis">users</EM>,and <EMCLASS="emphasis">finger</EM> have several advantages over <EMCLASS="emphasis">ps</EM>:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">They often present their informationin a format that is easier to read than the <EMCLASS="emphasis">ps</EM>output.</P></LI><LICLASS="listitem"><PCLASS="para">They sometimes contain information not present inthe <EMCLASS="emphasis">ps</EM> output, such as the names of remotehost origins.</P></LI><LICLASS="listitem"><PCLASS="para">They may run significantly faster than <EMCLASS="emphasis">ps</EM>.</P></LI></UL><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> The <ACLASS="indexterm"NAME="AUTOID-12894"></A><ACLASS="indexterm"NAME="AUTOID-12897"></A>permissions on the <ICLASS="filename">/etc/utmp</I>file are sometimes set to be writable by any user on many systems.This is ostensibly to allow various user programs that create windowsor virtual terminals to show the user as &quot;logged&quot;into each window without requiring superuser privileges. Unfortunately,if this file is world-writable, then any user can edit her entryto show a different username or terminal in a <EMCLASS="emphasis">who</EM>listing&nbsp;- or to show none at all. (She can also edit anybodyelse's entry to show whatever she wants!) It also is thesource of an old security hole that keeps reappearing in variousvendors' releases of <SPANCLASS="acronym">UNIX</SPAN>: by changingthe terminal name in this file to that of a sensitive file, an attackercan get system programs that write to user terminals (such as <EMCLASS="emphasis">wall</EM>and <EMCLASS="emphasis">biff</EM>) to overwrite the target with selectedoutput. This can lead to compromise or damage.</P><PCLASS="para">If your system has a mode <EMCLASS="emphasis">-rw-rw-rw-</EM><ICLASS="filename">/etc/utmp</I> file, we recommend that you changeit to remove the write access for nonowners. Then complain to yourvendor for not fixing such an old and well-known flaw.</P></BLOCKQUOTE><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="PUIS-CHP-10-SECT-1.2.1">10.1.2.1 <ACLASS="indexterm"NAME="AUTOID-12909"></A>sucommand and /etc/utmp and /var/adm/wtmpfiles</A></H4><PCLASS="para">When you use the <EMCLASS="emphasis">su</EM> command (see &quot;su:Changing Who You Claim to Be&quot; in <ACLASS="xref"HREF="ch04_01.htm"TITLE="Users, Groups, and the Superuser">Chapter 4, <CITECLASS="chapter">Users, Groups, and the Superuser</CITE></A>), itcreates a new process with both the process's <ICLASS="firstterm">realUID </I>and <ICLASS="firstterm"><ACLASS="indexterm"NAME="AUTOID-12917"></A><ACLASS="indexterm"NAME="AUTOID-12919"></A>effective UID </I>altered.This gives you the ability to access another user's files,and run programs as the other user.</P><PCLASS="para">However, while <EMCLASS="emphasis">su</EM> does not change yourentry in the <ICLASS="filename">/etc/utmp</I> or the <ICLASS="filename">/var/adm/wtmp</I>files, the <EMCLASS="emphasis">finger</EM> command will continueto display the account to which you logged in, not the one thatyou <EMCLASS="emphasis">su</EM>'ed to. Many other programsas well &nbsp;- such as <EMCLASS="emphasis">mail</EM>&nbsp;- maynot work properly when used from within a <EMCLASS="emphasis">su</EM>subshell, as they determine your username from the <EMCLASS="emphasis">/etc/utmp</EM>entry and not from the real or effective <SPANCLASS="acronym">UID</SPAN>.</P><PCLASS="para">Note that different versions of the <EMCLASS="emphasis">su</EM>command have different options available that allow you to resetyour environment, run a different command shell, or otherwise modifythe default behavior. One common argument is a simple dash, as in&quot;<EMCLASS="emphasis">su</EM> - <ICLASS="filename">user</I>&quot;.This form will cause the shell for <ICLASS="filename">user</I> tostart up as if it were a login shell.</P><PCLASS="para">Thus, the <EMCLASS="emphasis">su</EM> command should be used withcaution. While it is useful for quick tests, because it does notproperly update the <EMCLASS="emphasis">utmp</EM> and <EMCLASS="emphasis">wtmp</EM>files, it can cause substantial confusion to other users and tosome system utilities.<ACLASS="indexterm"NAME="AUTOID-12941"></A><ACLASS="indexterm"NAME="AUTOID-12944"></A><ACLASS="indexterm"NAME="AUTOID-12946"></A><ACLASS="indexterm"NAME="AUTOID-12949"></A></P></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-10-SECT-1.3">10.1.3 last Program</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-12955"></A><ACLASS="indexterm"NAME="AUTOID-12957"></A>Everytime a user logs in or logs out, <SPANCLASS="acronym">UNIX</SPAN> makes arecord in the file <EMCLASS="emphasis">wtmp</EM>. The <EMCLASS="emphasis">last</EM>program displays the contents of this file in an understandableform.[4] If you run <EMCLASS="emphasis">last</EM>with no arguments, the command displays all logins and logouts onevery device. <EMCLASS="emphasis">last</EM> will display the entirefile; you can abort the display by pressing the interrupt character(usually <SPANCLASS="acronym">CTRL-C</SPAN>):</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[4] On some SVR4 systems you can use the &quot;<EMCLASS="emphasis">who-a</EM>&quot; command to view the contents of the <EMCLASS="emphasis">wtmp</EM>file Check your documentation to see which command version you woulduse on your system.</P></BLOCKQUOTE><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% lastdpryor    ttyp3    std.com          Sat Mar 11 12:21 - 12:24  (00:02)simsong   ttyp2    204.17.195.43    Sat Mar 11 11:56 - 11:57  (00:00)simsong   ttyp1    204.17.195.43    Sat Mar 11 11:37   still logged indpryor    console                   Wed Mar  8 10:47 - 17:41 (2+06:53)devon     console                   Wed Mar  8 10:43 - 10:47  (00:03)simsong   ttyp3    pleasant.cambrid Mon Mar  6 16:27 - 16:28  (00:01)dpryor    ftp      mac4             Fri Mar  3 16:31 - 16:33  (00:02)dpryor    console                   Fri Mar  3 12:01 - 10:43 (4+22:41)simsong   ftp      pleasant.cambrid Fri Mar  3 08:40 - 08:56  (00:15)simsong   ttyp2    pleasant.cambrid Thu Mar  2 20:08 - 21:08  (00:59)...</PRE></BLOCKQUOTE><PCLASS="para">In this display, you can see that five login sessions havebeen active since March 7th: <EMCLASS="emphasis">simsong</EM>, <EMCLASS="emphasis">dpryor</EM>,<EMCLASS="emphasis">devon</EM>, <EMCLASS="emphasis">dpyror</EM> (again),and <EMCLASS="emphasis">simsong</EM> (again). Two of the users (<EMCLASS="emphasis">dpryor</EM>and <EMCLASS="emphasis">devon</EM>) logged on to the computer console.The main user of this machine is probably the user <EMCLASS="emphasis">dpryor</EM>(in fact, this computer is a workstation sitting on <EMCLASS="emphasis">dpryor</EM>'sdesk.) The terminal name <EMCLASS="emphasis">ftp</EM> indicates that<EMCLASS="emphasis">dpryor</EM> was logged in for <SPANCLASS="acronym">FTP</SPAN>file transfer. Other terminal names may also appear here, dependingon your system type and configuration; for instance, you might havean entry showing <EMCLASS="emphasis">pc-nfs</EM> as an entry type.</P><PCLASS="para">The <EMCLASS="emphasis">last</EM> command allows you to specifya <ACLASS="indexterm"NAME="AUTOID-12987"></A>username or aterminal as an argument to prune the amount of information displayed.If you provide a username, <EMCLASS="emphasis">last</EM> displays loginsand logouts only for that user. If you provide a <ACLASS="indexterm"NAME="AUTOID-12991"></A>terminal name, <EMCLASS="emphasis">last</EM>displays logins and logouts only for the specified terminal:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% last dpryordpryor    ttyp3    std.com          Sat Mar 11 12:21 - 12:24  (00:02)dpryor    console                   Wed Mar  8 10:47 - 17:41 (2+06:53)dpryor    ftp      mac4             Fri Mar  3 16:31 - 16:33  (00:02)dpryor    console                   Fri Mar  3 12:01 - 10:43 (4+22:41)dpryor    ftp      mac4             Mon Feb 27 10:43 - 10:45  (00:01)dpryor    ttyp6    std.com          Sun Feb 26 01:12 - 01:13  (00:01)dpryor    ftp      mac4             Thu Feb 23 14:42 - 14:43  (00:01)dpryor    ftp      mac4             Thu Feb 23 14:20 - 14:25  (00:04)dpryor    ttyp3    mac4             Wed Feb 22 13:04 - 13:06  (00:02)dpryor    console                   Tue Feb 21 09:57 - 12:01 (10+02:04)</PRE></BLOCKQUOTE><PCLASS="para">You may wish to issue the <EMCLASS="emphasis">last</EM> commandevery morning to see if there were unexpected logins during theprevious night.</P><PCLASS="para">On some systems, the <EMCLASS="emphasis">wtmp</EM> file also logs<ACLASS="indexterm"NAME="AUTOID-12999"></A>shutdowns and reboots.</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="PUIS-CHP-10-SECT-1.3.1">10.1.3.1 Pruning the wtmp file</A></H4><PCLASS="para">The <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13005"></A><ACLASS="indexterm"NAME="AUTOID-13007"></A><ACLASS="indexterm"NAME="AUTOID-13009"></A>wtmp</EM>file will continue to grow until you have no space left on yourcomputer's hard disk. For this reason, many vendors includeshell scripts with their <SPANCLASS="acronym">UNIX</SPAN> releases that zerothe <EMCLASS="emphasis">wtmp</EM> file automatically on a regular basis(such as once a week or once a month). These scripts are run automaticallyby the <EMCLASS="emphasis">cron</EM> program.</P><PCLASS="para">For example, many monthly shell scripts contain a statementthat looks like this:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># zero the log filecat /dev/null &gt;/var/adm/wtmp</PRE></BLOCKQUOTE><PCLASS="para">Instead of this simple-minded approach, you may wish to makea copy of the <EMCLASS="emphasis">wtmp</EM> file first, so you'llbe able to refer to logins in the previous month. To do so, youmust locate the shell script that zeros your log file and add thefollowing lines:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># make a copy of the log file and zero the old onerm /var/adm/wtmp.oldln /var/adm/wtmp /var/adm/wtmp.oldcp /dev/null /var/adm/wtmp.nulmv /var/adm/wtmp.nul /var/adm/wtmp</PRE></BLOCKQUOTE><PCLASS="para">Most versions of the <EMCLASS="emphasis">last</EM> command allowyou to specify a file to use other than <EMCLASS="emphasis">wtmp</EM>by using the <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13024"></A>-f</EM>option. For example:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% last -f /var/adm/wtmp.old</PRE></BLOCKQUOTE><PCLASS="para">Some versions of the <EMCLASS="emphasis">last</EM> command donot allow you to specify a different <EMCLASS="emphasis">wtmp</EM> fileto search through. If you need to check this previous copy and youare using one of these systems, you will need to momentarily placethe copy of the <EMCLASS="emphasis">wtmp</EM> file back into its originallocation. For example, you might use the following shell scriptto do the trick:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">#!/bin/shmv /var/adm/wtmp /var/adm/wtmp.realmv /var/adm/wtmp.old /var/adm/wtmplast $*mv /var/adm/wtmp /var/adm/wtmp.oldmv /var/adm/wtmp.real /var/adm/wtmp</PRE></BLOCKQUOTE><PCLASS="para">This approach is not without its problems, however. Any loginsand logouts will be logged to the <ICLASS="firstterm">wtmp.old</I>file while the command is running.<ACLASS="indexterm"NAME="AUTOID-13035"></A><ACLASS="indexterm"NAME="AUTOID-13038"></A><ACLASS="indexterm"NAME="AUTOID-13040"></A><ACLASS="indexterm"NAME="AUTOID-13043"></A><ACLASS="indexterm"NAME="AUTOID-13045"></A></P></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-10-SECT-1.4">10.1.4 loginlog File</A></H3><PCLASS="para">If you are using a <ACLASS="indexterm"NAME="AUTOID-13051"></A><ACLASS="indexterm"NAME="AUTOID-13054"></A><ACLASS="indexterm"NAME="AUTOID-13056"></A><ACLASS="indexterm"NAME="AUTOID-13059"></A>System V-based <ACLASS="indexterm"NAME="AUTOID-13062"></A>versionof <SPANCLASS="acronym">UNIX</SPAN> (including Solaris), you can log <ACLASS="indexterm"NAME="AUTOID-13066"></A>failed login attemptsin a special file called <ICLASS="filename">/var/adm/loginlog</I>.</P><PCLASS="para">To log failed login attempts, you must specifically createthis file with the following sequence of commands:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># touch /var/adm/loginlog# chmod 600 /var/adm/loginlog# chown root /var/adm/loginlog</PRE></BLOCKQUOTE><PCLASS="para">After this file is created, <SPANCLASS="acronym">UNIX</SPAN> will logall failed login attempts to your system. A &quot;failed loginattempt&quot; is defined as a login attempt in which a usertries to log into your system but types a bad password five timesin a row. Normally, System V <SPANCLASS="acronym">UNIX</SPAN> hangs up onthe caller (or disconnects the Telnet connection) after the fifthattempt. If this file exists, <SPANCLASS="acronym">UNIX</SPAN> will alsolog the fact that five bad attempts occurred.</P><PCLASS="para">The contents of the file look like this:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># cat /var/adm/loginlogsimsong:/dev/pts/8:Mon Nov 27 00:42:14 1995simsong:/dev/pts/8:Mon Nov 27 00:42:20 1995simsong:/dev/pts/8:Mon Nov 27 00:42:26 1995simsong:/dev/pts/8:Mon Nov 27 00:42:39 1995simsong:/dev/pts/8:Mon Nov 27 00:42:50 1995#</PRE></BLOCKQUOTE></DIV></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch09_03.htm"TITLE="9.3 A Final Note"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 9.3 A Final Note"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Practical UNIX &amp; Internet Security"><IMGSRC="../gifs/txthome.gif"ALT="Practical UNIX &amp; Internet Security"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_02.htm"TITLE="10.2 The acct/pacct Process Accounting File"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 10.2 The acct/pacct Process Accounting File"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">9.3 A Final Note</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">10.2 The acct/pacct Process Accounting File</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>