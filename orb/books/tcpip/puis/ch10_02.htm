<HTML><HEAD><TITLE>[Chapter 10] 10.2 The acct/pacct Process Accounting File</TITLE><METANAME="DC.title"CONTENT="Practical UNIX &amp; Internet Security"><METANAME="DC.creator"CONTENT="Simson Garfinkel &amp; Gene Spafford"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:07:27Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-148-8"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch10_01.htm"TITLE="10. Auditing and Logging"><LINKREL="prev"HREF="ch10_01.htm"TITLE="10.1 The Basic Log Files"><LINKREL="next"HREF="ch10_03.htm"TITLE="10.3 Program-Specific Log Files"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Practical UNIX &amp; Internet Security"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Practical UNIX &amp; Internet Security"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_01.htm"TITLE="10.1 The Basic Log Files"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 10.1 The Basic Log Files"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 10<BR>Auditing and Logging</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_03.htm"TITLE="10.3 Program-Specific Log Files"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 10.3 Program-Specific Log Files"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="PUIS-CHP-10-SECT-2">10.2 The acct/pacct Process Accounting File</A></H2><PCLASS="para">In addition to logins and logouts, <SPANCLASS="acronym">UNIX</SPAN>can log every single command run by every single user. This specialkind of logging is often called <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13083"></A><ACLASS="indexterm"NAME="AUTOID-13086"></A><ACLASS="indexterm"NAME="AUTOID-13088"></A><ACLASS="indexterm"NAME="AUTOID-13091"></A>process</EM> <EMCLASS="emphasis">accounting</EM>;normally, process accounting is used only in situations where usersare billed for the amount of <SPANCLASS="acronym">CPU</SPAN> time that theyconsume. The <ICLASS="filename">acct </I>or <ICLASS="filename">pacct </I>filecan be used after a break-in to help determine what commands a userexecuted (provided that the log file is not deleted.) This commandcan also be used for other purposes, such as seeing if anyone isusing some old software you wish to delete, or who is playing gameson the fileserver.</P><PCLASS="para">The <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13100"></A><ACLASS="indexterm"NAME="AUTOID-13102"></A>lastcomm</EM> or <EMCLASS="emphasis">acctcom</EM>program displays the contents of this file in a human-readable format:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% lastcommsendmail    F    root     __         0.05 secs Sat Mar 11 13:28mail       S     daemon   __         0.34 secs Sat Mar 11 13:28send             dfr      __         0.05 secs Sat Mar 11 13:28post             dfr      ttysf      0.11 secs Sat Mar 11 13:28sendmail    F    root     __         0.09 secs Sat Mar 11 13:28sendmail    F    root     __         0.23 secs Sat Mar 11 13:28sendmail    F    root     __         0.02 secs Sat Mar 11 13:28anno             dfr      ttys1      0.14 secs Sat Mar 11 13:28sendmail    F    root     __         0.03 secs Sat Mar 11 13:28mail       S     daemon   __         0.30 secs Sat Mar 11 13:28%</PRE></BLOCKQUOTE><PCLASS="para">If you have an intruder on your system and he has not editedor deleted the <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13108"></A><ACLASS="indexterm"NAME="AUTOID-13111"></A><ACLASS="indexterm"NAME="AUTOID-13113"></A>/var/adm/acct</EM>file, <EMCLASS="emphasis">lastcomm</EM> will provide you with a recordof the commands that the intruder used.[5]Unfortunately, <SPANCLASS="acronym">UNIX</SPAN> accounting does not recordthe arguments to the command typed by the intruder, nor the directoryin which the command was executed. Thus, keep in mind that a programnamed <EMCLASS="emphasis">vi</EM> and executed by a potential intrudermight actually be a renamed version of <EMCLASS="emphasis">cc</EM>&nbsp;- youhave no way to tell for certain by examining this log file.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[5] <EMCLASS="emphasis">lastcomm</EM>can work in two ways: by the system administrator to monitor attackers,or by an attacker to see if the administrator is monitoring him.For this reason, some administrators change the permission modeof the log file so that only the superuser can read its contents.</P></BLOCKQUOTE><PCLASS="para">On systems that have even moderate use, the <EMCLASS="emphasis">/var/adm/acct</EM>file grows very quickly&nbsp;- often more than one or two megabytesper day. For this reason, most sites that use accounting run thecommand <EMCLASS="emphasis">sa</EM> or <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13127"></A><ACLASS="indexterm"NAME="AUTOID-13129"></A>runacct</EM> on a nightly basis.The command processes the information in the <EMCLASS="emphasis">acct</EM>or <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13133"></A>pacct</EM> fileinto a summary file, which is often kept in <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13136"></A><ACLASS="indexterm"NAME="AUTOID-13139"></A>/var/adm/savacct</EM>.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-10-SECT-2.1">10.2.1 Accounting with System V</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-13144"></A>On <SPANCLASS="acronym">SVR4</SPAN> systems, you start the accountingwith the <ACLASS="indexterm"NAME="AUTOID-13148"></A>command:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># /usr/lib/acct/startup</PRE></BLOCKQUOTE><PCLASS="para">The accounting file on these systems is usually <ICLASS="filename">/var/adm/pacct</I>and it is read with the <EMCLASS="emphasis">acctcom</EM> command. The<EMCLASS="emphasis">acctcom</EM> command has more than 20 options, andcan provide a variety of interesting summaries. You should checkyour manual entry to become familiar with the possibilities.</P><PCLASS="para">Accounting is performed by the <SPANCLASS="acronym">UNIX</SPAN> kernel.Every time a process terminates, the kernel writes a 32-byte recordto the <EMCLASS="emphasis">/var/adm/acct</EM> file that includes:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Name of the user who ran the command</P></LI><LICLASS="listitem"><PCLASS="para">Name of the command</P></LI><LICLASS="listitem"><PCLASS="para">Amount of <SPANCLASS="acronym">CPU</SPAN> time used</P></LI><LICLASS="listitem"><PCLASS="para">Time that the process exited</P></LI><LICLASS="listitem"><PCLASS="para">Flags, including:</P></LI></UL><TABLECLASS="informaltable"><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"><PCLASS="para">S</P></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Command was executed by the superuser.</P></TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">F</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Command ran after a fork, but withoutan exec.</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">D</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Command generated a core file when itexited.</P></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">X</P></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><PCLASS="para">Command was terminated by signal</P></TD></TR></TBODY></TABLE></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-10-SECT-2.2">10.2.2 Accounting with BSD</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-13197"></A>You can turnon accounting by issuing the <EMCLASS="emphasis">accton</EM> command:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># accton filename</PRE></BLOCKQUOTE><PCLASS="para">Depending on your version of <SPANCLASS="acronym">UNIX</SPAN>, youmay find the <EMCLASS="emphasis">accton</EM> command in <EMCLASS="emphasis">/usr/etc</EM>or in <EMCLASS="emphasis">/usr/lib/acct</EM>. The filenamespecifies where accounting information should be kept. It is typically<EMCLASS="emphasis">/var/adm/acct</EM> or <EMCLASS="emphasis">/var/adm/acct</EM>.The file is read with the <EMCLASS="emphasis">lastcomm</EM> <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13211"></A><ACLASS="indexterm"NAME="AUTOID-13213"></A></EM>command.</P><DIVCLASS="sidebar"><H4CLASS="sidebar"><ACLASS="title"NAME="AUTOID-13215">Back Up Your Logs!</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-13218"></A><ACLASS="indexterm"NAME="AUTOID-13221"></A>Log files are a valuable resource. For this reason,many sites set up jobs in their <EMCLASS="emphasis">crontab</EM> filesto back up the logs every day.</P><PCLASS="para">One way to back up your logs is to back up each log one fileat a time. At one site, seven days worth of the log file <ICLASS="filename">/</I><EMCLASS="emphasis">usr/spool/mqueue/syslog</EM>are automatically kept in the files <EMCLASS="emphasis">syslog.1, syslog.2,syslog.3 ... syslog.7</EM>. Other sites set up shell scriptsthat automatically back up their log files and compress the backups.</P><PCLASS="para">A simple way to back up your log is to have a shell scriptthat runs every night and uses the <EMCLASS="emphasis">tar</EM> commandto archive your entire <EMCLASS="emphasis">/var/adm</EM> directory,then uses the <EMCLASS="emphasis">compress</EM> command to shorten theresulting output file. The following script could run at midnighteach night and make the appropriate backups into <EMCLASS="emphasis">/var/adm.backups</EM>:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">#!/bin/kshBFILE=$(date +backup.%y.%m.%d.tar.Z)cd /var/admtar cf - . | compress &gt; ../adm.backups/$BFILEexit 0</PRE></BLOCKQUOTE></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-10-SECT-2.3">10.2.3 messages Log File</A></H3><PCLASS="para">Many <ACLASS="indexterm"NAME="AUTOID-13238"></A><ACLASS="indexterm"NAME="AUTOID-13240"></A><ACLASS="indexterm"NAME="AUTOID-13243"></A><ACLASS="indexterm"NAME="AUTOID-13246"></A>versionsof <SPANCLASS="acronym">UNIX</SPAN> place a copy of any message printed onthe system console in a file called <ICLASS="filename">/</I><EMCLASS="emphasis">usr/adm/messages</EM>or <EMCLASS="emphasis">/var/adm/messages</EM>. This can be particularlyuseful, as it does not require the use of special software for logging&nbsp;- only a call to <EMCLASS="emphasis">printf</EM> in a C program or an<EMCLASS="emphasis">echo</EM> statement in a shell script.</P><PCLASS="para">Here is a sample of the <EMCLASS="emphasis">/var/adm/messages</EM>file from a computer running SunOS version 4.1:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Mar 14 14:30:58 bolt su: 'su root' succeeded for tanya on /dev/ttyrbMar 14 14:33:59 bolt vmunix: /home: file system fullMar 14 14:33:59 bolt last message repeated 8 timesMar 14 14:33:59 bolt vmunix: /home: file system fullMar 14 14:33:59 bolt last message repeated 16 times</PRE></BLOCKQUOTE><PCLASS="para">As you can see, the computer <ICLASS="filename">bolt</I> ishaving a problem with a filled disk. <EMCLASS="emphasis"><ACLASS="indexterm"NAME="AUTOID-13261"></A><ACLASS="indexterm"NAME="AUTOID-13264"></A><ACLASS="indexterm"NAME="AUTOID-13266"></A></EM></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_01.htm"TITLE="10.1 The Basic Log Files"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 10.1 The Basic Log Files"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Practical UNIX &amp; Internet Security"><IMGSRC="../gifs/txthome.gif"ALT="Practical UNIX &amp; Internet Security"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_03.htm"TITLE="10.3 Program-Specific Log Files"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 10.3 Program-Specific Log Files"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">10.1 The Basic Log Files</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">10.3 Program-Specific Log Files</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>