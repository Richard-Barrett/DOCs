<HTML><HEAD><TITLE>[Chapter 20] 20.2 Server-Side NFS Security</TITLE><METANAME="DC.title"CONTENT="Practical UNIX &amp; Internet Security"><METANAME="DC.creator"CONTENT="Simson Garfinkel &amp; Gene Spafford"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:15:56Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-148-8"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch20_01.htm"TITLE="20. NFS"><LINKREL="prev"HREF="ch20_01.htm"TITLE="20.1 Understanding NFS"><LINKREL="next"HREF="ch20_03.htm"TITLE="20.3 Client-Side NFS Security"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Practical UNIX &amp; Internet Security"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Practical UNIX &amp; Internet Security"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch20_01.htm"TITLE="20.1 Understanding NFS"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 20.1 Understanding NFS"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 20<BR>NFS</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch20_03.htm"TITLE="20.3 Client-Side NFS Security"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 20.3 Client-Side NFS Security"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="PUIS-CHP-20-SECT-2">20.2 Server-Side NFS Security</A></H2><PCLASS="para">Because <SPANCLASS="acronym">NFS</SPAN> allows users on a network toaccess files stored on the server, <SPANCLASS="acronym">NFS</SPAN> has significantsecurity implications for the server. These implications fall intothree broad categories:</P><DLCLASS="variablelist"><DTCLASS="term"><EMCLASS="emphasis">Client access</EM></DT><DDCLASS="listitem"><PCLASS="para"><SPANCLASS="acronym">NFS</SPAN> can (and should) be configuredso that only certain clients on the network can mount filesystemsstored on the server.</P></DD><DTCLASS="term"><EMCLASS="emphasis">User authentication</EM></DT><DDCLASS="listitem"><PCLASS="para"><SPANCLASS="acronym">NFS</SPAN> can (and should) be configuredso that users can only access and alter files to which they havebeen granted access.</P></DD><DTCLASS="term"><EMCLASS="emphasis">Eavesdropping and data spoofing</EM></DT><DDCLASS="listitem"><PCLASS="para"><SPANCLASS="acronym">NFS</SPAN> should (but does not) protectinformation on the network from eavesdropping and surreptitiousmodification.</P></DD></DL><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-20-SECT-2.1">20.2.1 Limiting Client Access: /etc/exportsand /etc/dfs/dfstab</A></H3><PCLASS="para">The <SPANCLASS="acronym">NFS</SPAN> server can be configured so thatonly certain hosts are allowed to mount filesystems on the server.This is a very important step in maintaining server security: ifan unauthorized host is denied the ability to mount a filesystem,then the unauthorized users on that host will not be able to accessthe server's files.</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="PUIS-CHP-20-SECT-2.1.1">20.2.1.1 /etc/exports</A></H4><PCLASS="para">Many versions of <SPANCLASS="acronym">UNIX</SPAN>, including Sun'sSunOS, HP's HP-UX, and <SPANCLASS="acronym">SGI</SPAN>'s<SPANCLASS="acronym">IRIX</SPAN> operating systems use the <ICLASS="filename">/etc/exports</I>file to designate which clients can mount the server'sfilesystem and what access those clients are to be given. Each linein the <ICLASS="filename">/etc/exports</I> file generally has the form:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><BCLASS="emphasis.bold">directory <EMCLASS="emphasis">-options [,more options]</EM></B></PRE></BLOCKQUOTE><PCLASS="para">For example, a sample <ICLASS="filename">/etc/exports</I> filemight look like this:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/ -access=math,root=prose.domain.edu/usr -ro/usr/spool/mail -access=math&#13;</PRE></BLOCKQUOTE><PCLASS="para">The <ICLASS="filename">directory</I> may be any directory or filesystem on your server.In the example, exported directories are <ICLASS="filename">/</I>, <ICLASS="filename">/usr,</I>and <ICLASS="filename">/usr/spool/mail.</I></P><PCLASS="para">The <ICLASS="filename">options</I> allow you to specify a variety of security-relatedoptions for each directory. These include:</P><DLCLASS="variablelist"><DTCLASS="term">access=machinelist</DT><DDCLASS="listitem"><PCLASS="para">Grants access to this filesystem only to the hostsor netgroups[8]specified in <ICLASS="filename">machinelist</I>. The names of hosts and netgroupsare listed and separated by colons (e.g., <ICLASS="filename">host1:host2:group3)</I>. Amaximum of ten hosts or group names can be listed in some oldersystems (check your documentation).[9] <ACLASS="indexterm"NAME="AUTOID-28583"></A><ACLASS="indexterm"NAME="AUTOID-28586"></A></P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[8] See the discussion of RPC and netgroups in Chapter19.</P><PCLASS="para">[9] There was anold bug in NFS that caused a filesystem to be exported to the worldif an exports line exceeded 256 characters after name alias expansion.Use <KBDCLASS="command">showmount -e</KBD> to verify when finished.</P></BLOCKQUOTE></DD><DTCLASS="term">ro</DT><DDCLASS="listitem"><PCLASS="para">Exports the directory and its contents as read-onlyto all clients. This options overrides whatever the file permissionbits are actually set to.</P></DD><DTCLASS="term">rw=machinelist</DT><DDCLASS="listitem"><PCLASS="para">Exports the filesystem read-only to all hosts exceptthose listed, which are allowed read/write access to thefilesystem.<ACLASS="indexterm"NAME="AUTOID-28596"></A></P></DD><DTCLASS="term">root=machinelist</DT><DDCLASS="listitem"><PCLASS="para">Normally, <SPANCLASS="acronym">NFS</SPAN> changes the userID for requests issued by the superuser on remote machines from0 (root) to -2 (nobody.) Specifying a list of hosts givesthe superuser on these remote machines superuser access on the server.<ACLASS="indexterm"NAME="AUTOID-28603"></A></P></DD><DTCLASS="term">anon=uid</DT><DDCLASS="listitem"><PCLASS="para">Specifies what user ID to use on <SPANCLASS="acronym">NFS</SPAN>requests that are not accompanied by a user ID, such as might happenfrom a <SPANCLASS="acronym">DOS</SPAN> client. The number specified is usedfor both the <SPANCLASS="acronym">UID</SPAN> and the <SPANCLASS="acronym">GID</SPAN>of anonymous requests. A value of -2 is the nobody user.A value of -1 usually disallows access. <ACLASS="indexterm"NAME="AUTOID-28613"></A></P></DD><DTCLASS="term">secure</DT><DDCLASS="listitem"><PCLASS="para">Specifies that <SPANCLASS="acronym">NFS</SPAN> should useSun's Secure <SPANCLASS="acronym">RPC</SPAN> (<SPANCLASS="acronym">AUTH_DES</SPAN>)authentication system, instead of <SPANCLASS="acronym">AUTH_UNIX</SPAN>.<ACLASS="indexterm"NAME="AUTOID-28623"></A> (See <ACLASS="xref"HREF="ch19_01.htm"TITLE="RPC, NIS, NIS+,  and Kerberos">Chapter 19, <CITECLASS="chapter">RPC, NIS, NIS+,  and Kerberos</CITE></A>) for more information.</P></DD></DL><PCLASS="para">You should understand that <SPANCLASS="acronym">NFS</SPAN> maintainsoptions on a per-filesystem basis, not per-directory, basis. Ifyou put two directories in the <ICLASS="filename">/etc/exports</I> filethat actually reside on the same filesystem, they will use the sameoptions (usually the options used in the last export listed).</P><PCLASS="para">Sun's documentation of <KBDCLASS="command">anon</KBD> states that, &quot;Ifa request comes from an unknown user, use the given <SPANCLASS="acronym">UID</SPAN>as the effective user ID.&quot; This statement is very misleading;in fact, <SPANCLASS="acronym">NFS</SPAN> by default honors &quot;unknown&quot;user IDs&nbsp;- that is, <SPANCLASS="acronym">UIDS</SPAN> that are notin the server's <ICLASS="filename">/etc/passwd </I><ACLASS="indexterm"NAME="AUTOID-28635"></A>file&nbsp;- in the sameway that it honors &quot;known&quot; <SPANCLASS="acronym">UIDS</SPAN>,because the <SPANCLASS="acronym">NFS</SPAN> server does not ever read thecontents of the <ICLASS="filename">/etc/passwd</I> file. The anon optionactually specifies which <SPANCLASS="acronym">UID</SPAN> to use for <SPANCLASS="acronym">NFS</SPAN>requests that are not accompanied by authentication credentials.</P><PCLASS="para">Let's look at the example <ICLASS="filename">/etc/exports</I>file again:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/ -access=math,root=prose.domain.edu/usr -ro/usr/spool/mail -access=math</PRE></BLOCKQUOTE><PCLASS="para">This example allows anybody in the group <ICLASS="filename">math</I> or on the machine<ICLASS="filename">math</I> to mount the <ICLASS="filename">root</I> directory of the server, but only the <ICLASS="filename">root</I>user on machine <ICLASS="filename">prose.domain.edu</I> has superuser access to these files.The <ICLASS="filename">/usr</I> filesystem is exported read-only to every machinethat can get <SPANCLASS="acronym">RPC</SPAN> packets to and from this server(usually a bad idea &nbsp;-  this may be a wider audience thanthe local network). And the <ICLASS="filename">/usr/spool/mail</I>directory is exported to any host in the math netgroup.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="PUIS-CHP-20-SECT-2.1.2">20.2.1.2 /usr/etc/exportfs</A></H4><PCLASS="para">The <ICLASS="filename">/usr/etc/exportfs</I> program <ACLASS="indexterm"NAME="AUTOID-28660"></A>reads the <ICLASS="filename">/etc/exports</I> fileand configures the <SPANCLASS="acronym">NFS</SPAN> server, which runs insidethe kernel's address space. After you make a change to<ICLASS="filename">/etc/exports, </I><ACLASS="indexterm"NAME="AUTOID-28665"></A><ACLASS="indexterm"NAME="AUTOID-28667"></A>be sure to type this on the server:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># <BCLASS="emphasis.bold">exportfs -a</B></PRE></BLOCKQUOTE><PCLASS="para">You can also use the <KBDCLASS="command">exportfs</KBD> command to temporarily changethe options on a filesystem. Because different versions of the commandhave slightly different syntax, you should consult your documentation.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="PUIS-CHP-20-SECT-2.1.3">20.2.1.3 Exporting NFS directories under System V: share anddfstab</A></H4><PCLASS="para">Versions of <SPANCLASS="acronym">NFS</SPAN> that are present on SystemV systems (including Solaris 2.x) have dispensed with the <ICLASS="filename">/etc/exports</I>file and have instead adopted a more general mechanism for dealingwith many kinds of distributed filesystems in a uniform manner.These systems use a command called <KBDCLASS="command">share</KBD> to extendaccess for a filesystem to a remote machine, and the command <KBDCLASS="command">unshare</KBD> to revoke access.</P><PCLASS="para">The <KBDCLASS="command">share </KBD>command has the syntax:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">share [ -F FSType ] [ -o specific_options ] [ -d description ] [ pathname]</PRE></BLOCKQUOTE><PCLASS="para">where <ICLASS="filename">FSType</I> should be <KBDCLASS="command">nfs</KBD> for <SPANCLASS="acronym">NFS</SPAN> filesystems,and <ICLASS="filename">specific_options</I> are the same as those documented withthe <ICLASS="filename">/etc/exportfs</I> file earlier. The optional argument<ICLASS="filename">description</I> is meant to be a human-readable description of the filesystemthat is being shared.</P><PCLASS="para">When a system using this mechanism boots, its network initializationscripts execute the shell script <ICLASS="filename">/etc/dfs/dfstab</I>.This file contains a list of <KBDCLASS="command">share </KBD>commands.For example:</P><DIVCLASS="example"><H4CLASS="example"><ACLASS="title"NAME="PUIS-CHP-20-EX-1">Example 20.1: An /etc/dfs/dfstab file With Some Problems</A></H4><BLOCKQUOTECLASS="screen"><PRECLASS="screen">#       place share(1M) commands here for automatic execution#       on entering init state 3.##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This configuration is not secure.#share -F nfs -o rw=red:blue:green /cpgshare -F nfs -o rw=clients -d &quot;spool&quot; /var/spoolshare -F nfs /tftpbootshare -F nfs -o ro /usr/lib/X11/ncdshare -F nfs -o ro /usr/openwin&#13;</PRE></BLOCKQUOTE></DIV><PCLASS="para">This file gives the computers <ICLASS="filename">red</I>, blue<ICLASS="filename">,</I> and <ICLASS="filename">green</I> accessto the <ICLASS="filename">/cpg filesystem;</I> it also gives all of the computersin the clients netgroup access to <ICLASS="filename">/var/spool.</I>All computers on the network are given read-write access to the<ICLASS="filename">/tftpboot directory;</I> and all computers on the network aregiven read-only access to the directories <ICLASS="filename">/usr/lib/X11/ncd</I>and <ICLASS="filename">/usr/openwin.</I></P><PCLASS="para">Do you see the security hole in the above configuration? It'sexplained in detail in <ACLASS="xref"HREF="ch20_04.htm"TITLE="Improving NFS Security">Section 20.4, "Improving NFS Security</A>&quot; later in this chapter.</P><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> Do <EMCLASS="emphasis">not</EM> export your filesystemsback to your own machine if your <SPANCLASS="acronym">RPC</SPAN> <ICLASS="filename">portmapper</I>has proxy forwarding enabled (the default in many vendor versions).You should not export your partitions to the local host, eitherby name or to the alias <ICLASS="filename">localhost</I>, and you should not export toany netgroups of which your host is a member. If proxy forwardingis enabled, an attacker can carefully craft <SPANCLASS="acronym">NFS</SPAN>packets and send them to the <KBDCLASS="command">portmapper</KBD>, which in turn forwardsthem to the <SPANCLASS="acronym">NFS</SPAN> server. As the packets come fromthe <KBDCLASS="command">portmapper</KBD> process (which is running as root), they appear tobe coming from a trusted system. This configuration can allow anyoneto alter and delete files at will.</P></BLOCKQUOTE></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-20-SECT-2.2">20.2.2 The showmount Command</A></H3><PCLASS="para">You can use the <SPANCLASS="acronym">UNIX</SPAN> command <ICLASS="filename">/usr/etc/showmount</I>to list all of the clients that have <EMCLASS="emphasis">probably</EM>mounted directories from your server. This command has the form:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/usr/etc/showmount [<ICLASS="filename">options</I>] [host]</PRE></BLOCKQUOTE><PCLASS="para">The <ICLASS="filename">options</I> are:</P><DLCLASS="variablelist"><DTCLASS="term">-a</DT><DDCLASS="listitem"><PCLASS="para">Lists all of the hosts and which directories theyhave mounted.</P></DD><DTCLASS="term">-d</DT><DDCLASS="listitem"><PCLASS="para">Lists only the directories that have been remotelymounted.</P></DD><DTCLASS="term">-e</DT><DDCLASS="listitem"><PCLASS="para">Lists all of the filesystems that are exported;this option is described in more detail later in this chapter.</P></DD></DL><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> The <KBDCLASS="command">showmount</KBD> command does not tellyou which hosts are actually using your exported filesystems; itshows you only the names of the hosts that have mounted your filesystemssince the last reset of the local log file. Because of the designof <SPANCLASS="acronym">NFS</SPAN>, you can use a filesystem without firstmounting it.</P></BLOCKQUOTE><DIVCLASS="sidebar"><H4CLASS="sidebar"><ACLASS="title"NAME="AUTOID-28746">NFS Exports Under Linux</A></H4><PCLASS="para">The Linux <SPANCLASS="acronym">NFS</SPAN> server offers a sophisticatedset of options that can be placed in the <ICLASS="filename">/etc/exports</I>file. While these options seem to increase security, they actuallydon't.</P><PCLASS="para">The options are:</P><DLCLASS="variablelist"><DTCLASS="term">secure</DT><DDCLASS="listitem"><PCLASS="para">This option requires that incoming <SPANCLASS="acronym">NFS</SPAN>requests come from an IP port less than 1024, one of the &quot;secure&quot;ports. This requirement prevents an attacker from sending requestsdirectly to your <SPANCLASS="acronym">NFS</SPAN> server unless the attackerhas obtained superuser access. (Of course, if the attacker has obtained<ICLASS="filename">root</I> access, this option does not help.) This option is equivalentto <SPANCLASS="acronym">NFS</SPAN> port monitoring under other versions of<SPANCLASS="acronym">UNIX</SPAN> (e.g., <ICLASS="filename">nfs_portmon</I> under SunOS).</P></DD><DTCLASS="term">root_squash</DT><DDCLASS="listitem"><PCLASS="para">Forces requests from <SPANCLASS="acronym">UID</SPAN> 0 tobe mapped to the anonymous <SPANCLASS="acronym">UID</SPAN>. Unfortunately,this option does not protect other <SPANCLASS="acronym">UIDS</SPAN>.</P></DD><DTCLASS="term">no_root_squash</DT><DDCLASS="listitem"><PCLASS="para">Turns off root squashing. Even less secure.</P></DD><DTCLASS="term">squash_uids=0-10,20,25-30</DT><DDCLASS="listitem"><PCLASS="para">Allows you to specify other <SPANCLASS="acronym">UIDS</SPAN>that are mapped to the anonymous <SPANCLASS="acronym">UID</SPAN>. Of course,an attacker can still gain access to your system by using non-squashed<SPANCLASS="acronym">UID</SPAN>s.</P></DD><DTCLASS="term">all_squash</DT><DDCLASS="listitem"><PCLASS="para">Specifies that all <SPANCLASS="acronym">UIDS</SPAN> shouldbe mapped to the anonymous <SPANCLASS="acronym">UID</SPAN>. This option doesgenuinely increase your system's security, but why notsimply export your filesystem read-only?</P></DD></DL></DIV></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch20_01.htm"TITLE="20.1 Understanding NFS"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 20.1 Understanding NFS"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Practical UNIX &amp; Internet Security"><IMGSRC="../gifs/txthome.gif"ALT="Practical UNIX &amp; Internet Security"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch20_03.htm"TITLE="20.3 Client-Side NFS Security"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 20.3 Client-Side NFS Security"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">20.1 Understanding NFS</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">20.3 Client-Side NFS Security</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>