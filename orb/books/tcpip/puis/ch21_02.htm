<HTML><HEAD><TITLE>[Chapter 21] 21.2 Building Your Own Firewall</TITLE><METANAME="DC.title"CONTENT="Practical UNIX &amp; Internet Security"><METANAME="DC.creator"CONTENT="Simson Garfinkel &amp; Gene Spafford"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:16:41Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-148-8"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch21_01.htm"TITLE="21. Firewalls"><LINKREL="prev"HREF="ch21_01.htm"TITLE="21.1 What's a Firewall?"><LINKREL="next"HREF="ch21_03.htm"TITLE="21.3 Example: Cisco Systems Routers as Chokes"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Practical UNIX &amp; Internet Security"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Practical UNIX &amp; Internet Security"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_01.htm"TITLE="21.1 What's a Firewall?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 21.1 What's a Firewall?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 21<BR>Firewalls</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_03.htm"TITLE="21.3 Example: Cisco Systems Routers as Chokes"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 21.3 Example: Cisco Systems Routers as Chokes"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="PUIS-CHP-21-SECT-2">21.2 Building Your Own Firewall</A></H2><PCLASS="para">For years,firewalls were strictly a do-it-yourself affair. A big innovationwas the introduction of several firewall toolkits&nbsp;- ready-madeproxies and client programs designed to build a simple, straightforwardfirewall system. Lately, a number of companies have started offeringcomplete firewall &quot;solutions.&quot; </P><PCLASS="para">Todaythere are four basic types of firewalls in use:</P><DLCLASS="variablelist"><DTCLASS="term"><EMCLASS="emphasis">Packet firewalls</EM></DT><DDCLASS="listitem"><PCLASS="para">These firewalls are typically built from routersthat are programmed to pass some types of packets and to block others.</P></DD><DTCLASS="term"><EMCLASS="emphasis">Traditional proxy-based firewalls</EM></DT><DDCLASS="listitem"><PCLASS="para">These firewalls require that users follow specialprocedures or use special network clients that are aware of theproxies.</P></DD><DTCLASS="term"><EMCLASS="emphasis">Packet-rewriting firewalls</EM></DT><DDCLASS="listitem"><PCLASS="para">These firewalls rewrite the contents of the IP packetsas they pass between the internal network and the Internet. Fromthe outside, all communications appear to be mediated through aproxy on the firewall. From the inside network, the firewall istransparent.</P></DD><DTCLASS="term"><EMCLASS="emphasis">Screens</EM></DT><DDCLASS="listitem"><PCLASS="para">These firewalls bisect a single Ethernet with apair of Ethernet interfaces. The screen doesn't have anIP address. Instead, each Ethernet interface listens to all packetsthat are transmitted on its segment and forwards the appropriatepackets, based on a complex set of rules, to the other interfaces.Because the screen does not have an IP address, it is highly resistantto attack over the network. For optimal security, the screen shouldbe programmed through a serial interface or removable media (e.g.,floppy disk), although you can design a screen that would be addressedthrough its Ethernet interface directly (speaking a network protocolother than IP). Some manufacturers of screens provide several networkinterfaces, so that you can set up a <SPANCLASS="acronym">WWW</SPAN> serveror a news server on a separate screened subnet using the same screen.</P></DD></DL><PCLASS="para">In this section, we will discuss the construction of a firewallbuilt from a choke and a gate that uses proxies to move informationbetween the internal network and the external network. We describehow to build this kind of firewall because the tools are readilyavailable, and because this type seems to provide adequate securityfor many applications.</P><PCLASS="para">For additional useful and practicalinformation on constructing your own firewall, we recommend thatyou read <EMCLASS="emphasis">Building Internet Firewalls</EM> by D. Brent Chapman and ElizabethD. Zwicky (O'Reilly &amp; Associates, 1995).</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-21-SECT-2.1">21.2.1 Planning Your Configuration</A></H3><PCLASS="para">Before youstart purchasing equipment or downloading software from the Internetfor your firewall, you might first want to answer some basic questions:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para"><EMCLASS="emphasis">What am I trying to protect?</EM> If youare simply trying to protect two or three computers, you might findthat using host-based security is easier and more effective thangoing to the expense and difficulty of building a full-fledged firewall.</P></LI><LICLASS="listitem"><PCLASS="para"><EMCLASS="emphasis">Do I want to build my own firewall, or buy a ready-madesolution?</EM> Although you could build a very effective firewall, thetask is very difficult and one in which a single mistake can leadto disaster.</P></LI><LICLASS="listitem"><PCLASS="para"><EMCLASS="emphasis">Should I buy a monitored firewall service?</EM> If your organization lacks the expertise to build itsown firewall, or it does not wish to commit the resources to monitora firewall 24 hours a day, 7 days a week, you may find that payingfor a monitored firewall service is an economical alternative. Several<SPANCLASS="acronym">ISPS</SPAN> now offer such services as a value-addedoption to their standard Internet offerings.</P></LI><LICLASS="listitem"><PCLASS="para"><EMCLASS="emphasis">How much money do I want to spend?</EM> You can spenda great deal of money on your own systems, or on a commercial product.Often (but not always) the extra expense may result in a more capablefirewall.</P></LI><LICLASS="listitem"><PCLASS="para"><EMCLASS="emphasis">Is simple packet filtering enough?</EM> If so, you canprobably set up your &quot;firewall&quot; simply by addinga few rules to your existing router's configuration files.</P></LI><LICLASS="listitem"><PCLASS="para"><EMCLASS="emphasis">If simple packet filtering is not enough, do I wanta gate and one choke, or two?</EM></P></LI><LICLASS="listitem"><PCLASS="para"><EMCLASS="emphasis">Will I allow inbound Telnet connections? If so,how will I authenticate them? How will I prevent passwords frombeing sniffed?</EM></P></LI><LICLASS="listitem"><PCLASS="para"><EMCLASS="emphasis">How will I get my users to adhere to the organization'sfirewall policy?</EM></P></LI></UL></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-21-SECT-2.2">21.2.2 Assembling the Parts</A></H3><PCLASS="para">After you have decidedon your configuration, you must then assemble the parts. This assemblyincludes:</P><DLCLASS="variablelist"><DTCLASS="term">Choke </DT><DDCLASS="listitem"><PCLASS="para">Most organizations use a router. You can use anexisting router or purchase a special router for the purpose.</P></DD><DTCLASS="term">Gate </DT><DDCLASS="listitem"><PCLASS="para">Usually, the gate is a spare computer running the<SPANCLASS="acronym">UNIX</SPAN> operating system. Gates do not need to betop-of-the-line workstations, because the speed at which they functionis limited by the speed of your Internet connection, not the speedof your computer's <SPANCLASS="acronym">CPU</SPAN>. In many cases,a high-end PC can provide sufficient capacity for your gate.</P></DD><DTCLASS="term">Software </DT><DDCLASS="listitem"><PCLASS="para">You'll want to get a variety of softwareto run on the gate. Start with a firewall toolkit, such as the onefrom Trusted Information Systems. You should also have a consistency-checkingpackage, such as Tripwire, to help you detect intrusion. Finally,consider using a package such as Tiger to help find security weaknessesin the firewall's <SPANCLASS="acronym">UNIX</SPAN> configuration.</P></DD></DL></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-21-SECT-2.3">21.2.3 Setting Up the Choke</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-29660"></A>The choke is the bridge between the insidenetwork and the outside network. It should not forward packets betweenthe two networks unless the packets have the gate computer as eithertheir destination or their origination address. You can optionallyfurther restrict the choke so that it forwards only packets forparticular protocols&nbsp;- for example, packets used for mailtransfer but not for telnet or rlogin. </P><PCLASS="para">There are threemain choices for your choke: </P><OLCLASS="orderedlist"><LICLASS="listitem"><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-29667"></A>Usean &quot;intelligent router.&quot; Many of these routerscan be set up to forward only certain kinds of packets and onlybetween certain addresses. </P></LI><LICLASS="listitem"><PCLASS="para">You can use a standard <SPANCLASS="acronym">UNIX</SPAN> computerwith two network interfaces. If you do so, do not run the program/usr/etc/routed (the network routingdaemon) on this computer. Set up the program so that it does notforward packets from one network interface to the other (usuallyby setting the kernel ip forwarding variable to 0).[7]A computer set up in this fashion is both the choke and the gate.&#13;</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[7] OnLinux, IP forwarding is a compile-time option. </P></BLOCKQUOTE></LI><LICLASS="listitem"><PCLASS="para">You can alter your operating system's networkdriver so that it only accepts packets from the internal networkand the choke. If you are running Linux, you can use the operatingsystem's kernel-based IP filtering, accessible throughthe <KBDCLASS="command">ipfw</KBD> command, to prevent the system fromreceiving packets from non-approved networks or hosts. In the nottoo distant future, other vendors may offer similar features.</P></LI></OL><PCLASS="para">The details of how you set up your choke will vary greatly,depending on the hardware you use and that hardware's software.Therefore, the following sections are only general guidelines.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-21-SECT-2.4">21.2.4 Choosing the Choke's Protocols</A></H3><PCLASS="para">Thechoke is an intelligent filter: it is usually set up so that onlythe gate machine can talk to the outside world. All messages fromthe outside (whether they're mail, <SPANCLASS="acronym">FTP</SPAN>,or attempts to break in) that are directed to internal machinesother than the gate are rejected. Attempts by local machines tocontact sites outside the <SPANCLASS="acronym">LAN</SPAN> are similarly denied.&#13;</P><PCLASS="para">The gate determines destinations, then handles requestsor forwards them as appropriate. For instance, <SPANCLASS="acronym">SMTP</SPAN>(mail) requests can be sent to the gate, which resolves local aliasesand then sends the mail to the appropriate internal machine. </P><PCLASS="para">Furthermore, you can set up your choke so that only specifickinds of messages are sent through. You should configure the choketo reject messages using unknown protocols. You can also configurethe choke to specifically reject known protocols that are too dangerousfor people in the outside world to use on your internal computers.&#13;</P><PCLASS="para">The choke software should carefully examine the optionbits that might be set in the header of each IP packet. Option bits,such as those for IP forwarding, fragmentation, and route recording,may be valid on some packets. However, they are sometimes set byattackers in an attempt to probe the state of your firewall or toget packets past a simple choke. Other options, such as source routing,are never acceptable; packets that specify them should be blocked.</P><PCLASS="para">You also want to configure the choke to examine the returnaddresses (source addresses) on packets. Packets from outside yournetwork should not state source addresses from inside your network,nor should they be broadcast or multicast addresses. Otherwise,an attacker might be able to craft packets that look normal to yourchoke and clients; in such cases, the responses to these packetsare what actually do the damage.</P><PCLASS="para">The choke can alsobe configured to prevent local users from connecting to outsidemachines through unrestricted channels. This type of configurationprevents Trojan-horse programs from installing network back doorson your local machines. Imagine a public domain data-analysis programthat surreptitiously listens on port 49372 for connections and thenforks off a /bin/csh. The configuration also discouragessomeone who does manage to penetrate one of your local machinesfrom sending information back to the outside world. </P><PCLASS="para">Ideally,there should be no way to change your choke's configurationfrom the network. An attacker trying to tap into your network willbe stuck if your choke is a PC-based router that can be reprogrammedonly from its keyboard.</P><BLOCKQUOTECLASS="note"><PCLASS="para"><STRONG>NOTE:</STRONG> The way you configure your choke will depend on theparticular router that you are using for a choke; consult your router'sdocumentation for detail. </P></BLOCKQUOTE></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_01.htm"TITLE="21.1 What's a Firewall?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 21.1 What's a Firewall?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Practical UNIX &amp; Internet Security"><IMGSRC="../gifs/txthome.gif"ALT="Practical UNIX &amp; Internet Security"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_03.htm"TITLE="21.3 Example: Cisco Systems Routers as Chokes"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 21.3 Example: Cisco Systems Routers as Chokes"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">21.1 What's a Firewall?</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">21.3 Example: Cisco Systems Routers as Chokes</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>