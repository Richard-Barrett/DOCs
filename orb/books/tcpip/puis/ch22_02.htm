<HTML><HEAD><TITLE>[Chapter 22] 22.2 sendmail (smap/smapd) Wrapper</TITLE><METANAME="DC.title"CONTENT="Practical UNIX &amp; Internet Security"><METANAME="DC.creator"CONTENT="Simson Garfinkel &amp; Gene Spafford"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T00:17:07Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-148-8"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch22_01.htm"TITLE="22. Wrappers and Proxies"><LINKREL="prev"HREF="ch22_01.htm"TITLE="22.1 Why Wrappers?"><LINKREL="next"HREF="ch22_03.htm"TITLE="22.3 tcpwrapper"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="Practical UNIX &amp; Internet Security"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="Practical UNIX &amp; Internet Security"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_01.htm"TITLE="22.1 Why Wrappers?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.1 Why Wrappers?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 22<BR>Wrappers and Proxies</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_03.htm"TITLE="22.3 tcpwrapper"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.3 tcpwrapper"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="PUIS-CHP-22-SECT-2">22.2 sendmail (smap/smapd) Wrapper</A></H2><PCLASS="para">The<SPANCLASS="acronym">TIS</SPAN>[1] Firewall Toolkit eliminatesmany of the security problems of <KBDCLASS="command">sendmail</KBD> bygoing to the heart of the problem and breaking the connection betweensendmail and the outside world. Instead of having a single <SPANCLASS="acronym">SUID</SPAN>program (<KBDCLASS="command">sendmail</KBD>) listen for connections on port 25, implementa complex command set, and deliver mail into users' mailboxes,the <SPANCLASS="acronym">TIS</SPAN> package uses a pair of programs&nbsp;- oneto accept mail from the network, and one to deliver it.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[1] Trusted Information Systemsis a company that develops and sells a variety of security productsand services. The Firewall Toolkit was largely written by a formeremployee, Marcus Ranum, and made available to the UNIX communityfor royalty-free use.</P></BLOCKQUOTE><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-22-SECT-2.1">22.2.1 What smap and smapd Do</A></H3><PCLASS="para">The <KBDCLASS="command">sendmail</KBD> wrapperprograms provide the following functions:</P><DLCLASS="variablelist"><DTCLASS="term"><ICLASS="filename">smap</I></DT><DDCLASS="listitem"><PCLASS="para">This program accepts messages over the network andwrites them into a special disk directory for future delivery. Althoughthe <ICLASS="filename">smap</I> program runs as <ICLASS="filename">root</I>, it executes in a specially designed<KBDCLASS="command">chroot</KBD> filesystem, from which it cannot damage the rest of the operatingsystem. The daemon is designed to be invoked from <KBDCLASS="command">inetd</KBD> and exitswhen the mail delivery session is completed. The program logs all<SPANCLASS="acronym">SMTP</SPAN> envelope information.</P></DD><DTCLASS="term"><ICLASS="filename">smapd</I></DT><DDCLASS="listitem"><PCLASS="para">This program periodically scans the directory where<KBDCLASS="command">smap</KBD> delivers mail. When it finds completed messages, it deliversthem to the appropriate user's mail file using <KBDCLASS="command">sendmail</KBD>or some other program.</P></DD></DL><PCLASS="para">The <SPANCLASS="acronym">TIS</SPAN> Firewall Toolkit stores configurationand permission information in a single file&nbsp;- usually <ICLASS="filename">/usr/local/etc/netperm-table.</I> Naturally, this file should be writable only by the superuser.For added security, set it to mode 600.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-22-SECT-2.2">22.2.2 Getting smap/smapd</A></H3><PCLASS="para">You can obtainthe <SPANCLASS="acronym">TIS</SPAN> Firewall Toolkit from the computer <ACLASS="systemitem.ftpserver"HREF="ftp://ftp.tis.com">ftp.tis.com</A> using anonymous<SPANCLASS="acronym">FTP</SPAN>.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-22-SECT-2.3">22.2.3 Installing the TIS smap/smapdsendmail Wrapper</A></H3><PCLASS="para">Installation of the complete <SPANCLASS="acronym">TIS</SPAN>Firewall Toolkit can be quite complex. Fortunately, the <KBDCLASS="command">sendmail</KBD>wrapper programs can be installed without the rest of the kit. The<KBDCLASS="command">sendmail</KBD> wrapper can be used to protect any machine that runs <KBDCLASS="command">sendmail</KBD>,even if that machine is not a firewall.</P><PCLASS="para">To install the<KBDCLASS="command">sendmail</KBD> wrapper, follow these steps:</P><OLCLASS="orderedlist"><LICLASS="listitem"><PCLASS="para">Obtain the <SPANCLASS="acronym">TIS</SPAN> FirewallToolkit from <ACLASS="systemitem.ftpserver"HREF="ftp://ftp.tis.com">ftp.tis.com</A>.</P></LI><LICLASS="listitem"><PCLASS="para">Read the documentation and compile the <KBDCLASS="command">sendmail</KBD>wrapper.</P></LI><LICLASS="listitem"><PCLASS="para">Install the <ICLASS="filename">netperm-table</I> configurationfile. The default location for the file is <ICLASS="filename">/usr/local/etc/netperm-table</I>.</P></LI><LICLASS="listitem"><PCLASS="para">Edit the <ICLASS="filename">smap</I> and <ICLASS="filename">smapd</I> rules to specify the <SPANCLASS="acronym">UID</SPAN>under which you want smap to run, where you want the spooled mailkept, where the executable is stored, where your <ICLASS="filename">sendmail</I> program is located, and where you want mail to go ifit can't be delivered for any reason.[2]In this example, we use uid 5, which corresponds to the user <ICLASS="systemitem">mail </I>in our <ICLASS="filename">/etc/passwd</I>file.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[2] Ifyou do set the undelivered mail directory, be sure to check it regularly.</P></BLOCKQUOTE><PCLASS="para">For example:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">smap, smapd:    userid 5smap, smapd:    directory /var/spool/smapsmapd:          executable /usr/local/etc/smapdsmapd:          sendmail /usr/lib/sendmailsmapd:          baddir /var/spool/smap/badsmap:           timeout 3600</PRE></BLOCKQUOTE></LI><LICLASS="listitem"><PCLASS="para">Create the <ICLASS="filename">smap</I> mail-spool directory (e.g. <ICLASS="filename">/usr/spool/smap</I>).Set the ownership of this directory to be the user specified inthe configuration file:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># chown 5 /usr/spool/smap# chmod 700 usr/spool/smap</PRE></BLOCKQUOTE><PCLASS="para">Also,create the <ICLASS="filename">smap</I> bad mail directory (e.g., <ICLASS="filename">/usr/spool/smap/bad</I>).Set the ownership of the directory to be the user specified in theconfiguration file.</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># chown 5 /usr/spool/smap /usr/spool/smap/bad# chmod 700 /usr/spool/smap /usr/spool/smap/bad</PRE></BLOCKQUOTE></LI><LICLASS="listitem"><PCLASS="para">Search your system's start-up files forthe line in which sendmail is started with the <ICLASS="filename">-bd</I> flag, and thenremove the flag. This change will prevent <KBDCLASS="command">sendmail</KBD> from listeningto port 25 for incoming <SPANCLASS="acronym">SMTP</SPAN> connections, but<KBDCLASS="command">sendmail</KBD> will continue its job of attempting to deliver all of themessages in the mail queue on a periodic basis. Note that theremay not be any such line: your system might be configured to run<KBDCLASS="command">sendmail</KBD> from the <KBDCLASS="command">inetd</KBD> as mail arrives.</P><PCLASS="para">For example,if your configuration file has this:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># Remove junk from the outbound mail queue directory and start up# the sendmail daemon. /usr/spool/mqueue is assumed here even though# it can be changed in the sendmail configuration file.## Any messages which end up in the queue, rather than being delivered# or forwarded immediately, will be processed once each hour.if [ -f /usr/lib/sendmail ]; then        (cd /usr/spool/mqueue; rm -f nf* lf*)        /usr/lib/sendmail -bd -q1h 2&gt;/dev/console &amp;&amp; \                (echo -n ' sendmail')   &gt;/dev/consolefi</PRE></BLOCKQUOTE><PCLASS="para">Change it to this:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">if [ -f /usr/lib/sendmail ]; then        (cd /usr/spool/mqueue; rm -f nf* lf*)        /usr/lib/sendmail -q1h 2&gt;/dev/console &amp;&amp; \                (echo -n ' sendmail')   &gt;/dev/consolefi</PRE></BLOCKQUOTE><PCLASS="para">Alternatively, you can use cron to invoke <KBDCLASS="command">sendmail</KBD> on a periodicbasis with the <ICLASS="filename">-q</I> option, by placing the following line in your<ICLASS="filename">crontab</I> file:[3]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[3] Note that differentversions of <ICLASS="filename">crontab</I> may have slightly different syntax.</P></BLOCKQUOTE><BLOCKQUOTECLASS="screen"><PRECLASS="screen">30 * * * * /usr/lib/sendmail -q &gt;/dev/null 2&gt;&amp;1</PRE></BLOCKQUOTE></LI><LICLASS="listitem"><PCLASS="para">Kill the sendmail <KBDCLASS="command">daemon</KBD> if it is running.</P></LI><LICLASS="listitem"><PCLASS="para">Modify your <ICLASS="filename">sendmail.cf</I> fileso that the <ICLASS="systemitem">mail</I> useris a trusted user. You need to do this so that <ICLASS="filename">sendmail</I>will respect the &quot;From:&quot; address that <ICLASS="filename">smapd</I>sets. The trusted user is set with the &quot;T&quot; flag.This example sets <ICLASS="systemitem">root</I>,<ICLASS="systemitem">daemon</I>, <KBDCLASS="command">uucp</KBD>, and <KBDCLASS="command">mail</KBD>as trusted users.</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">####################  Trusted users  ##################### this is equivalent to setting class &quot;t&quot;# Ft/etc/sendmail.ctTrootTdaemonTuucpTmail</PRE></BLOCKQUOTE></LI><LICLASS="listitem"><PCLASS="para">Edit your <ICLASS="filename">/etc/inetd.conf</I> fileby inserting this line so that <ICLASS="filename">smap</I> is startedwhen connections are attempted on port 25:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen">smtp    stream  tcp     nowait  root    /usr/local/etc/smap     smap</PRE></BLOCKQUOTE></LI><LICLASS="listitem"><PCLASS="para">Cause <KBDCLASS="command">inetd</KBD> to reread its initialization file bysending it a <SPANCLASS="acronym">HUP</SPAN> signal:</P><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># <BCLASS="emphasis.bold">ps aux | grep inetd</B>root       129   0.0  1.8 1.52M  296K ?  S     0:00  (inetd)root      1954   0.0  1.3 1.60M  208K p5 S     0:00 grep inetd# <BCLASS="emphasis.bold">kill -HUP 129</B>#</PRE></BLOCKQUOTE></LI><LICLASS="listitem"><PCLASS="para">Test to see if <KBDCLASS="command">smap</KBD> is receiving mail by tryingto send mail to the <ICLASS="filename">root</I> account. You can do this with <KBDCLASS="command">telnet</KBD>:[4]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[4] Of course, replace <ICLASS="filename">bigco.com </I>with yourown computer's hostname.</P></BLOCKQUOTE><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># <BCLASS="emphasis.bold">telnet localhost smtp</B>Trying 127.0.0.1... Connected to localhost.Escape character is &quot;^]&quot;.220 BIGCO.COM SMTP/smap Ready.<BCLASS="emphasis.bold">helo bigco.com</B>250 (bigco.com) pleased to meet you.<BCLASS="emphasis.bold">mail From:&lt;root@bigco.com&gt;</B>250 &lt;root@bigco.com&gt;... Sender Ok<BCLASS="emphasis.bold">rcpt To:&lt;root@bigco.com&gt;</B>250 &lt;root@bigco.com&gt; OK<BCLASS="emphasis.bold">data</B>354 Enter mail, end with &quot;.&quot; on a line by itself<BCLASS="emphasis.bold">This is a test.</B>.250 Mail accepted<BCLASS="emphasis.bold">quit</B>221 Closing connectionConnection closed by foreign host.#</PRE></BLOCKQUOTE></LI><LICLASS="listitem"><PCLASS="para">Check to see if the mail has, in fact, been putinto the <ICLASS="filename">/var/spool/smap</I> directory (orwhichever directory you specified.)</P></LI><LICLASS="listitem"><PCLASS="para">Install <KBDCLASS="command">smapd</KBD> in <ICLASS="filename">/usr/local/etc/smapd</I>or another suitable directory.</P></LI><LICLASS="listitem"><PCLASS="para">Start <KBDCLASS="command">smapd</KBD> by hand and see if the mail is delivered.</P></LI><LICLASS="listitem"><PCLASS="para">Modify your system's start-up files sothat <KBDCLASS="command">smapd</KBD> is run automatically at system start up.</P></LI></OL></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="PUIS-CHP-22-SECT-2.4">22.2.4 Possible Drawbacks</A></H3><PCLASS="para">There are some drawbacksto using the <KBDCLASS="command">smap</KBD> program as described earlier.The first is that people who are contacting your site on <SPANCLASS="acronym">TCP</SPAN>port 25 will no longer be able to execute the <SPANCLASS="acronym">VRFY</SPAN>or <SPANCLASS="acronym">EXPN</SPAN> <SPANCLASS="acronym">SMTP</SPAN> commands thatare supported by regular <KBDCLASS="command">sendmail</KBD>. (Actually,they will be able to execute them, but nothing useful will be returned.)These commands allow a remote client to verify that an address islocal to a machine (<SPANCLASS="acronym">VRFY</SPAN>) and to expand an alias(<SPANCLASS="acronym">EXPN</SPAN>). Arguably, these are possible securityrisks, but in some environments they are useful (as we illustratein Chapter 24, <EMCLASS="emphasis">Discovering a Break-in</EM>).</P><DIVCLASS="sidebar"><H4CLASS="sidebar"><ACLASS="title"NAME="PUIS-CHP-22-SB-1">Using identd</A></H4><PCLASS="para">Most network servers log the hostname of the client machinethat initiates the connection. Unfortunately, this is frequentlynot enough information. Consider what happens when someone uses<KBDCLASS="command">telnet</KBD> to connect to your machine to forge email.You may have very little hope of identifying the perpetrator otherthan knowing the address of the machine that originated the connection.If that machine has typical logging or supports a large number ofusers, even the cooperation of the administrators of that machinemay not be sufficient to trace the attack back to the perpetrator.</P><PCLASS="para">It is because of this situation that the <KBDCLASS="command">ident</KBD>protocol was defined (in <SPANCLASS="acronym">RFC</SPAN> 1413). The <ICLASS="filename">ident</I> protocol is a service that can <EMCLASS="emphasis">possibly</EM>determine the identity of a user at the other end of a network connection.When a remote client connects to a server machine, the server canopen a connection back to an <KBDCLASS="command">ident</KBD> server onthe client machine. The client machine presents the <KBDCLASS="command">ident</KBD>server with the port numbers of the connection it wishes to identify.The ident server then responds with some value that can be usedlater, if needed, to identify the originating account. Normally,this string is the username associated with that account. However,the administrator of the remote machine may wish to configure itto return some other value that can be used later but that doesnot explicitly name a user. For example, it could return an encryptedusername.</P><PCLASS="para">Note that <KBDCLASS="command">identd</KBD> is most definitely <EMCLASS="emphasis">not</EM>a form of authentication. At best, it is a weak form of identification.The remote server may not return useful information if the servicehas been compromised. It also depends on the remote site administratorhaving installed an unmodified and working <KBDCLASS="command">ident</KBD>server&nbsp;- and many people do not. Some people believe thatbecause <KBDCLASS="command">ident</KBD> cannot be trusted, they will not allow it to returnany useful information at all, so they configure their server toalways return &quot;Hillary Clinton&quot; or &quot;BillGates.&quot; However, in most instances, returning valid informationis helpful. In many university environments, for instance, wherethe <KBDCLASS="command">ident</KBD> servers are usually monitored and undercentral administrative control, using <KBDCLASS="command">ident</KBD> totag users who forge email is especially helpful.</P><PCLASS="para">Totake advantage of <KBDCLASS="command">ident</KBD>, your software needs to know how to querythe remote server, if it exists. It then needs to log that informationappropriately. Modern versions of <KBDCLASS="command">sendmail</KBD> havethis built in, to help cut down on mail forging. The <KBDCLASS="command">tcpwrapper</KBD>program also knows how to query <KBDCLASS="command">ident</KBD>.</P><PCLASS="para">Keepin mind that if you record information from an <KBDCLASS="command">ident</KBD>server, it may not be correct. In fact, if you are investigatinga problem that is actually being caused by the system administratorof the remote system, he or she may have altered the <KBDCLASS="command">ident</KBD>service. The service may thus return information designed to throwyou off by pointing at someone else.</P><PCLASS="para">Currently, <KBDCLASS="command">identd</KBD>is shipped standard with few systems. For example, it is shippedwith Linux, but is not usually enabled in the <ICLASS="filename">/etc/inetd.conf</I>file.</P></DIV><PCLASS="para">A more serious shortcoming is that versionsof <KBDCLASS="command">sendmail</KBD> with built-in support for the <KBDCLASS="command">ident </KBD>protocolwill no longer be able to obtain information about the sending user.The use of the <KBDCLASS="command">ident</KBD> protocol is discussed in <ACLASS="xref"HREF="ch22_02.htm#PUIS-CHP-22-SB-1"TITLE="Using identd">the sidebar "Using identd"</A>.</P><PCLASS="para">If using <KBDCLASS="command">ident</KBD> makes sense in your environment, youwon't be able to use it with <KBDCLASS="command">smap</KBD> unless you spawn <KBDCLASS="command">smap</KBD>from another wrapper that implements <ICLASS="filename">ident</I>,such as the <KBDCLASS="command">tcpwrapper</KBD> program, which is described in the next section.</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_01.htm"TITLE="22.1 Why Wrappers?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.1 Why Wrappers?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="Practical UNIX &amp; Internet Security"><IMGSRC="../gifs/txthome.gif"ALT="Practical UNIX &amp; Internet Security"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_03.htm"TITLE="22.3 tcpwrapper"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.3 tcpwrapper"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">22.1 Why Wrappers?</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">22.3 tcpwrapper</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>