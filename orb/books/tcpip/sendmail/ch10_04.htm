<HTML><HEAD><TITLE>[Chapter 10] 10.4 Nested Angle Brackets</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T18:36:19Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch10_01.htm"TITLE="10. Rule Set 3"><LINKREL="prev"HREF="ch10_03.htm"TITLE="10.3 Missing Addresses"><LINKREL="next"HREF="ch10_05.htm"TITLE="10.5 Details of Rule Flow"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_03.htm"TITLE="10.3 Missing Addresses"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 10.3 Missing Addresses"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 10<BR>Rule Set 3</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_05.htm"TITLE="10.5 Details of Rule Flow"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 10.5 Details of Rule Flow"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-10-SECT-4">10.4 Nested Angle Brackets</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-5839"></A><ACLASS="indexterm"NAME="AUTOID-5842"></A><ACLASS="indexterm"NAME="AUTOID-5845"></A><ACLASS="indexterm"NAME="AUTOID-5848"></A>Another kind of address that can cause problems is one containingnested angle brackets. These occur because of bugs in MUAs.[2]For example, consider the following address:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[2] Also because RFC733 misspecified angle bracket use.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">&lt;a&lt;b&gt;c&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">&#13;Run sendmail in rule-testing mode, using the current <EMCLASS="emphasis">client.cf</EM>file and give the nested address shown above to rule set 3:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">&gt; <CODECLASS="userinput"><B>3 &lt;a&lt;b&gt;c&gt;</B></CODE>rewrite: ruleset  3   input: &lt; a &lt; b &gt; c &gt;rewrite: ruleset  3 returns: a &lt; b</PRE></BLOCKQUOTE></P><PCLASS="para">&#13;Clearly, this is wrong. The correct address should have been <CODECLASS="literal">b</CODE>,the address inside the innermost of the nested angle brackets.The rule that caused the mistake is this one:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$* &lt; $* &gt; $*       $2                      basic RFC822 parsing</PRE></BLOCKQUOTE></P><PCLASS="para">And here is why:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><ICLASS="lineannotation">workspace                   LHS</I>                 $*       <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> match zero or more</I>&lt;                &lt;        <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> match exactly              </I>a                $*       <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> match zero</I>&lt;                         <ICLASS="lineannotation"><IMGSRC="../chars/darr.gif"ALT="-v">    or more</I>b&gt;                &gt;        <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> match exactly</I>c                $*       <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> match zero</I>&gt;                         <ICLASS="lineannotation"><IMGSRC="../chars/darr.gif"ALT="-v">    or more</I></PRE></BLOCKQUOTE></P><PCLASS="para">Because the workspace is scanned left to right, the second <CODECLASS="literal">&lt;</CODE>is not seen as anything special. That is, there is no concept inthis rule of innermost and outermost angle brackets pairs.</P><PCLASS="para">To handle nested angle brackets, another rule needs to be designed.[3]That new rule looks like this:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[3] In <ACLASS="xref"HREF="ch29_01.htm"TITLE="Rule Sets">Chapter 29, <CITECLASS="chapter">Rule Sets</CITE></A>,we show a rule that de-nests a nearly unlimitednumber of angle brackets.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$* &lt; $* &lt; $* &gt; $* &gt; $*   $2&lt;$3&gt;$4                de-nest brackets</PRE></BLOCKQUOTE></P><PCLASS="para">This new rule matches any address in the workspace that containsnested brackets. Using the count of LHS operators, the RHS stripsaway the outermost layer:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$* &lt; $* &lt; $* &gt; $* &gt; $*   $2&lt;$3&gt;$4                de-nest brackets <IMGSRC="../chars/uarr.gif"ALT="-^">    <IMGSRC="../chars/uarr.gif"ALT="-^">    <IMGSRC="../chars/uarr.gif"ALT="-^">    <IMGSRC="../chars/uarr.gif"ALT="-^">    <IMGSRC="../chars/uarr.gif"ALT="-^"> <EMCLASS="emphasis">$1   $2   $3   $4   $5</EM></PRE></BLOCKQUOTE></P><PCLASS="para">To test this new rule, add it to the <EMCLASS="emphasis">client.cf</EM> file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">S3 # preprocessing for all rule setsR$* &lt;&gt; $*           $n                      handle &lt;&gt; error address<CODECLASS="userinput"><B>R$* &lt; $* &lt; $* &gt; $* &gt; $*     $2&lt;$3&gt;$4        de-nest brackets          </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> new</I>R$* &lt; $* &gt; $*       $2                      basic RFC822 parsing</PRE></BLOCKQUOTE></P><PCLASS="para">&#13;Run <EMCLASS="emphasis">sendmail</EM> again to test this new rule:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">&gt; <CODECLASS="userinput"><B>3 &lt;a&lt;b&gt;c&gt;</B></CODE>rewrite: ruleset  3   input: &lt; a &lt; b &gt; c &gt;rewrite: ruleset  3 returns: b</PRE></BLOCKQUOTE></P><PCLASS="para">As predicted, the second rule de-nested, thus allowing the thirdrule to isolate the address part.</P><PCLASS="para">Using what you have learned so far, predict how <EMCLASS="emphasis">sendmail</EM> willhandle this address:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">&lt;&lt;&lt;a&gt;&gt;&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">Feed it to <EMCLASS="emphasis">sendmail</EM> in rule-testing mode to see whether you arecorrect. Remember that <EMCLASS="emphasis">sendmail</EM> performs minimum matching.</P><PCLASS="para">As a general motto when designing your own rule sets, be liberalin what you accept (including addresses such as <EMCLASS="emphasis">&lt;&lt;&lt;a&gt;&gt;&gt;</EM>),but conservative in what you create (never send out such uglyaddresses).[4]&#13;</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[4] Paraphrased from <EMCLASS="emphasis">The Robustness Principle</EM>, RFC793, TCP specification.Jon Postel, Ed.</P></BLOCKQUOTE></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_03.htm"TITLE="10.3 Missing Addresses"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 10.3 Missing Addresses"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_05.htm"TITLE="10.5 Details of Rule Flow"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 10.5 Details of Rule Flow"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">10.3 Missing Addresses</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">10.5 Details of Rule Flow</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>