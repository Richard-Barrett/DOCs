<HTML><HEAD><TITLE>[Chapter 11] 11.4 Rule Set Hubset</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T18:36:37Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch11_01.htm"TITLE="11. Rule Sets 1 and S="><LINKREL="prev"HREF="ch11_03.htm"TITLE="11.3 All Mail from the Hub"><LINKREL="next"HREF="ch11_05.htm"TITLE="11.5 Testing So Far"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_03.htm"TITLE="11.3 All Mail from the Hub"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 11.3 All Mail from the Hub"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 11<BR>Rule Sets 1 and S=</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_05.htm"TITLE="11.5 Testing So Far"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 11.5 Testing So Far"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-11-SECT-4">11.4 Rule Set Hubset</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-11-IX-HUBSET-RULE-SET"></A><ACLASS="indexterm"NAME="SML2-CH-11-IX-RULE-SETS-HUBSET"></A>Place the following new rule after rule set 3 in the <EMCLASS="emphasis">client.cf</EM>file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">S3 # preprocessing for all rule setsR$* &lt;&gt; $*                    $n             handle &lt;&gt; error addressR$* &lt; $* &lt; $* &gt; $* &gt; $*      $2&lt;$3&gt;$4       de-nest bracketsR$* &lt; $* &gt; $*                $2             basic RFC822 parsing<CODECLASS="userinput"><B>SHubset # Rewrite the sender for the hub                     </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> new</I></PRE></BLOCKQUOTE></P><PCLASS="para">At this point you may be wondering why we can give this rule seta symbolic name, when the earlier rule sets (0 and 3)had numeric names. The answer lies inside <EMCLASS="emphasis">sendmail</EM>. Recall thatrule set numbers 0 through 5 have special internal meaning to<EMCLASS="emphasis">sendmail</EM>. Part of that meaning is their names.The <EMCLASS="emphasis">sendmail</EM> program recognizes those special rules only by number.If you were to give them names instead of numbers, <EMCLASS="emphasis">sendmail</EM>would not recognize them, and your configuration filewould cease to work.</P><PCLASS="para">On the other hand, beginning with V8.7 <EMCLASS="emphasis">sendmail</EM>, you may bothspecify a rule set and give it a symbolic name. Internally,<EMCLASS="emphasis">sendmail</EM> converts that name to a number (a high one such as 199)and internally refers to it by number. The conversion process ensuresthat each name will correspond to a unique number.</P><PCLASS="para">Now that we've named <CODECLASS="literal">Hubset</CODE>, let's put some rules in it.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-11-SECT-4-1">11.4.1 Rewrite the Lone Username</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-11-IX-REWRITING-ADDRESSES"></A><ACLASS="indexterm"NAME="SML2-CH-11-IX-SENDERS-ADDRESS-REWRITING"></A>The sender's address can take several forms. It can be a user'slogin name, such as <EMCLASS="emphasis">gw</EM> or <EMCLASS="emphasis">ben</EM>. It can be a user at a short hostname, such as <EMCLASS="emphasis">gw@wash</EM> or <EMCLASS="emphasis">ben@fbi</EM>. It can bea user at a fully qualified name such as <EMCLASS="emphasis">gw@wash.dc.gov</EM>or <EMCLASS="emphasis">ben@fbi.dc.gov</EM>.</P><PCLASS="para">The <CODECLASS="literal">Hubset</CODE> rule set first looks for an address that isjust a simple user's name, such as <EMCLASS="emphasis">gw</EM>, and makes itappear as though it is from the mail hub. To do this, you need anew LHS wildcard operator, <CODECLASS="literal">$-</CODE>.<ACLASS="indexterm"NAME="AUTOID-6140"></A>The <CODECLASS="literal">$-</CODE> wildcard operator matches <EMCLASS="emphasis">exactly one</EM> tokenin the workspace.The first rule in the <CODECLASS="literal">Hubset</CODE> rule setuses the <CODECLASS="literal">$-</CODE> wildcard operator like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">SHubset # Rewrite the sender for the hub<CODECLASS="userinput"><B>R$-                          $@ $1@${HUB}   user -&gt; user@hub    </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> new</I></PRE></BLOCKQUOTE></P><PCLASS="para">Because <CODECLASS="literal">$-</CODE> is the only wildcard operatorin the LHS, a match occurs only if the workspace contains a singletoken:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$-<ICLASS="lineannotation">matches </I>  &quot;you&quot;$-<ICLASS="lineannotation">does not match </I>  &quot;you&quot; &quot;@&quot; &quot;localhost&quot;</PRE></BLOCKQUOTE></P><PCLASS="para">This LHS is used to look for an address thatcontains only a user's login name. When such a match is found,the RHS (<CODECLASS="literal">$@ $1@${HUB}</CODE>) rewrites that address byappending an <CODECLASS="literal">@</CODE> and the name of the mail hub machine,which was stored in the <CODECLASS="literal">${HUB}</CODE> macro.</P><PCLASS="para">The RHS contains two rewrite operators, one that you have seenalready and one that you haven't:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$1<ICLASS="lineannotation">positional operator (you have seen this)</I>$@<ICLASS="lineannotation">return immediately (new)</I></PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-6167"></A><ACLASS="indexterm"NAME="AUTOID-6170"></A>When <CODECLASS="literal">$@</CODE> begins (prefixes) the RHS of any rule, it tells<EMCLASS="emphasis">sendmail</EM> to return (exit the current rule set)immediately after it has rewritten the workspace. If the <CODECLASS="literal">$@</CODE>prefix did not appear at the start of the RHS, <EMCLASS="emphasis">sendmail</EM>would rewrite the workspace and then evaluate the LHS again. The <CODECLASS="literal">$@</CODE>also prevents the workspace from being carried down toany additional rules in the current rule set. An immediate returnfrom this rule is desirable becauseadditional rules might corrupt the now correct workspace.</P><PCLASS="para">The actual rewriting is done by <CODECLASS="literal">$1@${HUB}</CODE>.The <CODECLASS="literal">$1</CODE>, which you have seen before,takes the username matched by the LHS of <CODECLASS="literal">$-</CODE> (thefirst and only wildcard operator, thus <CODECLASS="literal">$1</CODE>). Then an <CODECLASS="literal">@</CODE>character is appended. Then the <CODECLASS="literal">${HUB}</CODE> macro is appendedto the workspace.</P><PCLASS="para">The <CODECLASS="literal">${HUB}</CODE> macro contains the address of the mail hub machineas it is known to the outside world. This is different from the<CODECLASS="literal">${REMOTE}</CODE> macro that you defined earlier, which contains the addressof the mail hub machine as it is known to the internal network.Before you can use the value of <CODECLASS="literal">${HUB}</CODE>,you need to define it in the <EMCLASS="emphasis">client.cf</EM> file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># Defined macrosD{REMOTE}mailhost              # The name of the mail hub<CODECLASS="userinput"><B>D{HUB}mail.us.edu              # Hub as known to the outside world    </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> new</I></PRE></BLOCKQUOTE></P><PCLASS="para">This new macro definition places the text <CODECLASS="literal">mail.us.edu</CODE>into the macro named <CODECLASS="literal">{HUB}</CODE>.Now the RHS of <CODECLASS="literal">$1@${HUB}</CODE> will rewrite the workspace into</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">you @ mail . us . edu <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I>  <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I> <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I> <ICLASS="lineannotation">$1</I> <ICLASS="lineannotation">@</I> <ICLASS="lineannotation">${HUB}</I></PRE></BLOCKQUOTE></P><PCLASS="para">This is exactly what is wanted. Remember that the <CODECLASS="literal">Hubset</CODE> rule set handles only sender addresses.Any sender address that consists of nothing morethan the name of a user will be rewritten to appear tocome from the mail hub.<ACLASS="xref"HREF="ch11_04.htm#SML2-CH-11-TAB-0"TITLE="Three LHS Wildcard Operators">Table 11.1</A>shows the three LHS wildcard operators that you now know.</P><TABLECLASS="table"><CAPTIONCLASS="table"><ACLASS="title"NAME="SML2-CH-11-TAB-0">Table 11.1: Three LHS Wildcard Operators</A></CAPTION><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Wildcard</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Description</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">$+</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Match one or more tokens</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">$*</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Match zero or more tokens</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">$-</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Match exactly one token</TD></TR></TBODY></TABLE><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-6230"></A><ACLASS="indexterm"NAME="AUTOID-6231"></A></P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-11-SECT-4-2">11.4.2 A Word About ${HUB}</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-6235"></A><ACLASS="indexterm"NAME="AUTOID-6238"></A><ACLASS="indexterm"NAME="AUTOID-6241"></A>In the <EMCLASS="emphasis">client.cf</EM> file, <CODECLASS="literal">${REMOTE}</CODE>is defined to be the nameof the hub machine as it is known internally to your network.<CODECLASS="literal">${HUB}</CODE> is defined to be the name of that same machineas it is known to the outside world. Note thatboth names could be (and probably will be) the same at your site.</P><PCLASS="para">The important point about <CODECLASS="literal">${REMOTE}</CODE> is that it contains a symbolicname, such as <EMCLASS="emphasis">mailhost</EM>. This allows the machine that is used asthe hub to be easily changed should the need arise. As your site becomes larger and more complex,you might want to have several hubs for routing messages tothe outside world. Or you might want to have one machine handle alloutgoing mail and another handle all incoming mail.Using a symbolic name makes such changes easy.</P><PCLASS="para">The important point about <CODECLASS="literal">${HUB}</CODE>, on the other hand, is thatit contains a fully qualified domain name that is listed with theDomain Name System or the UUCP maps and is knownto all other sites in the world. This is the host part ofthe address that other sites will use when they reply to mail sentfrom the hub.</P><PCLASS="para">Remember that a name such as <EMCLASS="emphasis">you@</EM> with the value of <CODECLASS="literal">${HUB}</CODE> added makes the address of the local sender (<EMCLASS="emphasis">you</EM>)look as though it is from the hub (<EMCLASS="emphasis">mail.us.edu</EM>).When someone at another site replies to this address,the reply will go to the <EMCLASS="emphasis">hub</EM> rather than to the local client.This is an important distinction, because the client machine may (by design)be unable to receive mail (more on this later).<ACLASS="indexterm"NAME="AUTOID-6258"></A><ACLASS="indexterm"NAME="AUTOID-6259"></A>&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_03.htm"TITLE="11.3 All Mail from the Hub"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 11.3 All Mail from the Hub"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_05.htm"TITLE="11.5 Testing So Far"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 11.5 Testing So Far"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">11.3 All Mail from the Hub</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">11.5 Testing So Far</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>