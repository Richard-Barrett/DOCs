<HTML><HEAD><TITLE>[Chapter 11] 11.6 Handling user@thishost</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T18:36:41Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch11_01.htm"TITLE="11. Rule Sets 1 and S="><LINKREL="prev"HREF="ch11_05.htm"TITLE="11.5 Testing So Far"><LINKREL="next"HREF="ch11_07.htm"TITLE="11.7 Rule Set 1"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_05.htm"TITLE="11.5 Testing So Far"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 11.5 Testing So Far"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 11<BR>Rule Sets 1 and S=</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_07.htm"TITLE="11.7 Rule Set 1"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 11.7 Rule Set 1"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-11-SECT-6">11.6 Handling user@thishost</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-11-IX-HOSTNAMES-CHANGING-TO-HUB-NAME"></A><ACLASS="indexterm"NAME="SML2-CH-11-IX-HUBS-CHANGING-HOSTNAME-TO"></A><ACLASS="indexterm"NAME="SML2-CH-11-IX-NAMES-CHANGING-FROM-HOST-TO-HUB"></A>The <CODECLASS="literal">Hubset</CODE> rule set next needs a rule that willtake an address consisting of a username and a short hostname and will change only the hostpart. Consider an address of the form:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">user@thishost</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the <CODECLASS="literal">user</CODE> part is what you already dealt with: a user's loginname such as <EMCLASS="emphasis">you</EM>. It is followed by an <CODECLASS="literal">@</CODE>character and then the local host's name.One method of matching this form of addressin the LHS would be to match the user, the <CODECLASS="literal">@</CODE>character, and <EMCLASS="emphasis">any</EM> hostname(recall that the <CODECLASS="literal">$+</CODE> matches one or more tokens in the workspace):</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$-@$+</PRE></BLOCKQUOTE></P><PCLASS="para">This form is easy to use because the <CODECLASS="literal">$+</CODE> would matchany hostname at all and wouldn't require that you knowall the possible names for the local host ahead of time. Unfortunately,you shouldn't use this approach, becauseyou want to rewrite the sender's hostname only if it is that ofthe local machine.Using <CODECLASS="literal">$+</CODE> would cause the sender's hostname to be rewritten whether ornot it is the name of the local machine.</P><PCLASS="para">But how could the sender's address not be from the local machine?Recall that <EMCLASS="emphasis">sendmail</EM> gets the sender address from oneof four places: from the envelope, from the <CODECLASS="literal">From:</CODE>header, from the <CODECLASS="literal">-f</CODE> switch (see below),or from the <EMCLASS="emphasis">uid</EM> of the process that ran <EMCLASS="emphasis">sendmail</EM>.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-6327"></A>Consider, for example, a Usenet news-posting program that posts news by sendingmail. It may be desirable to have all posted news messages appearto be from the news program on the news server machine. Oneway to achieve this is by running <EMCLASS="emphasis">sendmail</EM> withthe <CODECLASS="literal">-f</CODE> switch:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">-f news@news.server</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the <CODECLASS="literal">-f</CODE> switch causes <EMCLASS="emphasis">sendmail</EM> touse the address specified on the command line as the addressof the sender.</P><PCLASS="para">But in this example you would not want to changethe address of the sender to appear as though it were from thehub. That would undo what <CODECLASS="literal">news</CODE> tries to do withthe <CODECLASS="literal">-f</CODE> switch.</P><PCLASS="para">A better approach is to match the user, the <CODECLASS="literal">@</CODE>character, and the specific local hostname:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$-@$w</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-6344"></A>Recall that <CODECLASS="literal">$w</CODE> was definedto be the short hostname of the local host.This LHS matches only a workspace (sender's address) thatbegins with a single user's login name (<CODECLASS="literal">$-</CODE>),followed by <CODECLASS="literal">@</CODE>, and then by the nameof the local host (<CODECLASS="literal">$w</CODE>).</P><PCLASS="para">Add this new rule to the <EMCLASS="emphasis">client.cf</EM> file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">SHubset # Rewrite the sender for the hubR$-             $@ $1@${HUB}            user -&gt; user@hub<CODECLASS="userinput"><B>R$-@$w          $@ $1@${HUB}            user@local -&gt; user@hub      </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> new</I></PRE></BLOCKQUOTE></P><PCLASS="para">Notice that, other than their comments, the two rules differ onlyin their LHS. The flow through these rules is that the firsttries to match a lone username in the workspace. If that matchfails, the second rule tries to match the workspace.It matches only a workspace that contains the name ofa user at the local machine. To observe this rule in action, run <EMCLASS="emphasis">sendmail</EM> in rule-testing mode again:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>./sendmail -d0.1 -Cclient.cf -bt</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-6362"></A>This time, we added the <CODECLASS="literal">-d0.1</CODE> debugging command-line switch,which tells <EMCLASS="emphasis">sendmail</EM> to print the identity of the local machine:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Version 8.8.4 Compiled with: LOG MATCHGECOS MIME7TO8 MIME8TO7 NAMED_BIND NDBM NETINET                NETUNIX NIS SCANF XDEBUG============ SYSTEM IDENTITY (after readcf) ============      (short domain name) $w = here  (canonical domain name) $j = here.us.edu         (subdomain name) $m = us.edu              (node name) $k = here========================================================ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)Enter &lt;ruleset&gt; &lt;address&gt;&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">Note that <EMCLASS="emphasis">sendmail</EM>, in this example, defines <CODECLASS="literal">$w</CODE>as <CODECLASS="literal">here</CODE>, the name of the localmachine. Your local machine name will, of course, differ. Fortunately,you don't have to know what that name is to designa new rule. Simply use <CODECLASS="literal">$w</CODE>, and let <EMCLASS="emphasis">sendmail</EM>do all the work.</P><PCLASS="para">Now give <EMCLASS="emphasis">sendmail</EM> rule sets 3 and <CODECLASS="literal">Hubset</CODE>as you did before, but thistime specify a sender's address that contains a user anda host part:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">&gt; <CODECLASS="userinput"><B>3,Hubset you@here</B></CODE>               <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I>               <ICLASS="lineannotation">the same as appeared in $w</I></PRE></BLOCKQUOTE></P><PCLASS="para">The user part can be any login name. The host part must bethe text in the <CODECLASS="literal">$w</CODE> macro(displayed when you just ran <EMCLASS="emphasis">sendmail</EM> with the <CODECLASS="literal">-d0.1</CODE>debugging command-line switch above).</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">rewrite: ruleset  3   input: you @ hererewrite: ruleset  3 returns: you @ hererewrite: ruleset 199   input: you @ hererewrite: ruleset 199 returns: you @ mail . us . edu</PRE></BLOCKQUOTE></P><PCLASS="para">As intended, <CODECLASS="literal">Hubset</CODE>, the custom rule set for rewritingthe sender's address for the hub delivery agent, madethe local address appear to be from the <CODECLASS="literal">hub</CODE>.</P><PCLASS="para">Note, however, that you cannot specify macros when testing addresses;that is, the following does not work:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">&gt; <CODECLASS="userinput"><B>3,Hubset you@$w</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">The <EMCLASS="emphasis">sendmail</EM> program does not recognize macros in addresses.They aren't recognized becausemacros in rule sets are expanded when the configuration fileis read, not when <EMCLASS="emphasis">sendmail</EM> reads addresses. The command aboveresults in the following erroneous output:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">rewrite: ruleset  3   input: you @ $wrewrite: ruleset  3 returns: you @ $wrewrite: ruleset 199   input: you @ $wrewrite: ruleset 199 returns: you @ $w</PRE></BLOCKQUOTE></P><PCLASS="para">Also note that the value in <CODECLASS="literal">$w</CODE> is the short hostname,<EMCLASS="emphasis">here</EM>, instead of the fully qualified name <EMCLASS="emphasis">here.us.edu</EM>.Instead of adding an additional rule to test for the fully qualified name,we defer this problem to the next chapter.<ACLASS="indexterm"NAME="AUTOID-6405"></A><ACLASS="indexterm"NAME="AUTOID-6406"></A><ACLASS="indexterm"NAME="AUTOID-6407"></A>&#13;</P></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_05.htm"TITLE="11.5 Testing So Far"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 11.5 Testing So Far"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_07.htm"TITLE="11.7 Rule Set 1"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 11.7 Rule Set 1"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">11.5 Testing So Far</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">11.7 Rule Set 1</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>