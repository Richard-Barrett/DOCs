<HTML><HEAD><TITLE>[Chapter 14] Headers, Precedence, and Trust</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T18:38:22Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="part01.htm"TITLE="I. A Tutorial"><LINKREL="prev"HREF="ch13_05.htm"TITLE="13.5 Things to Try"><LINKREL="next"HREF="ch14_02.htm"TITLE="14.2 Headers Versus Delivery Agent Flags"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch13_05.htm"TITLE="13.5 Things to Try"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 13.5 Things to Try"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 14</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch14_02.htm"TITLE="14.2 Headers Versus Delivery Agent Flags"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 14.2 Headers Versus Delivery Agent Flags"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="CHAPTER"><H1CLASS="chapter"><ACLASS="title"NAME="SML2-CH-14">14. Headers, Precedence, and Trust</A></H1><DIVCLASS="htmltoc"><P><B>Contents:</B><BR><ACLASS="sect1"HREF="#SML2-CH-14-SECT-1"TITLE="14.1 Headers">Headers</A><BR><ACLASS="sect1"HREF="ch14_02.htm"TITLE="14.2 Headers Versus Delivery Agent Flags">Headers Versus Delivery Agent Flags</A><BR><ACLASS="sect1"HREF="ch14_03.htm"TITLE="14.3 Headers Learned So Far">Headers Learned So Far</A><BR><ACLASS="sect1"HREF="ch14_04.htm"TITLE="14.4 Precedence">Precedence</A><BR><ACLASS="sect1"HREF="ch14_05.htm"TITLE="14.5 Sending Real Mail">Sending Real Mail</A><BR><ACLASS="sect1"HREF="ch14_06.htm"TITLE="14.6 Trusted User">Trusted User</A><BR><ACLASS="sect1"HREF="ch14_07.htm"TITLE="14.7 Things to Try">Things to Try</A></P><P></P></DIV><PCLASS="para"></P><PCLASS="para">In the previous chapter you sent mail to yourself and saw that <EMCLASS="emphasis">sendmail</EM> added several problematic header lines to your message.Also the hub machine added some unsuitable headers.In this chapter we show how to use the <CODECLASS="literal">H</CODE> configuration commandto add legal headers to a message, the <CODECLASS="literal">P</CODE> configurationcommand to set message priorities, and the <CODECLASS="literal">T</CODE> configuration commandto define &quot;trusted&quot; users.&#13;</P><DIVCLASS="sect1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-14-SECT-1">14.1 Headers</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-14-IX-HEADERS-MESSAGE"></A><ACLASS="indexterm"NAME="AUTOID-7620"></A>The header configuration command begins with the letter <CODECLASS="literal">H</CODE>.Like all configuration commands, the <CODECLASS="literal">H</CODE> is the first characteron a line. The <CODECLASS="literal">H</CODE> isthen followed by the name of a header:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">H<CODECLASS="replaceable"><I>name</I></CODE>:<CODECLASS="replaceable"><I> field</I></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">Here, <CODECLASS="replaceable"><I>name</I></CODE> is the name of a header, such as <CODECLASS="literal">Subject</CODE>.The list of all header names that are of interest to <EMCLASS="emphasis">sendmail</EM> canbe found in <ACLASS="xref"HREF="ch35_01.htm"TITLE="Headers">Chapter 35, <CITECLASS="chapter">Headers</CITE></A>.The name is followed by a colonand then text that is appropriate for the header.Optional whitespace can surround the colon.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-7635"></A>RFC822 (modified by RFC1123) specifies that certain header linesmust appear in all email messages. Of those, the two you willfirst add to the <EMCLASS="emphasis">client.cf</EM> file are shown in<ACLASS="xref"HREF="ch14_01.htm#SML2-CH-14-TAB-0"TITLE="Two Required Headers">Table 14.1</A>.&#13;</P><TABLECLASS="table"><CAPTIONCLASS="table"><ACLASS="title"NAME="SML2-CH-14-TAB-0">Table 14.1: Two Required Headers</A></CAPTION><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Name</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Description</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">When Added</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">From:</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Address of the sender</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">If missing</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">Received:</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Record of receipt</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Always</TD></TR></TBODY></TABLE><PCLASS="para">Unless otherwise specified (as you will see later), a header that is declaredin the configuration file is added to a mail message only if one doesn't already exist.The exception to thisrule is the <CODECLASS="literal">Received:</CODE> header. It is always added to a mail message, even if there is alreadyone (or more) there.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-14-SECT-1-1">14.1.1 The From: Header</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-7664"></A>The <CODECLASS="literal">From:</CODE> header contains the official address ofthe sender. Declaring the <CODECLASS="literal">From:</CODE> header is simplicityitself, because it uses as its <CODECLASS="replaceable"><I>field</I></CODE> a single macrosurrounded by angle braces:<ACLASS="indexterm"NAME="AUTOID-7669"></A></P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">HFrom: &lt;$g&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">Recall that there are two kinds of macros: those that you definewith the <CODECLASS="literal">D</CODE> command and those that <EMCLASS="emphasis">sendmail</EM> defines.The <CODECLASS="literal">g</CODE> macro is one of the latter.The value <EMCLASS="emphasis">sendmail</EM> gives the <CODECLASS="literal">g</CODE> macro is theaddress of the sender (generated by <EMCLASS="emphasis">sendmail</EM>) as itappears on the envelope. That address, when you are thesender, was generated by the <CODECLASS="literal">Hubset</CODE> rule set:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">SHubset # Rewrite the sender for the hubR$-             $@ $1@${HUB}            user -&gt; user@hub</PRE></BLOCKQUOTE></P><PCLASS="para">The sender address (<EMCLASS="emphasis">you</EM>) is rewritten by this rule so that itbecomes <EMCLASS="emphasis">you@mail.us.edu</EM>. That is, the hostname and domainof the hub machine are appended so that the mail appears tocome from the hub. This is the envelope address of the sender,and that is the address placed into the <CODECLASS="literal">g</CODE> macro. For email sent byyou, the value that is given to <CODECLASS="literal">$g</CODE> (and thus to the <CODECLASS="literal">From:</CODE>header) is:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">From: &lt;you@mail.us.edu&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">The <CODECLASS="literal">From:</CODE> header is added to an outgoingmail message only if there is not already a <CODECLASS="literal">From:</CODE> header there.(Often an MUA will add a <CODECLASS="literal">From:</CODE> header.)It is placed intothe <EMCLASS="emphasis">client.cf</EM> file to ensure that no mail leaves the localmachine without this required header.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-14-SECT-1-2">14.1.2 The Received: Header</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-7699"></A>The <CODECLASS="literal">Received:</CODE> header is special. It isalways added to the header portion of every mail message, evenif one or more of them are already present.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-7703"></A><ACLASS="indexterm"NAME="AUTOID-7707"></A>The <CODECLASS="literal">Received:</CODE> header is used to make a recordof each machine that mail has passed through. When <EMCLASS="emphasis">sendmail</EM>calculates a hop count (to bounce mail with too many hops), it doesso by counting the <CODECLASS="literal">Received:</CODE> header lines.The declaration of the <CODECLASS="literal">Received:</CODE> header is a bitcomplicated.A minimal <CODECLASS="literal">Received:</CODE> header declaration looks like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">HReceived: by $j; $b</PRE></BLOCKQUOTE></P><PCLASS="para">The word <CODECLASS="literal">by</CODE> is mandatory. It must be followed by the fully qualified,official name of the local machine. As you saw earlier when youran <EMCLASS="emphasis">sendmail</EM> with the <CODECLASS="literal">-d0.1</CODE> debugging switch, thefully qualified name was assigned to the <CODECLASS="literal">j</CODE> macro:<ACLASS="indexterm"NAME="AUTOID-7721"></A></P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">============ SYSTEM IDENTITY (after readcf) ============      (short domain name) $w = here  (canonical domain name) <CODECLASS="userinput"><B>$j</B></CODE> = here.us.edu                          <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I>                        <ICLASS="lineannotation">note</I></PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-7729"></A><ACLASS="indexterm"NAME="AUTOID-7731"></A><ACLASS="indexterm"NAME="AUTOID-7734"></A>The <CODECLASS="literal">Received:</CODE> header definition concludes with a semicolon,followed by the current date and time as stored in <CODECLASS="literal">$b</CODE>.The <CODECLASS="literal">b</CODE> macro contains the current date in ARPAnetformat; that is, the day of the week, the month, the day, the time,the year, and the time zone.</P><PCLASS="para">These items in the <CODECLASS="literal">Received:</CODE> headerform the minimum information required in this header.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-14-SECT-1-3">14.1.3 Testing So Far</A></H3><PCLASS="para">Add the <CODECLASS="literal">From:</CODE> and <CODECLASS="literal">Received:</CODE> headers to the <EMCLASS="emphasis">client.cf</EM>file. The new lines in <EMCLASS="emphasis">client.cf</EM> will look like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O OldStyleHeaders=TrueO BlankSub=.                    # Replace unquoted spaces with a dot.<CODECLASS="userinput"><B># Headers                                                              </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> new</I><CODECLASS="userinput"><B>HFrom: &lt;$g&gt;                     # Added only if missing                </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> new</I><CODECLASS="userinput"><B>HReceived: by $j; $b            # Always added                         </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> new</I></PRE></BLOCKQUOTE></P><PCLASS="para">Here, they follow the options that were added in the last chapter.As usual, comments have been included to clarify your intent.See <ACLASS="xref"HREF="ch31_01.htm"TITLE="Defined Macros">Chapter 31, <CITECLASS="chapter">Defined Macros</CITE></A>,for a more detailed explanation of the <CODECLASS="literal">j</CODE> and <CODECLASS="literal">b</CODE>macros.</P><PCLASS="para">Now send mail to yourself just as you did at the end of thepreceding chapter:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>./sendmail -Cclient.cf </B></CODE><CODECLASS="replaceable"><I>you</I></CODE><CODECLASS="userinput"><B>Subject: testing</B></CODE><CODECLASS="userinput"><B>To: </B></CODE><CODECLASS="replaceable"><I>you</I></CODE><CODECLASS="userinput"><B></B></CODE><CODECLASS="userinput"><B>testing</B></CODE><CODECLASS="userinput"><B>.</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">Retrieve the mail that you just sent, save it to a file, and lookat what you saved. It will look something like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">From you@mail.us.edu Fri Dec 13 05:47:47 1996Return-Path: &lt;you@mail.us.edu&gt;Received: from here.us.edu (you@here.us.edu [123.45.67.8]) bymail.us.edu(8.8.4/8.8.4) with ESMTP id FAA13451 for &lt;you&gt;; Fri, 13 Dec 1996 05:47:46 -0700Date: Fri, 13 Dec 1996 05:47:46 -0700<CODECLASS="userinput"><B>From: you@mail.us.edu (Your Full Name)                                  </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> note</I>Message-Id: &lt;199509091247.FAA13451@mail.us.edu&gt;<CODECLASS="userinput"><B>Received: by here.us.edu; Fri, 13 Dec 1996 05:47:44 -0700               </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> note</I>Subject: testingTo: youtesting</PRE></BLOCKQUOTE></P><PCLASS="para">Notice that a new<CODECLASS="literal">Received:</CODE> header was added. This is the onejust declared in the <EMCLASS="emphasis">client.cf</EM> file. The two <CODECLASS="literal">Received:</CODE> headers form a trail that shows who firstreceived the message and how it was passed from one machineto the other.</P><PCLASS="para">Also notice that the contents of the <CODECLASS="literal">From:</CODE> header havechanged. Something has removed the angle brackets and addedyour full name. What happened was this:</P><OLCLASS="orderedlist"><LICLASS="listitem"><PCLASS="para">On the hub machine the address in the envelope for the senderis taken from the RCPT message that the local machine sendsduring the SMTP conversation. That address is the value of<CODECLASS="literal">$g</CODE> with angle brackets added.</P></LI><LICLASS="listitem"><PCLASS="para">On the hub machine the address in the <CODECLASS="literal">From:</CODE> headeris compared to the sender envelope address.The address in the <CODECLASS="literal">From:</CODE> header that <EMCLASS="emphasis">client.cf</EM>supplied was the value of <CODECLASS="literal">$g</CODE> surrounded in angle brackets.</P></LI><LICLASS="listitem"><PCLASS="para">Whenever the address in the envelope for the sender and the addressin the <CODECLASS="literal">From:</CODE> header are identical, <EMCLASS="emphasis">sendmail</EM>removes the <CODECLASS="literal">From:</CODE> header and creates a new one.Thus <EMCLASS="emphasis">sendmail</EM> on a correctly configured hub machine removes the <CODECLASS="literal">From:</CODE>header and creates a new one that includes your full name.</P></LI></OL><PCLASS="para">The definition of the <CODECLASS="literal">From:</CODE> header on a hub ismore complex then that in the <EMCLASS="emphasis">client.cf</EM> file.One possible definition might looklike this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">From: $g $?x($x)$.</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-7809"></A><ACLASS="indexterm"NAME="AUTOID-7812"></A><ACLASS="indexterm"NAME="AUTOID-7814"></A><ACLASS="indexterm"NAME="AUTOID-7817"></A>This is just like the local definition, but it has a macro<EMCLASS="emphasis">conditional</EM> added. A macro conditional issimply an if-endif construction, where <CODECLASS="literal">$?</CODE> is theif and <CODECLASS="literal">$.</CODE> is the endif. The preceding definition, then,can be broken down like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$?        <ICLASS="lineannotation">if</I>x         <ICLASS="lineannotation">    the macro x contains a value</I>($x)      <ICLASS="lineannotation">      add this to the definition</I>$.        <ICLASS="lineannotation">endif</I></PRE></BLOCKQUOTE></P><PCLASS="para">&#13;The macro <CODECLASS="literal">x</CODE> contains as its value the full name ofthe sender. If that full name is not known, <CODECLASS="literal">x</CODE> hasno value and the full name is omitted.If <CODECLASS="literal">$x</CODE> does contain a value, the full name isadded in parentheses.Macro conditionals are described in<ACLASS="xref"HREF="ch31_01.htm"TITLE="Defined Macros">Chapter 31</A>.&#13;</P></DIV></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch13_05.htm"TITLE="13.5 Things to Try"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 13.5 Things to Try"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch14_02.htm"TITLE="14.2 Headers Versus Delivery Agent Flags"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 14.2 Headers Versus Delivery Agent Flags"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">13.5 Things to Try</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">14.2 Headers Versus Delivery Agent Flags</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>