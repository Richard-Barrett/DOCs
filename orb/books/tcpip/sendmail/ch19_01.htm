<HTML><HEAD><TITLE>[Chapter 19] V8 m4 Configuration</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:10:22Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="part02.htm"TITLE="II. Build and Install"><LINKREL="prev"HREF="ch18_08.htm"TITLE="18.8 Alphabetized Reference"><LINKREL="next"HREF="ch19_02.htm"TITLE="19.2 Build with m4"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch18_08.htm"TITLE="18.8 Alphabetized Reference"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 18.8 Alphabetized Reference"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 19</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch19_02.htm"TITLE="19.2 Build with m4"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 19.2 Build with m4"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="CHAPTER"><H1CLASS="chapter"><ACLASS="title"NAME="SML2-CH-19">19. V8 m4 Configuration</A></H1><DIVCLASS="htmltoc"><P><B>Contents:</B><BR><ACLASS="sect1"HREF="#SML2-CH-19-SECT-1"TITLE="19.1 The m4 Preprocessor">The m4 Preprocessor</A><BR><ACLASS="sect1"HREF="ch19_02.htm"TITLE="19.2 Build with m4">Build with m4</A><BR><ACLASS="sect1"HREF="ch19_03.htm"TITLE="19.3 The Minimal mc File">The Minimal mc File</A><BR><ACLASS="sect1"HREF="ch19_04.htm"TITLE="19.4 m4 Macros by Function">m4 Macros by Function</A><BR><ACLASS="sect1"HREF="ch19_05.htm"TITLE="19.5 Pitfalls">Pitfalls</A><BR><ACLASS="sect1"HREF="ch19_06.htm"TITLE="19.6 Alphabetized m4 Macros">Alphabetized m4 Macros</A></P><P></P></DIV><PCLASS="para"></P><PCLASS="para">V8 <EMCLASS="emphasis">sendmail</EM> provides an easy way to create a custom configurationfile for your site.<ACLASS="indexterm"NAME="SML2-CH-19-IX-V8-SENDMAIL-M4-PREPROCESSOR"></A><ACLASS="indexterm"NAME="SML2-CH-19-IX-M4-PREPROCESSOR"></A><ACLASS="indexterm"NAME="SML2-CH-19-IX-MACROS-M4-PREPROCESSOR"></A>In the <EMCLASS="emphasis">cf</EM> subdirectory of the V8 <EMCLASS="emphasis">sendmail</EM> sourcedistribution you will find a file named <EMCLASS="emphasis">README</EM>. It contains easy-to-understand, step-by-step instructions thatallow you to create a custom configuration file for your site.This chapter supplements that file.</P><DIVCLASS="sect1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-19-SECT-1">19.1 The m4 Preprocessor</A></H2><PCLASS="para">Creating a configuration file with <EMCLASS="emphasis">m4</EM>(1) is simplicityitself. The  <EMCLASS="emphasis">m4</EM>(1) program is a macro preprocessor that produces a <EMCLASS="emphasis">sendmail</EM> configuration fileby processing a file whose name ends in <EMCLASS="emphasis">.mc</EM>(for <BCLASS="emphasis.bold">m</B>acro <BCLASS="emphasis.bold">c</B>onfiguration).That is, it processes (reads)its input and gathers definitions of macros, then replaces those macros with their values and outputs the result.</P><PCLASS="para">This use of macros is much the sameas that described in <ACLASS="xref"HREF="ch07_01.htm#SML2-CH-7-SECT-1"TITLE="Overview">Section 7.1, "Overview"</A>, except that<EMCLASS="emphasis">m4</EM>'s rules are different.With <EMCLASS="emphasis">m4</EM>, macros are defined (given values) like this:<ACLASS="indexterm"NAME="AUTOID-12983"></A></P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">define(<CODECLASS="replaceable"><I>macro</I></CODE>,<CODECLASS="replaceable"><I>value</I></CODE>)</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the <CODECLASS="replaceable"><I>macro</I></CODE> is a symbolic name that you will use later.Legal names must begin with an underscore or letter and may containletters, digits, and underscores. The <CODECLASS="replaceable"><I>value</I></CODE> can be anyarbitrary text. A comma separates the two, and that comma can besurrounded with optional whitespace.</P><PCLASS="para">There must be no space between the <CODECLASS="literal">define</CODE> and the left parenthesis.The definition ends with the right parenthesis.</P><PCLASS="para">&#13;To illustrate, consider this one-line <EMCLASS="emphasis">m4</EM> source filenamed <EMCLASS="emphasis">/tmp/x</EM>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">           <ICLASS="lineannotation">input text to be converted</I>           <ICLASS="lineannotation"><IMGSRC="../chars/darr.gif"ALT="-v"></I>define(A,B)A<ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I><ICLASS="lineannotation">the m4 definition</I></PRE></BLOCKQUOTE></P><PCLASS="para">When <EMCLASS="emphasis">m4</EM> is run to process this file, the output produced showsthat <CODECLASS="literal">A</CODE> (the <EMCLASS="emphasis">input</EM>) is redefined to become <CODECLASS="literal">B</CODE>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>m4 /tmp/x</B></CODE>B</PRE></BLOCKQUOTE></P><PCLASS="para"></P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-19-SECT-1-1">19.1.1 m4 is greedy</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-13015"></A>The <EMCLASS="emphasis">m4</EM> program is greedy. That is, if a <CODECLASS="replaceable"><I>macro</I></CODE> isalready defined, its value will replace its name in the seconddeclaration. Consider this input file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">define(A,B)define(A,C)A B</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the first line assigns the value <CODECLASS="literal">B</CODE> to the macro named<CODECLASS="literal">A</CODE>. The second line notices that <CODECLASS="literal">A</CODE> is a define macro,so <EMCLASS="emphasis">m4</EM> replaces that <CODECLASS="literal">A</CODE> with <CODECLASS="literal">B</CODE> and thendefines <CODECLASS="literal">B</CODE> as having the value <CODECLASS="literal">C</CODE>. The output of this file,after processing with <EMCLASS="emphasis">m4</EM>, will be:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">C C</PRE></BLOCKQUOTE></P><PCLASS="para">To prevent this kind of greedy behavior (and to prevent the confusionit can create), you may quote an item to prevent <EMCLASS="emphasis">m4</EM> from interpretingit.<ACLASS="indexterm"NAME="AUTOID-13035"></A>zzz<ACLASS="indexterm"NAME="AUTOID-13037"></A><ACLASS="indexterm"NAME="AUTOID-13039"></A>You quote with <EMCLASS="emphasis">m4</EM> by surroundingeach item with left and right single quotes:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">define(A,B)define(`A',C)A B</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the first line defines <CODECLASS="literal">A</CODE> as <CODECLASS="literal">B</CODE> as before. Butthe second line no longer sees <CODECLASS="literal">A</CODE> as a macro.Instead, the single quotes allow <CODECLASS="literal">A</CODE> to be redefined as <CODECLASS="literal">C</CODE>.So the output is now:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">C B</PRE></BLOCKQUOTE></P><PCLASS="para">Although it is not strictly necessary,we recommend that all <CODECLASS="replaceable"><I>macro</I></CODE> and <CODECLASS="replaceable"><I>value</I></CODE>pairs be quoted. The above should generallybe expressed like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">define(`A',`B')      define(`A',`C')   A B</PRE></BLOCKQUOTE></P><PCLASS="para">This is the form that we use when illustrating <EMCLASS="emphasis">m4</EM> throughout this book.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-19-SECT-1-2">19.1.2 m4 and dnl</A></H3><PCLASS="para">Another problem with <EMCLASS="emphasis">m4</EM> is that it replaces its commandswith empty lines. The above <CODECLASS="literal">define</CODE> commands, for example,will actually print like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> a blank line</I>                           <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> a blank line</I>A B</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-13069"></A>To suppress this insertion of blank lines, you can use the special<EMCLASS="emphasis">m4</EM> command <CODECLASS="literal">dnl</CODE> (for Delete through New Line). That commandlooks like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">define(`A',`B')<CODECLASS="userinput"><B>dnl</B></CODE>define(`A',`C')<CODECLASS="userinput"><B>dnl</B></CODE>A B</PRE></BLOCKQUOTE></P><PCLASS="para">You can use <CODECLASS="literal">dnl</CODE> to remove blank lines where they might prove inconvenient or unsightly in a configuration file.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-19-SECT-1-3">19.1.3 m4 and arguments</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-13082"></A>When an <EMCLASS="emphasis">m4</EM> macro name is immediately followed by a right parenthesis,it is treated like a function call. Arguments given to it in that roleare used to replace <CODECLASS="literal">$</CODE><CODECLASS="replaceable"><I>digit</I></CODE> expressions in the original definition.For example, suppose the macro CONCAT is defined like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">define(`CONCAT',`$1$2$3')dnl</PRE></BLOCKQUOTE></P><PCLASS="para">and then later used like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">CONCAT(`host', `.', `domain')</PRE></BLOCKQUOTE></P><PCLASS="para">The result will be that <CODECLASS="literal">host</CODE> will replace <CODECLASS="literal">$1</CODE>, thedot will replace <CODECLASS="literal">$2</CODE>, and the <CODECLASS="literal">domain</CODE> will replace <CODECLASS="literal">$3</CODE>, alljammed tightly together just as <CODECLASS="literal">`$1$2$3'</CODE> were:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">host.domain</PRE></BLOCKQUOTE></P><PCLASS="para">Macro arguments are used to create such techniques as FEATURE()and OSTYPE(), which are described later in this chapter.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-19-SECT-1-4">19.1.4 m4 diversions</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-13106"></A><ACLASS="indexterm"NAME="AUTOID-13108"></A><ACLASS="indexterm"NAME="AUTOID-13110"></A>One of the <EMCLASS="emphasis">m4</EM> program's strengths is its ability to divide its inputinto different parts and to later reassemble them in a more logicalfashion. Consider, for example, the desire to output all options together.One way to do this is with the <EMCLASS="emphasis">m4</EM> program's <CODECLASS="literal">divert</CODE> and<CODECLASS="literal">undivert</CODE> commands, for example,</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">divert(1)dnlO ALIASFILE=/etc/aliasesdivert(2)dnlPfirst-class=0divert(1)dnlO OperatorChars=.:%@!^/[]+undivert(1)dnlundivert(2)dnl</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the <CODECLASS="literal">divert(1)</CODE> causes all subsequent lines (up to the next<CODECLASS="literal">divert</CODE> or next <CODECLASS="literal">undivert</CODE>) to be held in a buffer numberedone. Buffer one will hold all the options. The second <CODECLASS="literal">divert</CODE>switches to buffer two, which is used to hold priorities. The third<CODECLASS="literal">divert</CODE> switches back to buffer one.</P><PCLASS="para">The <CODECLASS="literal">undivert(1)</CODE> causes all the options gathered in buffer oneto be output, and the <CODECLASS="literal">undivert(2)</CODE> causes the priorities tobe output. The result looks like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O ALIASFILE=/etc/aliasesO OperatorChars=.:%@!^/[]+Pfirst-class=0</PRE></BLOCKQUOTE></P><PCLASS="para">The diversions used by <EMCLASS="emphasis">sendmail</EM>'s <EMCLASS="emphasis">m4</EM> technique are listedin<ACLASS="xref"HREF="ch19_01.htm#SML2-CH-19-TAB-0"TITLE="m4 Diversions Used and Reserved by sendmail">Table 19.1</A>.In general, the macros listed should be used in place of diversion numbersbecause the meaning of those numbers may be changed in future versionsof <EMCLASS="emphasis">sendmail</EM>.<ACLASS="indexterm"NAME="AUTOID-13135"></A></P><TABLECLASS="table"><CAPTIONCLASS="table"><ACLASS="title"NAME="SML2-CH-19-TAB-0">Table 19.1: m4 Diversions Used and Reserved by sendmail</A></CAPTION><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">divert</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Description </TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(-1)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal to <EMCLASS="emphasis">m4</EM>(1), tells it ignore all lines that follow</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(0)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Internal to <EMCLASS="emphasis">m4</EM>(1), tells it to stop diverting and to output immediately</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(1)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Local host detection and resolution with LOCAL_NET_CONFIG (see <ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-37"TITLE="">Section 19.6.37, LOCAL-NET-CONFIG</A>)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(2)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Rule set 3 (via 96) additions with LOCAL_RULE_3 (see <ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-35"TITLE="">Section 19.6.35, LOCAL-RULE-3</A>)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(3)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Rule set 0 (via 98) additions with LOCAL_RULE_0 (see <ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-32"TITLE="">Section 19.6.32, LOCAL-RULE-0</A>)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(4)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Rule set 0 UUCP additions (<ACLASS="xref"HREF="ch19_04.htm#SML2-CH-19-SECT-4-6"TITLE="UUCP">Section 19.4.6, "UUCP"</A>)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(5)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Locally interpreted names (overrides $R) with LOCAL_USER (<ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-38"TITLE="">Section 19.6.38, LOCAL-USER</A>)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(6)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Local configuration (at top of file) with LOCAL_CONFIG (see <ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-30"TITLE="">Section 19.6.30, LOCAL-CONFIG</A>)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(7)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Delivery agent definitions with MAILER (see <ACLASS="xref"HREF="ch19_03.htm#SML2-CH-19-SECT-3-2"TITLE="MAILER()">Section 19.3.2, "MAILER()"</A>) and MAILER_DEFINITIONS (see <ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-40"TITLE="">Section 19.6.40, MAILER-DEFINITIONS</A>)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(8)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">unused</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">(9)</TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Rule sets 1 and 2 with LOCAL_RULE_1 and LOCAL_RULE_2 (see <ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-34"TITLE="">Section 19.6.34, LOCAL-RULE-2</A>), rule set 5, and LOCAL_RULESETS (see <ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-36"TITLE="">Section 19.6.36, LOCAL-RULESETS</A>)</TD></TR></TBODY></TABLE></DIV></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch18_08.htm"TITLE="18.8 Alphabetized Reference"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 18.8 Alphabetized Reference"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch19_02.htm"TITLE="19.2 Build with m4"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 19.2 Build with m4"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">18.8 Alphabetized Reference</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">19.2 Build with m4</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>