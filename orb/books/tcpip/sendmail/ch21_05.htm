<HTML><HEAD><TITLE>[Chapter 21] 21.5 Prepare for Disaster</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:28:33Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch21_01.htm"TITLE="21. DNS and sendmail"><LINKREL="prev"HREF="ch21_04.htm"TITLE="21.4 How to Use nslookup"><LINKREL="next"HREF="ch21_06.htm"TITLE="21.6 Pitfalls"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_04.htm"TITLE="21.4 How to Use nslookup"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 21.4 How to Use nslookup"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 21<BR>DNS and sendmail</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_06.htm"TITLE="21.6 Pitfalls"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 21.6 Pitfalls"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-21-SECT-5">21.5 Prepare for Disaster</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-21-IX-DISASTERS"></A><ACLASS="indexterm"NAME="SML2-CH-21-IX-TROUBLESHOOTING-DISASTERS"></A><ACLASS="indexterm"NAME="SML2-CH-21-IX-DNS-DOMAIN-NAME-SYSTEM-DISASTERS"></A>Disasters can take many forms and, by their very nature, are unexpected.If DNS and mail are to continue to work, expecting the unexpected is vital.The kinds of disasters that one must anticipate vary fromthe mundane to the catastrophic:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">A reboot or scheduled down-time for dumps on the mail or DNS servershould only cause mail to be delayed, not lost.</P></LI><LICLASS="listitem"><PCLASS="para">A failed component on the mail or DNS server could cause mail deliveryto be delayed anywhere from a few hours to a few days.A delay of over three to five days could cause many hosts to bounce queued mailunless steps are taken to receive that mail elsewhere.</P></LI><LICLASS="listitem"><PCLASS="para">Natural disasters can disrupt site or network connectivity forweeks. The Loma Prieta earthquake on the West Coast of the United Stateslasted only a few minutes but knocked out electric power to many areasfor far longer. Fear of gas leaks prevented repowering many buildings for up to twoweeks. A hurricane, flood, fire, or even an errant backhoecould knock out your institution for weeks.</P></LI></UL><PCLASS="para"></P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-21-SECT-5-1">21.5.1 Offsite MX Hosts</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-17930"></A><ACLASS="indexterm"NAME="AUTOID-17933"></A>When mail can't be received, whether because of a small eventor a large disaster, an offsite MX host can save the day. An offsiteMX host is simply another machine that can receive mail for your sitewhen your site is unavailable. The location of the offsite machine dependson your situation. For a subdomain at one end of a microwave link,having an offsite host on the other side of the microwave might be sufficient. Fora large site, such as a university, a machine at another university(possibly in a different state or country) would be wise.</P><PCLASS="para">Before we show how to set up offsite MX hosts,note that offsite MX hosts are not an unmixed blessing.If an offsite MX host does not handle mail reliably, youcould lose mail.  In many cases it is better not to have anoffsite MX host than to have an unreliable one.  Withoutan MX site, mail will normally be queued on the sending host.A reliable MX backup is useful, but an unreliable one is a disaster.</P><PCLASS="para">You should not unilaterally select a host to function as an offsiteMX host.To set up an offsite MX host, you need to negotiate with themanagers of other sites. By mutual agreement, another site's managerwill configure that other machine to accept mail bound for yoursite (possibly queueing weeks' worth of mail) and configure thatsite to forward that mail to yours when your site comes back up.</P><PCLASS="para">For example, suppose your site is in the state of Iowa, in the UnitedStates. Further suppose that inNorthern Japan there is a site with which you are friendly.You could negotiate with that site's manager to receive and hold your mail ina disaster. When the site is set up to do so, you firstadd a high-cost MX record for it:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">mailhost.uiowa.edu.   IN   MX 2     mailhost.uiowa.edu.mailhost.uiowa.edu.   IN   MX 10    backup.uiowa.edu.mailhost.uiowa.edu.   IN   MX 900   pacific.north.jp.    <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> note</I></PRE></BLOCKQUOTE></P><PCLASS="para">To be sure the MX works, send mail to yourself viathat new MX site:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>mail you%mailhost.uiowa.edu@pacific.north.jp</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">[16]<ACLASS="indexterm"NAME="AUTOID-17951"></A><ACLASS="indexterm"NAME="AUTOID-17954"></A><ACLASS="indexterm"NAME="AUTOID-17956"></A><ACLASS="indexterm"NAME="AUTOID-17959"></A>Here, the <CODECLASS="literal">%</CODE> in the address causes the message to first be deliveredto <EMCLASS="emphasis">pacific.north.jp</EM>. That machine then throws away itsown name and converts the remaining <CODECLASS="literal">%</CODE> to an <CODECLASS="literal">@</CODE>. Theresult is then mailed back to you at </P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[16] This example presumes that <EMCLASS="emphasis">pacific.north.jp</EM> can handlethe <CODECLASS="literal">%</CODE> &quot;hack.&quot; Most places do, so this is probablya safe assumption.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">you@mailhost.uiowa.edu</PRE></BLOCKQUOTE></P><PCLASS="para">This verifies that the disasterMX machine can get mail to your site when it returns to service.</P><PCLASS="para">During a disaster the first sign of trouble will be mail for your site suddenlyappearing in the queue at <EMCLASS="emphasis">pacific.north.jp</EM>. The managerthere should notice and set up a separate queue to hold theincoming mail until your site returns to service (see <ACLASS="xref"HREF="ch23_07.htm#SML2-CH-23-SECT-7-1"TITLE="Handling a Down Site">Section 23.7.1, "Handling a Down Site"</A>).When your site recovers, you can contact that manager and arrangefor a queue run to deliver the backlog of mail. </P><PCLASS="para">If your site is out of service for weeks, the backlog of mailmight be partly on tape or some other backup media. You mighteven want to negotiate an artificially slow feed so thatyour local spool directory won't overfill.</P><PCLASS="para">Even in minor disasters an MX host can save much grief becausedelivery will be serialized. Without an MX host, every machinein the world that had mail for your machine would try to sendit at the same time, that is, when  your machine returns to service. That could overload your machine and even crash it, causing the problem to repeat overand over.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-21-SECT-5-2">21.5.2 Offsite Servers</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-17976"></A><ACLASS="indexterm"NAME="AUTOID-17978"></A><ACLASS="indexterm"NAME="AUTOID-17980"></A><ACLASS="indexterm"NAME="AUTOID-17983"></A>A disaster MX is good only as long as your DNS services stay alive toadvertise it.Most sites have multiple name server machines to balance the load ofDNS lookups and to provide redundancy in case one fails.Unfortunately, few sites have offsite name servers as a hedge againstdisaster. Consider the disaster MX record developed above:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">mailhost.uiowa.edu.   IN   MX 900   pacific.north.jp.</PRE></BLOCKQUOTE></P><PCLASS="para">Ideally, one would want<EMCLASS="emphasis">pacific.north.jp</EM> to queue all mail until the local siteis back in service.<ACLASS="indexterm"NAME="AUTOID-17989"></A><ACLASS="indexterm"NAME="AUTOID-17991"></A>Unfortunately, all DNS records contain a Time To Live (TTL) thatmay or may not be present in the declaration line:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">mailhost.uiowa.edu.   IN   MX 900   pacific.north.jp.                   <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I>                   <ICLASS="lineannotation">TTL implied</I>mailhost.uiowa.edu. 86400  IN   MX 900   pacific.north.jp.                    <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I>                    <ICLASS="lineannotation">TTL specified as 24 hours in seconds</I></PRE></BLOCKQUOTE></P><PCLASS="para">When other sites look up the local site, they cache this record.They will not look it up again until 24 hours have passed. Thereforeif an earthquake strikes, all other sites will forget about thisrecord after 24 hours and will not be able to look it up again.</P><PCLASS="para">In general, records set up for disaster purposes should be givenTTLs that are over a month:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">mailhost.uiowa.edu. 3600000  IN   MX 900   pacific.north.jp.                    <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I>                    <ICLASS="lineannotation">TTL specified as 41 days in seconds</I></PRE></BLOCKQUOTE></P><PCLASS="para">But note that TTLs should be the same for all recordsso that they will all time out the same:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">mailhost.uiowa.edu.  3600000 IN   MX 2     mailhost.uiowa.edu.mailhost.uiowa.edu.  3600000 IN   MX 10    backup.uiowa.edu.mailhost.uiowa.edu.  3600000 IN   MX 900   pacific.north.jp.</PRE></BLOCKQUOTE></P><PCLASS="para">If you gave the disaster recorda long TTL and left the default for your normal MX records,your normal records would time out and disappear from other sites' caches.This would result in all mail suddenly and mysteriously going to the disasterhost when there was no disaster to cause it.</P><PCLASS="para">Note that long TTLs can make updates to your DNS filesawkward. Updates won't take effect until the TTL times out.If you anticipate a future change, say a rearrangement of your MXrecords, you can change the TTLs to 2 hours, wait a month forthe long TTL to time out, then make and test your changes.[17]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[17] And hope that no disaster strikes in the meanwhile. A better techniqueis to set up an offsite secondary DNS server with a large TTLin the SOA record.</P></BLOCKQUOTE><PCLASS="para">If many hosts at your site receive mail (rather than a centralmail server), it is necessary to add a disasterrecord for each. Unfortunately, when the number of such hosts atyour site is greater than 100 or so, individual disasterMX records become difficult to manage simply because of scale.</P><PCLASS="para">At such sites, a better method of disaster preparedness is toset up <EMCLASS="emphasis">pacific.north.jp</EM> as another primary DNS server forthe local site. There are two advantages to this &quot;authoritative&quot;backup server approach:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">An offsite primary server eliminates the need to set upindividual MX disaster records.</P></LI><LICLASS="listitem"><PCLASS="para">An out-of-country primary server can lower the network impactof DNS lookups of your site.</P></LI></UL><PCLASS="para">Unfortunately, setting up an offsite or out-of-country servercan be extremely difficult. We won't show you how to do thathere. Instead, we refer you to the book <EMCLASS="emphasis">DNS and BIND</EM> by PaulAlbitz and Cricket Liu (O'Reilly &amp; Associates, 2nd edition, 1997).<ACLASS="indexterm"NAME="AUTOID-18022"></A><ACLASS="indexterm"NAME="AUTOID-18023"></A><ACLASS="indexterm"NAME="AUTOID-18024"></A>&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_04.htm"TITLE="21.4 How to Use nslookup"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 21.4 How to Use nslookup"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_06.htm"TITLE="21.6 Pitfalls"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 21.6 Pitfalls"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">21.4 How to Use nslookup</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">21.6 Pitfalls</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>