<HTML><HEAD><TITLE>[Chapter 22] Security</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:28:38Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="part03.htm"TITLE="III. Administration"><LINKREL="prev"HREF="ch21_06.htm"TITLE="21.6 Pitfalls"><LINKREL="next"HREF="ch22_02.htm"TITLE="22.2 The Environment"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_06.htm"TITLE="21.6 Pitfalls"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 21.6 Pitfalls"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 22</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_02.htm"TITLE="22.2 The Environment"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.2 The Environment"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="CHAPTER"><H1CLASS="chapter"><ACLASS="title"NAME="SML2-CH-22">22. Security</A></H1><DIVCLASS="htmltoc"><P><B>Contents:</B><BR><ACLASS="sect1"HREF="#SML2-CH-22-SECT-1"TITLE="22.1 Why root?">Why root?</A><BR><ACLASS="sect1"HREF="ch22_02.htm"TITLE="22.2 The Environment">The Environment</A><BR><ACLASS="sect1"HREF="ch22_03.htm"TITLE="22.3 SMTP Probes">SMTP Probes</A><BR><ACLASS="sect1"HREF="ch22_04.htm"TITLE="22.4 The Configuration File">The Configuration File</A><BR><ACLASS="sect1"HREF="ch22_05.htm"TITLE="22.5 Permissions">Permissions</A><BR><ACLASS="sect1"HREF="ch22_06.htm"TITLE="22.6 The Aliases File">The Aliases File</A><BR><ACLASS="sect1"HREF="ch22_07.htm"TITLE="22.7 Forged Mail">Forged Mail</A><BR><ACLASS="sect1"HREF="ch22_08.htm"TITLE="22.8 Security Features">Security Features</A><BR><ACLASS="sect1"HREF="ch22_09.htm"TITLE="22.9 Pitfalls">Pitfalls</A></P><P></P></DIV><PCLASS="para"></P><PCLASS="para">The <EMCLASS="emphasis">sendmail</EM> program can be an open door to abuse. Unlessthe administrator is careful, the misuse or misconfigurationof <EMCLASS="emphasis">sendmail</EM> can lead to an insecure and possibly compromisedsystem.<ACLASS="indexterm"NAME="SML2-CH-22-IX-SECURITY"></A>Since <EMCLASS="emphasis">sendmail</EM> is usually installed to run as an <EMCLASS="emphasis">suidroot</EM> process, it is a prime target for intrusion.The &quot;Internet worm,&quot; for example, used a flaw in old versionsof <EMCLASS="emphasis">sendmail</EM> as one way to gain entry to thousands of machines.[1]If <EMCLASS="emphasis">sendmail</EM> is not properly installed,external probes over networks can be used to gain information that is valuablein attempting entry. Once inside, improper file permissionscan be used to trick <EMCLASS="emphasis">sendmail</EM> into giving away <EMCLASS="emphasis">root</EM> privilege.Even email cannot be trusted, and forged email can causesome users to give away their passwords.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[1] That flaw has been eliminated&nbsp;- wrongly by some vendors who turnedall debugging completely off correctly by most whosimply disabled SMTP debugging.</P></BLOCKQUOTE><PCLASS="para">In this chapter we present several ways to protect your site fromintrusion via <EMCLASS="emphasis">sendmail</EM>. Most are just good common sense, andthe experienced system administrator may be offended that we statethe obvious. But not all system administrators are experienced, andnot all who administer systems are system administrators.If you fall into the latter category, you may wish to keepkeep a good, general UNIX reference by your side to better appreciateour suggestions.&#13;</P><DIVCLASS="sect1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-22-SECT-1">22.1 Why root?</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-18073"></A><ACLASS="indexterm"NAME="AUTOID-18075"></A><ACLASS="indexterm"NAME="AUTOID-18078"></A>One common complaint about <EMCLASS="emphasis">sendmail</EM> centers on the factthat it must usually be run <EMCLASS="emphasis">suid root</EM> (that is, run as<EMCLASS="emphasis">root</EM> no matter who actually runs it). [2]But for the most part it is necessary for <EMCLASS="emphasis">sendmail</EM> to run as<EMCLASS="emphasis">root</EM> to satisfy the legitimate needs of users. Consider the following:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[2] Contrary to popular belief,<EMCLASS="emphasis">sendmail</EM> does not run as <EMCLASS="emphasis">root</EM> to handle local delivery(except that <EMCLASS="emphasis">sendmail</EM> can deliver directly to files when necessary,but that is not directly germane to this discussion).Local delivery is handled by delivery agents (such as <EMCLASS="emphasis">/bin/mail</EM>),which may run <EMCLASS="emphasis">suid root</EM> themselves (or <EMCLASS="emphasis">sgid mail</EM> as inSysV).</P></BLOCKQUOTE><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Users want <EMCLASS="emphasis">~/.forward</EM> files to work even when their home directory isset to mode 700.The <EMCLASS="emphasis">sendmail</EM> program requires <EMCLASS="emphasis">root</EM> privilegeso that it can temporarily become the user to read and process the <EMCLASS="emphasis">~/.forward</EM>file.</P></LI><LICLASS="listitem"><PCLASS="para">Users want <EMCLASS="emphasis">:include:</EM> mailing-list files readable only by themselves and<EMCLASS="emphasis">sendmail</EM>.The <EMCLASS="emphasis">sendmail</EM> program requires <EMCLASS="emphasis">root</EM> privilegeso that it can temporarily become the owner of the list.</P></LI><LICLASS="listitem"><PCLASS="para">Users want programs that run on their behalf to run as themselves.  Thisrequires <EMCLASS="emphasis">root</EM> privileges, and running as anything else would bepotentially very dangerous.</P></LI><LICLASS="listitem"><PCLASS="para">Users want <EMCLASS="emphasis">sendmail</EM> to listen on a TCP/IP port thatis common (port 25). The <EMCLASS="emphasis">sendmail</EM> program requires <EMCLASS="emphasis">root</EM> privilegeso that it can initiate a listening connection to its privileged port.</P></LI></UL><PCLASS="para">Some folks have been tempted to run <EMCLASS="emphasis">sendmail</EM> as an untrustedpseudo-user (such as <EMCLASS="emphasis">nobody</EM>). But this doesn't really work.For example, it causes programs in users' <EMCLASS="emphasis">~/.forward</EM> filesto be run as <EMCLASS="emphasis">nobody</EM>, and it requires the queue to be ownedby <EMCLASS="emphasis">nobody</EM>. Consequently, such a scheme allows any userto break into and modify the queue.[3]&#13;</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[3] But note that V8.8 <EMCLASS="emphasis">sendmail</EM> hasloosened the latter for use on firewall machines, where it won't complain aboutnon-<EMCLASS="emphasis">root</EM> <EMCLASS="emphasis">qf</EM> files if it is not running as <EMCLASS="emphasis">root</EM>.</P></BLOCKQUOTE><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-1-1">22.1.1 Test seteuid and setreuid</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-18130"></A><ACLASS="indexterm"NAME="AUTOID-18132"></A>Clearly, many of <EMCLASS="emphasis">sendmail</EM>'s duties require it to run as <EMCLASS="emphasis">root</EM>. As acorollary, however, whenever <EMCLASS="emphasis">sendmail</EM> does not need to be <EMCLASS="emphasis">root</EM>,it should become the appropriate nonprivileged user. It does this by usingthe following bit of logic:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">If it was compiled with support for <EMCLASS="emphasis">seteuid</EM>(3) (see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-55"TITLE="">Section 18.8.55, USESETEUID</A>),use that routine to set the effective <EMCLASS="emphasis">uid</EM> to that of the desired non-<EMCLASS="emphasis">root</EM>user. This is less preferred than the following:</P></LI><LICLASS="listitem"><PCLASS="para">If it was compiled with support for <EMCLASS="emphasis">setreuid</EM>(3) (see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-9"TITLE="">Section 18.8.9, HAS...</A>),use that routine to set the effective and real <EMCLASS="emphasis">uid</EM>s to those of the desired non-<EMCLASS="emphasis">root</EM> user.</P></LI><LICLASS="listitem"><PCLASS="para">Otherwise, use <EMCLASS="emphasis">setuid</EM>(3) to become the desired non-<EMCLASS="emphasis">root</EM> user.</P></LI></UL><PCLASS="para">Note that <EMCLASS="emphasis">setreuid</EM>(3) is preferred over <EMCLASS="emphasis">seteuid</EM>(3)[4]and <EMCLASS="emphasis">setuid</EM>(3)because it allows <EMCLASS="emphasis">sendmail</EM> to temporarily give away both itsreal and effective <EMCLASS="emphasis">root</EM>privilege, then to get it back again. To illustrate the need for this behavior,consider processing a mailing list that saves mail to two different files:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[4] Except when <EMCLASS="emphasis">seteuid</EM>(3) is Posix compliant. Old implementationsof <EMCLASS="emphasis">seteuid</EM>(3) didn't properly save the <EMCLASS="emphasis">uid</EM>; hence the preference,in that, case for <EMCLASS="emphasis">setreuid</EM>(3).</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/u/bill/archive        <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> owned by the user bill, mode 4600</I>/u/alice/archive       <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> owned by the user alice, mode 4600</I></PRE></BLOCKQUOTE></P><PCLASS="para">Further consider that these files both have permissions of <EMCLASS="emphasis">suid</EM> tothe individual users[5]and are writable only by the individual users.To perform delivery in this instance, <EMCLASS="emphasis">sendmail</EM> must[6]first become<EMCLASS="emphasis">bill</EM> (this requires <EMCLASS="emphasis">root</EM> privilege to do). When it isdone, <EMCLASS="emphasis">sendmail</EM> must become <EMCLASS="emphasis">root</EM> again so that it cannext become <EMCLASS="emphasis">alice</EM>. By retaining a real <EMCLASS="emphasis">uid</EM> of <EMCLASS="emphasis">root</EM>(with the <EMCLASS="emphasis">seteuid</EM>(3) routine), <EMCLASS="emphasis">sendmail</EM> is able tochange its effective <EMCLASS="emphasis">uid</EM> back and forth between users and<EMCLASS="emphasis">root</EM> as needed.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[5] When delivering to files, <EMCLASS="emphasis">sendmail</EM> will become the owner of the fileif that file's <EMCLASS="emphasis">suid</EM> bit is set and if no execute bits are set.</P><PCLASS="para">[6] We say &quot;must&quot; because in an NFS environment, <EMCLASS="emphasis">root</EM>is mapped to <EMCLASS="emphasis">nobody</EM> so, in that instance, even <EMCLASS="emphasis">root</EM> won't be able towrite to <EMCLASS="emphasis">bill</EM>'s files.</P></BLOCKQUOTE><PCLASS="para">See the description of the <EMCLASS="emphasis">test</EM> directory in <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-55"TITLE="">Section 18.8.55</A>for more on this subject.&#13;</P></DIV></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch21_06.htm"TITLE="21.6 Pitfalls"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 21.6 Pitfalls"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_02.htm"TITLE="22.2 The Environment"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.2 The Environment"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">21.6 Pitfalls</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">22.2 The Environment</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>