<HTML><HEAD><TITLE>[Chapter 22] 22.2 The Environment</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:28:47Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch22_01.htm"TITLE="22. Security"><LINKREL="prev"HREF="ch22_01.htm"TITLE="22.1 Why root?"><LINKREL="next"HREF="ch22_03.htm"TITLE="22.3 SMTP Probes"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_01.htm"TITLE="22.1 Why root?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.1 Why root?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 22<BR>Security</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_03.htm"TITLE="22.3 SMTP Probes"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.3 SMTP Probes"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-22-SECT-2">22.2 The Environment</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-18202"></A><ACLASS="indexterm"NAME="AUTOID-18204"></A><ACLASS="indexterm"NAME="AUTOID-18207"></A>As a general rule, programs should never trust their environment.Such trust can lead to exploitation that has grave security consequences.<ACLASS="indexterm"NAME="AUTOID-18210"></A>To illustrate, consider the often misused SunOS LD_LIBRARY_PATHenvironment variable. Programs that use shared libraries look at thisvariable to determine which shared library routines they should use and inwhat order they should load them.One form of attack against non-<EMCLASS="emphasis">suid</EM>programs (such as some delivery agents) is to modify the LD_LIBRARY_PATH variable (asin a user's <EMCLASS="emphasis">~/.forward</EM> file) to introduce Trojanhorse library routines in place of the real system's library routines.Certainly, <EMCLASS="emphasis">sendmail</EM> should not pass such variables to its delivery agents.</P><PCLASS="para">To improve security, V8 <EMCLASS="emphasis">sendmail</EM> began deleting variables fromits environment before passing them to its delivery agents. It removed theIFS variable to protect Bourne shell-script agents and all variablesbeginning with &quot;LD<CODECLASS="literal">_</CODE>&quot; to protect all delivery agentsfrom shared library attacks.</P><PCLASS="para">Beginning with V8.7, <EMCLASS="emphasis">sendmail</EM> now takes the opposite approach. Insteadof trying to second-guess attackers, it instead constructsthe delivery agent environment from scratch. In this scheme itdefines the AGENT variable as <CODECLASS="literal">sendmail</CODE>, and the TZ variable is as appropriate(see the <CODECLASS="literal">TimeZoneSpec</CODE> (<CODECLASS="literal">t</CODE>) option, <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-69"TITLE="">Section 34.8.69, TimeZoneSpec (t)</A>).Also, in support of operating systems that require them, it passesthe ISP and SYSTYPE variables from its own environment to thedelivery agent's environment.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-2-1">22.2.1 The E Configuration Command</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-18227"></A><ACLASS="indexterm"NAME="AUTOID-18229"></A>When <EMCLASS="emphasis">sendmail</EM> executes (runs) a delivery agent (see <ACLASS="xref"HREF="ch30_06.htm#SML2-CH-30-SECT-6-2"TITLE="The Child">Section 30.6.2, "The Child"</A>),it passes to that delivery agent an environment that includes only theitems described above.Some delivery agents, however, may require additional environmental variablesto function properly. For those special cases, <EMCLASS="emphasis">sendmail</EM> offers the<CODECLASS="literal">E</CODE> configuration command to set individual environment variablesthat will be passed to all delivery agents:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">E<CODECLASS="replaceable"><I>var</I></CODE>=<CODECLASS="replaceable"><I>value</I></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">The <CODECLASS="replaceable"><I>var</I></CODE> is the environment variable that will be either defined orredefined. It is immediately followed (with no intervening space) by anequal sign and then (again with no intervening space) by the <CODECLASS="replaceable"><I>value</I></CODE> that willbe assigned to it.</P><PCLASS="para">If the <CODECLASS="literal">=</CODE><CODECLASS="replaceable"><I>value</I></CODE> is missing, <EMCLASS="emphasis">sendmail</EM> looks up the variable <CODECLASS="replaceable"><I>var</I></CODE>in its environment and, if it is found, uses that value. If the <CODECLASS="literal">=</CODE> is presentbut the <CODECLASS="replaceable"><I>value</I></CODE> is absent, the <CODECLASS="replaceable"><I>var</I></CODE> is assigned an emptystring (a single zero byte). If the <CODECLASS="replaceable"><I>var</I></CODE> is missing,a variable name that is an empty string is used.</P><PCLASS="para">The <CODECLASS="replaceable"><I>var</I></CODE> is looked up to see whether it is already a part of the delivery agent'senvironment. If it is, it is redefined to be the new value. If it is not, it isadded to that list of variables. If that addition will cause the list to exceedMAXUSERENVIRON variables (as defined in <EMCLASS="emphasis">conf.h</EM>, see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-19"TITLE="">Section 18.8.19, MAX...</A>),the definition is silently ignored.</P><PCLASS="para">Whether or not the <CODECLASS="replaceable"><I>var</I></CODE> was added to, or updated in, the delivery agent'senvironment, it is always added or updated to <EMCLASS="emphasis">sendmail</EM>'s environmentwith <EMCLASS="emphasis">putenv</EM>(2). If this call fails, <EMCLASS="emphasis">sendmail</EM> logs and prints thefollowing message:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">setuserenv: putenv(<CODECLASS="replaceable"><I>var=value</I></CODE>) failed</PRE></BLOCKQUOTE></P><PCLASS="para">Only one <CODECLASS="replaceable"><I>var</I></CODE> may be defined per <CODECLASS="literal">E</CODE> command. Additional environmentvariables require multiple <CODECLASS="literal">E</CODE> commands.Each <CODECLASS="literal">E</CODE> command affects all delivery agents. There is no way to tune theenvironment on a per delivery agent basis.</P><PCLASS="para">For DG/UX under V8.7 <EMCLASS="emphasis">sendmail</EM> you will need to declare</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">E_FORCE_MAIL_LOCAL_=yes</PRE></BLOCKQUOTE></P><PCLASS="para">in your configuration file to enable <EMCLASS="emphasis">/bin/mail</EM> to work properly.Beginning with <EMCLASS="emphasis">V8.8</EM> <EMCLASS="emphasis">sendmail</EM>, this is already donein <EMCLASS="emphasis">cf/ostype/dgux.m4</EM>.&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_01.htm"TITLE="22.1 Why root?"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.1 Why root?"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_03.htm"TITLE="22.3 SMTP Probes"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.3 SMTP Probes"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">22.1 Why root?</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">22.3 SMTP Probes</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>