<HTML><HEAD><TITLE>[Chapter 22] 22.3 SMTP Probes</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:28:56Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch22_01.htm"TITLE="22. Security"><LINKREL="prev"HREF="ch22_02.htm"TITLE="22.2 The Environment"><LINKREL="next"HREF="ch22_04.htm"TITLE="22.4 The Configuration File"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_02.htm"TITLE="22.2 The Environment"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.2 The Environment"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 22<BR>Security</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_04.htm"TITLE="22.4 The Configuration File"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.4 The Configuration File"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-22-SECT-3">22.3 SMTP Probes</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-22-IX-SMTP-SIMPLE-MAIL-TRANSFER-PROTOCOL-SMTP-PROBES"></A>Although SMTP probes can be legitimate uses of the network, they canalso pose potential risks. They are sometimesused to see whether a bug remains unfixed. Sometimes they are usedto try to gather user login namesor to feed a program unexpected input in such a way that it breaks andgives away <EMCLASS="emphasis">root</EM> privilege.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-3-1">22.3.1 SMTP debug</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-18288"></A><ACLASS="indexterm"NAME="AUTOID-18290"></A><ACLASS="indexterm"NAME="AUTOID-18292"></A><ACLASS="indexterm"NAME="AUTOID-18294"></A><ACLASS="indexterm"NAME="AUTOID-18297"></A>An &quot;unfixed bug&quot; probe can use the SMTP <CODECLASS="literal">debug</CODE> and <CODECLASS="literal">showq</CODE> commands.The SMTP <CODECLASS="literal">debug</CODE> commandallows the local <EMCLASS="emphasis">sendmail</EM> to be placed into debugging mode(as with the <CODECLASS="literal">-d</CODE> command-line switch; see <ACLASS="xref"HREF="ch37_01.htm#SML2-CH-37-SECT-1"TITLE="The Syntax of -d">Section 37.1, "The Syntax of -d"</A>) from any other machineanywhere on the network. The SMTP <CODECLASS="literal">showq</CODE> command allows outsidersto view the contents of the mail queue.</P><PCLASS="para">If SMTPDEBUG (see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-42"TITLE="">Section 18.8.42, SMTPDEBUG</A>) is defined when <EMCLASS="emphasis">sendmail</EM> is compiled,the SMTP <EMCLASS="emphasis">debug</EM> and <EMCLASS="emphasis">showq</EM> commands are allowedto work; otherwise, they are disabled.SMTPDEBUG should be defined only when modifyingthe <EMCLASS="emphasis">sendmail</EM> code and testing a new version. It should neverbe defined in an official release of <EMCLASS="emphasis">sendmail</EM>. To see whether it hasbeen defined at your site, run the following command:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>telnet localhost 25</B></CODE>Trying 123.45.6.7 ...Connected to localhost.Escape character is '^]'.220 localhost sendmail 8.8.4 ready at Fri, 13 Dec 1996 06:36:12 -0800<CODECLASS="userinput"><B>debug</B></CODE>500 Command unrecognized<CODECLASS="userinput"><B>quit</B></CODE>221 localhost.us.edu closing connectionConnection closed by foreign host.%</PRE></BLOCKQUOTE></P><PCLASS="para">When connected, enter the command <CODECLASS="literal">debug</CODE>. If you get theanswer <CODECLASS="literal">500 Command unrecognized</CODE>, you know thatSMTPDEBUG is not enabled. If, on the other hand, you get the answer<CODECLASS="literal">200 Debug set</CODE>, SMTPDEBUG is defined on yoursystem, and you should immediately take steps to correct the situation.Either contact your vendor and request a new version of <EMCLASS="emphasis">sendmail</EM>,or get the <EMCLASS="emphasis">sendmail</EM> source and compile it with SMTPDEBUG undefined.</P><PCLASS="para">When SMTPDEBUG is undefined andan outsider connects to the local machine and attempts to execute the<CODECLASS="literal">debug</CODE> or <CODECLASS="literal">showq</CODE> commands,<EMCLASS="emphasis">sendmail</EM> will <EMCLASS="emphasis">syslog</EM>(3) a message like the following:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Jul 22 07:09:00 here.domain sendmail[192]: &quot;debug&quot; command from there.domain       (123.45.67.89)</PRE></BLOCKQUOTE></P><PCLASS="para">This message shows the name of the machine that attempts the probe, or (<EMCLASS="emphasis">there.domain</EM>), andthe IP address of that machine. Note that this message is logged only if the<CODECLASS="literal">LogLevel</CODE> (<CODECLASS="literal">L</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-33"TITLE="">Section 34.8.33, LogLevel (L)</A>) is nonzero.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-3-2">22.3.2 SMTP vrfy and expn</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-18339"></A><ACLASS="indexterm"NAME="AUTOID-18341"></A><ACLASS="indexterm"NAME="AUTOID-18344"></A><ACLASS="indexterm"NAME="AUTOID-18347"></A><ACLASS="indexterm"NAME="AUTOID-18349"></A><ACLASS="indexterm"NAME="AUTOID-18352"></A>You may be dismayed to learn that the login names of ordinary userscan be used to break into a system.It is not, for example, all that unusual for a user to select a passwordthat is simply a copy of his or her login name, first name, last name, or some combination of initials. A risk of attack can arisefrom outsiders guessing login names. Any that they find can be used to try tobreak in, and the SMTP <CODECLASS="literal">vrfy</CODE> gives an attacker the means to discoverlogin names.</P><PCLASS="para">The SMTP <CODECLASS="literal">vrfy</CODE> command causes <EMCLASS="emphasis">sendmail</EM> toverify that it will accept an address for delivery. If a user's login name is given,the full name and login name are printed:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><CODECLASS="userinput"><B>vrfy george</B></CODE>250 George Washington &lt;george@wash.dc.gov&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the 250 SMTP reply code (see RFC821) means a successful verification.[7]If the user is unknown, however, <EMCLASS="emphasis">sendmail</EM> says so:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[7] See the <CODECLASS="literal">F=q</CODE> flag(<ACLASS="xref"HREF="ch30_08.htm#SML2-CH-30-SECT-8-36"TITLE="">Section 30.8.36, F=q</A>) for a way and reason tochange this SMTP reply code to 252.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><CODECLASS="userinput"><B>vrfy foo</B></CODE>550 foo... User unknown</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-18372"></A>The SMTP <EMCLASS="emphasis">expn</EM> command is similar to the <CODECLASS="literal">vrfy</CODE> command,except that in the case of a mailing list, it will show all the members of that list.The SMTP <EMCLASS="emphasis">expn</EM> command causes <EMCLASS="emphasis">sendmail</EM> toexpand (show all the recipients) of an address.To illustrate the risk, consider thatmany sites have aliases that include all or a large segment ofusers. Such aliases often have easily guessed names, such as <EMCLASS="emphasis">all</EM>, <EMCLASS="emphasis">everyone</EM>, or <EMCLASS="emphasis">staff</EM>. A probe of <EMCLASS="emphasis">all</EM>, for example,might produce something like the following:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><CODECLASS="userinput"><B>expn all</B></CODE>250-George Washington &lt;george@wash.dc.gov&gt;250-Thomas Jefferson &lt;tj@wash.dc.gov&gt;250-Ben Franklin &lt;ben@here.us.edu&gt;250-Betsy Ross &lt;msflag@ora.com&gt;250 John Q. Public &lt;jqp@aol.com&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">With well-designed passwords these full and login names can safelybe given to the world at large. But if one user (say <CODECLASS="literal">jqp</CODE>)has a poorly designed password (such as <EMCLASS="emphasis">jqpublic</EM>), your site'ssecurity can easily be compromised.[8]Note that not all uses of <CODECLASS="literal">vrfy</CODE> or <EMCLASS="emphasis">expn</EM>represent probes. Some MUAs,[9]for example, routinely <CODECLASS="literal">vrfy</CODE> each recipient before sending a message.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[8] The <EMCLASS="emphasis">fingerd</EM>(8) utility can also reveal login IDs. <ACLASS="indexterm"NAME="AUTOID-18392"></A></P><PCLASS="para">[9] The GNU <EMCLASS="emphasis">fingerd</EM>(8) daemon also uses <CODECLASS="literal">vrfy</CODE> to providemailbox information.</P></BLOCKQUOTE><PCLASS="para">SMTP <CODECLASS="literal">vrfy</CODE> and <CODECLASS="literal">expn</CODE> commands are individuallylogged in a form like one of the following:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Sep 22 11:40:43 yourhost sendmail[pid]: other.host: vrfy allSep 22 11:40:43 yourhost sendmail[pid]: [222.33.44.55]: vrfy allSep 22 11:40:43 yourhost sendmail[pid]: other.host: expn allSep 22 11:40:43 yourhost sendmail[pid]: [222.33.44.55]: expn all</PRE></BLOCKQUOTE></P><PCLASS="para">This shows that someone from the outside (<CODECLASS="literal">other.host</CODE> in thefirst and third examples)attempted to probe for usernames in the mailing list named <CODECLASS="literal">all</CODE>.In the second and last examples the probing hostname could not be found, so the IPaddress is printed instead (in the square brackets).Note that this form of logging is enabled only if the<CODECLASS="literal">LogLevel</CODE> (<CODECLASS="literal">L</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-33"TITLE="">Section 34.8.33</A>)is greater than 5.</P><PCLASS="para">Pre-V8 versions of <EMCLASS="emphasis">sendmail</EM> do not report SMTP<CODECLASS="literal">vrfy</CODE> or <CODECLASS="literal">expn</CODE> attempts at all. Some versions of <EMCLASS="emphasis">sendmail</EM> (such asthe HP_UX version) appearto verify but really only echo the address stated.</P><PCLASS="para">V8 <EMCLASS="emphasis">sendmail</EM> allows <EMCLASS="emphasis">vrfy</EM> and <EMCLASS="emphasis">expn</EM> services to beselectively accepted or rejected on the basis of the setting ofthe  <CODECLASS="literal">PrivacyOptions</CODE> (<CODECLASS="literal">p</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-47"TITLE="">Section 34.8.47, PrivacyOptions (p)</A>).For best security we recommend this setting:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O PrivacyOptions=goaway</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-18427"></A></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_02.htm"TITLE="22.2 The Environment"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.2 The Environment"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_04.htm"TITLE="22.4 The Configuration File"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.4 The Configuration File"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">22.2 The Environment</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">22.4 The Configuration File</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>