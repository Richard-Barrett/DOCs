<HTML><HEAD><TITLE>[Chapter 22] 22.7 Forged Mail</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:29:58Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch22_01.htm"TITLE="22. Security"><LINKREL="prev"HREF="ch22_06.htm"TITLE="22.6 The Aliases File"><LINKREL="next"HREF="ch22_08.htm"TITLE="22.8 Security Features"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_06.htm"TITLE="22.6 The Aliases File"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.6 The Aliases File"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 22<BR>Security</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_08.htm"TITLE="22.8 Security Features"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.8 Security Features"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-22-SECT-7">22.7 Forged Mail</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19244"></A><ACLASS="indexterm"NAME="AUTOID-19246"></A><ACLASS="indexterm"NAME="AUTOID-19249"></A>Although they are aware that paper mail can be forged, most usersare blissfully unaware that email can also be forged.Forged mail can lead to a serious breach of security.Two points of vulnerability that require particular attention arethe queue file and the SMTP interface of <EMCLASS="emphasis">sendmail</EM>.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-7-1">22.7.1 Forging with the Queue Directory</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19256"></A>All versions of <EMCLASS="emphasis">sendmail</EM>trust the files in the mail queue. They assume that only <EMCLASS="emphasis">sendmail</EM>has placed files there. As a consequence, a poorly protected queuedirectory can allow the attacker to create mail that looks 100 percentauthentic. This can be used to send forged mail, to append to system critical files,or to run arbitrary programs as <EMCLASS="emphasis">root</EM> or other users.Consider the following bogus <EMCLASS="emphasis">qfAA00001</EM> filefor sending forged mail (<EMCLASS="emphasis">qf</EM> files are described in <ACLASS="xref"HREF="ch23_09.htm"TITLE="The qf File Internals">Section 23.9, "The qf File Internals"</A>):</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">V1T829313834P943442$_root@yourhostS&lt;root@yourhost&gt;RPFD:george@yourhostH?P?return-path: &lt;root@yourhost&gt;Hmessage-id: &lt;199604121257.GAA12601@yourhost&gt;HFrom: root@yourhostHDate: Fri, 13 Dec 1996 05:47:46 -0700HTo: george@yourhostHSubject: Change your Password Now!!</PRE></BLOCKQUOTE></P><PCLASS="para">This <CODECLASS="literal">qf</CODE> file causes mail to be sent to <EMCLASS="emphasis">george</EM> that appearsin all ways to come from <EMCLASS="emphasis">root</EM>. There is nothing in this <CODECLASS="literal">qf</CODE> file to indicateto the recipient (or to <EMCLASS="emphasis">sendmail</EM>) that the message is not authentic.Now further suppose that the <CODECLASS="literal">df</CODE> file (the message body) containsthe following text:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">The system has been compromised. Change your password NOW!Your new password must be:                           Fuzz7balThank you,        -System Administration</PRE></BLOCKQUOTE></P><PCLASS="para">Unfortunately, in any large organization there will be more than a fewusers who will obey a message like this. They will gladly change theirpassword to one assigned to them, thereby providing the attacker witheasy access to their accounts.</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The queue directory must be owned by <EMCLASS="emphasis">root</EM> and writable onlyby <EMCLASS="emphasis">root</EM>. CERT recommends that the queuedirectory always be mode 0700.</P></LI><LICLASS="listitem"><PCLASS="para">The queue files placed into the queue by <EMCLASS="emphasis">sendmail</EM> must be wellprotected by defining narrow default permissions with the<CODECLASS="literal">TempFileMode</CODE> (<CODECLASS="literal">F</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-68"TITLE="">Section 34.8.68, TempFileMode (F)</A>).A default of 0600 is best.</P></LI></UL><PCLASS="para"></P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-7-2">22.7.2 Forging with SMTP</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19292"></A>We won't illustrate the SMTP interaction here. But notethat anyone can connect to your local <EMCLASS="emphasis">sendmail</EM> via<EMCLASS="emphasis">telnet</EM>(1) at port 25 or run <EMCLASS="emphasis">sendmail</EM> withthe <CODECLASS="literal">-bs</CODE> command-line switch. Once connected, <EMCLASS="emphasis">sendmail</EM> mustof necessity believe everything it receives. The onlyexception is the hostname sent in the HELO message.[17]In that case the <EMCLASS="emphasis">sendmail</EM>program looks up the real hostname based on the connection. Ifthe stated hostname and the real hostname differ, the falsename is used as the name of the sending host with the real nameadded in parentheses:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[17] V8 <EMCLASS="emphasis">sendmail</EM> also tries to verify the connection itselfwith <EMCLASS="emphasis">identd</EM> if possible.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">550 your.host hello false.host (real.host), pleased to meet you</PRE></BLOCKQUOTE></P><PCLASS="para">The real hostname is then used as the sending hostname in the constructionof all headers. The result (the header and body received by the user) mightlook something like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">From root@false.host Dec 13 14:36:40 1996Received: from real.host by your.host (8.8.4/8.8.4)        id AA00998; Fri, 13 Dec 1996 14:36:38 -0700Message-Id: &lt;9612213133.GAA05059@your.host&gt;From: root@false.host (System Administration)To: you@your.hostSubject: Change your password now!Date: Fri, 13 Dec 1996 05:47:46 -0700To improve security at our location you are requested to immediatelychange your password. The password you have been assigned is:        7Fuzzy1'sThank you,        -root</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19311"></A>Fortunately, the <CODECLASS="literal">Received:</CODE> header above contains the name of the real host (which is not alwaysthe case). An attentive usercan tell that this is a forged message because the host in thatheader line differs from the false hostname used in the other headerlines.</P><PCLASS="para">However, most mail-reading programs allow users to filter out(prevent your seeing) uninteresting header lines.[18]Typically, users chooseto ignore headers such as <CODECLASS="literal">Received:</CODE> and <CODECLASS="literal">Message-ID:</CODE>.For such users the task of detecting forged mail is much more difficult.Instead of seeing the above message, with real hostnames, they mightsee the following with only false names:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[18] In fact, the <EMCLASS="emphasis">gnu-emacs</EM>(1) mail reader deletes those linesirrevocably.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">From root@false.host Dec 13 14:36:40 1996From: root@false.host (System Administration)To: you@your.hostSubject: Change your password now!Date:  Fri, 13 Dec 1996 14:36:38 -0700To improve security at our location you are requested to immediatelychange your password. The password you have been assigned is:        7Fuzzy1'sThank you,        -root</PRE></BLOCKQUOTE></P><PCLASS="para">Clearly, a user who sees only this much of the mail message will be morelikely to believe that it is real.</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Educate your users that mail can be forged. Teach them what to lookfor when they receive a message of questionable authenticity.</P></LI><LICLASS="listitem"><PCLASS="para">Rarely, if ever, send mail as <EMCLASS="emphasis">root</EM>. Always communicate asyourself and always use a distinctive style of writing. If usersnever see mail from <EMCLASS="emphasis">root</EM>, they will be more likely to questionsuch mail when it arrives.</P></LI><LICLASS="listitem"><PCLASS="para">Train users to never send (or ask to receive) clear-text passwordsor other security-related information by email.</P></LI></UL><PCLASS="para"></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_06.htm"TITLE="22.6 The Aliases File"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.6 The Aliases File"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_08.htm"TITLE="22.8 Security Features"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.8 Security Features"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">22.6 The Aliases File</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">22.8 Security Features</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>