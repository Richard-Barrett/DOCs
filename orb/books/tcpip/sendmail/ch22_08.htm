<HTML><HEAD><TITLE>[Chapter 22] 22.8 Security Features</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:30:05Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch22_01.htm"TITLE="22. Security"><LINKREL="prev"HREF="ch22_07.htm"TITLE="22.7 Forged Mail"><LINKREL="next"HREF="ch22_09.htm"TITLE="22.9 Pitfalls"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_07.htm"TITLE="22.7 Forged Mail"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.7 Forged Mail"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 22<BR>Security</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_09.htm"TITLE="22.9 Pitfalls"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.9 Pitfalls"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-22-SECT-8">22.8 Security Features</A></H2><PCLASS="para">We now turn our attention from security problems to securityfeatures:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The <CODECLASS="literal">T</CODE> configuration command (class <CODECLASS="literal">t</CODE>)defines which users are allowed to use the <CODECLASS="literal">-f</CODE>command-line switch to override the sender address with one of their own.</P></LI><LICLASS="listitem"><PCLASS="para">The <EMCLASS="emphasis">smrsh</EM> program replaces <EMCLASS="emphasis">/bin/sh</EM> as the program run by the<CODECLASS="literal">prog</CODE> delivery agent to execute programs.</P></LI><LICLASS="listitem"><PCLASS="para">Several options can be used to tighten security and to provide reportsof security violations.</P></LI><LICLASS="listitem"><PCLASS="para">The <EMCLASS="emphasis">/etc/shells</EM> file prevents ordinary users from running programson your mail server.</P></LI></UL><PCLASS="para"></P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-8-1">22.8.1 Trusted Users</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19357"></A><ACLASS="indexterm"NAME="AUTOID-19359"></A><ACLASS="indexterm"NAME="AUTOID-19361"></A><ACLASS="indexterm"NAME="AUTOID-19364"></A><ACLASS="indexterm"NAME="AUTOID-19367"></A><ACLASS="indexterm"NAME="AUTOID-19370"></A>Under pre-V8 <EMCLASS="emphasis">sendmail</EM>,trusted users are those who are allowed to use the <CODECLASS="literal">-f</CODE>command-line switch (see <ACLASS="xref"HREF="ch36_07.htm#SML2-CH-36-SECT-7-21"TITLE="">Section 36.7.21, -f and -r</A>) to override thesender address with one of their own.V8.1 <EMCLASS="emphasis">sendmail</EM> eliminated this configuration command.V8.7 restored it, but as a class, and uses that class only to suppress warning headers.</P><PCLASS="para">Trusted users are necessary for certain kinds of mail to flow properly.By way of example, the <EMCLASS="emphasis">rmail</EM>(8) program of the UUCP suite ofprograms runs <EMCLASS="emphasis">suid</EM> to <EMCLASS="emphasis">uucp</EM>. If <EMCLASS="emphasis">rmail</EM> were not to use the <CODECLASS="literal">-f</CODE>command-line switch, all mail from UUCP wouldwrongly appear to come from the <EMCLASS="emphasis">uucp</EM> user.To circumvent this problem, <EMCLASS="emphasis">rmail</EM> runs <EMCLASS="emphasis">sendmail</EM> as</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/usr/lib/sendmail -f <EMCLASS="emphasis">reallyfrom</EM></PRE></BLOCKQUOTE></P><PCLASS="para">This tells <EMCLASS="emphasis">sendmail</EM> to show, in both the header and envelope,the message as being from <EMCLASS="emphasis">reallyfrom</EM>, rather than from<EMCLASS="emphasis">uucp</EM>.</P><PCLASS="para">The concept of a trusted user is intended to prevent ordinary usersfrom changing the sender address and thereby forging mail.Although that intention is laudable and good for UUCP, it can cause problemswith mailing lists. Consider the following:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">list: &quot;|/usr/lib/sendmail -oi -flist-request -odi list-real&quot;list-real:    :include:/export/share/mail-lists/list.list</PRE></BLOCKQUOTE></P><PCLASS="para">The intention here is for all mail sent to the mailing list named <CODECLASS="literal">list</CODE>to be dispatched as though it were sent fromthe address <CODECLASS="literal">list-request</CODE> (the <CODECLASS="literal">-f</CODE>).This causes errors to be returned to the maintainer of the list(the <CODECLASS="literal">list-request</CODE>), but replies still go to the real sender.</P><PCLASS="para">Unfortunately, this scheme fails when mail is posted to <CODECLASS="literal">list</CODE>from the local machine. Recall that only trusted users can changethe identity of the sender with <CODECLASS="literal">-f</CODE>. This is whyV8.1 <EMCLASS="emphasis">sendmail</EM> eliminated the concept of the trusted user(anyone could use the <CODECLASS="literal">-f</CODE> switch).Beginning with V8.7, <EMCLASS="emphasis">sendmail</EM> restored the concept but uses the <CODECLASS="literal">T</CODE> command only to suppress warning headers.&#13;</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-22-SECT-8-1-1">22.8.1.1 Declare trusted users (not V8.1 through V8.6)</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19410"></A>Trusted users are defined by those lines in the <EMCLASS="emphasis">sendmail.cf</EM> file that begin with the uppercase letter <CODECLASS="literal">T</CODE>.Only trusted users may use the<EMCLASS="emphasis">sendmail</EM> program's <CODECLASS="literal">-f</CODE> command-lineswitch to specify who sent the message.Beginning with V8.7 <EMCLASS="emphasis">sendmail</EM>, the class <CODECLASS="literal">t</CODE>may also be used.</P><PCLASS="para">The <CODECLASS="literal">T</CODE> <EMCLASS="emphasis">sendmail.cf</EM> command must begin a line. One or morespace-delimited usernames then follow on that same line. Theremay be multiple <CODECLASS="literal">T</CODE> commands in a <EMCLASS="emphasis">sendmail.cf</EM> file, each<EMCLASS="emphasis">adding</EM> names to the list of trusted users. Prior to V8 there could be at most<CODECLASS="literal">MAXTRUST</CODE> trusted users, where <CODECLASS="literal">MAXTRUST</CODE> was definedin <EMCLASS="emphasis">conf.h</EM> when you compiled <EMCLASS="emphasis">sendmail</EM>. Beginning with V8.7, thereis no limit:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">T uucp                   <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> legal in V8.1 through V8.6 but ignored</I>Troot daemon             <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> legal in V8.1 through V8.6 but ignored</I>Ct uucp                  <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> V8.7 and above</I>Ctroot daemon            <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> V8.7 and above</I></PRE></BLOCKQUOTE></P><PCLASS="para">The two <CODECLASS="literal">T</CODE> commands show that there may optionally be whitespacebetween the <CODECLASS="literal">T</CODE> and the first name in any list of names.They indicate that <EMCLASS="emphasis">uucp</EM>, <EMCLASS="emphasis">root</EM>, and <EMCLASS="emphasis">daemon</EM> aretrusted and have been added to the list of trusted users inthat order. The two class declarations show a similar declarationfor use beginning with V8.7 <EMCLASS="emphasis">sendmail</EM> (but note that V8.7 and abovecan still use the old syntax).</P><PCLASS="para">Prior to V8 <EMCLASS="emphasis">sendmail</EM>, if you listed more than <CODECLASS="literal">MAXTRUST</CODE> trusted users,<EMCLASS="emphasis">sendmail</EM> printed and <EMCLASS="emphasis">syslog</EM>(3)'ed a message like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">sendmail: too many T lines, 32 max</PRE></BLOCKQUOTE></P><PCLASS="para">This message was not fatal. The <EMCLASS="emphasis">sendmail</EM> program issuedit for each excess <CODECLASS="literal">T</CODE> line (ignored those trusted users)and continued to run.</P><PCLASS="para">Prior to V8 <EMCLASS="emphasis">sendmail</EM>, if a user who was not trusted attempted to use the <CODECLASS="literal">-f</CODE>switch, that attempt was silently ignored (silently disallowed).Beginning with V8.7 <EMCLASS="emphasis">sendmail</EM>, if a user who is not trusted attempts to usethe <CODECLASS="literal">-f</CODE> switch, that attempt may produce an <CODECLASS="literal">X-Authentication-Warning:</CODE>header (see <ACLASS="xref"HREF="ch35_10.htm#SML2-CH-35-SECT-10-35"TITLE="">Section 35.10.35, X-Authentication-Warning:</A>)if the <CODECLASS="literal">PrivacyOptions</CODE> (<CODECLASS="literal">p</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-47"TITLE="">Section 34.8.47</A>) has<CODECLASS="literal">authwarnings</CODE> listed.</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19467"></A>Even though some users find them annoying, we recommend that you always enable<CODECLASS="literal">X-Authentication-Warning:</CODE> headers. They warn of suspicious behavior.If the behavior is legitimate, modify that behavior to eliminate theheader instead of eliminating the more valuable warning headers.</P></LI></UL><PCLASS="para"></P></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-8-2">22.8.2 The smrsh Program</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19474"></A><ACLASS="indexterm"NAME="AUTOID-19476"></A>One line of attack against all users, including <EMCLASS="emphasis">root</EM>, is to modifya user's <EMCLASS="emphasis">~/.forward</EM> file (see <ACLASS="xref"HREF="ch22_05.htm#SML2-CH-22-SECT-5-3"TITLE="Permissions for ~/.forward Files">Section 22.5.3, "Permissions for ~/.forward Files"</A>).Unless you take steps to prevent it, <EMCLASS="emphasis">sendmail</EM> will run any programthat it finds in a user's <EMCLASS="emphasis">~/.forward</EM> file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">\user|&quot;/usr/ucb/vacation user&quot;                                    <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> ok</I>|&quot;/tmp/x.sh&quot;                                                 <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> An attack!</I>|&quot;cp /bin/sh /home/george/.x; chmod u+s /home/george/.x&quot;     <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> An attack!</I></PRE></BLOCKQUOTE></P><PCLASS="para">As an aid in preventing such attacks, V8 <EMCLASS="emphasis">sendmail</EM> offersthe <EMCLASS="emphasis">smrsh</EM> (<BCLASS="emphasis.bold">s</B>end<BCLASS="emphasis.bold">m</B>ail <BCLASS="emphasis.bold">r</B>estricted <BCLASS="emphasis.bold">sh</B>ell) program,and V8.7 <EMCLASS="emphasis">sendmail</EM> offers the <CODECLASS="literal">smrsh</CODE> FEATURE (see <ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-22"TITLE="">Section 19.6.22, FEATURE(smrsh)</A>)as an easy way to install <EMCLASS="emphasis">smrsh</EM> with the <EMCLASS="emphasis">m4</EM> configuration technique.</P><PCLASS="para">The <EMCLASS="emphasis">smrsh</EM> program is supplied in source form with the <EMCLASS="emphasis">sendmail</EM>distribution in the <EMCLASS="emphasis">smrsh</EM> directory. The <EMCLASS="emphasis">README</EM> file in that directorydescribes how to compile and install <EMCLASS="emphasis">smrsh</EM>.</P><PCLASS="para">The <EMCLASS="emphasis">smrsh</EM> program replaces the <EMCLASS="emphasis">/bin/sh</EM> program in the <CODECLASS="literal">prog</CODE>delivery agent (see <ACLASS="xref"HREF="ch30_02.htm#SML2-CH-30-SECT-2-1"TITLE="Required Symbolic Names">Section 30.2.1, "Required Symbolic Names"</A>) declaration:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Mprog, P=<CODECLASS="userinput"><B>/usr/local/etc/smrsh</B></CODE>, ...</PRE></BLOCKQUOTE></P><PCLASS="para">Thereafter, whenever <EMCLASS="emphasis">smrsh</EM> is called to run a program, <EMCLASS="emphasis">smrsh</EM>strips the leading path from the program name and looks for that programin its special <EMCLASS="emphasis">/usr/adm/sm.bin</EM> directory. If the program is notfound in that directory, the message bounces. Thus in our first attack example above,with <EMCLASS="emphasis">smrsh</EM> installed and with <EMCLASS="emphasis">x.sh</EM> not in the <EMCLASS="emphasis">/usr/adm/sm.bin</EM> directory,the <EMCLASS="emphasis">~/.forward</EM> line</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">|&quot;/tmp/x.sh&quot;</PRE></BLOCKQUOTE></P><PCLASS="para">would cause the email message to bounce with this error:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">smrsh: /usr/adm/sm.bin/x.sh: not found</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19529"></A>The <EMCLASS="emphasis">smrsh</EM> program also screens out program lines that containsuspicious characters (such as our second attack above):</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">|&quot;cp /bin/sh /home/george/.x; chmod u+s /home/george/.x&quot;</PRE></BLOCKQUOTE></P><PCLASS="para">In this instance, <EMCLASS="emphasis">smrsh</EM> would reject the command line (and thusbounce the message) because it contained a semicolon character:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">smrsh: cannot use ; in command</PRE></BLOCKQUOTE></P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">The <EMCLASS="emphasis">smrsh</EM> program is simple yet immensely valuable. We recommendthat it be routinely installed on all your machines.</P></LI><LICLASS="listitem"><PCLASS="para">Be veryconservative when choosing programs to put in the <EMCLASS="emphasis">/usr/adm/sm.bin</EM> directory.Never, for example, put programs there that allow shell escapes.</P></LI></UL><PCLASS="para"></P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-8-3">22.8.3 Security Options</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-22-IX-OPTIONS-SENDMAIL-SECURITY"></A>The <EMCLASS="emphasis">sendmail</EM> program offers several options that can help you to improvethe security at your site. Some we have discussed above.We touch on a few more in this section, and providea recommended setting where appropriate. For a full description of each, see the sections referenced.&#13;</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-22-SECT-8-3-1">22.8.3.1 The DefaultUser option</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19556"></A><ACLASS="indexterm"NAME="AUTOID-19558"></A><ACLASS="indexterm"NAME="AUTOID-19561"></A><ACLASS="indexterm"NAME="AUTOID-19564"></A>The <CODECLASS="literal">DefaultUser</CODE> (<CODECLASS="literal">u</CODE>) option (see<ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-15"TITLE="">Section 34.8.15</A>) can be used to ensure that the defaultidentity (when it is not running as <EMCLASS="emphasis">root</EM>) is a safe one.  CERTrecommends that you create a pseudo-user whose <EMCLASS="emphasis">uid</EM> and <EMCLASS="emphasis">gid</EM>are used nowhere on your system, then define the <CODECLASS="literal">DefaultUser</CODE>(<CODECLASS="literal">u</CODE>) option to be that pseudo-user.  As an additionalprecaution, make sure that pseudo-user lacks a valid shell and has novalid home directory:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">nullmail:*:32765:32765:Sendmail Default User:/no/such/directory:/bin/false</PRE></BLOCKQUOTE></P><PCLASS="para">At the same time, set up a group entry for this user's group:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">nullgroup:*:32765:</PRE></BLOCKQUOTE></P><PCLASS="para">This is necessary if you want to refer to this group symbolically at some later time.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19582"></A>Avoid using the name <EMCLASS="emphasis">nobody</EM>, because <EMCLASS="emphasis">root</EM> is mapped to<EMCLASS="emphasis">nobody</EM> over NFS. If <EMCLASS="emphasis">root</EM> were to create a file overNFS that it thought was safe because <EMCLASS="emphasis">root</EM> owned it andbecause it was readable only by <EMCLASS="emphasis">root</EM>, that <EMCLASS="emphasis">root</EM> user wouldbe surprised to find that file owned by <EMCLASS="emphasis">nobody</EM>. Consequently, werecommend that in an NFS environment you set the default user toone less than <EMCLASS="emphasis">nobody</EM>. For example, if <EMCLASS="emphasis">nobody</EM> has the <EMCLASS="emphasis">uid</EM>65534, you could set up</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">nullmail:*:65533:65533:Sendmail Default User:/no/such/directory:/bin/false</PRE></BLOCKQUOTE></P><PCLASS="para"></P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-22-SECT-8-3-2">22.8.3.2 The ForwardPath option</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19601"></A><ACLASS="indexterm"NAME="AUTOID-19603"></A><ACLASS="indexterm"NAME="AUTOID-19606"></A>The <CODECLASS="literal">ForwardPath</CODE> (<CODECLASS="literal">J</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-27"TITLE="">Section 34.8.27, ForwardPath (J)</A>) lists a seriesof directories that <EMCLASS="emphasis">sendmail</EM> will search for user <EMCLASS="emphasis">~/.forward</EM> files.At most sites there are users who are savvy and able to correctly administertheir own <EMCLASS="emphasis">~/.forward</EM> files, but there are others who areuntrained or careless. One way to allow experienced users use of the <EMCLASS="emphasis">~/.forward</EM> facility while denying it to the others is with the<CODECLASS="literal">ForwardPath</CODE> (<CODECLASS="literal">J</CODE>) option:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O ForwardPath=/usr/local/etc/forwards/$u.forward:$z/.forward</PRE></BLOCKQUOTE></P><PCLASS="para">Here, <EMCLASS="emphasis">sendmail</EM> will first search the <EMCLASS="emphasis">/usr/local/etc/forwards</EM> directoryto find a file that begins with the user's login name (the <CODECLASS="literal">$u</CODE> see <ACLASS="xref"HREF="ch31_10.htm#SML2-CH-31-SECT-10-36"TITLE="">Section 31.10.36, $u</A>)followed by a <EMCLASS="emphasis">.forward</EM>. If you set up such a file for the untrained user, say <EMCLASS="emphasis">bob</EM>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">-rw-r-r-  1 root  system   0 Dec 13  1996  /usr/local/etc/forwards/bob.forward</PRE></BLOCKQUOTE></P><PCLASS="para">and if that file is empty, <EMCLASS="emphasis">bob</EM>'s mail will always be delivered locally, no matterwhat <EMCLASS="emphasis">bob</EM> puts in his <EMCLASS="emphasis">~/.forward</EM> file.For experienced users you can omit their files from the <EMCLASS="emphasis">/usr/local/etc/forwards</EM>directory, thus enabling their use of their /<EMCLASS="emphasis">.forward</EM> files.&#13;</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-22-SECT-8-3-3">22.8.3.3 The LogLevel option</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19638"></A>The <EMCLASS="emphasis">sendmail</EM> program normally logs a great deal of useful information via <EMCLASS="emphasis">syslog</EM> (see <ACLASS="xref"HREF="ch26_01.htm#SML2-CH-26-SECT-1-1"TITLE="syslog(3)">Section 26.1.1, "syslog(3)"</A>).There will be times, however, whenthe normal amount of information is insufficient. Consider, for example,that some outsider is using your site to forge mail. Since thisis done over an SMTP connection, it would be handy to haveboth sides of all SMTP conversations logged.You can do this with the <CODECLASS="literal">LogLevel</CODE> (<CODECLASS="literal">L</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-33"TITLE="">Section 34.8.33</A>):</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O LogLevel=12      <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> V8.8 and above to log SMTP</I></PRE></BLOCKQUOTE></P><PCLASS="para">Beginning with V8.8 <EMCLASS="emphasis">sendmail</EM>, a level of 12 causes both sides of every SMTP conversation to be logged. Thatlogging looks very similar to the logging produced by verbose mode (see <ACLASS="xref"HREF="ch04_02.htm"TITLE="Verbose (-v)">Section 4.2, "Verbose (-v)"</A>).</P><PCLASS="para">&#13;Note that after changing the log level in your configuration file you will need to restartthe daemon. With V8.7 and above <EMCLASS="emphasis">sendmail</EM> you restart the daemon like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># <CODECLASS="userinput"><B>kill -HUP `head -1 /etc/sendmail.pid`</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">Be aware that a log level of 12 produces a huge amount of output. Be preparedto prune your log files more often than usual.&#13;</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-22-SECT-8-3-4">22.8.3.4 The PostmasterCopy option</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19661"></A><ACLASS="indexterm"NAME="AUTOID-19663"></A><ACLASS="indexterm"NAME="AUTOID-19666"></A>The <CODECLASS="literal">PostmasterCopy</CODE> (<CODECLASS="literal">P</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-46"TITLE="">Section 34.8.46, PostmasterCopy (P)</A>)causes a copy of every bounced message to be delivered to a named user.Usually, that user is the person who handle email problems. But sinceclumsy intrusion attempts can result in bounced mail, there will betimes when bounced mail should also be delivered to thesecurity administrator. Consider the following:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">--- Transcript of session follows ---... while talking to your.site.domain.:&gt;&gt;&gt; RCPT To:&lt;root@your.site.domain&gt;&lt;&lt;&lt; 550 cannot open /tmp/.../getshell: No such file or directory550 cannot open /tmp/.../getshell: No such file or directory</PRE></BLOCKQUOTE></P><PCLASS="para">This bounced mail message indicates that someone tried to become<EMCLASS="emphasis">root</EM> by breaking through your <EMCLASS="emphasis">aliases</EM> database.</P><PCLASS="para">Users are added to the list of those who get copies of bouncedmessages with the <CODECLASS="literal">PostmasterCopy</CODE> (<CODECLASS="literal">P</CODE>) option:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O PostmasterCopy=postmaster<CODECLASS="userinput"><B>,securitymaster</B></CODE>                                     <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I>                                   <ICLASS="lineannotation">added</I></PRE></BLOCKQUOTE></P><PCLASS="para">Here, <CODECLASS="literal">securitymaster</CODE> (probably an alias to a real user)was added.&#13;</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-22-SECT-8-3-5">22.8.3.5 The PrivacyOptions option</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19690"></A>The <CODECLASS="literal">PrivacyOptions</CODE> (<CODECLASS="literal">p</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-47"TITLE="">Section 34.8.47</A>)is used to limit the amount of information offered to the outsideworld and to limit other kinds of access. The most restrictive settingfor the <CODECLASS="literal">PrivacyOptions</CODE> (<CODECLASS="literal">p</CODE>) is probably best:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O PrivacyOptions=goaway,restrictmailq,restrictqrun</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19700"></A><ACLASS="indexterm"NAME="AUTOID-19702"></A><ACLASS="indexterm"NAME="AUTOID-19705"></A><ACLASS="indexterm"NAME="AUTOID-19707"></A>This setting disables the <CODECLASS="literal">expn</CODE> and <CODECLASS="literal">vrfy</CODE> SMTPcommands, requires other sites to identify themselves before sending mail,and also limits access to the mail queue directory.</P><PCLASS="para">&#13;As a general rule it is best to begin with tight security. This minimizesyour risk at the start and allows you to cautiously ease restrictionsat a comfortable rate. Beginning with loose restrictionsmay force you to tighten restrictions in a panic when it is least convenientto do so.&#13;</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-22-SECT-8-3-6">22.8.3.6 The SafeFileEnvironment option</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19716"></A><ACLASS="indexterm"NAME="AUTOID-19718"></A><ACLASS="indexterm"NAME="AUTOID-19722"></A><ACLASS="indexterm"NAME="AUTOID-19726"></A>Beginning with V8.7 <EMCLASS="emphasis">sendmail</EM>,the <CODECLASS="literal">SafeFileEnvironment</CODE> option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-58"TITLE="">Section 34.8.58, SafeFileEnvironment</A>)determines how delivery will be made to files.Ordinarily, <EMCLASS="emphasis">sendmail</EM> will deliver to anything, provided that ithas permission to do so (see <ACLASS="xref"HREF="ch24_02.htm#SML2-CH-24-SECT-2-2"TITLE="Delivery to Files">Section 24.2.2, "Delivery to Files"</A>). It can, forexample, deliver by appending to ordinary files or by writing to a devicesuch as <EMCLASS="emphasis">/dev/log</EM>.</P><PCLASS="para">If the <CODECLASS="literal">SafeFileEnvironment</CODE> option is declared, <EMCLASS="emphasis">sendmail</EM> will onlydeliver to ordinary files. This improves security by preventing anyone fromscribbling over sensitive things, such as directories anddevices. (Beginning with V8.8 <EMCLASS="emphasis">sendmail</EM>, it is still okay to write to<EMCLASS="emphasis">/dev/null</EM> even though this option is set.)</P><PCLASS="para">The <CODECLASS="literal">SafeFileEnvironment</CODE> option can also be used to define a directoryunder which all files that will be appended to must exist. This may inconveniencesome users but will generally improve the security of your site. We recommend:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O SafeFileEnvironment=<CODECLASS="replaceable"><I>/path</I></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">This takes care of both security enhancements. Of course, you will need to createthe directory specified in <CODECLASS="replaceable"><I>/path</I></CODE> and modify all path references inyour <EMCLASS="emphasis">aliases</EM> file before actually enabling this.</P><PCLASS="para">If all you want to do is prevent writing to directories and devices, and if youdo not want to place all files in a special path, you can accomplish thisby defining <CODECLASS="replaceable"><I>/path</I></CODE> as the root directory:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O SafeFileEnvironment=<CODECLASS="replaceable"><I>/</I></CODE></PRE></BLOCKQUOTE></P><PCLASS="para"></P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-22-SECT-8-3-7">22.8.3.7 The TempFileMode option</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19757"></A><ACLASS="indexterm"NAME="AUTOID-19759"></A><ACLASS="indexterm"NAME="AUTOID-19762"></A>The <CODECLASS="literal">TempFileMode</CODE> (<CODECLASS="literal">F</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-68"TITLE="">Section 34.8.68</A>)specifies the mode (file permissions) to give temporary files and queue files.In general, all files that are created by <EMCLASS="emphasis">sendmail</EM> should be consideredproprietary for safety's sake. We recommend a setting of:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O TempFileMode=0600</PRE></BLOCKQUOTE></P><PCLASS="para">With this narrow setting, the risk of accidental or malicious easingof permissions of your mail archive directories or queue becomes lessof a risk.<ACLASS="indexterm"NAME="AUTOID-19772"></A>&#13;</P></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-22-SECT-8-4">22.8.4 The /etc/shells file</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19776"></A><ACLASS="indexterm"NAME="AUTOID-19778"></A>To prevent certain users from running programs or writing to files by way ofthe <EMCLASS="emphasis">aliases</EM> or <EMCLASS="emphasis">~/.forward</EM> files, V8 <EMCLASS="emphasis">sendmail</EM> introducedthe concept of a &quot;valid shell.&quot; Just before allowing delivery via an aliassuch as these:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">|&quot;/some/program&quot;/save/to/a/file</PRE></BLOCKQUOTE></P><PCLASS="para">the user's password entry is looked up. If the shell entry from that passwordentry is a valid one, delivery is allowed. A shell is valid if it is listed in the <EMCLASS="emphasis">/etc/shells</EM>file. If that file does not exist, <EMCLASS="emphasis">sendmail</EM> looks up the shell in its internal listthat looks (more or less) like this:[19]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[19] This is an amalgamation of many vendor lists. See <EMCLASS="emphasis">conf.c</EM> in thesource distribution for details.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/bin/bsh/bin/csh/bin/ksh/bin/pam/bin/posix/sh/bin/rksh/bin/rsh/bin/sh/bin/tsh/usr/bin/bsh/usr/bin/csh/usr/bin/keysh/usr/bin/ksh/usr/bin/pam/usr/bin/posix/sh/usr/bin/rksh/usr/bin/rsh/usr/bin/sh/usr/bin/tsh</PRE></BLOCKQUOTE></P><PCLASS="para">With this technique it is possible to prevent certain users from having<EMCLASS="emphasis">sendmail</EM> running programs or delivering to files on their behalf.To illustrate, consider the need to prevent the <EMCLASS="emphasis">ftp</EM> pseudo-userfrom misusing <EMCLASS="emphasis">sendmail</EM>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">ftp:*:1092:255:File Transfer Protocol Program:/u/ftp:/no/shell</PRE></BLOCKQUOTE></P><PCLASS="para">Here, any attempt by <EMCLASS="emphasis">ftp</EM> to send mail through a program orinto a file will fail because the shell <EMCLASS="emphasis">/no/shell</EM> is nota valid shell. Such mail will bounce with one of these two errors:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">User ftp@here.us.edu doesn't have a valid shell for mailing to programsUser ftp@here.us.edu doesn't have a valid shell for mailing to files</PRE></BLOCKQUOTE></P><PCLASS="para">&#13;Note that unusual circumstances may require you to allow users with invalidshells to run program or deliver to files. To enable this for all such users(as on a mail server with restricted logins), place the following linedirectly in the <EMCLASS="emphasis">/etc/shells</EM> file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/SENDMAIL/ANY/SHELL/</PRE></BLOCKQUOTE></P><PCLASS="para">To enable this for selected users,just replace their shell with a bogus one that is listed in /etc/shells:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">ftp:*:1092:255:File Transfer Protocol Program:/u/ftp:<CODECLASS="userinput"><B>/bogus/shell</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">We recommend that all pseudo-users (such as <EMCLASS="emphasis">bin</EM> and <EMCLASS="emphasis">ftp</EM>)be given invalid shells in the password file and that /SENDMAIL/ANY/SHELL/never be used.</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_07.htm"TITLE="22.7 Forged Mail"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.7 Forged Mail"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_09.htm"TITLE="22.9 Pitfalls"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 22.9 Pitfalls"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">22.7 Forged Mail</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">22.9 Pitfalls</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>