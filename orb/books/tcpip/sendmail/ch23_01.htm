<HTML><HEAD><TITLE>[Chapter 23] The Queue</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:31:13Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="part03.htm"TITLE="III. Administration"><LINKREL="prev"HREF="ch22_09.htm"TITLE="22.9 Pitfalls"><LINKREL="next"HREF="ch23_02.htm"TITLE="23.2 Parts of a Queued Message"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_09.htm"TITLE="22.9 Pitfalls"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.9 Pitfalls"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 23</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_02.htm"TITLE="23.2 Parts of a Queued Message"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.2 Parts of a Queued Message"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="CHAPTER"><H1CLASS="chapter"><ACLASS="title"NAME="SML2-CH-23">23. The Queue</A></H1><DIVCLASS="htmltoc"><P><B>Contents:</B><BR><ACLASS="sect1"HREF="#SML2-CH-23-SECT-1"TITLE="23.1 Overview of the Queue">Overview of the Queue</A><BR><ACLASS="sect1"HREF="ch23_02.htm"TITLE="23.2 Parts of a Queued Message">Parts of a Queued Message</A><BR><ACLASS="sect1"HREF="ch23_03.htm"TITLE="23.3 A Bogus qf File (V8 only): Qf">A Bogus qf File (V8 only): Qf</A><BR><ACLASS="sect1"HREF="ch23_04.htm"TITLE="23.4 Printing the Queue">Printing the Queue</A><BR><ACLASS="sect1"HREF="ch23_05.htm"TITLE="23.5 How the Queue Is Processed">How the Queue Is Processed</A><BR><ACLASS="sect1"HREF="ch23_06.htm"TITLE="23.6 Cause the Queue to Be Processed">Cause the Queue to Be Processed</A><BR><ACLASS="sect1"HREF="ch23_07.htm"TITLE="23.7 Process Alternate Queues">Process Alternate Queues</A><BR><ACLASS="sect1"HREF="ch23_08.htm"TITLE="23.8 Pitfalls">Pitfalls</A><BR><ACLASS="sect1"HREF="ch23_09.htm"TITLE="23.9 The qf File Internals">The qf File Internals</A></P><P></P></DIV><PCLASS="para"></P><PCLASS="para">Mail messages may either be delivered immediately or be heldfor later delivery.<ACLASS="indexterm"NAME="SML2-CH-23-IX-QUEUE"></A><ACLASS="indexterm"NAME="AUTOID-19858"></A>Held messages are referred to as &quot;queued.&quot;They are placed into a holding directory, usually called <EMCLASS="emphasis">mqueue</EM>,from which they are delivered at a later time.There are many reasons a mail message may be queued:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">If a mail message is temporarily undeliverable, it is queuedand delivery is attempted later. If the message is addressedto multiple recipients, it is queued only for those recipientsto whom delivery is not immediately possible.</P></LI><LICLASS="listitem"><PCLASS="para">If the <CODECLASS="literal">s</CODE> configuration option is set to true, all mailmessages are queued for safety while delivery is attempted.The message is removed from the queue only if deliverysucceeds. If delivery fails, the messageis left in the queue, and another attempt is made to deliver itlater. This causes the mail to be saved in the unhappy eventof a system crash during processing.</P></LI><LICLASS="listitem"><PCLASS="para">If <EMCLASS="emphasis">sendmail</EM> is run with the <CODECLASS="literal">DeliveryMode</CODE> (<CODECLASS="literal">d</CODE>) option(see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-16"TITLE="">Section 34.8.16, DeliveryMode (d)</A>) set to <CODECLASS="literal">queue-only</CODE> or<CODECLASS="literal">defer</CODE>, all mail is queued, and no immediatedelivery attempt is made. A separate queue run is requiredto attempt delivery.</P></LI><LICLASS="listitem"><PCLASS="para">If the load (average number of blocked processes) becomes higher thanthe value given to the <CODECLASS="literal">QueueLA</CODE> (<CODECLASS="literal">x</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-50"TITLE="">Section 34.8.50, QueueLA (x)</A>),<EMCLASS="emphasis">sendmail</EM> queues messages rather than attempting to deliverthem. A separate queue run is required later to process the queue.</P></LI></UL><PCLASS="para"></P><DIVCLASS="sect1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-23-SECT-1">23.1 Overview of the Queue</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19886"></A><ACLASS="indexterm"NAME="AUTOID-19889"></A>The <EMCLASS="emphasis">sendmail</EM> queue is implemented by placing held messagesinto a directory.<ACLASS="indexterm"NAME="AUTOID-19894"></A>That directory and its name (usually <EMCLASS="emphasis">mqueue</EM>)are specified in the configuration file by the <CODECLASS="literal">QueueDirectory</CODE> (<CODECLASS="literal">Q</CODE>)option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-48"TITLE="">Section 34.8.48, QueueDirectory (Q)</A>):</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">OQ/var/spool/mqueue                         <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> pre-V8.7 form</I>O QueueDirectory=/var/spool/mqueue          <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> beginning with V8.7</I></PRE></BLOCKQUOTE></P><PCLASS="para">If the <CODECLASS="literal">QueueDirectory</CODE> (<CODECLASS="literal">Q</CODE>) option is missing, the name defaults to <CODECLASS="literal">mqueue</CODE>.When the location is relative (as <CODECLASS="literal">mqueue</CODE>),it is relative to the location where<EMCLASS="emphasis">sendmail</EM> is run. Since the <EMCLASS="emphasis">sendmail</EM> daemon is typically startedfrom an <EMCLASS="emphasis">rc</EM> file at boot time, such relative locations are usually relativeto the <EMCLASS="emphasis">root</EM> (<CODECLASS="literal">/</CODE>) directory.[1]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[1] Of course, if <EMCLASS="emphasis">sendmail</EM> is started somewhere else or by someone else, the queue directorywill be a subdirectory under that other starting directory.</P></BLOCKQUOTE><PCLASS="para">After <EMCLASS="emphasis">sendmail</EM> has processed its configuration file, itdoes a <EMCLASS="emphasis">chdir</EM>(2) into its queue directory and does all therest of its work from there. This change into the queue directoryhas two side effects:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Should the <EMCLASS="emphasis">sendmail</EM> program fault and produce a core dump, the coreimage is left in the queue directory.</P></LI><LICLASS="listitem"><PCLASS="para">Any relative pathnames that are given to options in the configuration file are interpreted as relative to the queue directory. (This is nottrue for the <CODECLASS="literal">F</CODE> configuration command; see <ACLASS="xref"HREF="ch32_01.htm#SML2-CH-32-SECT-1-2"TITLE="The F Class Command">Section 32.1.2, "The F Class Command"</A>.Those files are processed at the sametime as the configuration file, before the <EMCLASS="emphasis">chdir</EM>.)</P></LI></UL><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-19930"></A><ACLASS="indexterm"NAME="AUTOID-19933"></A>The queue directory should be set to have very narrow permissions.It must be owned by <EMCLASS="emphasis">root</EM>.We (and CERT) recommend a mode of 0700.Prior to V8 <EMCLASS="emphasis">sendmail</EM>, such narrow permissions would causeC-shell scripts run from a <EMCLASS="emphasis">~/.forward</EM> files to fail.V8 <EMCLASS="emphasis">sendmail</EM> lets you specify alternative directories in whichto run programs (see the <CODECLASS="literal">D=</CODE> delivery agent equate, <ACLASS="xref"HREF="ch30_04.htm#SML2-CH-30-SECT-4-3"TITLE="">Section 30.4.3, D=</A>).This allows you to use mode 0700 queue directorieswithout the associated problems.</P><PCLASS="para">As a further precaution, all the components of the path leading tothe queue directory should be owned by <EMCLASS="emphasis">root</EM> and be writable only by <EMCLASS="emphasis">root</EM>.In the case of our example of <EMCLASS="emphasis">/var/spool/mqueue</EM>, permissions shouldlook like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">drwxr-xr-x  root    /drwxr-xr-x  root    /var/drwxr-xr-x  root    /var/spool/drwx---  root    /var/spool/mqueue/</PRE></BLOCKQUOTE></P><PCLASS="para">For additional security, see the <CODECLASS="literal">restrictmailq</CODE> keyword for the<CODECLASS="literal">PrivacyOptions</CODE> (<CODECLASS="literal">p</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-47"TITLE="">Section 34.8.47, PrivacyOptions (p)</A>).It allows only users in the same group as the group ownershipof the queue directory to be ableto print its contents with <EMCLASS="emphasis">mailq</EM> or <CODECLASS="literal">-bp</CODE> (see <ACLASS="xref"HREF="ch23_04.htm"TITLE="Printing the Queue">Section 23.4, "Printing the Queue"</A>).&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch22_09.htm"TITLE="22.9 Pitfalls"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 22.9 Pitfalls"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_02.htm"TITLE="23.2 Parts of a Queued Message"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.2 Parts of a Queued Message"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">22.9 Pitfalls</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">23.2 Parts of a Queued Message</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>