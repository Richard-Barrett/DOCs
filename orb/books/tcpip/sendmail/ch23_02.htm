<HTML><HEAD><TITLE>[Chapter 23] 23.2 Parts of a Queued Message</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:31:48Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch23_01.htm"TITLE="23. The Queue"><LINKREL="prev"HREF="ch23_01.htm"TITLE="23.1 Overview of the Queue"><LINKREL="next"HREF="ch23_03.htm"TITLE="23.3 A Bogus qf File (V8 only): Qf"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_01.htm"TITLE="23.1 Overview of the Queue"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.1 Overview of the Queue"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 23<BR>The Queue</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_03.htm"TITLE="23.3 A Bogus qf File (V8 only): Qf"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.3 A Bogus qf File (V8 only): Qf"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-23-SECT-2">23.2 Parts of a Queued Message</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-23-IX-QUEUE-MESSAGE-PARTS"></A>When a message is stored in the queue, it is split into pieces.Each of those pieces is stored as a separate file in thequeue directory. That is, the header and other information aboutthe message are stored in one file, while the body (the data)is stored in another.All told, six different types of files may appear in the queue directory.The type of each is denoted by the first twoletters of the filenames. Each filename begins with a single letterfollowed by an <CODECLASS="literal">f</CODE> character. The complete list is shown in<ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-TAB-0"TITLE="Queue File Types">Table 23.1</A>.<ACLASS="indexterm"NAME="AUTOID-19964"></A></P><TABLECLASS="table"><CAPTIONCLASS="table"><ACLASS="title"NAME="SML2-CH-23-TAB-0">Table 23.1: Queue File Types</A></CAPTION><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">File</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1"></TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Description</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">df</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-SECT-2-2"TITLE="The Data (Message Body) File: df">Section 23.2.2, "The Data (Message Body) File: df"</A></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Data (message body)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">lf</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-SECT-2-3"TITLE="The Lock File (obsolete as of V5.62): lf">Section 23.2.3, "The Lock File (obsolete as of V5.62): lf"</A></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Lock file (obsolete as of V5.62)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">nf</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-SECT-2-4"TITLE="The ID Creation File (obsolete as of V5.62): nf">Section 23.2.4, "The ID Creation File (obsolete as of V5.62): nf"</A></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">ID creation file (obsolete as of V5.62)</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">tf</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-SECT-2-6"TITLE="The Temporary qf Rewrite Image: tf">Section 23.2.6, "The Temporary qf Rewrite Image: tf"</A></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Temporary qf rewrite image</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">xf</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-SECT-2-7"TITLE="The Transcript File: xf">Section 23.2.7, "The Transcript File: xf"</A></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Transcript file</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">qf</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-SECT-2-5"TITLE="The Queue Control File: qf">Section 23.2.5, "The Queue Control File: qf"</A></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Queue control file (and headers)</TD></TR></TBODY></TABLE><PCLASS="para">The complete form for each filename is</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Xf<CODECLASS="replaceable"><I>ident</I></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">The <CODECLASS="literal">X</CODE> is one of the leading letters shown in<ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-TAB-0"TITLE="Queue File Types">Table 23.1</A>.The <CODECLASS="literal">f</CODE> is the constant letter <CODECLASS="literal">f</CODE>. The <CODECLASS="replaceable"><I>ident</I></CODE> is a unique queueidentifier associated with each mail message.</P><PCLASS="para">In the following sections we first describe the identifier that is common to all the queue file parts, then describe each file type in alphabetical order.The internal details of the <CODECLASS="literal">qf</CODE> file can vary depending on theversion of <EMCLASS="emphasis">sendmail</EM>, so it is discussed separatelyat the end of this chapter.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-2-1">23.2.1 The Queue Identifier</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20028"></A><ACLASS="indexterm"NAME="AUTOID-20030"></A>To ensure that new filenames are not the same as the names offiles that may already be in the queue, <EMCLASS="emphasis">sendmail</EM> uses thefollowing pattern for each new <CODECLASS="replaceable"><I>ident</I></CODE>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">AA<CODECLASS="replaceable"><I>pid</I></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> prior to V8.6</I><CODECLASS="replaceable"><I>hour</I></CODE>AA<CODECLASS="replaceable"><I>pid</I></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> beginning with V8.6</I></PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20044"></A><ACLASS="indexterm"NAME="AUTOID-20047"></A>Here, <CODECLASS="replaceable"><I>pid</I></CODE> is the process identification number of the incarnationof <EMCLASS="emphasis">sendmail</EM> that is trying to create the file. Because <EMCLASS="emphasis">sendmail</EM>often <EMCLASS="emphasis">fork</EM>(2)'s to process the queue, that <CODECLASS="replaceable"><I>pid</I></CODE> is likely to be unique, resulting in a unique <CODECLASS="replaceable"><I>ident</I></CODE>.For V8 <EMCLASS="emphasis">sendmail</EM> an extra letter prefixes the <CODECLASS="literal">AA</CODE>. Shownas <CODECLASS="replaceable"><I>hour</I></CODE>, it is an uppercase letter that corresponds tothe hour (in a 24-hour clock) that the identifier was created.For example, a file created in hour three of the day willhave a <CODECLASS="literal">D</CODE> prefixed (thehour begins at midnight with <CODECLASS="literal">A</CODE>).[2]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[2] Programs should not depend on the lead letter actually encoding the hour.It is intended only to ensure that all identifiers be uniquewithin any 24-hour period and as an aid toscripts that need to extract information from log files.</P></BLOCKQUOTE><PCLASS="para">If <EMCLASS="emphasis">sendmail</EM> cannot create an exclusive filename(because a file with that identifier already exists), it clocks thesecond <CODECLASS="literal">A</CODE> of the <CODECLASS="literal">AA</CODE> to a <CODECLASS="literal">B</CODE> and tries again.It continues this process, clocking the right-hand letterfrom <CODECLASS="literal">A</CODE> to <CODECLASS="literal">Z</CODE> and the left-hand letterfrom <CODECLASS="literal">A</CODE> to <CODECLASS="literal">~</CODE> until it succeeds:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">AA            <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> start</I>AB            <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> second try</I>AC            <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> third try</I><ICLASS="lineannotation"> ... and so on</I>~W~X~Y            <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> last try</I>~Z            <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> failure</I></PRE></BLOCKQUOTE></P><PCLASS="para">If itnever succeeds, the <CODECLASS="replaceable"><I>ident</I></CODE> ultimately looks like the followingand <EMCLASS="emphasis">sendmail</EM> has failed:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><CODECLASS="replaceable"><I>hour</I></CODE>~Z<CODECLASS="replaceable"><I>pid</I></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">This <CODECLASS="replaceable"><I>ident</I></CODE> is unlikely to ever appear, because the clocking providesfor over 1600 possibilities.</P><PCLASS="para">All the files associated with a given mail message share the same<CODECLASS="replaceable"><I>ident</I></CODE> as a part of their filenames. The individual filesassociated with a single mail message differ only in the firstletter of their names.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-2-2">23.2.2 The Data (Message Body) File: df</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20093"></A><ACLASS="indexterm"NAME="AUTOID-20096"></A><ACLASS="indexterm"NAME="AUTOID-20099"></A>All mail messages are composed of a header and a body.When queued, the body is stored in the <EMCLASS="emphasis">df</EM> file.</P><PCLASS="para">Traditionally, the message body could contain only characters thathad the high (most significant) bit turned off (cleared,set to 0). But under V8 <EMCLASS="emphasis">sendmail</EM>, with a version 2 or higher configurationfile (see <ACLASS="xref"HREF="ch27_05.htm"TITLE="The V Configuration Command">Section 27.5, "The V Configuration Command"</A>),the high bit is left as is until delivery (whereupon the <CODECLASS="literal">F=7</CODE> delivery-agentflag, see <ACLASS="xref"HREF="ch30_08.htm#SML2-CH-30-SECT-8-4"TITLE="">Section 30.8.4, F=7</A>,determines whether or not that bit will be stripped during delivery).</P><PCLASS="para">Because the message body can contain sensitive or personal information,the <CODECLASS="literal">df</CODE> file should be protected from reading by ordinaryusers. If the queue directory is world readable, then the<CODECLASS="literal">TempFileMode</CODE> (<CODECLASS="literal">F</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-68"TITLE="">Section 34.8.68, TempFileMode (F)</A>)should specify minimum permissions (such as 0600) for queued files.But if the queue directory is protectedby both narrow permissions and a secure machine, the <CODECLASS="literal">TempFileMode</CODE> (<CODECLASS="literal">F</CODE>) option may be relaxed for easier administration.</P><PCLASS="para">There is currently no plan to provide for encryption of <CODECLASS="literal">df</CODE>files. If you are concerned about the privacy of your message,you should use an end-to-end encryption package (not discussed inthis book).&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-2-3">23.2.3 The Lock File (obsolete as of V5.62): lf</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20119"></A>When old versions of <EMCLASS="emphasis">sendmail</EM> process a queued message (attemptto redeliver it)they create an empty lock file. That lock file is necessary tosignal to other running <EMCLASS="emphasis">sendmail</EM> processes that the mail messageis busy so that they won't try to deliver the message too.Current versions simply <EMCLASS="emphasis">flock</EM>(2) or <EMCLASS="emphasis">fcntl</EM>(2) the <CODECLASS="literal">qf</CODE> file.<ACLASS="indexterm"NAME="AUTOID-20126"></A><ACLASS="indexterm"NAME="AUTOID-20128"></A></P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-23-SECT-2-3-1">23.2.3.1 Current style file locking</A></H4><PCLASS="para">The method that <EMCLASS="emphasis">sendmail</EM> uses to initially create an exclusive lockwhen first queueing a fileis twofold. First it attempts to <EMCLASS="emphasis">creat</EM>(2) the file withthe argument</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O_CREAT|O_WRONLY|O_EXCL</PRE></BLOCKQUOTE></P><PCLASS="para">If that succeeds,it then attempts to lock the file. If HASFLOCK (see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-9"TITLE="">Section 18.8.9, HAS...</A>)is definedwhen <EMCLASS="emphasis">sendmail</EM> is compiled, the file is locked with <EMCLASS="emphasis">flock</EM>(2).Otherwise, it is locked with a <EMCLASS="emphasis">fcntl</EM>(2) <CODECLASS="literal">F_SETLK</CODE> argument.</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-23-SECT-2-3-2">23.2.3.2 Locks shown when printing the queue</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20146"></A><ACLASS="indexterm"NAME="AUTOID-20149"></A>When <EMCLASS="emphasis">mailq</EM> is run (or the <CODECLASS="literal">-bp</CODE> command-line switch isgiven to <EMCLASS="emphasis">sendmail</EM>), the contents of the queue are listed.In that listing, an asterisk that appears to the right of an identifierindicates that a lock exists on the message:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">                Mail Queue (1 request)-Q-ID- -Size- --Q-Time--- ------Sender/Recipient------MAA17445*   126 Fri Apr 17 10:17 &lt;gw@wash.dc.gov&gt;        <IMGSRC="../chars/uarr.gif"ALT="-^">                        &lt;ben@franklin.edu&gt;       <ICLASS="lineannotation">note</I></PRE></BLOCKQUOTE></P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-23-SECT-2-3-3">23.2.3.3 Locks can get stuck</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20161"></A><ACLASS="indexterm"NAME="AUTOID-20163"></A>Occasionally, a file will become locked and remain that way for a long time.One indication of a stuck lock is a series of <EMCLASS="emphasis">syslog</EM>messages about a given identifier:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Apr 12 00:33:38 ourhost sendmail[641]: AA00614: lockedApr 12 01:22:14 ourhost sendmail[976]: AA00614: lockedApr 12 02:49:23 ourhost sendmail[3251]: AA00976: lockedApr 12 02:49:51 ourhost sendmail[5977]: AA00614: lockedApr 12 03:53:05 ourhost sendmail[9839]: AA00614: locked</PRE></BLOCKQUOTE></P><PCLASS="para">An occasional lock message, such as <CODECLASS="literal">AA00976</CODE> in the thirdline above, is normal. But when an identifier is continually reportingas locked (like the <CODECLASS="literal">AA00614</CODE> lines), an orphaned lockmay exist and should be investigated.Use <EMCLASS="emphasis">ps</EM>(1) to look for lines that list queue file identifiers:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">root      5338 160  -AA00614 To wash.dc.gov (sendmail)</PRE></BLOCKQUOTE></P><PCLASS="para">This shows that the queued mail message, whose identifier is<CODECLASS="literal">AA00614</CODE>, is currently being processed. It the lockon that file is stuck, consider killing the <EMCLASS="emphasis">sendmail</EM> thatis processing it.&#13;</P></DIV></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-2-4">23.2.4 The ID Creation File (obsolete as of V5.62): nf</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20180"></A>Old versions of <EMCLASS="emphasis">sendmail</EM> used an <CODECLASS="literal">nf</CODE> file when creatinga message identifier to avoid race conditions.[3]But contemporaryversions of <EMCLASS="emphasis">sendmail</EM> create the queue identifier when firstcreating the <CODECLASS="literal">qf</CODE> file. The <CODECLASS="literal">nf</CODE> file is obsolete.&#13;</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[3] Historical footnote: This stems from the days when the onlyatomic file-system call was <EMCLASS="emphasis">link</EM>(2).</P></BLOCKQUOTE></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-2-5">23.2.5 The Queue Control File: qf</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20193"></A>A queued mail message is composed of two primary parts. The <CODECLASS="literal">df</CODE>file contains the message body. The <CODECLASS="literal">qf</CODE> file contains the messageheader.</P><PCLASS="para">In addition to the header, the <CODECLASS="literal">qf</CODE> file also contains all theinformation necessary to:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Deliver the message. It contains the sender's address and a listof recipient addresses.</P></LI><LICLASS="listitem"><PCLASS="para">Order message processing. It contains a priority that determinesthe current message's position in a queue run of many messages.</P></LI><LICLASS="listitem"><PCLASS="para">Expire the message. It contains the date that the message wasoriginally queued. That date is used to time out a message.</P></LI><LICLASS="listitem"><PCLASS="para">Explain the message. It contains the reason that the messageis in the queue and possibly the error that caused it to be queued.</P></LI></UL><PCLASS="para">The <CODECLASS="literal">qf</CODE> file is line-oriented, with one item of information perline. Each line begins with a single uppercase character (thecode letter), whichspecifies the contents of the line. Each code letter is then followedby the information appropriate to the letter.The code letters and their meanings are shown in <ACLASS="xref"HREF="ch23_09.htm#SML2-CH-23-TAB-1"TITLE="qf File Code Letters">Table 23.2</A> of <ACLASS="xref"HREF="ch23_09.htm"TITLE="The qf File Internals">Section 23.9, "The qf File Internals"</A>.</P><PCLASS="para">Here is an example of a version 1 (for V8.8 <EMCLASS="emphasis">sendmail</EM>)<CODECLASS="literal">qf</CODE> file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">V1T826845694K0N0P30016I7/4/20$_you@localhostMDeferred: Host wash.dc.gov is downSyou@your.domainRPFD:george@wash.dc.govRPFD:jeffersonH?P?Return-Path: you@your.domainHReceived: (from you@your.domain) by your.domain (8.8.4/8.8.4)        id QAA06571 for george@wash.dc.gov; Thu, 14 Mar 1996 16:21:34 -0700 (MST)H?D?Date: Thu, 14 Mar 1996 16:21:34 -0700 (MST)H?F?From: Your Name &lt;you@your.domain&gt;H?x?Full-Name: Your NameH?M?Message-Id: &lt;199603142321.QAA06571@your.domain&gt;HSubject: foo.</PRE></BLOCKQUOTE></P><PCLASS="para">This fictional <CODECLASS="literal">qf</CODE> file shows the information that will beused to send a mail message from <CODECLASS="literal">you@your.domain</CODE>(the <CODECLASS="literal">S</CODE> line)to two recipients: <CODECLASS="literal">george@wash.dc.gov</CODE> and <CODECLASS="literal">jefferson</CODE>(the <CODECLASS="literal">R</CODE> lines).It also shows the various headers that appear in that message (the<CODECLASS="literal">H</CODE> lines).We discuss the individual lines of the <CODECLASS="literal">qf</CODE> file inat the end of this chapter.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-2-6">23.2.6 The Temporary qf Rewrite Image: tf</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20229"></A>When processing a queued message, it is often necessary for<EMCLASS="emphasis">sendmail</EM> to modify the contents of the <CODECLASS="literal">qf</CODE> file.This usually occurs if delivery has failed or ifdelivery for only a part of the recipientlist succeeded. In either event, at least the messagepriority needs to be incremented.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20234"></A>To prevent damage to the original <CODECLASS="literal">qf</CODE> file, <EMCLASS="emphasis">sendmail</EM> makeschanges to a temporary copy of that file. The temporary copy hasthe same queue identifier as the original, but its name beginswith a <CODECLASS="literal">t</CODE>.</P><PCLASS="para">After the <CODECLASS="literal">tf</CODE> file has been successfully written and closed,<EMCLASS="emphasis">sendmail</EM> calls <EMCLASS="emphasis">rename</EM>(2) to replace the original withthe copy. If the renaming fails, <EMCLASS="emphasis">sendmail</EM> <EMCLASS="emphasis">syslog</EM>(3)'s at LOG_CRIT a message like the following:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">cannot rename(tfAA00000, qfAA00000), df=dfAA00000</PRE></BLOCKQUOTE></P><PCLASS="para">Failure to rename is an unusual, but serious, problem:A queued messagehas been processed, but its <CODECLASS="literal">qf</CODE> file contains old and incorrectinformation. This failure may, for example,indicate a hardware error, a corrupted queue directory, or that thesystem administrator accidentally removed the queue directory.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-2-7">23.2.7 The Transcript File: xf</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20253"></A><ACLASS="indexterm"NAME="AUTOID-20255"></A>A given mail message may be destined for many recipients,requiring different delivery agents.During the process of delivery, error messages(such as &quot;User unknown&quot; and &quot;Permission denied&quot;)can be printed back to <EMCLASS="emphasis">sendmail</EM> by each delivery agent.</P><PCLASS="para">While calling the necessary delivery agents, <EMCLASS="emphasis">sendmail</EM>saves all the error messages it receives in a temporary file.The name of that temporary file begins with the letters <CODECLASS="literal">xf</CODE>.After all delivery agents have been called, <EMCLASS="emphasis">sendmail</EM> returns any collectederror messages to the sender and deletes the temporary <CODECLASS="literal">xf</CODE> file.If there are no errors, the empty <CODECLASS="literal">xf</CODE> file is silently deleted.The <CODECLASS="literal">-d51.104</CODE> debugging switch (see <ACLASS="xref"HREF="ch37_05.htm#SML2-CH-37-SECT-5-171"TITLE="">Section 37.5.171, -d51.104</A>)can be used to prevent deletion of the <CODECLASS="literal">xf</CODE> file.<ACLASS="indexterm"NAME="AUTOID-20268"></A>&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_01.htm"TITLE="23.1 Overview of the Queue"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.1 Overview of the Queue"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_03.htm"TITLE="23.3 A Bogus qf File (V8 only): Qf"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.3 A Bogus qf File (V8 only): Qf"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">23.1 Overview of the Queue</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">23.3 A Bogus qf File (V8 only): Qf</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>