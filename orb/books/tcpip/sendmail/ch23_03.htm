<HTML><HEAD><TITLE>[Chapter 23] 23.3 A Bogus qf File (V8 only): Qf</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:32:33Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch23_01.htm"TITLE="23. The Queue"><LINKREL="prev"HREF="ch23_02.htm"TITLE="23.2 Parts of a Queued Message"><LINKREL="next"HREF="ch23_04.htm"TITLE="23.4 Printing the Queue"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_02.htm"TITLE="23.2 Parts of a Queued Message"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.2 Parts of a Queued Message"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 23<BR>The Queue</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_04.htm"TITLE="23.4 Printing the Queue"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.4 Printing the Queue"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-23-SECT-3">23.3 A Bogus qf File (V8 only): Qf</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20272"></A><ACLASS="indexterm"NAME="AUTOID-20274"></A><ACLASS="indexterm"NAME="AUTOID-20277"></A>For security reasons, V8 <EMCLASS="emphasis">sendmail</EM> performs a number of checks oneach <CODECLASS="literal">qf</CODE> file before trusting its contents. If any <CODECLASS="literal">qf</CODE> filefails to be trustworthy, <EMCLASS="emphasis">sendmail</EM> converts the leading <CODECLASS="literal">q</CODE> in its nameto an uppercase <CODECLASS="literal">Q</CODE>. We discuss each possible problem in the sectionsthat follow.</P><PCLASS="para">Note that when <EMCLASS="emphasis">sendmail</EM> renames a <CODECLASS="literal">qf</CODE> file intoa <CODECLASS="literal">Qf</CODE> file, it usually (but not always) logs that it did so.In the following, <CODECLASS="replaceable"><I>qffile</I></CODE> is the full filename of the <CODECLASS="literal">qf</CODE> file, beforeit was renamed:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Losing <CODECLASS="replaceable"><I>qffile</I></CODE>: <ICLASS="lineannotation">reason here</I></PRE></BLOCKQUOTE></P><PCLASS="para">Also note that, although <EMCLASS="emphasis">sendmail</EM> checks the <CODECLASS="literal">qf</CODE> file for a number ofplausibilities, its checking is by no means exhaustive. The checks thatwe describe here are no substitute for a well managed system.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-3-1">23.3.1 Badly Formed qf Filename</A></H3><PCLASS="para">V8.6 <EMCLASS="emphasis">sendmail</EM> always checks the form of the <CODECLASS="literal">qf</CODE> filename for correctness. V8.7 and above <EMCLASS="emphasis">sendmail</EM> also check the<CODECLASS="literal">qf</CODE> filename but do so only if PICKY_QF_NAME_CHECKis defined when building (see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-35"TITLE="">Section 18.8.35, PICKY...</A>).<ACLASS="indexterm"NAME="AUTOID-20307"></A>If the <CODECLASS="literal">qf</CODE> file name is incorrectlyformed (see <ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-SECT-2-1"TITLE="The Queue Identifier">Section 23.2.1, "The Queue Identifier"</A>),<EMCLASS="emphasis">sendmail</EM> presumes that some other program placed the file in thequeue and rejects it:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">orderq: bogus qf name <ICLASS="lineannotation">bogus name here</I></PRE></BLOCKQUOTE></P><PCLASS="para">Beginning with V8.7, <EMCLASS="emphasis">sendmail</EM> requires PICKY_QF_NAME_CHECK to be definedbecause some sites allow legitimate programs (other than <EMCLASS="emphasis">sendmail</EM>) towrite into <EMCLASS="emphasis">sendmail</EM>'s queue.</P><PCLASS="para">&#13;To fix this problem, either undefine PICKY_QF_NAME_CHECK when you build <EMCLASS="emphasis">sendmail</EM>(if your site allows other programs to write into the queue directory) ortrace down the process that is placing badly formed <CODECLASS="literal">qf</CODE> names inyour queue and fix it.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-3-2">23.3.2 Bad qf Owner or Permissions</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20325"></A>Each <CODECLASS="literal">qf</CODE> file must be owned by the effective user ID under which<EMCLASS="emphasis">sendmail</EM> runs (usually <EMCLASS="emphasis">root</EM>). A <CODECLASS="literal">qf</CODE> file must notbe group or world writable. If a <CODECLASS="literal">qf</CODE> file fails either test, itis considered bogus and is renamed to a <CODECLASS="literal">Qf</CODE> file. Then <EMCLASS="emphasis">sendmail</EM> logsthese messages:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><CODECLASS="replaceable"><I>id</I></CODE>: bogus queue file, uid=<CODECLASS="replaceable"><I>owner</I></CODE>, mode=<CODECLASS="replaceable"><I>perms</I></CODE>Losing <CODECLASS="replaceable"><I>qffile</I></CODE>: bogus file uid in mqueue</PRE></BLOCKQUOTE></P><PCLASS="para">Here, <CODECLASS="replaceable"><I>id</I></CODE> is the identifier portion of the <CODECLASS="literal">qf</CODE> file name,<CODECLASS="replaceable"><I>owner</I></CODE> is the <EMCLASS="emphasis">uid</EM> of the user that owns the <CODECLASS="literal">qf</CODE>file, and <CODECLASS="replaceable"><I>perms</I></CODE> are the file permissions of the <CODECLASS="literal">qf</CODE> file, printedin octal.</P><PCLASS="para">This problem may point to bad queue directory permissions that allow anyone(or some group) to place files there. Or it may indicate that some processesother than <EMCLASS="emphasis">sendmail</EM> is writing to your queue.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-3-3">23.3.3 Extra Data at End of qf File</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20354"></A>One form of attack against <EMCLASS="emphasis">sendmail</EM> is to append additional controllines to the end of an existing <CODECLASS="literal">qf</CODE> file. V8.7 <EMCLASS="emphasis">sendmail</EM> specificallychecks for additional text and rejects the <CODECLASS="literal">qf</CODE> file if any is found:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">SECURITY ALERT: extra data in qf: <ICLASS="lineannotation">first bogus line printed here</I>Losing <CODECLASS="replaceable"><I>qffile</I></CODE>: bogus queue line</PRE></BLOCKQUOTE></P><PCLASS="para">V8.7 <EMCLASS="emphasis">sendmail</EM> terminates its legitimate list of <CODECLASS="literal">qf</CODE> control linesby placing a dot on a line by itself. Any text following that line, includingcomments and blank lines, is considered an error.This may represent a serious attack against your machine or site. If you get this message,investigate at once.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-3-4">23.3.4 Unknown Control Character in qf File</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20371"></A><ACLASS="indexterm"NAME="AUTOID-20373"></A>Each line in a <CODECLASS="literal">qf</CODE> file must begin with a known control letter orcharacter (see <ACLASS="xref"HREF="ch23_09.htm"TITLE="The qf File Internals">Section 23.9</A>).If a line begins with any other character, it is considered bad, and thewhole file is rejected:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">readqf: <CODECLASS="replaceable"><I>qffile</I></CODE>: line <CODECLASS="replaceable"><I>num</I></CODE>: bad line &quot;<ICLASS="lineannotation">bogus line here</I>&quot;Losing <CODECLASS="replaceable"><I>qffile</I></CODE>: unrecognized line</PRE></BLOCKQUOTE></P><PCLASS="para">Note that this error is to be anticipated if you go backwards, from a later release toan earlier release of <EMCLASS="emphasis">sendmail</EM>.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-3-5">23.3.5 Funny Flag Bits in qf File</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20388"></A>An <CODECLASS="literal">F</CODE> line in a <CODECLASS="literal">qf</CODE> file is used to save and restore envelope flagbits.  Unfortunately, the first line of a UNIX style mailbox also begins withan <CODECLASS="literal">F</CODE>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">From someone@site</PRE></BLOCKQUOTE></P><PCLASS="para">If a <CODECLASS="literal">qf</CODE> file's <CODECLASS="literal">F</CODE> line begins with the five characters &quot;<CODECLASS="literal">From </CODE>&quot;,V8.7 and above <EMCLASS="emphasis">sendmail</EM> will reject the file and log a possible attack:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">SECURITY ALERT: bogus qf line <ICLASS="lineannotation">bogus line here</I>Losing <CODECLASS="replaceable"><I>qffile</I></CODE>: bogus queue line</PRE></BLOCKQUOTE></P><PCLASS="para">This represents a serious attack against your machine or site. If you get this message,investigate at once.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-3-6">23.3.6 Savemail Panic</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20408"></A><ACLASS="indexterm"NAME="AUTOID-20410"></A><ACLASS="indexterm"NAME="AUTOID-20413"></A><ACLASS="indexterm"NAME="AUTOID-20416"></A>In the rare event that <EMCLASS="emphasis">sendmail</EM> cannot dispose of a bounced message, it willpreserve the <CODECLASS="literal">qf</CODE> file as a <CODECLASS="literal">Qf</CODE> file and log the message:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">savemail: cannot save rejected e-mail anywhereLosing <CODECLASS="replaceable"><I>qffile</I></CODE>: savemail panic</PRE></BLOCKQUOTE></P><PCLASS="para">The <EMCLASS="emphasis">sendmail</EM> program tries everything possible to avoid thisstate (including bouncing the message, sending it to the <EMCLASS="emphasis">postmaster</EM>,and saving it to a <EMCLASS="emphasis">dead.letter</EM> file). Only if all else fails willit preserve the <CODECLASS="literal">qf</CODE> file as a <CODECLASS="literal">Qf</CODE> file.</P><PCLASS="para">In general this points to an alias problem with the user named <EMCLASS="emphasis">postmaster</EM> orthe owner of a mailing list.Such users are special. They must be able to receive email messages no matter what.They should be the names of real people, not the names of further mailing lists.&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_02.htm"TITLE="23.2 Parts of a Queued Message"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.2 Parts of a Queued Message"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_04.htm"TITLE="23.4 Printing the Queue"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.4 Printing the Queue"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">23.2 Parts of a Queued Message</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">23.4 Printing the Queue</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>