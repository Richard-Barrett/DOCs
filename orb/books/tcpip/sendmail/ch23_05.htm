<HTML><HEAD><TITLE>[Chapter 23] 23.5 How the Queue Is Processed</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:33:31Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch23_01.htm"TITLE="23. The Queue"><LINKREL="prev"HREF="ch23_04.htm"TITLE="23.4 Printing the Queue"><LINKREL="next"HREF="ch23_06.htm"TITLE="23.6 Cause the Queue to Be Processed"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_04.htm"TITLE="23.4 Printing the Queue"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.4 Printing the Queue"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 23<BR>The Queue</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_06.htm"TITLE="23.6 Cause the Queue to Be Processed"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.6 Cause the Queue to Be Processed"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-23-SECT-5">23.5 How the Queue Is Processed</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-23-IX-QUEUE-PROCESSING"></A><ACLASS="indexterm"NAME="SML2-CH-23-IX-PROCESSING-QUEUE"></A>Over time, messages may gather in the queue awaiting delivery.They remain there until <EMCLASS="emphasis">sendmail</EM> performs a queue runto process the queue.The <EMCLASS="emphasis">sendmail</EM> program can be told either to process thequeue periodically (when run as a daemon) or to process thequeue once, then exit.Each time <EMCLASS="emphasis">sendmail</EM> processes the queue, it also performs a seriesof operations that are intended to improve the efficiency with which it deliversmessages.</P><PCLASS="para">First the <EMCLASS="emphasis">queue</EM> directory is opened for reading. If thatdirectory cannot be opened, <EMCLASS="emphasis">sendmail</EM> <EMCLASS="emphasis">syslog</EM>(3)'s the followingmessage at LOG_CRIT and exits:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">orderq: cannot open &quot;/var/spool/mailq&quot; as &quot;.&quot;</PRE></BLOCKQUOTE></P><PCLASS="para">This error is usually the result of a user running <EMCLASS="emphasis">sendmail</EM>in an unsafe manner, with a <CODECLASS="literal">-C</CODE> command-line argument, for example.It can also result from <EMCLASS="emphasis">sendmail</EM> attempting to open anNFS-mounted queue directory, where <EMCLASS="emphasis">root</EM> is mapped to <EMCLASS="emphasis">nobody</EM>.</P><PCLASS="para">Next, the <CODECLASS="literal">qf</CODE> files are read to gather their prioritiesand times (the <CODECLASS="literal">P</CODE> and <CODECLASS="literal">T</CODE> lines). If a <CODECLASS="literal">qf</CODE> filecannot be opened, it is quietly ignored unlessthe  <CODECLASS="literal">-d41.2</CODE> debugging command-line switch (see <ACLASS="xref"HREF="ch37_05.htm#SML2-CH-37-SECT-5-145"TITLE="">Section 37.5.145, -d41.2</A>)is specified.That switch causes <EMCLASS="emphasis">sendmail</EM> to print the following error message:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">orderq: cannot open qfMAA12345 (<ICLASS="lineannotation">reason</I>)</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-20630"></A><ACLASS="indexterm"NAME="AUTOID-20633"></A><ACLASS="indexterm"NAME="AUTOID-20636"></A>Prior to V8.7 <EMCLASS="emphasis">sendmail</EM>,there was a hard limit on the number of messages that could be processed at anytime. If more than QUEUESIZE (defined in <EMCLASS="emphasis">conf.h</EM>, typically1000) messages were in queue, only the first QUEUESIZE (1000) of themwould be processed! Ordinarily, this was not a problem. But it couldquickly become one if your queue were clogged with a huge number ofundeliverable messages (where the first 1000 continued to bedeferred). In that case the only solution isto temporarily move the 1000 messages out ofthe way by hand (see <ACLASS="xref"HREF="ch23_07.htm#SML2-CH-23-SECT-7-1"TITLE="Handling a Down Site">Section 23.7.1, "Handling a Down Site"</A>) and clearthe queue. The only way to detect this situation is toprint the queue (see <ACLASS="xref"HREF="ch23_04.htm"TITLE="Printing the Queue">Section 23.4</A>). </P><PCLASS="para">V8.7 and above <EMCLASS="emphasis">sendmail</EM> dynamically allocates memory to processthe queue. If more than QUEUESIZE messages are found, <EMCLASS="emphasis">sendmail</EM>will print the following notice and process them:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">grew WorkQ for <ICLASS="lineannotation">queue_directory</I> to <ICLASS="lineannotation">bytes</I></PRE></BLOCKQUOTE></P><PCLASS="para">As an alternative to this dynamic behavior, V8.7 and above <EMCLASS="emphasis">sendmail</EM>offers a hard limit that is somewhat like the old version butis site tunable with the <CODECLASS="literal">MaxQueueRunSize</CODE> option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-38"TITLE="">Section 34.8.38</A>).After all the <CODECLASS="literal">qf</CODE> files have been gathered, they are sortedin order of cost.Messages with the lowest value of the <CODECLASS="literal">P</CODE> line have the highestpriority (lowest cost) and are processed first.</P><PCLASS="para">Beginning with V8.7, <EMCLASS="emphasis">sendmail</EM> also offers the <CODECLASS="literal">QueueSortOrder</CODE> option(see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-51"TITLE="">Section 34.8.51, QueueSortOrder</A>), which allows youto sort by priority (as before), by priority and host-name, or by date queued.Once all the messages have been sorted, <EMCLASS="emphasis">sendmail</EM> processes eachin turn.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-23-SECT-5-1">23.5.1 Processing a Single Message</A></H3><PCLASS="para">A single queued message has a single sender but may have many recipients.When processing a queued message, <EMCLASS="emphasis">sendmail</EM> attempts to deliver itto all recipients before processing the next queued message.</P><PCLASS="para">The first step in processing a queued message is to lock it so thatconcurrent runs of <EMCLASS="emphasis">sendmail</EM> do not attempt to process it simultaneously(see <ACLASS="xref"HREF="ch23_02.htm#SML2-CH-23-SECT-2-3-1"TITLE="Current style file locking">Section 23.2.3.1, "Current style file locking"</A>).Then the <CODECLASS="literal">qf</CODE> file is opened and read. The sender and all therecipients are gathered from the corresponding <CODECLASS="literal">S</CODE> and <CODECLASS="literal">R</CODE>lines.</P><PCLASS="para">For each recipient, delivery is attempted. If delivery is successful,that recipient's address is removed from the <EMCLASS="emphasis">sendmail</EM> program'sinternal list of recipient addresses. If delivery fails, that addressis either left in the list or bounced, dependingon the nature of the error.</P><PCLASS="para">After all recipients have been either delivered, bounced, or left inthe list, <EMCLASS="emphasis">sendmail</EM> reexamines that list. If there are no recipientsleft in it, the message is de-queued (all of the files in the queuedirectory that compose it are removed). If any recipients areleft, the <CODECLASS="literal">M</CODE> line is assigned the error message of the lastfailed message, and the <CODECLASS="literal">qf</CODE> file is rewritten with the listof remaining recipients. Finally, the <CODECLASS="literal">qf</CODE> file is closed,thus freeing its lock.</P><PCLASS="para">&#13;Under V8 <EMCLASS="emphasis">sendmail</EM> the <CODECLASS="literal">CheckpointInterval</CODE> (<CODECLASS="literal">C</CODE>) option(see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-7"TITLE="">Section 34.8.7, CheckpointInterval (C)</A>) causes checkpointing of this process.When this option has a positive value, the <CODECLASS="literal">qf</CODE> file isrewritten after that value's number of recipients have been processed.For example, consider a mail message to five recipients. If the<CODECLASS="literal">CheckpointInterval</CODE> (<CODECLASS="literal">C</CODE>) option is set to a value of 2, the <CODECLASS="literal">qf</CODE> file is rewritten afterthe first two recipients have been processed, then again after four, and againafter they all have been processed.This keeps the <CODECLASS="literal">qf</CODE> file reasonably up-to-date as protectionagainst <EMCLASS="emphasis">sendmail</EM> being improperly killed or the machine crashing.&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_04.htm"TITLE="23.4 Printing the Queue"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.4 Printing the Queue"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_06.htm"TITLE="23.6 Cause the Queue to Be Processed"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.6 Cause the Queue to Be Processed"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">23.4 Printing the Queue</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">23.6 Cause the Queue to Be Processed</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>