<HTML><HEAD><TITLE>[Chapter 23] 23.8 Pitfalls</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:35:04Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch23_01.htm"TITLE="23. The Queue"><LINKREL="prev"HREF="ch23_07.htm"TITLE="23.7 Process Alternate Queues"><LINKREL="next"HREF="ch23_09.htm"TITLE="23.9 The qf File Internals"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_07.htm"TITLE="23.7 Process Alternate Queues"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.7 Process Alternate Queues"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 23<BR>The Queue</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_09.htm"TITLE="23.9 The qf File Internals"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.9 The qf File Internals"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-23-SECT-8">23.8 Pitfalls</A></H2><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-21003"></A><ACLASS="indexterm"NAME="AUTOID-21006"></A>Each release of <EMCLASS="emphasis">sendmail</EM> offers more and better ways to handlequeue problems. They are mostly implemented as options.<ACLASS="xref"HREF="ch34_06.htm#SML2-CH-34-TAB-6"TITLE="Options that Affect the Queue">Table 34.7</A> in <ACLASS="xref"HREF="ch34_06.htm#SML2-CH-34-SECT-6-2"TITLE="The Queue">Section 34.6.2, "The Queue"</A> lists all optionsthat affect the queue. Of special interest are the new <CODECLASS="literal">MaxQueueRunSize</CODE>,<CODECLASS="literal">Timeout.queuereturn</CODE>, and <CODECLASS="literal">Timeout.queuewarn</CODE> options.Whenever you upgrade to a new <EMCLASS="emphasis">sendmail</EM> release, be sure toread the <EMCLASS="emphasis">RELEASE_NOTES</EM> for that latest information about new waysto solve queueing problems.</P></LI><LICLASS="listitem"><PCLASS="para">The queue directory should never be shared among machines. Such sharingcan make detection of orphaned locks impossible.Bugs in network locking daemons can leadto race conditions in which neither of two machines can generate a queue identifier.</P></LI><LICLASS="listitem"><PCLASS="para">In old versions of <EMCLASS="emphasis">sendmail</EM>it was possible for an <CODECLASS="literal">lf</CODE> file to be left in place eventhough its corresponding mail message was not being processed.Such spurious files prevented the messagefrom ever being delivered unless they were removed by hand. Spurious lockfiles could be detected by watching the <EMCLASS="emphasis">syslog</EM>(5) filefor frequent <CODECLASS="literal">locked</CODE> warnings.</P></LI><LICLASS="listitem"><PCLASS="para">Homespun programs and shell scripts for delivery of local mailcan fail and lose mail by exiting with the wrong value.In the case of a recoverable error (a full disk, for example)they should exit with EX_OSERR or EX_TEMPFAIL.Both these exit values are defined in <EMCLASS="emphasis">&lt;sysexits.h&gt;</EM> and cause the message to be requeued.</P></LI><LICLASS="listitem"><PCLASS="para">Because <EMCLASS="emphasis">sendmail</EM> does a <EMCLASS="emphasis">chdir</EM>(2) into its queue directory,you should avoid removing and recreating that directory while the<EMCLASS="emphasis">sendmail</EM> daemon is running. When processing the queue,<EMCLASS="emphasis">sendmail</EM> tries to read the queue directory by doingan <EMCLASS="emphasis">opendir</EM>(3) of the current directory. When the queuedirectory is removed, <EMCLASS="emphasis">sendmail</EM> fails that open and<EMCLASS="emphasis">syslog</EM>(3)'s the following warning:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">orderq: cannot open &quot;/usr/spool/mqueue&quot; as &quot;.&quot;: No such file or directory</PRE></BLOCKQUOTE></P><PCLASS="para"></P></LI><LICLASS="listitem"><PCLASS="para">Under a few old versions of <EMCLASS="emphasis">sendmail</EM> a bug in handling the queue could cause a message to be lost whenthat message was the last in a queue run to be processed. This, amongother reasons, is good cause to always make sure you are runningthe latest version of <EMCLASS="emphasis">sendmail</EM>.</P></LI><LICLASS="listitem"><PCLASS="para">The <EMCLASS="emphasis">sendmail</EM> program assumes that only it and other trusted<EMCLASS="emphasis">root</EM> programs will placefiles into the queue directory. Consequently, it trusts everythingit finds there. The queue directory <EMCLASS="emphasis">must</EM> be protected fromother users and un-trusted programs.</P></LI><LICLASS="listitem"><PCLASS="para">If the queue directory is on a disk mounted separately from <EMCLASS="emphasis">/</EM> and <EMCLASS="emphasis">/usr</EM>, be certain to mount that disk <EMCLASS="emphasis">before</EM> startingthe <EMCLASS="emphasis">sendmail</EM> daemon. If you reverse these steps, the<EMCLASS="emphasis">sendmail</EM> daemon will <EMCLASS="emphasis">chdir</EM>(2) into the queue beforethe mount. One effect of the reversal is that incoming mail will use a differentdirectory than outgoing mail. Another effect is that incoming queuedmail will be invisible. Yet another effect is that the outgoing queuewill never be processed by the daemon.</P></LI></UL><PCLASS="para"></P></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_07.htm"TITLE="23.7 Process Alternate Queues"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.7 Process Alternate Queues"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_09.htm"TITLE="23.9 The qf File Internals"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.9 The qf File Internals"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">23.7 Process Alternate Queues</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">23.9 The qf File Internals</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>