<HTML><HEAD><TITLE>[Chapter 24] 24.5 The Aliases Database</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:38:50Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch24_01.htm"TITLE="24. Aliases"><LINKREL="prev"HREF="ch24_04.htm"TITLE="24.4 Special Aliases"><LINKREL="next"HREF="ch24_06.htm"TITLE="24.6 Prevent Aliasing with -n"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch24_04.htm"TITLE="24.4 Special Aliases"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 24.4 Special Aliases"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 24<BR>Aliases</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch24_06.htm"TITLE="24.6 Prevent Aliasing with -n"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 24.6 Prevent Aliasing with -n"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-24-SECT-5">24.5 The Aliases Database</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-24-IX-ALIASES-FILE"></A><ACLASS="indexterm"NAME="SML2-CH-24-IX-DBM-DATABASE-ALIAS-FILE-AND"></A>Reading the <EMCLASS="emphasis">aliases</EM> file every time <EMCLASS="emphasis">sendmail</EM>begins to run can slow mail delivery andcreate a lot of unnecessary computational overhead. To improve efficiency,<EMCLASS="emphasis">sendmail</EM> has the ability to store aliases in a separate databaseformat on disk. In this format, <EMCLASS="emphasis">sendmail</EM> rarely needs toread the <EMCLASS="emphasis">aliases</EM> file. Instead, it merely opensthe database and performs lookups as necessary.</P><PCLASS="para">The <EMCLASS="emphasis">sendmail</EM> program builds its database files by readingthe <EMCLASS="emphasis">aliases</EM>(5) file and rewriting that file in database format.Usually, the aliases file is called <EMCLASS="emphasis">aliases</EM>. With that name,<EMCLASS="emphasis">ndbm</EM>(3) database files are called <EMCLASS="emphasis">aliases.pag</EM> and<EMCLASS="emphasis">aliases.dir</EM>, and the <EMCLASS="emphasis">db</EM>(5) database fileis called <EMCLASS="emphasis">aliases.db</EM>.</P><PCLASS="para">The <EMCLASS="emphasis">sendmail</EM> program offers several forms of database, oneof which is chosen at compile time (see <ACLASS="xref"HREF="ch18_04.htm#SML2-CH-18-SECT-4-1"TITLE="DBMDEF=">Section 18.4.1, "DBMDEF="</A>).&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-24-SECT-5-1">24.5.1 Rebuild the Alias Database</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-23082"></A><ACLASS="indexterm"NAME="AUTOID-23085"></A><ACLASS="indexterm"NAME="AUTOID-23088"></A>You tell <EMCLASS="emphasis">sendmail</EM> to rebuild its database filesby running it in <CODECLASS="literal">-bi</CODE> mode. This mode can be executed intwo different ways:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>newaliases</B></CODE>% <CODECLASS="userinput"><B>/usr/lib/sendmail -bi</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">The first form is shorthand for the second.Either causes <EMCLASS="emphasis">sendmail</EM> to rebuild those files.If the database is successfully built, <EMCLASS="emphasis">sendmail</EM> printsa single line:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">895 aliases, longest 565 bytes, 30444 bytes total</PRE></BLOCKQUOTE></P><PCLASS="para">This shows that 895 <CODECLASS="literal">local</CODE> entries appeared to the left ofcolons in the <EMCLASS="emphasis">aliases</EM> file. The longest list of addressesto the right of a colon was 565 bytes (excluding the newline).And there were 30,444 total bytes of noncomment information inthe file.</P><PCLASS="para">V8 <EMCLASS="emphasis">sendmail</EM> supports multiple alias database files (see the<CODECLASS="literal">AliasFile</CODE> (<CODECLASS="literal">A</CODE>) option, <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-1"TITLE="">Section 34.8.1</A>).Consequently, each line of its output is prefixed with the nameof the alias file being rebuilt. For example,</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/etc/aliasdir/users: 895 aliases, longest 565 bytes, 30444 bytes total/etc/aliasdir/lists: 34 aliases, longest 89 bytes, 1296 bytes total</PRE></BLOCKQUOTE></P><PCLASS="para"></P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-24-SECT-5-2">24.5.2 Check the Right Side of Aliases</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-23116"></A><ACLASS="indexterm"NAME="AUTOID-23119"></A><ACLASS="indexterm"NAME="AUTOID-23122"></A><ACLASS="indexterm"NAME="AUTOID-23125"></A>When V8 <EMCLASS="emphasis">sendmail</EM> rebuilds the alias database files, it can optionallybe told to check the legality of all addresses to the right of thecolons. The <CODECLASS="literal">CheckAliases</CODE> (<CODECLASS="literal">n</CODE>) option(see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-6"TITLE="">Section 34.8.6, CheckAliases (n)</A>) turns on this check:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">O CheckAliases=True    # validate RHS in newaliases</PRE></BLOCKQUOTE></P><PCLASS="para">Each address is validated by running it through rule set 3,then rule set 0.Rule set 0 must select a delivery agent for the address. If it does,the address is silently validated and accepted. If not, the addressis skipped, and the following warning is printed:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><CODECLASS="replaceable"><I>address</I></CODE>... bad address</PRE></BLOCKQUOTE></P><PCLASS="para">Other errors may be printed before the above line that indicate morespecific reasons for the failure. For example,</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">... Unbalanced '&lt;'</PRE></BLOCKQUOTE></P><PCLASS="para">The <CODECLASS="literal">-d20.1</CODE> debugging switch (see <ACLASS="xref"HREF="ch37_05.htm#SML2-CH-37-SECT-5-66"TITLE="">Section 37.5.66, -d20.1</A>) can be used to gain a better idea ofwhy the <CODECLASS="replaceable"><I>address</I></CODE> failed. But be forewarned: The<CODECLASS="literal">-d20.1</CODE> switch can produce many screens of output.</P><PCLASS="para">In general, we do not recommend setting the <CODECLASS="literal">CheckAliases</CODE> (<CODECLASS="literal">n</CODE>) optionto true in the configuration file, because it can cause each right-side address tobe resolved through DNS and thus slow down the rebuild considerably.For better efficiency, leave the <EMCLASS="emphasis">CheckAliases</EM> (<CODECLASS="literal">n</CODE>) option offin the configuration file and turn it on only when rebuilding by hand:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>newaliases -on</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para"></P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-24-SECT-5-3">24.5.3 Prevent Simultaneous Rebuilds</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-23157"></A>The alias database files can be automatically rebuilt in three ways:by the daemon(if the <CODECLASS="literal">AutoRebuildAliases</CODE> (<CODECLASS="literal">D</CODE>) option, see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-4"TITLE="">Section 34.8.4, AutoRebuildAliases (D)</A>,is true), by users sending mail (and therebyindirectly running <EMCLASS="emphasis">sendmail</EM>), and by users intentionally rebuildingthe database with<EMCLASS="emphasis">newaliases</EM> (or the <CODECLASS="literal">-bi</CODE> command-line switch). To preventone rebuild from compromising and corrupting another, <EMCLASS="emphasis">sendmail</EM>uses file locking.</P><PCLASS="para">The <EMCLASS="emphasis">sendmail</EM> program uses <EMCLASS="emphasis">flock</EM>(2)or <EMCLASS="emphasis">fcntl</EM>(2) with F_SETLK to lock the <EMCLASS="emphasis">aliases</EM> file(depending on how it was compiled).If the <EMCLASS="emphasis">aliases</EM> file is already locked (because the database iscurrently being rebuilt), <EMCLASS="emphasis">sendmail</EM> prints the following message:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Alias file <CODECLASS="replaceable"><I>name</I></CODE> is already being rebuilt</PRE></BLOCKQUOTE></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-23177"></A>If <EMCLASS="emphasis">sendmail</EM> is attempting to rebuild because it wasrun as <EMCLASS="emphasis">newaliases</EM> or with the <CODECLASS="literal">-bi</CODE> command-lineswitch, the above message is printed, and the program exits.Otherwise, the above message is printed, and <EMCLASS="emphasis">sendmail</EM> waitsfor the <EMCLASS="emphasis">aliases</EM> file to become unlocked.</P><PCLASS="para">Once the <EMCLASS="emphasis">aliases</EM> file is locked, <EMCLASS="emphasis">sendmail</EM> nextlooks to see whether the key <CODECLASS="literal">@</CODE> appears in the database. If that keyis missing, <EMCLASS="emphasis">sendmail</EM> knows that the database is stillbeing rebuilt. If the <CODECLASS="literal">AliasWait</CODE> (<CODECLASS="literal">a</CODE>) option(see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-2"TITLE="">Section 34.8.2, AliasWait (a)</A>) has a value, <EMCLASS="emphasis">sendmail</EM>waits that amount of time for the other rebuild to finish.If the <CODECLASS="literal">AliasWait</CODE> (<CODECLASS="literal">a</CODE>) option is missing or has a zero value,<EMCLASS="emphasis">sendmail</EM> plows ahead, trusting the previouslock to prevent simultaneous rebuilds.</P><PCLASS="para">The <EMCLASS="emphasis">sendmail</EM> program waits the number of secondsspecified by the <CODECLASS="literal">AliasWait</CODE> (<CODECLASS="literal">a</CODE>) option for an <CODECLASS="literal">@</CODE> key toappear in the database. If that key doesn't appear within thatwait, <EMCLASS="emphasis">sendmail</EM> continues with the rebuild, assuming thatsome other process died while attempting to rebuild.</P><PCLASS="para">Before entering the key (the name to the left of the colon) and contents (everything to the right of the colon) pairs into the database, <EMCLASS="emphasis">sendmail</EM>truncates the database (reduces it to size zero), therebyremoving the <CODECLASS="literal">@</CODE> key.After all the key and contents pairs have been written to thedatabase, <EMCLASS="emphasis">sendmail</EM> adds a new <CODECLASS="literal">@</CODE> key to showthat it is done.</P><PCLASS="para">Finally, <EMCLASS="emphasis">sendmail</EM> closes the database and the<EMCLASS="emphasis">aliases</EM> file. Closing the <EMCLASS="emphasis">aliases</EM> file releasesall locks it has on that file.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-24-SECT-5-4">24.5.4 No DBM Aliasing</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-23214"></A><ACLASS="indexterm"NAME="AUTOID-23217"></A><ACLASS="indexterm"NAME="AUTOID-23220"></A>Some versions of UNIX do not provide the libraries that are needed tocompile <EMCLASS="emphasis">sendmail</EM> with database support. When neither the<EMCLASS="emphasis">db</EM>(3) nor <EMCLASS="emphasis">ndbm</EM>(3) library is available, and whenno other method for getting aliases is declared (such as <EMCLASS="emphasis">nis</EM>),<EMCLASS="emphasis">sendmail</EM> keeps aliases in its internal symbol table.</P><PCLASS="para">When the symbol table is used, <EMCLASS="emphasis">sendmail</EM> buildsits alias database only once. When <EMCLASS="emphasis">sendmail</EM> is run as a daemon, the <EMCLASS="emphasis">aliases</EM>file is read only once. If the file changes, the daemonneeds to be killed and restarted. In general, it is notrecommended to run <EMCLASS="emphasis">sendmail</EM> in daemon mode withoutexternal database files.<ACLASS="indexterm"NAME="AUTOID-23233"></A><ACLASS="indexterm"NAME="AUTOID-23234"></A>&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch24_04.htm"TITLE="24.4 Special Aliases"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 24.4 Special Aliases"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch24_06.htm"TITLE="24.6 Prevent Aliasing with -n"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 24.6 Prevent Aliasing with -n"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">24.4 Special Aliases</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">24.6 Prevent Aliasing with -n</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>