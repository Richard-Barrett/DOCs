<HTML><HEAD><TITLE>[Chapter 26] 26.2 Statistics</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:41:00Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch26_01.htm"TITLE="26. Logging and Statistics"><LINKREL="prev"HREF="ch26_01.htm"TITLE="26.1 Logging with syslog"><LINKREL="next"HREF="ch26_03.htm"TITLE="26.3 Signaling the Daemon"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch26_01.htm"TITLE="26.1 Logging with syslog"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 26.1 Logging with syslog"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 26<BR>Logging and Statistics</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch26_03.htm"TITLE="26.3 Signaling the Daemon"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 26.3 Signaling the Daemon"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-26-SECT-2">26.2 Statistics</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-26-IX-STATISTICS"></A>The <EMCLASS="emphasis">sendmail</EM> program provides the ability to gather information that can be used to produce valuable statistics. As you will see,the <CODECLASS="literal">StatusFile</CODE> (<CODECLASS="literal">S</CODE>) option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-66"TITLE="">Section 34.8.66, StatusFile (S)</A>) is used to specify a file into which delivery agentstatistics can be saved. The <EMCLASS="emphasis">mailstats</EM>(1) program (see <ACLASS="xref"HREF="ch26_02.htm#SML2-CH-26-SECT-2-2"TITLE="Viewing Statistics: mailstats">Section 26.2.2, "Viewing Statistics: mailstats"</A>) prints a summary of those statistics.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-26-SECT-2-1">26.2.1 The sendmail.st File</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-26-IX-SENDMAIL-ST-FILE"></A>The <EMCLASS="emphasis">sendmail</EM> program can maintainan ongoing record of the total number and total sizes of all outgoingand incoming mail messages handled by each delivery agent.<ACLASS="indexterm"NAME="AUTOID-25127"></A>This ability is enabled by using the <CODECLASS="literal">StatusFile</CODE> (<CODECLASS="literal">S</CODE>) option      (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-66"TITLE="">Section 34.8.66</A>):</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">OS<CODECLASS="replaceable"><I>/path                   </I></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> prior to V8.7</I>O StatusFile=<CODECLASS="replaceable"><I>/path        </I></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> beginning with V8.7</I></PRE></BLOCKQUOTE></P><PCLASS="para">&#13;The <CODECLASS="replaceable"><I>/path</I></CODE> is the full pathname of the file into whichstatistics are saved. Most vendors provide configuration filesthat specify <CODECLASS="replaceable"><I>/path</I></CODE> as</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/etc/sendmail.st</PRE></BLOCKQUOTE></P><PCLASS="para">Just declaring the <CODECLASS="literal">StatusFile</CODE> (<CODECLASS="literal">S</CODE>) optionis not enough, however,for if the file does not exist (or if it is unwritable), <EMCLASS="emphasis">sendmail</EM>silently ignores that option and does not savestatistics.You must also create the empty file</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>touch /etc/sendmail.st</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">Note that the gathering of statistics can later be turned off merely by renamingor removing the file.</P><PCLASS="para">If the <CODECLASS="literal">StatusFile</CODE> (<CODECLASS="literal">S</CODE>) option has not already been declared,you need to declare it and then kill and restart the <EMCLASS="emphasis">sendmail</EM> daemonfor that declaration to take effect.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-26-SECT-2-2">26.2.2 Viewing Statistics: mailstats</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-25158"></A><ACLASS="indexterm"NAME="AUTOID-25160"></A>The <EMCLASS="emphasis">mailstats</EM> program is supplied with <EMCLASS="emphasis">sendmail</EM> to provide aconvenient way to print the contents of the <EMCLASS="emphasis">sendmail.st</EM> file.The output of the <EMCLASS="emphasis">mailstats</EM> program varies depending on theversion of <EMCLASS="emphasis">sendmail</EM> installed. For V8.8 <EMCLASS="emphasis">sendmail</EM> the outputlooks like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Statistics from Fri May 10 11:23:55 1996 M msgsfr bytes_from  msgsto   bytes_to  Mailer 1      0          0K     43       5913K  *file* 3     26        546K     96        639K  local 4    421       2996K   3271      78233K  smtp======================================== T    447       3542K   3410      84785K</PRE></BLOCKQUOTE></P><PCLASS="para">The first line shows the timethe statistics file was begun.The lines that follow show the number of messagesand the total size in kilobytes of those messages both received(<CODECLASS="literal">msgsfr</CODE>) andsent (<CODECLASS="literal">msgsto</CODE>) for each delivery agent.The <CODECLASS="literal">M</CODE> column shows the index into the internal array ofdelivery agents, and the <CODECLASS="literal">Mailer</CODE> shows the symbolic name.The last line shows totals. Note that if a delivery agent handled no traffic,it is excluded from the report.<ACLASS="indexterm"NAME="AUTOID-25176"></A>&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-26-SECT-2-3">26.2.3 Using cron for Daily and Weekly Statistics</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-25180"></A><ACLASS="indexterm"NAME="AUTOID-25182"></A><ACLASS="indexterm"NAME="AUTOID-25185"></A>The <EMCLASS="emphasis">mailstats</EM> program prints the contents of the <EMCLASS="emphasis">sendmail.st</EM>file, but it does not zero the counters in that file. To clear (zero)that file, you need to truncate it. One easy way to truncatethe <EMCLASS="emphasis">sendmail.st</EM> file is</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>cp /dev/null /etc/sendmail.st</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">When <EMCLASS="emphasis">sendmail</EM> discoversan empty <EMCLASS="emphasis">sendmail.st</EM> file, it begins gathering statistics allover again.One use for truncation is to collect daily reportsfrom <EMCLASS="emphasis">mailstats</EM>. Consider the following simple shell script:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">#!/bin/shST=/etc/sendmail.stMS=/usr/ucb/mailstatsif [ -s $ST -a -f $MS ]; then        $MS | mail -s &quot;Daily mail stats&quot; postmaster        cp /dev/null $STfiexit 0</PRE></BLOCKQUOTE></P><PCLASS="para">When run, this script checks to see whether a nonempty <EMCLASS="emphasis">sendmail.st</EM> fileand program <EMCLASS="emphasis">mailstats</EM> exist. If they do,<EMCLASS="emphasis">mailstats</EM> is run, printing the statistics, which are then mailedto <CODECLASS="literal">postmaster</CODE>. The <EMCLASS="emphasis">sendmail.st</EM> file isthen truncated to a size of zero.Such a script could be run once per night using the <EMCLASS="emphasis">cron</EM>(8)facility with a <EMCLASS="emphasis">crontab</EM>(5) entry like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">0 0 * * * sh /usr/ucb/mailstats.script &gt;/dev/null 2&gt;&amp;1</PRE></BLOCKQUOTE></P><PCLASS="para">Here, <CODECLASS="literal">mailstats.script</CODE> is the name given to theabove shell script, and the <CODECLASS="literal">0&nbsp;0</CODE> causes that scriptto be executed once per day at midnight.</P><PCLASS="para">Some versions of <EMCLASS="emphasis">mailstats</EM> allow you to specify a differentlocation for the statistics file. The form of that specificationvaries with the version of <EMCLASS="emphasis">sendmail</EM> being run(see <EMCLASS="emphasis">mailstats</EM>(8)). Yours may look like one of the following:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>mailstats /var/log/statlog</B></CODE>% <CODECLASS="userinput"><B>mailstats -f /var/log/statlog        </B></CODE><ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> V8 uses this form</I></PRE></BLOCKQUOTE></P><PCLASS="para">If your version of <EMCLASS="emphasis">mailstats</EM> allows a different location(and name) for the statistics file, you canmove that file to the new location by revising the <CODECLASS="literal">StatusFile</CODE> (<CODECLASS="literal">S</CODE>) optionin the <EMCLASS="emphasis">sendmail</EM> program's configuration file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">OS/var/log/statlog</PRE></BLOCKQUOTE></P><PCLASS="para">Note that V8 <EMCLASS="emphasis">mailstats</EM>(8) automatically parses the configuration file tofind the location of its statistics file.</P><PCLASS="para">Moving and renaming the statistics fileallows one to automatically collect daily copiesof that file. Consider the following variation on the previousshell script:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">#!/bin/shDIR=/var/logST=statlogMS=/usr/ucb/mailstatsif [ -d $DIR ]; then        cd $DIR        if [ -s $ST -a -f $MS ]; then                test -f ${ST}.5 &amp;&amp; mv ${ST}.5 ${ST}.6                test -f ${ST}.4 &amp;&amp; mv ${ST}.4 ${ST}.5                test -f ${ST}.3 &amp;&amp; mv ${ST}.3 ${ST}.4                test -f ${ST}.2 &amp;&amp; mv ${ST}.2 ${ST}.3                test -f ${ST}.1 &amp;&amp; mv ${ST}.1 ${ST}.2                test -f ${ST}.0 &amp;&amp; mv ${ST}.0 ${ST}.1                test -f ${ST}   &amp;&amp; mv ${ST}   ${ST}.0                touch ${ST}                $MS -f $DIR/${ST}.0 | mail -s &quot;Daily mail stats&quot; postmaster        fifiexit 0</PRE></BLOCKQUOTE></P><PCLASS="para">As before, the statistics are mailed to <CODECLASS="literal">postmaster</CODE>. Butinstead of being truncated, the <EMCLASS="emphasis">sendmail.st</EM> file is renamed<EMCLASS="emphasis">sendmail.st.0</EM>. A series of renames (<EMCLASS="emphasis">mv</EM>(1)) are used to maintaina week's worth of copies.These copies allow the ambitiousadministrator to create a program for gathering weekly summariesfrom seven archived daily copies.<ACLASS="indexterm"NAME="AUTOID-25239"></A><ACLASS="indexterm"NAME="AUTOID-25240"></A>&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch26_01.htm"TITLE="26.1 Logging with syslog"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 26.1 Logging with syslog"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch26_03.htm"TITLE="26.3 Signaling the Daemon"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 26.3 Signaling the Daemon"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">26.1 Logging with syslog</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">26.3 Signaling the Daemon</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>