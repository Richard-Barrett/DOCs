<HTML><HEAD><TITLE>[Chapter 26] 26.3 Signaling the Daemon</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:41:06Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch26_01.htm"TITLE="26. Logging and Statistics"><LINKREL="prev"HREF="ch26_02.htm"TITLE="26.2 Statistics"><LINKREL="next"HREF="ch26_04.htm"TITLE="26.4 Log Transactions with -X"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch26_02.htm"TITLE="26.2 Statistics"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 26.2 Statistics"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 26<BR>Logging and Statistics</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch26_04.htm"TITLE="26.4 Log Transactions with -X"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 26.4 Log Transactions with -X"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-26-SECT-3">26.3 Signaling the Daemon</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-26-IX-SIGNALS"></A><ACLASS="indexterm"NAME="SML2-CH-26-IX-DAEMON-SIGNALS"></A>The <EMCLASS="emphasis">sendmail</EM> program recognizes three signals that cause it to perform certain actions. SIGINT causes <EMCLASS="emphasis">sendmail</EM> toclean up after itself and exit. Beginning with V8.7, SIGHUP causes <EMCLASS="emphasis">sendmail</EM> tore-execute itself (thus restarting and reading its configurationfile anew). Also beginning with V8.7,SIGUSR1 causes <EMCLASS="emphasis">sendmail</EM> to log its filedescriptors and other information.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-26-SECT-3-1">26.3.1 SIGINT  Cleanup and Exit</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-25256"></A>Whenever <EMCLASS="emphasis">sendmail</EM>gets a SIGINT signal (as would be the case if the systemwere being shut down), it tries to exit cleanly.</P><PCLASS="para">First it unlocks any queued file it is processing. This has theeffect of canceling delivery so that the message will be triedagain when the system comes back up. Then <EMCLASS="emphasis">sendmail</EM> resets itsidentity to the identity it originally ran under.This causes accounting records to correctly show that thesame user <EMCLASS="emphasis">sendmail</EM> started as has exited. Finally,<EMCLASS="emphasis">sendmail</EM> exits with EX_OK, no matter what,so that errors will not be produced during shutdown.</P><PCLASS="para">As a final note, beginning with V8.7,SIGINT is ignored when <EMCLASS="emphasis">sendmail</EM> is runningin rule-testing mode with <CODECLASS="literal">-bt</CODE>.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-26-SECT-3-2">26.3.2 SIGHUP  Restart</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-25269"></A>Beginning with V8.7, a SIGHUP signal willcause <EMCLASS="emphasis">sendmail</EM> to re-execute itself with its originalcommand line. This works only if it is running in daemon mode(with <CODECLASS="literal">-bd</CODE>; see <ACLASS="xref"HREF="ch36_07.htm#SML2-CH-36-SECT-7-5"TITLE="">Section 36.7.5, -bd</A>). For example,consider initially running <EMCLASS="emphasis">sendmail</EM> like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># <CODECLASS="userinput"><B>/usr/lib/sendmail -bd -q1h</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">&#13;Then imagine that you changed something in the configuration fileand wanted the running daemon to reread that file. You couldcause that to happen by killing the currently running daemon witha SIGHUP signal:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># <CODECLASS="userinput"><B>kill -HUP `head -1 /etc/sendmail.pid`</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">This will cause <EMCLASS="emphasis">sendmail</EM> to execute the command</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">/usr/lib/sendmail -bd -q1h</PRE></BLOCKQUOTE></P><PCLASS="para">The original daemon exits, and the newly executed daemonreplaces it.</P><PCLASS="para">Be aware that this works only if you run <EMCLASS="emphasis">sendmail</EM>using a full pathname. If you use a relative path, an attemptto restart <EMCLASS="emphasis">sendmail</EM> with SIGHUP will fail, and the following warningwill be logged at LOG_ALERT:<ACLASS="indexterm"NAME="AUTOID-25290"></A></P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">could not exec <ICLASS="lineannotation">bad command line here</I>: <ICLASS="lineannotation">reason</I></PRE></BLOCKQUOTE></P><PCLASS="para">This is a very serious situation because it means that youroriginal daemon has exited and no new daemon ran to replace it.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-26-SECT-3-3">26.3.3 SIGUSR1  Dump States</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-26-IX-DUMPING-STATE"></A>Beginning with V8.6.5, <EMCLASS="emphasis">sendmail</EM> responds to aSIGUSR1 signal. This signalcauses <EMCLASS="emphasis">sendmail</EM> to <EMCLASS="emphasis">syslog</EM>at LOG_DEBUG the several items that define its state.[2]That <EMCLASS="emphasis">syslog</EM> output begins with a line that looks like this:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[2] This same information is <EMCLASS="emphasis">syslog</EM>'d if the daemon loosestrack of <CODECLASS="literal">$j</CODE> in <CODECLASS="literal">$=w</CODE>and if <CODECLASS="literal">$j</CODE> becomes or is not fully qualified.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">-- dumping state on <CODECLASS="replaceable"><I>reason</I></CODE>: $j = <CODECLASS="replaceable"><I>val</I></CODE> --</PRE></BLOCKQUOTE></P><PCLASS="para">where <CODECLASS="replaceable"><I>reason</I></CODE> can be any one of the following:<CODECLASS="literal">siguser1</CODE> The information has been logged because <EMCLASS="emphasis">sendmail</EM> receiveda SIGUSR1 signal. In this instance the daemon logsthe information and continues to run.</P><DLCLASS="variablelist"><DTCLASS="term"><CODECLASS="literal">daemon&nbsp;lost&nbsp;$j</CODE></DT><DDCLASS="listitem"><PCLASS="para">The information has been logged because a running daemon discovered that the value in <CODECLASS="literal">$j</CODE> (the canonical nameof this host; see <ACLASS="xref"HREF="ch31_10.htm#SML2-CH-31-SECT-10-20"TITLE="">Section 31.10.20, $j</A>)disappeared from the class <CODECLASS="literal">$=w</CODE> (the list of all namesby which the local host is known; see <ACLASS="xref"HREF="ch32_05.htm#SML2-CH-32-SECT-5-8"TITLE="">Section 32.5.8, $=w</A>).This test is made and this information is logged only if <EMCLASS="emphasis">sendmail</EM> was compiled with XDEBUG defined(see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-57"TITLE="">Section 18.8.57, XDEBUG</A>).In this instance the daemon logs the information and aborts.</P></DD><DTCLASS="term"><CODECLASS="literal">daemon&nbsp;$j&nbsp;lost&nbsp;dot</CODE></DT><DDCLASS="listitem"><PCLASS="para">The information has been logged because a running daemon discovered that the value in <CODECLASS="literal">$j</CODE> (the canonical nameof this host; see <ACLASS="xref"HREF="ch31_10.htm#SML2-CH-31-SECT-10-20"TITLE="">Section 31.10.20</A>) was no longercanonical (no longer contained a dot inside it).This test is made and this information is logged onlyif <EMCLASS="emphasis">sendmail</EM> was compiled with XDEBUG defined(see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-57"TITLE="">Section 18.8.57</A>).In this instance the daemon logs the information and aborts.</P></DD></DL><PCLASS="para">Whichever the reason, the information that is logged for each looks pretty muchthe same; for example,</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">-- dumping state on <CODECLASS="replaceable"><I>when</I></CODE>: $j = <CODECLASS="replaceable"><I>val</I></CODE> -- CurChildren =<CODECLASS="replaceable"><I>num</I></CODE> -- open file descriptors: --                                    <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> output of dumpfd() here</I> -- connection cache: --                                    <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> output of mci_dump() here</I> -- ruleset debug_dumpstate returns stat <CODECLASS="replaceable"><I>ret</I></CODE>, pv: --                                     <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> output of rule set debug_dumpstate here</I> -- end of state dump --</PRE></BLOCKQUOTE></P><PCLASS="para">We have described the first line already. If for some reason <CODECLASS="literal">$j</CODE>is missing from <CODECLASS="literal">$=w</CODE>, that line will be followed by</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">*** $j not in $=w ***</PRE></BLOCKQUOTE></P><PCLASS="para">The second line simply shows the numberof children the daemon has forked and currently has out doingother work in parallel with itself. That line is followed by threesections of information. The first two sections are always output;the third is output only if rule set <CODECLASS="literal">debug_dumpstate</CODE> exists.&#13;</P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-26-SECT-3-3-1">26.3.3.1 -- open file descriptors: --</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-25361"></A>Each open file descriptor is displayed along with its current properties.These lines of output can be numerous. In general form, theylook like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><CODECLASS="replaceable"><I>num</I></CODE>: fl=<CODECLASS="replaceable"><I>flags</I></CODE> mode=<CODECLASS="replaceable"><I>mode type stats</I></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">Here, the <CODECLASS="replaceable"><I>num</I></CODE> is the number of the open file descriptor.The other information in this line is described in detail in ourdiscussion of the <CODECLASS="literal">-d2.9</CODE> debugging switch (see <ACLASS="xref"HREF="ch37_05.htm#SML2-CH-37-SECT-5-13"TITLE="">Section 37.5.13, -d2.9</A>).&#13;</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-26-SECT-3-3-2">26.3.3.2 -- connection cache: --</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-25375"></A>When sending mail, outgoing connections are maintained for efficiency,and information about those connections is cached. Before connecting to a remote host, for example, <EMCLASS="emphasis">sendmail</EM> checks itscache to see whether that host is down. If it is, it skipsconnecting to that host.</P><PCLASS="para">This output is highly detailed and very complicated. See the<CODECLASS="literal">-d11.1</CODE> debugging switch (<ACLASS="xref"HREF="ch37_05.htm#SML2-CH-37-SECT-5-44"TITLE="">Section 37.5.44, -d11.1</A>)for a full description.&#13;</P></DIV><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="SML2-CH-26-SECT-3-3-3">26.3.3.3 -- ruleset debug_dumpstate returns stat ..., pv: --</A></H4><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-25384"></A><ACLASS="indexterm"NAME="AUTOID-25386"></A>If rule set <CODECLASS="literal">debug_dumpstate</CODE>[3]is defined in your configuration file, it willbe called here, and the above line of output will be printed. The <CODECLASS="literal">stat</CODE>is the numeric representation of the code returned by<EMCLASS="emphasis">sendmail</EM>'s internal <EMCLASS="emphasis">rewrite</EM>() routine. That code will beeither EX_OK (0) if there were no parsing errors, EX_CONFIG (78) if there were, or EX_DATAERR (65)if there was a fatal error (such as too much recursion or a replacementwas out of bounds). Text describing the error is also logged andwill appear in this output.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[3] In V8.7 <EMCLASS="emphasis">sendmail</EM> this is rule set 89. Beginning withV8.8 <EMCLASS="emphasis">sendmail</EM>, rule sets 80 through 89 are reservedfor use by vendors, such as Sun Microsystems.</P></BLOCKQUOTE><PCLASS="para">Rule set <CODECLASS="literal">debug_dumpstate</CODE>is called with an empty workspace. After rule set <CODECLASS="literal">debug_dumpstate</CODE> isdone, each token in the resulting new workspace is printed one perline. This gives you a hook into the internals of <EMCLASS="emphasis">sendmail</EM>,enabling you to display information that might otherwise be invisible.For example, consider the desire to display <EMCLASS="emphasis">identd</EM> information,the current sender's address, and the current queue identifier:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Sdebug_dumpstateR$*     $@ $&amp;_ $&amp;s $&amp;i</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the <CODECLASS="literal">$*</CODE> in the LHS matches the zero tokens passedto rule set <CODECLASS="literal">debug_dumpstate</CODE>. The <CODECLASS="literal">$@</CODE> prefix in the RHS suppressesrecursion.  Each of the three macros that follows is stated witha <CODECLASS="literal">$&amp;</CODE> prefix (see <ACLASS="xref"HREF="ch31_05.htm#SML2-CH-31-SECT-5-3"TITLE="Use Value as Is with $&amp;">Section 31.5.3, "Use Value as Is with $&amp;"</A>) that preventseach from being prematurely expanded when the configuration file is first read.</P><PCLASS="para">Another example might involve the need to look up the current recipient's hostwith DNS:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Sdebug_dumpstateR$*     $@ $[ $&amp;h $]</PRE></BLOCKQUOTE></P><PCLASS="para">The <CODECLASS="literal">$[</CODE> and <CODECLASS="literal">$]</CODE> operators (see <ACLASS="xref"HREF="ch28_06.htm#SML2-CH-28-SECT-6-6"TITLE="Canonicalize Hostname: $[ and $]">Section 28.6.6, "Canonicalize Hostname: $[ and $]"</A>)cause the hostname appearing between them to be looked up withDNS and replaced with its full canonical name. Again, themacro <CODECLASS="literal">h</CODE> is prefixed with <CODECLASS="literal">$&amp;</CODE> to prevent prematureexpansion.</P><PCLASS="para">In general, rule set <CODECLASS="literal">debug_dumpstate</CODE>should be excluded from your configuration file.When a problem does appear, you can define it, restart the daemon, andthen wait for the problem to reoccur. When it does, kill <EMCLASS="emphasis">sendmail</EM>with a SIG_USR1 and examine the <EMCLASS="emphasis">syslog</EM> result.</P><PCLASS="para">Do not be tempted to use rule set <CODECLASS="literal">debug_dumpstate</CODE>for routine logging of specialtyinformation. Forcing rules to be processed with a signal is fraught with danger.The current active rule set can, for example,be clobbered in possibly unrecoverable ways. Use thisrule set <CODECLASS="literal">debug_dumpstate</CODE>technique only to solve specific problems, then eraseit when the problem is solved.<ACLASS="indexterm"NAME="AUTOID-25426"></A><ACLASS="indexterm"NAME="AUTOID-25427"></A><ACLASS="indexterm"NAME="AUTOID-25428"></A>&#13;</P></DIV></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch26_02.htm"TITLE="26.2 Statistics"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 26.2 Statistics"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch26_04.htm"TITLE="26.4 Log Transactions with -X"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 26.4 Log Transactions with -X"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">26.2 Statistics</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">26.4 Log Transactions with -X</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>