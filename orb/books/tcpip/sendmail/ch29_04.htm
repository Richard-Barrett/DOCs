<HTML><HEAD><TITLE>[Chapter 29] 29.4 Rule Set 3</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:51:22Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch29_01.htm"TITLE="29. Rule Sets"><LINKREL="prev"HREF="ch29_03.htm"TITLE="29.3 The Sequence of Rule Sets"><LINKREL="next"HREF="ch29_05.htm"TITLE="29.5 Rule Set 4"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch29_03.htm"TITLE="29.3 The Sequence of Rule Sets"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 29.3 The Sequence of Rule Sets"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 29<BR>Rule Sets</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch29_05.htm"TITLE="29.5 Rule Set 4"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 29.5 Rule Set 4"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-29-SECT-4">29.4 Rule Set 3</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-29-IX-RULE-SETS-RULE-SET-3"></A>Rule set 3 is the first to process every address.It puts each into a form that simplifies the tasks of other rule sets.The most common methodis to have rule set 3 <EMCLASS="emphasis">focus</EM> an address (place angle brackets aroundthe host part). Then later rules don't haveto search for the host part, because it is already highlighted.For example, consider trying to spot the recipient host in this mess:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">uuhost!user%host1%host2</PRE></BLOCKQUOTE></P><PCLASS="para">Here, <CODECLASS="literal">user</CODE> is eventually intended to receive the mailmessage on the host <CODECLASS="literal">uuhost</CODE>. But where should <EMCLASS="emphasis">sendmail</EM>send the message first? As it happens,<EMCLASS="emphasis">sendmail</EM> selects <CODECLASS="literal">uuhost</CODE>. Focusingon this address therefore results in the following:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">user%host1%host2&lt;@uuhost.uucp&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">Note that <CODECLASS="literal">uuhost</CODE> was moved to the end, the <CODECLASS="literal">!</CODE> was changedto an <CODECLASS="literal">@</CODE>, and <CODECLASS="literal">.uucp</CODE> was appended.The <CODECLASS="literal">@</CODE> is thereso that all focused parts uniformly contain an <CODECLASS="literal">@</CODE>just before the targeted host.Later, when we take up postprocessing,we'll show how rule set 4 moves the <CODECLASS="literal">uuhost</CODE> back to the beginningand replaces the <CODECLASS="literal">!</CODE>.&#13;</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-4-1">29.4.1 A Special Case: From:&lt;&gt;</A></H3><PCLASS="para">The first rule in a typical rule set 3 handles addresses that arecomposed of empty angle brackets. These represent the specialcase of an empty or nonexistent address. Empty addresses shouldbe turned into the address of the pseudo-user that bounces mail,<EMCLASS="emphasis">Mailer-Daemon</EM>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># handle &quot;from:&lt;&gt;&quot; special caseR$*&lt;&gt;$*      $@&lt;@&gt;       empty becomes special</PRE></BLOCKQUOTE></P><PCLASS="para">Here, empty angle brackets, no matter what surrounds them (<CODECLASS="literal">$*</CODE>),are rewritten to be a lone <CODECLASS="literal">@</CODE>. Other rule sets later turn thisspecial token into <CODECLASS="literal">$n</CODE> (which contains <EMCLASS="emphasis">Mailer-Daemon</EM>as its value).&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-4-2">29.4.2 Basic Textual Canonicalization</A></H3><PCLASS="para">Addresses can be legally expressed in only four formats:[2]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[2] Actually, we are fudging for simplicity. Addresses can appear in various permutations of those shownand we completely ignore the <CODECLASS="literal">list:members;</CODE>form of address.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">addressaddress (full name)&lt;address&gt;full name &lt;address&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">When <EMCLASS="emphasis">sendmail</EM> preprocesses an address that is in the secondformat, it removes (and saves for later use)the full name from within the parentheses. The lasttwo formats, however, contain additional characters and informationthat are not discarded during preprocessing. As a consequence, ruleset 3 must take on the job of discarding the unwanted information:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># basic textual canonicalizationR$*&lt;$*&lt;$*&lt;$*&gt;$*&gt;$*&gt;$*   $4        3-level &lt;&gt; nestingR$*&lt;$*&lt;$*&gt;$*&gt;$*         $3        2-level &lt;&gt; nestingR$*&lt;$*&gt;$*               $2        basic RFC821/822 parsing</PRE></BLOCKQUOTE></P><PCLASS="para">Here, we discard everything outside of and including the innermostpair of angle brackets. Three rules are required to do this because ofthe minimal-matching nature of the LHS operators(see <ACLASS="xref"HREF="ch08_07.htm#SML2-CH-8-SECT-7-2"TITLE="Minimal Matching">Section 8.7.2, "Minimal Matching"</A>). Considertrying to de-nest a three-level workspace using only a rulelike the third:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><ICLASS="lineannotation">the workspace <IMGSRC="../chars/rarr.gif"ALT="-&gt;"></I>  A &lt; B &lt; C &lt; D &gt; C &gt; B &gt; A$*  <ICLASS="lineannotation">matches <IMGSRC="../chars/rarr.gif"ALT="-&gt;"> </I>A&lt;   <ICLASS="lineannotation">matches <IMGSRC="../chars/rarr.gif"ALT="-&gt;"> </I>&lt;$+  <ICLASS="lineannotation">matches <IMGSRC="../chars/rarr.gif"ALT="-&gt;"> </I>B &lt; C &lt; D&gt;   <ICLASS="lineannotation">matches <IMGSRC="../chars/rarr.gif"ALT="-&gt;"> </I>&gt;$*  <ICLASS="lineannotation">matches <IMGSRC="../chars/rarr.gif"ALT="-&gt;"> </I>C &gt; B &gt; A</PRE></BLOCKQUOTE></P><PCLASS="para">Clearly, the result <CODECLASS="literal">B&lt;C&lt;D</CODE> is not the value between the innermostpair of angle brackets and will result in an address that producesthe error message:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Unbalanced '&lt;'</PRE></BLOCKQUOTE></P><PCLASS="para">John Halleck designed a clever alternative to the above traditional techniquethat is now included with V8 <EMCLASS="emphasis">sendmail</EM>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$*                     $: &lt; $1 &gt;                       housekeeping &lt;&gt;R$+ &lt; $* &gt;                 &lt; $2 &gt;                       strip excess on leftR&lt; $* &gt; $+                 &lt; $1 &gt;                       strip excess on rightR&lt;&gt;                     $@ &lt; @ &gt;                        MAIL FROM:&lt;&gt; caseR&lt; $+ &gt;                 $: $1                           remove housekeeping &lt;&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">Here, angle bracket pairs are stripped first from the left of an address,then from the right, and finally whatever is left must be the address.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-4-3">29.4.3 Handling Routing Addresses</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-27953"></A><ACLASS="indexterm"NAME="AUTOID-27956"></A>The <EMCLASS="emphasis">sendmail</EM> program must be able to handle addressesthat are in <EMCLASS="emphasis">route address</EM> syntax.Such addresses are in the form<EMCLASS="emphasis">@A,@B:user@C</EM> (which means that mail should be sent first to <EMCLASS="emphasis">A</EM>, then from <EMCLASS="emphasis">A</EM> to <EMCLASS="emphasis">B</EM>, and finallyfrom <EMCLASS="emphasis">B</EM> to <EMCLASS="emphasis">C</EM>).[3]The commas are converted to colons foreasier design of subsequent rules. They must be converted back tocommas by rule set 4.Rule set 3 uses a simple rule to convert all commas tocolons:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[3] Also see the <CODECLASS="literal">DontPruneRoutes</CODE> option in <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-20"TITLE="">Section 34.8.20, DontPruneRoutes (R)</A>and the <CODECLASS="literal">F=d</CODE> delivery agent flag in <ACLASS="xref"HREF="ch30_08.htm#SML2-CH-30-SECT-8-16"TITLE="">Section 30.8.16, F=d</A>.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># make sure list syntax is easy to parseR@ $+ , $+        @ $1 : $2           change all &quot;,&quot; to &quot;:&quot;</PRE></BLOCKQUOTE></P><PCLASS="para">The iterative nature of rules comes into play here. As long as thereis an <CODECLASS="literal">@</CODE> followed by anything (<CODECLASS="literal">$+</CODE>), then a comma,then anything, this rule repeats, converting the comma toa colon. The result is then carrieddown to the next rule that focuses:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R@ $+ : $+         $@ &lt;@ $1&gt; : $2      focus route-addr</PRE></BLOCKQUOTE></P><PCLASS="para">Once that host has angle brackets placed around it (is focused),the job of rule set 3 ends, and it exits (the <CODECLASS="literal">$@</CODE> prefix in the RHS).&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-4-4">29.4.4 Handling Specialty Addresses</A></H3><PCLASS="para">&#13;A whole book is dedicated to the myriad formsof addressing that might face a site administrator: <EMCLASS="emphasis">!%@:: A Directory of Electronic Mail Addressing &amp; Networks</EM> byDonnalyn Frey and Rick Adams (O'Reilly &amp; Associates, 1993).We won't duplicate that work here; rather, we point out thatmost such addresses are handled nicely by existing configuration files.Consider the format of a DECnet address:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">host::user</PRE></BLOCKQUOTE></P><PCLASS="para">One approach to handling such an address in rule set 3 is to convertit into the Internet <EMCLASS="emphasis">user@host.domain</EM> form:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$+ :: $+        $@ $2 @ $1.decnet</PRE></BLOCKQUOTE></P><PCLASS="para">Here, we reverse the <CODECLASS="literal">host</CODE> and <CODECLASS="literal">user</CODE> and put them intoInternet form. The <CODECLASS="literal">.decnet</CODE> can later be used by rule set 0to select an appropriate delivery agent.</P><PCLASS="para">This is a simple example of a special address problem from the manythat can develop. In addition to DECnet, for example, your site may have to dealwith Xerox <EMCLASS="emphasis">Grapevine</EM> addresses, X.400 addresses, or UUCPaddresses. The best way to handle such addresses is to copy what othershave done.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-4-5">29.4.5 Focusing for @ Syntax</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-28000"></A>The last few rules in our illustration of rule set 3 are used to processthe Internet-style <EMCLASS="emphasis">user@domain</EM> address:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># find focus for @ syntax addressesR$+ @ $+                $: $1 &lt;@ $2&gt;        focus on domainR$+ &lt; $+ @ $+ &gt;            $1 $2 &lt;@ $3&gt;     move gaze rightR$+ &lt;@ $+ &gt;             $@ $1 &lt;@ $2&gt;        already focused</PRE></BLOCKQUOTE></P><PCLASS="para">For an address like <EMCLASS="emphasis">something@something</EM>, the first rulefocuses on all the tokens following the first<CODECLASS="literal">@</CODE> as the name of the host.Recall that the <CODECLASS="literal">$:</CODE> prefix to the RHSprevents potentially infinite recursion. Assuming that the workspace startedwith:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">user@host1@host2</PRE></BLOCKQUOTE></P><PCLASS="para">this first rewrite results in</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">user&lt;@host1@host2&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">The second rule (<CODECLASS="literal">move gaze right</CODE>) then attempts tofine-tune the focus by making sure only the rightmost <CODECLASS="literal">@host</CODE>is selected. This rule can move the focus right, using recursion, andcan handle addresses that are as extreme as the following:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">user&lt;@host1@host2@host3@host4&gt; <ICLASS="lineannotation">becomes <IMGSRC="../chars/rarr.gif"ALT="-&gt;"></I> user@host1@host2@host3&lt;@host4&gt;</PRE></BLOCKQUOTE></P><PCLASS="para">&#13;The third rule checks to see whether the workspacehas been focused. If it has, it returns the focused workspace(the <CODECLASS="literal">$@</CODE> prefix in the RHS), and its job is done.</P><PCLASS="para">Any address that has not been handled by rule set 3 is unchangedand probably not focused. Since rule set 0 expects all addressesto be focused so that it can select appropriate delivery agents, suchunfocused addresses may bounce. Many configuration filesallow local addresses (just a username) to be unfocused.<ACLASS="indexterm"NAME="AUTOID-28023"></A>&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch29_03.htm"TITLE="29.3 The Sequence of Rule Sets"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 29.3 The Sequence of Rule Sets"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch29_05.htm"TITLE="29.5 Rule Set 4"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 29.5 Rule Set 4"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">29.3 The Sequence of Rule Sets</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">29.5 Rule Set 4</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>