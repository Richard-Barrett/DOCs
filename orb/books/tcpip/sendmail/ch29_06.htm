<HTML><HEAD><TITLE>[Chapter 29] 29.6 Rule Set 0</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:51:39Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch29_01.htm"TITLE="29. Rule Sets"><LINKREL="prev"HREF="ch29_05.htm"TITLE="29.5 Rule Set 4"><LINKREL="next"HREF="ch29_07.htm"TITLE="29.7 Rule Set 5"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch29_05.htm"TITLE="29.5 Rule Set 4"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 29.5 Rule Set 4"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 29<BR>Rule Sets</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch29_07.htm"TITLE="29.7 Rule Set 5"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 29.7 Rule Set 5"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-29-SECT-6">29.6 Rule Set 0</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-29-IX-RULE-SETS-RULE-SET-0"></A><ACLASS="indexterm"NAME="AUTOID-28078"></A><ACLASS="indexterm"NAME="AUTOID-28081"></A>The job of rule set 0 is to select a delivery agent for each recipient.It is called once for each recipient and must rewrite each into aspecial form called a <EMCLASS="emphasis">triple</EM>. A triple is simply three piecesof information: the symbolic name of the delivery agent,the host part of the address, and the user part of the address.Each part is indicated in the RHS by a special prefix operator, as shown in<ACLASS="xref"HREF="ch29_06.htm#SML2-CH-29-TAB-1"TITLE="Rule Set 0 Special RHS Operators">Table 29.2</A>.&#13;</P><TABLECLASS="table"><CAPTIONCLASS="table"><ACLASS="title"NAME="SML2-CH-29-TAB-1">Table 29.2: Rule Set 0 Special RHS Operators</A></CAPTION><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Operator</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Description</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">$#</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Delivery agent</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">$@</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Recipient host</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="literal">$:</CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Recipient user</TD></TR></TBODY></TABLE><PCLASS="para">&#13;The triple is formed by rewriting with the RHS. It looks like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$#<CODECLASS="replaceable"><I>delivery_agent</I></CODE> $@<CODECLASS="replaceable"><I>host</I></CODE> $:<CODECLASS="replaceable"><I>user</I></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">The delivery agent selection must be the first of the three. In addition tospecifying the delivery agent, <CODECLASS="literal">$#</CODE> also causes rule set 0to exit. The other two parts of the triple must appear in the ordershown (<CODECLASS="literal">$@</CODE> first, then <CODECLASS="literal">$:</CODE>).</P><PCLASS="para">All three parts of the triple must be present in the RHS. The onlyexception is the <CODECLASS="literal">$@</CODE><CODECLASS="replaceable"><I>host</I></CODE> part when the deliveryagent has the <CODECLASS="literal">F=l</CODE> flag set.It <EMCLASS="emphasis">may</EM> be present for IDA and V8 <EMCLASS="emphasis">sendmail</EM>but must be absent for all other versions of <EMCLASS="emphasis">sendmail</EM>.</P><PCLASS="para">Not all rules in rule set 0 are specifically used to select a deliveryagent. It may be necessary, for example, to canonicalize an addresswith <CODECLASS="literal">$[</CODE> and <CODECLASS="literal">$]</CODE> (see <ACLASS="xref"HREF="ch28_06.htm#SML2-CH-28-SECT-6-6"TITLE="Canonicalize Hostname: $[ and $]">Section 28.6.6, "Canonicalize Hostname: $[ and $]"</A>)before being able to decide whether the address is local or remote.</P><PCLASS="para">If an address passes through rule set 0 without selectinga delivery agent, the following error message is produced, and themail message bounces:<ACLASS="indexterm"NAME="AUTOID-28129"></A></P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">buildaddr: no mailer in parsed address</PRE></BLOCKQUOTE></P><PCLASS="para">&#13;Therefore it is important to design a rule set 0 that selects a deliveryagent for every legitimate address.</P><PCLASS="para">If a triple is missing the user part, the following error isproduced:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">buildaddr: no user</PRE></BLOCKQUOTE></P><PCLASS="para">If the delivery agent that is selected is one for which there is nocorresponding <CODECLASS="literal">M</CODE> configuration file declaration, the error is<ACLASS="indexterm"NAME="AUTOID-28139"></A></P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">buildaddr: unknown mailer <ICLASS="lineannotation">bad delivery agent name here</I></PRE></BLOCKQUOTE></P><PCLASS="para"></P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-6-1">29.6.1 Further Processing: $:user</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-28148"></A><ACLASS="indexterm"NAME="AUTOID-28151"></A>The user part of the triple is intended for use in the command lineof the delivery agent and in the RCPT command in an SMTP connection.For either use, that address is rewritten by rule set 2, the<CODECLASS="literal">R=</CODE> equate of the delivery agent, and rule set 4,as illustrated in<ACLASS="xref"HREF="ch29_06.htm#SML2-CH-29-FIG-4"TITLE="The flow of $:user through rule sets">Figure 29.5</A>.This means that the user part can be in focusedform, because the focus is later removed by rule set 4.But the user part <EMCLASS="emphasis">must</EM> be a single username (no host)for the <CODECLASS="literal">local</CODE> delivery agent.</P><PCLASS="para">The rewritten result is stored for use whena delivery agent's <CODECLASS="literal">$u</CODE> in<CODECLASS="literal">A=</CODE> (see <ACLASS="xref"HREF="ch30_04.htm#SML2-CH-30-SECT-4-1"TITLE="">Section 30.4.1, A=</A>) argument is expanded.For example, for the <CODECLASS="literal">local</CODE> delivery agent, the rewritten result is theusername as it will be given to <EMCLASS="emphasis">/bin/mail</EM> for local delivery.</P><H4CLASS="figure"><ACLASS="title"NAME="SML2-CH-29-FIG-4">Figure 29.5: The flow of $:user through rule sets</A></H4><IMGCLASS="graphic"SRC="figs/sm2806.gif"ALT="Figure 29.5"><PCLASS="para">The rewritten result is also given to a remote site duringthe exchange of mail using the SMTP protocol. The local machinetells the remote machine the name of the recipient by saying<CODECLASS="literal">RCPT to:</CODE> followed by the rewritten user portionof the triple.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-6-2">29.6.2 Selecting S= and R=</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-28172"></A><ACLASS="indexterm"NAME="AUTOID-28174"></A><ACLASS="indexterm"NAME="AUTOID-28176"></A>When it selects a delivery agent, rule set 0 also selectsthe rules that will be used in rewriting senderand recipient addresses. A sender address is rewritten bythe rule set specified by the <CODECLASS="literal">S=</CODE> equate (see <ACLASS="xref"HREF="ch30_04.htm#SML2-CH-30-SECT-4-11"TITLE="">Section 30.4.11, S=</A>).The recipient addresses are rewritten by the rule set specified by the <CODECLASS="literal">R=</CODE> equate (see <ACLASS="xref"HREF="ch30_04.htm#SML2-CH-30-SECT-4-10"TITLE="">Section 30.4.10</A>).If the <CODECLASS="literal">R=</CODE> or <CODECLASS="literal">S=</CODE> specifies rule set 0 orif either is undeclared, then that portion of rewritingis skipped.</P><PCLASS="para">We won't cover individual <CODECLASS="literal">R=</CODE> or <CODECLASS="literal">S=</CODE> rule sets here, becausethey depend on the individual needs of delivery agents.Instead, we recommend that you examine how your configuration file usesthem. You'll probably be surprised to find that many <CODECLASS="literal">R=</CODE> and<CODECLASS="literal">S=</CODE> equates reference nonexistent rules (which means that<EMCLASS="emphasis">sendmail</EM> will do no rewriting).&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-6-3">29.6.3 Delivering to Local Recipient</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-28194"></A><ACLASS="indexterm"NAME="AUTOID-28197"></A><ACLASS="indexterm"NAME="AUTOID-28201"></A>Typically, some early rules in rule set 0 are intended todetect addresses that should be delivered locally. A rule that accomplishes that end might look like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$+ &lt;@ $w&gt;          $#local $:$1                 local address</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the <CODECLASS="literal">$w</CODE> macro is the name of the local host. Note that theRHS strips the focused host part from the username.</P><PCLASS="para">At some sites, the local host can be known by any of severalnames. A rule to handle such hosts would begin with a classdeclaration that adds those names to the class <CODECLASS="literal">w</CODE> (likethe first line below):<ACLASS="indexterm"NAME="AUTOID-28210"></A><ACLASS="indexterm"NAME="AUTOID-28213"></A></P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Cw font-server fax printer3R$+ &lt;@ $=w&gt;        $#local $:$1                 local address</PRE></BLOCKQUOTE></P><PCLASS="para">The class <CODECLASS="literal">w</CODE> is special because it is the one to which<EMCLASS="emphasis">sendmail</EM> automatically appends the alternative name of thelocal host. The class declaration line above adds names that <EMCLASS="emphasis">sendmail</EM>might not automatically detect. Usually, such a declarationwould be near the top of the configuration file, rather thanin rule set 0, but technically it can appear anywhere in the file.This rule looks to see whetheran address contains any of the names in class <CODECLASS="literal">w</CODE>. If it does, the<CODECLASS="literal">$=w</CODE> in the LHS matches, and the RHS selects the<CODECLASS="literal">local</CODE> delivery agent.</P><PCLASS="para">On central mail server machines, rule set 0 may also haveto match from a list of hosts for which the central server is anMX recipient machine (see <ACLASS="xref"HREF="ch19_06.htm#SML2-CH-19-SECT-6-26"TITLE="">Section 19.6.26, FEATURE(use-cw-file)</A>).&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-6-4">29.6.4 Forwarding to a Knowledgeable Host</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-28229"></A><ACLASS="indexterm"NAME="AUTOID-28232"></A>After handling mail destined for the local host, rule set 0generally looks for addresses that require a knowledgeablehost to forward messages on the local host's behalf.In the following rule, <CODECLASS="literal">$B</CODE> (see <ACLASS="xref"HREF="ch31_10.htm#SML2-CH-31-SECT-10-5"TITLE="">Section 31.10.5, $B</A>) is the nameof a machine that knows how to deliver BITNET mail (see <ACLASS="xref"HREF="ch19_04.htm#SML2-CH-19-SECT-4-5"TITLE="Relays">Section 19.4.5, "Relays"</A>):</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$* &lt;@ $+.BITNET&gt; $*   $#smtp $@$B $:$1&lt;@$2.BITNET&gt;$3    user@host.BITNET</PRE></BLOCKQUOTE></P><PCLASS="para">The tag <CODECLASS="literal">.BITNET</CODE> would have been added by userswhen sending mail. Note that <CODECLASS="literal">BITNET</CODE> in the LHS is case-insensitive;a user can specify <CODECLASS="literal">Bitnet</CODE>, <CODECLASS="literal">bitnet</CODE>,or even <CODECLASS="literal">BiTNeT</CODE>, and this rule will still match.A similar scheme can be used for other specialty addresses,such as UUCP and DECnet.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-6-5">29.6.5 Handling UUCP Locally</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-28248"></A><ACLASS="indexterm"NAME="AUTOID-28251"></A>Hosts sometimes deliver mail to a few UUCP connections locally and forwardto other UUCP connections through a knowledgeable host. The rules that handle thissituation often make use of another class:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$* &lt;@ $=V.UUCP&gt;     $#uucp $@$2 $:$1               user@localuucpR$* &lt;@ $+.UUCP&gt;      $#smtp $@$Y $:$1&lt;@$2.UUCP&gt;     kick upstairs</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the class <CODECLASS="literal">$=V</CODE> contains a list of local UUCP connections.They are matched by the first rule, which selects the <CODECLASS="literal">uucp</CODE>delivery agent. All other UUCP addresses are passed to theknowledgeable host in <CODECLASS="literal">$Y</CODE> (see <ACLASS="xref"HREF="ch31_10.htm#SML2-CH-31-SECT-10-45"TITLE="">Section 31.10.45, $Y</A>)). The user part (<CODECLASS="literal">$:</CODE>)that is given to the knowledgeable host is the original address as itappeared to the LHS.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-6-6">29.6.6 Forwarding over the Network</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-28265"></A>Next, rule set 0 typically sees whether it can send the mail messageover the network. In the following example we assume that the local hostis connected to an IP network:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># deal with other remote namesR$* &lt;@ $*&gt; $*         $#smtp $@$2 $:$1&lt;@$2&gt;$3          user@host.domain</PRE></BLOCKQUOTE></P><PCLASS="para">Remember that we have already screened out and handleddelivery to the local host, and therefore the focused host (in the <CODECLASS="literal">&lt;@$*&gt;</CODE> of the LHS) is on the network.The <CODECLASS="literal">smtp</CODE>delivery agent is selected (to deliver using the SMTP protocol),with connection to be made to <CODECLASS="literal">$2</CODE> (the <CODECLASS="literal">$*</CODE> partof the <CODECLASS="literal">&lt;@$*&gt;</CODE> in the LHS). </P><PCLASS="para">The focus is kept in the user portion of the RHS triple. Rememberthat the user portion will be rewritten by rule sets 2, <CODECLASS="literal">R=</CODE>,and 4. Also remember that rule set 4 will defocus the address.The reason we keep the focus here is because rule set 2 andall <CODECLASS="literal">R=</CODE> rules expect the host part of addresses to be focused.&#13;</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-29-SECT-6-7">29.6.7 Handling Leftover Local Addresses</A></H3><PCLASS="para">Whatever is left after all preceding rules in rule set0 have selected delivery agents is probably a local address.Here, we check for a username without a host part:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">R$+       $#local $:$1        regular local names</PRE></BLOCKQUOTE></P><PCLASS="para">Notice that the user part is not focused; it is unfocused becausethere is no host part on lone local usernames.<ACLASS="indexterm"NAME="AUTOID-28285"></A></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch29_05.htm"TITLE="29.5 Rule Set 4"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 29.5 Rule Set 4"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch29_07.htm"TITLE="29.7 Rule Set 5"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 29.7 Rule Set 5"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">29.5 Rule Set 4</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">29.7 Rule Set 5</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>