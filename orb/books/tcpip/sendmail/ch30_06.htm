<HTML><HEAD><TITLE>[Chapter 30] 30.6 How Executed</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T19:57:22Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch30_01.htm"TITLE="30. Delivery Agents"><LINKREL="prev"HREF="ch30_05.htm"TITLE="30.5 Internally Defined Names"><LINKREL="next"HREF="ch30_07.htm"TITLE="30.7 Pitfalls"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch30_05.htm"TITLE="30.5 Internally Defined Names"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 30.5 Internally Defined Names"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 30<BR>Delivery Agents</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch30_07.htm"TITLE="30.7 Pitfalls"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 30.7 Pitfalls"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-30-SECT-6">30.6 How Executed</A></H2><PCLASS="para">For safety and efficiency, <EMCLASS="emphasis">sendmail</EM> undertakes a complicatedseries of steps to run (execute) a delivery agent.[14]Some (such as setting the environment) are intended to improvesecurity. Others (such as forking) are intended to improveefficiency by creating parallel actions. Here, we discuss those steps in the order in which theyare taken by <EMCLASS="emphasis">sendmail</EM>.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[14] For the purposeof this discussion we will exclude the internal agents (such asIPC) and focus on actual programs (such as <EMCLASS="emphasis">/bin/mail</EM>).</P></BLOCKQUOTE><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-30-SECT-6-1">30.6.1 Fork</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-30772"></A>When <EMCLASS="emphasis">sendmail</EM> performs delivery, it cannotsimply replace itself with the delivery agent program. Instead, itmust <EMCLASS="emphasis">fork</EM>(2), and the child will replace itself.</P><PCLASS="para">If <EMCLASS="emphasis">sendmail</EM> is running in verbose mode (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-76"TITLE="">Section 34.8.76, Verbose</A>), itshows that it is about to start this process:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Connecting to <ICLASS="lineannotation">delivery agent</I></PRE></BLOCKQUOTE></P><PCLASS="para">If a traffic-logging file was specified with <CODECLASS="literal">-X</CODE>command-line switch (see <ACLASS="xref"HREF="ch26_04.htm"TITLE="Log Transactions with -X">Section 26.4, "Log Transactions with -X"</A>), <EMCLASS="emphasis">sendmail</EM> appends thefollowing line to that file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><ICLASS="lineannotation">pid</I> === EXEC <ICLASS="lineannotation">the expanded A= here</I></PRE></BLOCKQUOTE></P><PCLASS="para">Here, the <CODECLASS="literal">A=</CODE> equate (see <ACLASS="xref"HREF="ch30_04.htm#SML2-CH-30-SECT-4-1"TITLE="">Section 30.4.1</A>) from the deliveryagent's declaration is printed with all its macros expandedand with the recipients listed.</P><PCLASS="para">Next <EMCLASS="emphasis">sendmail</EM> creates a <EMCLASS="emphasis">pipe</EM> so that itwill be able to print the email message to thedelivery agent and so that it can read errorsemitted by the delivery agent. See the <CODECLASS="literal">-d11</CODE> debuggingswitch (see <ACLASS="xref"HREF="ch37_05.htm#SML2-CH-37-SECT-5-44"TITLE="">Section 37.5.44, -d11.1</A>) for a description of whatcan go wrong.</P><PCLASS="para">If all has gone well, <EMCLASS="emphasis">sendmail</EM> <EMCLASS="emphasis">fork</EM>(2)sa copy of itself. The parent then pipes the emailmessage to the child.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-30-SECT-6-2">30.6.2 The Child</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-30804"></A>The child is the copy of <EMCLASS="emphasis">sendmail</EM> that will transforminto the delivery agent. But before the child can transform, itmust perform a few more necessary steps.</P><PCLASS="para">If <EMCLASS="emphasis">sendmail</EM> was compiled with HASSETUSERCONTEXTdefined (see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-9"TITLE="">Section 18.8.9, HAS...</A>), it calls <EMCLASS="emphasis">setusercontext</EM>(3) like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">setusercontext(NULL, <CODECLASS="replaceable"><I>pwd</I></CODE>, <CODECLASS="replaceable"><I>uid</I></CODE>, LOGIN_SETRESOURCES|LOGIN_SETPRIORITY);</PRE></BLOCKQUOTE></P><PCLASS="para">Here, <CODECLASS="replaceable"><I>pwd</I></CODE> is a pointer to a structure of type<EMCLASS="emphasis">passwd</EM> for the user whose <EMCLASS="emphasis">uid</EM> is <CODECLASS="replaceable"><I>uid</I></CODE>.The <CODECLASS="replaceable"><I>uid</I></CODE> is that of the controlling user(see <ACLASS="xref"HREF="ch24_02.htm#SML2-CH-24-SECT-2-2"TITLE="Delivery to Files">Section 24.2.2, "Delivery to Files"</A>) or therecipient (see <ACLASS="xref"HREF="ch30_08.htm#SML2-CH-30-SECT-8-33"TITLE="">Section 30.8.33, F=o</A>).</P><PCLASS="para">If the <CODECLASS="literal">N=</CODE> equate (see <ACLASS="xref"HREF="ch30_04.htm#SML2-CH-30-SECT-4-8"TITLE="">Section 30.4.8</A>) has anonzero value, <EMCLASS="emphasis">sendmail</EM> calls <EMCLASS="emphasis">nice</EM>(3) to &quot;re-nice&quot;the delivery agent to that value.</P><PCLASS="para">The <EMCLASS="emphasis">sendmail</EM> program next sets its <EMCLASS="emphasis">uid</EM> and<EMCLASS="emphasis">gid</EM> as appropriate. If the <CODECLASS="literal">DontInitGroups</CODE> option(see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-19"TITLE="">Section 34.8.19, DontInitGroups</A>) is false, <EMCLASS="emphasis">sendmail</EM>calls <EMCLASS="emphasis">initgroups</EM>(3).The identity used is that described under the <CODECLASS="literal">DefaultUser</CODE>option (see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-15"TITLE="">Section 34.8.15</A>).</P><PCLASS="para">Next <EMCLASS="emphasis">sendmail</EM> attempts to <EMCLASS="emphasis">chdir</EM>(2) into one ofthe directories listed in the <CODECLASS="literal">D=</CODE> equate (see <ACLASS="xref"HREF="ch30_04.htm#SML2-CH-30-SECT-4-3"TITLE="">Section 30.4.3</A>).This process can be watched with the <CODECLASS="literal">-d11.20</CODE> debuggingswitch (see <ACLASS="xref"HREF="ch37_05.htm#SML2-CH-37-SECT-5-46"TITLE="">Section 37.5.46</A>).</P><PCLASS="para">Finally, <EMCLASS="emphasis">sendmail</EM> calls <EMCLASS="emphasis">setsid</EM>(2) to become a process-groupleader and <EMCLASS="emphasis">execve</EM>(2)to become the delivery agent. That lattercall looks like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">execve(<CODECLASS="replaceable"><I>agent</I></CODE>, <CODECLASS="replaceable"><I>argv</I></CODE>, <CODECLASS="replaceable"><I>envp</I></CODE>);</PRE></BLOCKQUOTE></P><PCLASS="para">Here, <CODECLASS="replaceable"><I>agent</I></CODE> is the full path of the delivery agentas specified in the <CODECLASS="literal">P=</CODE> equate (see <ACLASS="xref"HREF="ch30_04.htm#SML2-CH-30-SECT-4-9"TITLE="">Section 30.4.9</A>).The argument vector (contents of the <CODECLASS="literal">A=</CODE> equate withall the macros expanded and all the recipients added) is passedas <CODECLASS="replaceable"><I>argv</I></CODE>. The environment is that originally givento <EMCLASS="emphasis">sendmail</EM>, massaged for security and augmentedby the <CODECLASS="literal">E=</CODE> configuration command (see <ACLASS="xref"HREF="ch22_02.htm#SML2-CH-22-SECT-2-1"TITLE="The E Configuration Command">Section 22.2.1</A>).</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch30_05.htm"TITLE="30.5 Internally Defined Names"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 30.5 Internally Defined Names"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch30_07.htm"TITLE="30.7 Pitfalls"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 30.7 Pitfalls"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">30.5 Internally Defined Names</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">30.7 Pitfalls</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>