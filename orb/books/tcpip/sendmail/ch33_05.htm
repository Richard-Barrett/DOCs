<HTML><HEAD><TITLE>[Chapter 33] 33.5 The User Database</TITLE><METANAME="DC.title"CONTENT="sendmail"><METANAME="DC.creator"CONTENT="Bryan Costales &amp; Eric Allman"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-01-06T20:25:27Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-222-0"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch33_01.htm"TITLE="33. Database Macros"><LINKREL="prev"HREF="ch33_04.htm"TITLE="33.4 Use Maps with $( and $) in Rules"><LINKREL="next"HREF="ch33_06.htm"TITLE="33.6 Database Maps and m4"></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="sendmail"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="sendmail"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/ssrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch33_04.htm"TITLE="33.4 Use Maps with $( and $) in Rules"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 33.4 Use Maps with $( and $) in Rules"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 33<BR>Database Macros</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch33_06.htm"TITLE="33.6 Database Maps and m4"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 33.6 Database Maps and m4"BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="SML2-CH-33-SECT-5">33.5 The User Database</A></H2><PCLASS="para"><ACLASS="indexterm"NAME="SML2-CH-33-IX-USER-DATABASE"></A><ACLASS="indexterm"NAME="SML2-CH-33-IX-DATABASES-USER-DATABASE"></A>The User Database is a special database file that you create foruse by <EMCLASS="emphasis">sendmail</EM>.It causes sender and recipient addresses to be rewritten undercontrol of an external database file.Ordinarily, any local address is first looked up in the <EMCLASS="emphasis">aliases</EM>database. If it is not found there, that user's <EMCLASS="emphasis">~/.forward</EM> is nextexamined. If the User Database is enabled, the address is looked upin that database after aliasing and before forwarding.</P><PCLASS="para">Lookup can be local via a database file, remote via a User Databaseserver, or via a Hesiod network service. Here, we describe thedatabase file form. The others are described in <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-75"TITLE="">Section 34.8.75, UserDatabaseSpec (U)</A>.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-33-SECT-5-1">33.5.1 Enable the User Database</A></H3><PCLASS="para">The User Database is automatically enabled when you compile<EMCLASS="emphasis">sendmail</EM> if you include support for NEWDB or HESIOD(see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-54"TITLE="">Section 18.8.54, USERDB</A>). To see whether a precompiled version of <EMCLASS="emphasis">sendmail</EM> includes User Databasesupport, run it with the <CODECLASS="literal">-d0.1</CODE> switch:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>/usr/lib/sendmail -d0.1 -bt &lt; /dev/null</B></CODE>Version 8.8.4 Compiled with: LOG MIME8TO7 NETINET NETUNIX NEWDB SCANF <CODECLASS="userinput"><B>USERDB</B></CODE> XDEBUG                                                              <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I>                                                              <ICLASS="lineannotation">note</I></PRE></BLOCKQUOTE></P><PCLASS="para">If USERDB is listed, User Database support is included.</P><PCLASS="para">Next you must declare the location ofits database file with the <CODECLASS="literal">UserDatabaseSpec</CODE> (<CODECLASS="literal">U</CODE>) option(see <ACLASS="xref"HREF="ch34_08.htm#SML2-CH-34-SECT-8-75"TITLE="">Section 34.8.75</A>):</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">OU/etc/userdb.db                           <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> in your cf file (V8)</I>O UserDatabaseSpec=/etc/userdb.db          <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> in your cf file (V8.7)</I>define(`confUSERDB_SPEC',/etc/userdb.db)   <ICLASS="lineannotation"><IMGSRC="../chars/larr.gif"ALT="&lt;-"> in your m4 file</I></PRE></BLOCKQUOTE></P><PCLASS="para">Here, the location of the database file is set to be <EMCLASS="emphasis">/etc/userdb.db</EM>.You can also enable a default location for the database file that willtake effect should the <CODECLASS="literal">UserDatabaseSpec</CODE> (<CODECLASS="literal">U</CODE>) option bemissing by defining that location with UDB_DEFAULT_SPEC incompiling (see <ACLASS="xref"HREF="ch18_08.htm#SML2-CH-18-SECT-8-53"TITLE="">Section 18.8.53, UDB-DEFAULT-SPEC</A>).</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-33-SECT-5-2">33.5.2 Create the User Database</A></H3><PCLASS="para">The User Database is a <CODECLASS="literal">btree</CODE> class (see <ACLASS="xref"HREF="ch33_08.htm#SML2-CH-33-SECT-8-1"TITLE="">Section 33.8.1</A>)database file created from a source text file using the <EMCLASS="emphasis">makemap</EM> program:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">% <CODECLASS="userinput"><B>makemap btree /etc/userdb.db &lt; /etc/userdb</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">Here, <EMCLASS="emphasis">/etc/userdb</EM> is the source-text file that is input, and <EMCLASS="emphasis">/etc/userdb.db</EM>is the database we are creating (the one defined by the <CODECLASS="literal">U</CODE> option in theprevious section).[5]</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[5] The <CODECLASS="literal">.db</CODE> is added automatically if it is missing. We include it herefor clarity.</P></BLOCKQUOTE><PCLASS="para">The source-text file is composed of key and value pairs, one pair per line:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><CODECLASS="replaceable"><I>key    value</I></CODE>     <ICLASS="lineannotation"><IMGSRC="../chars/uarr.gif"ALT="-^"></I>  <ICLASS="lineannotation">whitespace</I></PRE></BLOCKQUOTE></P><PCLASS="para">The <CODECLASS="replaceable"><I>key</I></CODE> is a user's login name, a colon, and one of twopossible keywords: <CODECLASS="literal">maildrop</CODE> or <CODECLASS="literal">mailname</CODE>. The keyword that is chosen determines the nature of the <CODECLASS="replaceable"><I>value</I></CODE>.<CODECLASS="literal">maildrop</CODE> The <CODECLASS="replaceable"><I>value</I></CODE> is the official delivery address for this user.If there are multiple official addresses, they should either be listedas a single compound value, with separating commas, as,for example:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">root:maildrop         sysadmin@here.us.edu,bill@there.us.edu</PRE></BLOCKQUOTE></P><PCLASS="para">or be listed on individual lines:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">root:maildrop         sysadmin@here.us.eduroot:maildrop         bill@there.us.edu</PRE></BLOCKQUOTE></P><PCLASS="para">This latter form requires you to use the <CODECLASS="literal">-d</CODE> command-line switchwith the <EMCLASS="emphasis">makemap</EM>(1) program (see <ACLASS="xref"HREF="ch33_02.htm#SML2-CH-33-SECT-2-1-1"TITLE="-d  allow duplicate keys">Section 33.2.1.1</A>) whencreating the database but has the advantage of being a simpler sourcefile to manage.<CODECLASS="literal">mailname</CODE> The <CODECLASS="literal">mailname</CODE> keyword causes a &quot;reverse alias&quot; transformation,wherein the login name in the key is changed into the addressin the value for outgoing mail. For example:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">bob:mailname          Bob.Roberts@Here.US.EDU</PRE></BLOCKQUOTE></P><PCLASS="para">This causes mail sent by <CODECLASS="literal">bob</CODE> to go out addressed as thoughit is from <CODECLASS="literal">Bob.Roberts@Here.US.EDU</CODE>.[6]This transformation occurs in the header and envelope.But note that the sender-envelope is not rewritten by UDB unlessthe <CODECLASS="literal">F=i</CODE> flag (see <ACLASS="xref"HREF="ch30_08.htm#SML2-CH-30-SECT-8-24"TITLE="">Section 30.8.24, F=i</A>) is present in thedelivery agent that is selected for the sender.Also note that the recipient headers are not rewritten by UDBunless the <CODECLASS="literal">F=k</CODE> flag (see <ACLASS="xref"HREF="ch30_08.htm#SML2-CH-30-SECT-8-26"TITLE="">Section 30.8.26, F=j</A>)delivery agent is selected for the recipient.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[6] Using full names in outgoing mail is probably not a good idea. Unlike login names,full names are not guaranteed to be unique. If current users expect to be able toreceive mail under full names, future users with the same full name may be out ofluck. Always weigh convenience against maintainable uniqueness when designingyour mail setup.</P></BLOCKQUOTE><PCLASS="para">Naturally, the <CODECLASS="literal">maildrop</CODE> and <CODECLASS="literal">mailname</CODE> keywords shouldoccur in pairs. Each outgoing address that is created with <CODECLASS="literal">mailname</CODE>should have a corresponding <CODECLASS="literal">maildrop</CODE> entry so that returnmail can be delivered. In the above example a reasonable pairmight look like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">bob:mailname          Bob.Roberts@Here.US.EDUBob.Roberts:maildrop  bob</PRE></BLOCKQUOTE></P><PCLASS="para">Here, outgoing mail from the user named <CODECLASS="literal">bob</CODE> will be addressedas though it is from <CODECLASS="literal">Bob.Roberts@Here.US.EDU</CODE>. Incoming mail(whether it is original or in reply to the outgoing) will be addressedas though it is to the name <CODECLASS="literal">Bob.Roberts</CODE>, which will betransformed into and delivered to the local user <CODECLASS="literal">bob</CODE>.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="SML2-CH-33-SECT-5-3">33.5.3 A :default Outgoing Hostname</A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-38417"></A><ACLASS="indexterm"NAME="AUTOID-38420"></A>The <CODECLASS="literal">mailname</CODE> keyword allows the host part of outgoingaddresses to mask the real hostname of the originating machine.This property can, for example, be used to convert the hostname into afirewall name:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">bob:mailname          bob@Firewall.US.EDU</PRE></BLOCKQUOTE></P><PCLASS="para">Here, the canonical name of <CODECLASS="literal">bob</CODE>'s machine is <CODECLASS="literal">Here.US.EDU</CODE>.The <CODECLASS="literal">mailname</CODE> keyword causes outgoing mail from <CODECLASS="literal">bob</CODE>to appear as though it is from the firewall machine (<CODECLASS="literal">Firewall.US.EDU</CODE>) instead.</P><PCLASS="para">Ordinarily, this transformation is not automatic. Each usernamethat is to appear to be from the firewall machine willneed an entry like that above in the User Database. To automate this process, you can use the special username<CODECLASS="literal">:default</CODE> in a <CODECLASS="literal">mailname</CODE> declaration:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">:default:mailname     Firewall.US.EDU</PRE></BLOCKQUOTE></P><PCLASS="para">If a <CODECLASS="literal">maildrop</CODE> entry is found for a particular name,but no corresponding <CODECLASS="literal">mailname</CODE> record is found, the outgoing address is ordinarily unchanged. If, however, a defaulthostname has been defined with <CODECLASS="literal">:default</CODE>, that hostnamereplaces the local hostname for all addresses that lack their own<CODECLASS="literal">mailname</CODE> entry:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">:default:mailname     Firewall.US.EDU    bob:maildrop          bob@here.us.edu</PRE></BLOCKQUOTE></P><PCLASS="para">In this example the user <CODECLASS="literal">bob</CODE> has a <CODECLASS="literal">maildrop</CODE> entrybut lacks a <CODECLASS="literal">mailname</CODE> entry. Outgoing mail from this userwill have the <CODECLASS="literal">:default</CODE> hostname used instead of the local hostname. The user <CODECLASS="literal">sally</CODE>, on the other hand, hasneither a <CODECLASS="literal">maildrop</CODE> entry nor a <CODECLASS="literal">mailname</CODE> entryand so will not have her outgoing address rewritten.<ACLASS="indexterm"NAME="AUTOID-38452"></A><ACLASS="indexterm"NAME="AUTOID-38453"></A></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch33_04.htm"TITLE="33.4 Use Maps with $( and $) in Rules"><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 33.4 Use Maps with $( and $) in Rules"BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="sendmail"><IMGSRC="../gifs/txthome.gif"ALT="sendmail"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch33_06.htm"TITLE="33.6 Database Maps and m4"><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 33.6 Database Maps and m4"BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">33.4 Use Maps with $( and $) in Rules</TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">33.6 Database Maps and m4</TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="../tcpip/index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>