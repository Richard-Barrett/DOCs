<HTML><HEAD><TITLE>[Chapter 10] 10.7 Modifying a sendmail.cf File </TITLE><METANAME="DC.title"CONTENT="TCP/IP Network Administration"><METANAME="DC.creator"CONTENT="Craig Hunt"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T01:39:48Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-322-7"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch10_01.htm"TITLE="10. sendmail "><LINKREL="prev"HREF="ch10_06.htm"TITLE="10.6 Rewriting the Mail Address "><LINKREL="next"HREF="ch10_08.htm"TITLE="10.8 Testing sendmail.cf "></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="TCP/IP Network Administration"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="TCP/IP Network Administration"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/tsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_06.htm"TITLE="10.6 Rewriting the Mail Address "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 10.6 Rewriting the Mail Address "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 10<BR>sendmail </FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_08.htm"TITLE="10.8 Testing sendmail.cf "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 10.8 Testing sendmail.cf "BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="TCP2-CH-10-SECT-7">10.7 Modifying a sendmail.cf File </A></H2><PCLASS="para"><ACLASS="indexterm"NAME="TCP2-CH-10-IX-SENDMAIL-CF-FILE-MODIFYING"></A>In this section we put into practice everything we discussed aboutsample configuration files&nbsp;- their structure and the commands usedto build them. We'll modify the prototype configuration file,<ACLASS="indexterm"NAME="AUTOID-14635"></A><EMCLASS="emphasis">linux.smtp.cf</EM>, for use on <EMCLASS="emphasis">peanut.nuts.com</EM>. We've chosento modify this file because its configuration is closest to theconfiguration we need for <EMCLASS="emphasis">peanut.nuts.com</EM>. <EMCLASS="emphasis">peanut</EM> is a Linuxworkstation on a TCP/IP Ethernet, and it uses SMTP mail and domainname service (DNS).</P><PCLASS="para">The following sections are titled according to the sections of the file,and they describe the modifications we'll make to the file, section bysection. Remember that other <EMCLASS="emphasis">sendmail.cf</EM> files will probably usedifferent section titles, but the basic information provided in theconfiguration will be the same.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="TCP2-CH-10-SECT-7.1">10.7.1 Modifying Local Information </A></H3><PCLASS="para"><ACLASS="indexterm"NAME="TCP2-CH-10-IX-SENDMAIL-CF-FILE-MODIFYING-LOCAL-INFORMATION"></A>The first line in the local information section of the <EMCLASS="emphasis">sendmail.cf</EM>file defines class w.[21]<ACLASS="indexterm"NAME="AUTOID-14654"></A>Class w is the full set of host names for whichthis system accepts mail. Use the class w command to add hostnames tothis set. sendmail initializes this class to the value in macro w(<BCLASS="emphasis.bold">$w</B>), which is the hostname of this computer. On most systems that isenough; sendmail is able to correctly identify most of the otherhostnames for which it should accept mail by querying DNS.<ACLASS="indexterm"NAME="AUTOID-14657"></A>The w class needs only to identify systems that expectthis host to accept mail forthem and that do not have CNAME<ACLASS="indexterm"NAME="AUTOID-14660"></A><ACLASS="indexterm"NAME="AUTOID-14662"></A><ACLASS="indexterm"NAME="AUTOID-14664"></A>or MX entries in the DNS that point tothis host. You'll need to add a hostname to class w, or an MX recordto DNS, if you see the following mail error:</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[21] The full text of the local information section is shown in <ACLASS="xref"HREF="appe_01.htm"TITLE="A sendmail Reference">Appendix E</A>.</P></BLOCKQUOTE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">mil-gw.nuts.com. config error: mail loops back to me (MX problem?)</PRE></BLOCKQUOTE></P><PCLASS="para">In our sample, we accept the <BCLASS="emphasis.bold">Cw</B> command as written, and let sendmaildefine the value for w internally. This is the most common method fordesktop systems like <EMCLASS="emphasis">peanut</EM>. On the system <EMCLASS="emphasis">almond</EM>, whichis also known by the name <EMCLASS="emphasis">mil-gw</EM>, we would add values to class was follows:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Cwlocalhost mil-gw mil-gw.nuts.com</PRE></BLOCKQUOTE></P><PCLASS="para">Now mail addressed to <EMCLASS="emphasis">user@mil-gw.nuts.com</EM> would be accepted by<EMCLASS="emphasis">almond</EM> and not rejected as being addressed to the wrong host.</P><PCLASS="para">Some mail servers might need to be configured to accept mail for manydifferent hostnames. In that case you may want to load class w from afile containing all of the hostnames. Do that with the <BCLASS="emphasis.bold">F</B> command.</P><PCLASS="para">No modification is necessary for the <BCLASS="emphasis.bold">j</B> macro definition because,on this system, sendmail obtains a fully qualified domain name for the<BCLASS="emphasis.bold">j</B> macro from DNS. On some systems this is the case; on othersystems sendmail obtains the hostname without the domain extension. If<BCLASS="emphasis.bold">j</B> doesn't contain the full name, initialize <EMCLASS="emphasis">j</EM> with the hostname(<BCLASS="emphasis.bold">$w</B>) and the domain name. In the sample file we would do this by&quot;uncommenting&quot; the <BCLASS="emphasis.bold">Dj</B> command and editing the domain string tobe <EMCLASS="emphasis">nuts.com</EM>.  However, there is no need to do this because<BCLASS="emphasis.bold">j</B> has the correct value.</P><PCLASS="para">To test if <BCLASS="emphasis.bold">j</B> is set to the correct value on your system, runsendmail with the <BCLASS="emphasis.bold">-bt</B> option and the debug level set to 0.4.In response to this, sendmail displays several lines of information,including the value of <BCLASS="emphasis.bold">j</B>. In the example below, sendmaildisplays the value <EMCLASS="emphasis">peanut.nuts.com</EM> for <BCLASS="emphasis.bold">j</B>. If it displayedonly <EMCLASS="emphasis">peanut</EM>, we would edit <EMCLASS="emphasis">sendmail.cf</EM> to correct thevalue for <BCLASS="emphasis.bold">j</B>.</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># sendmail -bt -d0.4Version 8.8.5 Compiled with: LOG MATCHGECOS MIME8TO7 NAMED_BIND NDBM                NETINET NETUNIX NEWDB SCANF USERDB XDEBUGcanonical name: peanut.nuts.com UUCP nodename: peanut        a.k.a.: peanut.nuts.com        a.k.a.: [172.16.12.2]============ SYSTEM IDENTITY (after readcf) ============      (short domain name) $w = peanut  (canonical domain name) $j = peanut.nuts.com         (subdomain name) $m = nuts.com              (node name) $k = peanut========================================================ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)Enter &lt;ruleset&gt; &lt;address&gt;&gt; ^D</PRE></BLOCKQUOTE></P><PCLASS="para">The next line in the local information section defines class P. In oursample configuration file, class P stores the names of some specialmail routing domains. These pseudo-domain names allow us to addressusers who are not on the Internet with Internet style email addresses.For example, mail can be addressed using the normal UUCP &quot;bang&quot; syntax,<ACLASS="indexterm"NAME="AUTOID-14701"></A>e.g., <EMCLASS="emphasis">ora!los!craig</EM>, or it can be addressed in a pseudo-Internetformat, e.g., <EMCLASS="emphasis">craig@los.ora.uucp</EM>. These mail routing domainssimplify the address that the user enters, and route the mail to thecorrect mail relay host. However, pseudo-domains<ACLASS="indexterm"NAME="AUTOID-14706"></A>are rarely needed becausemost mailers now support standard Internet-style addresses.<ACLASS="indexterm"NAME="AUTOID-14708"></A>The class P definition in <EMCLASS="emphasis">linux.smtp.cf</EM> does notrequire any modification.The only value assigned as a pseudo-domain is a dot (.), which is usedin this <EMCLASS="emphasis">sendmail.cf</EM> file to identify canonical domain names.</P><PCLASS="para">The configuration file has macro definitions for several mail relays.None of these are assigned a value in our sample file. You only needa relay host if your system cannot deliver the mail because it lackscapability or connectivity. UNIX systems do not lack capability, but<ACLASS="indexterm"NAME="AUTOID-14714"></A>a firewall might limit connectivity. Some sites use a mail relay sothat only one systems needs a full <EMCLASS="emphasis">sendmail.cf</EM> configuration.The other hosts at the site simply forward their mail to the smart hostfor delivery. If this is the configuration policy of your site, enterthe name of the mail relay as the &quot;smart&quot; relay. For example:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">DSrelay.nuts.com</PRE></BLOCKQUOTE></P><PCLASS="para">We don't enter anything in any of the relay settings on <EMCLASS="emphasis">peanut</EM>. Thisdesktop system will handle all its own mail. Hey, that's why we run UNIX!</P><PCLASS="para">The local information section in the sample file also includes four keyfile definitions. Three of these <BCLASS="emphasis.bold">K</B> commands are commented out,and all four of them can be ignored. The one key file definition thatis not commented out defines the <EMCLASS="emphasis">dequote</EM> database,<ACLASS="indexterm"NAME="AUTOID-14725"></A>which is aninternal sendmail database used to remove quotes from within emailaddresses. The <EMCLASS="emphasis">user</EM> key file, which is commented out, is also aninternal database. It is used to check if a username exists. The lasttwo databases exist only if you create them. The <EMCLASS="emphasis">domaintable</EM><ACLASS="indexterm"NAME="AUTOID-14729"></A>is used to rewrite domain names and the <EMCLASS="emphasis">mailertable</EM> database<ACLASS="indexterm"NAME="AUTOID-14732"></A>is used to send mail addressed to a specific domain through a particular mailerto a specific remote host.</P><PCLASS="para">The version number doesn't <EMCLASS="emphasis">require</EM> modification&nbsp;- but it's a goodidea to keep track of the changes you make to your sendmailconfiguration, and this is the place to do it. Each time you modify theconfiguration, change the version number by adding your own revisionnumber. At the same time,enter a comment in the file describing the changes you made. Usually,this is the last change made to the files so the comments reflectall changes. For example, the original version numbersection in the <EMCLASS="emphasis">linux.smtp.cf</EM> file is:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">#######################   Version Number   #######################DZ8.7.3</PRE></BLOCKQUOTE></P><PCLASS="para">After we have finished all of our modifications, it willcontain:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">#######################   Version Number   ########################  R1.0 - modified for peanut by Craig#       - cleaned up the comments in the local info section#  R1.1 - modified macro M to use nuts.com instead of the#         hostname in outgoing mail#  R2.0 - added rule a to S11 &amp; S31 to rewrite to first.last formatDZ8.7.3R2.0</PRE></BLOCKQUOTE></P><PCLASS="para">Finally, we need to understand the purpose of a few other classes andmacros found in this section. The M macro is used to rewrite the senderhost address. Define a value for M to hide the name of the local hostin outbound mail. Classes E and M are both related to macro M. ClassE defines the usernames for which the hostname is not rewritten evenif the M macro is defined. For example, <EMCLASS="emphasis">root@peanut.nuts.com</EM> isnot rewritten to <EMCLASS="emphasis">root@nuts.com</EM> even if M is defined as DMnuts.com.Class M is defines other hostnames, not just the local hostname,that should be rewritten to the value of macro M. This is used on mailservers that might need to rewrite sender addresses for their clients.For example:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># who I masquerade as (null for no masquerading) (see also $=M)DMnuts.com# class M: domains that should be converted to $MCMacorn.nuts.com brazil.nuts.com filbert.nuts.com</PRE></BLOCKQUOTE></P><PCLASS="para">Given the macro M and class M definitions shown above. This host wouldrewrite mail from <EMCLASS="emphasis">user@brazil.nuts.com</EM> or <EMCLASS="emphasis">user@acorn.nuts.com</EM>to <EMCLASS="emphasis">user@nuts.com</EM>. <EMCLASS="emphasis">peanut</EM> is not a server so we won't useclass M. But we will use macro M later in the configuration.</P><PCLASS="para">We spent lots of time looking at the local information section becausealmost everything you will need to do to configure a system can bedone here. We will quickly discuss the other section before gettinginto the really challenging task of working with rewrite rules.<ACLASS="indexterm"NAME="AUTOID-14753"></A></P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="TCP2-CH-10-SECT-7.2">10.7.2 Modifying Options </A></H3><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-14757"></A>The section, &quot;Options,&quot; defines the sendmail environment.For example, some of the options specify the file paths used bysendmail, as in these lines from the <EMCLASS="emphasis">linux.smtp.cf</EM> file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># location of alias fileO AliasFile=/etc/aliases# location of help fileO HelpFile=/usr/lib/sendmail.hf# status fileO StatusFile=/etc/sendmail.st# queue directoryO QueueDirectory=/var/spool/mqueue</PRE></BLOCKQUOTE></P><PCLASS="para">If these paths are correct for your system, don't modify them.On <EMCLASS="emphasis">peanut</EM> we want to keep the files just where they are, whichis generally the case when you use a <EMCLASS="emphasis">sendmail.cf</EM> file that wasdesigned for your operating system. In fact, you will probably not needto change any of the options if you use a configuration file designedfor your operating system. If you're really curious about sendmailoptions, see <ACLASS="xref"HREF="appe_01.htm"TITLE="A sendmail Reference">Appendix E</A>.</P><PCLASS="para">The next few sections of the <EMCLASS="emphasis">linux.smtp.cf</EM> file define themessages' precedences, the trusted users, and the headers. None ofthese sections are modified. Following these sections are the rewriterules and the mailers. This material is the bulk of the file and theheart of the configuration. The sample configuration file is designed toallow SMTP mail delivery on a Linux system running DNS, so we assume nomodifications are required.We want to test the configuration before copying it into<EMCLASS="emphasis">sendmail.cf</EM>. We'll save it in a temporary configuration file,<EMCLASS="emphasis">test.cf</EM>, and use the troubleshooting features of sendmailto test it.<ACLASS="indexterm"NAME="AUTOID-14772"></A>&#13;</P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_06.htm"TITLE="10.6 Rewriting the Mail Address "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 10.6 Rewriting the Mail Address "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="TCP/IP Network Administration"><IMGSRC="../gifs/txthome.gif"ALT="TCP/IP Network Administration"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch10_08.htm"TITLE="10.8 Testing sendmail.cf "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 10.8 Testing sendmail.cf "BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">10.6 Rewriting the Mail Address </TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">10.8 Testing sendmail.cf </TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>