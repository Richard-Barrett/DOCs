<HTML><HEAD><TITLE>[Chapter 11] 11.7 Analyzing Protocol Problems </TITLE><METANAME="DC.title"CONTENT="TCP/IP Network Administration"><METANAME="DC.creator"CONTENT="Craig Hunt"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1999-02-04T01:41:17Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-322-7"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch11_01.htm"TITLE="11. Troubleshooting TCP/IP "><LINKREL="prev"HREF="ch11_06.htm"TITLE="11.6 Checking Name Service "><LINKREL="next"HREF="ch11_08.htm"TITLE="11.8 Protocol Case Study "></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="TCP/IP Network Administration"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,65"HREF="index.htm"ALT="TCP/IP Network Administration"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/tsrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_06.htm"TITLE="11.6 Checking Name Service "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 11.6 Checking Name Service "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 11<BR>Troubleshooting TCP/IP </FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_08.htm"TITLE="11.8 Protocol Case Study "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 11.8 Protocol Case Study "BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="TCP2-CH-11-SECT-7">11.7 Analyzing Protocol Problems </A></H2><PCLASS="para"><ACLASS="indexterm"NAME="TCP2-CH-11-IX-PROTOCOL-PROBLEMS-TROUBLESHOOTING"></A><ACLASS="indexterm"NAME="TCP2-CH-11-IX-TROUBLESHOOTING-PROTOCOL-PROBLEMS"></A>Problems caused by bad TCP/IP configurations are much more common thanproblems caused by bad TCP/IP protocol implementations. Most of theproblems you encounter will succumb to analysis using the simple toolswe have already discussed. But on occasion, you may need to analyzethe protocol interaction between two systems. In the worst case, youmay need to analyze the packets in the data stream bit by bit.<ACLASS="indexterm"NAME="AUTOID-16430"></A>Protocol analyzers help you do this.</P><PCLASS="para"><ACLASS="indexterm"NAME="TCP2-CH-11-IX-SNOOP"></A><BCLASS="emphasis.bold">snoop</B> is the tool we'll use. It is provided with the Solarisoperating system.[11]Although we use <BCLASS="emphasis.bold">snoop</B> in all of our examples, the conceptsintroduced in this section should be applicable to the analyzer thatyou use, because most protocol analyzers function in basically the sameway. Protocol analyzers allow you to select, or filter, the packetsyou want to examine, and to examine those packets byte by byte. We'lldiscuss both of these functions.</P><BLOCKQUOTECLASS="footnote"><PCLASS="para">[11] If you don't use Solaris, try <BCLASS="emphasis.bold">tcpdump</B>. It is available viaanonymous FTP on the Internet and is similar to <BCLASS="emphasis.bold">snoop</B>.</P></BLOCKQUOTE><PCLASS="para">Protocol analyzers watch all the packets on the network. Therefore,you only need <EMCLASS="emphasis">one</EM> system that runs analyzer software on theaffected part of the network. One Solaris system with <BCLASS="emphasis.bold">snoop</B> can<ACLASS="indexterm"NAME="AUTOID-16445"></A>monitor the network traffic and tell you what the other hosts are (oraren't) doing. This, of course, assumes a shared media network. Ifyou use an Ethernet switch, only the traffic on an individual segmentcan be seen. Some switches provide a monitor port. For others you mayneed to take your monitor to the location of the problem.</P><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="TCP2-CH-11-SECT-7.1">11.7.1 Packet Filters </A></H3><PCLASS="para"><ACLASS="indexterm"NAME="TCP2-CH-11-IX-PACKET-FILTERS"></A><BCLASS="emphasis.bold">snoop</B> reads all the packets on an Ethernet. It does this by<ACLASS="indexterm"NAME="AUTOID-16455"></A>placing the Ethernet interface into <EMCLASS="emphasis">promiscuous mode</EM>.Normally, an Ethernet interface only passes packets up to the higherlayer protocols that are destined for the local host. In promiscuousmode, all packets are accepted and passed to the higher layer. Thisallows <BCLASS="emphasis.bold">snoop</B> to view all packets and to select packets foranalysis, based on a filter you define. Filters can be defined tocapture packets from, or to, specific hosts, protocols, and ports, orcombinations of all these.As an example, let's look at a very simple <BCLASS="emphasis.bold">snoop</B> filter. Thefollowing <BCLASS="emphasis.bold">snoop</B> command displays all packets sent between thehosts <EMCLASS="emphasis">almond</EM> and <EMCLASS="emphasis">peanut</EM>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># <CODECLASS="userinput"><B>snoop host almond and host peanut</B></CODE>Using device /dev/le (promiscuous mode)peanut.nuts.com -&gt; almond.nuts.com ICMP Echo requestalmond.nuts.com -&gt; peanut.nuts.com ICMP Echo replypeanut.nuts.com -&gt; almond.nuts.com RLOGIN C port=1023almond.nuts.com -&gt; peanut.nuts.com RLOGIN R port=1023<CODECLASS="userinput"><B>^C</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">The filter &quot;host almond and host peanut&quot; selects only those packetsthat are from <EMCLASS="emphasis">peanut</EM> to <EMCLASS="emphasis">almond</EM>, or from <EMCLASS="emphasis">almond</EM> to<ACLASS="indexterm"NAME="AUTOID-16471"></A><EMCLASS="emphasis">peanut</EM>. The filter is constructed from a set of primitives, andassociated hostnames, protocol names, and port numbers. Theprimitives can be modified and combined with the operators <BCLASS="emphasis.bold">and</B>,<BCLASS="emphasis.bold">or</B>, and <BCLASS="emphasis.bold">not</B>. The filter may be omitted; this causes<BCLASS="emphasis.bold">snoop</B> to display all packets from the network.</P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-16481"></A><ACLASS="xref"HREF="ch11_07.htm#TCP2-CH-11-TAB-1"TITLE="Expression Primitives">Table 11.2</A>shows the primitives used to build <BCLASS="emphasis.bold">snoop</B> filters.There are a few additional primitives and some variations that performthe same functions, but these are the essential primitive. See the<BCLASS="emphasis.bold">snoop</B> manpage for additional details.</P><TABLECLASS="table"><CAPTIONCLASS="table"><ACLASS="title"NAME="TCP2-CH-11-TAB-1">Table 11.2: Expression Primitives</A></CAPTION><THEADCLASS="thead"><TRCLASS="row"VALIGN="TOP"><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Primitive</TH><THCLASS="entry"ALIGN="LEFT"ROWSPAN="1"COLSPAN="1">Matches Packets</TH></TR></THEAD><TBODYCLASS="tbody"><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">dst host | <BCLASS="emphasis.bold">net </B>| <BCLASS="emphasis.bold">port </B><CODECLASS="replaceable"><I>destination</I></CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">To <CODECLASS="replaceable"><I>destination</I></CODE> host, net, or port</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">src host | <BCLASS="emphasis.bold">net </B>| <BCLASS="emphasis.bold">port </B><CODECLASS="replaceable"><I>source</I></CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">From <CODECLASS="replaceable"><I>source</I></CODE> host, net, or port</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">host <CODECLASS="replaceable"><I>destination</I></CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">To or from <CODECLASS="replaceable"><I>destination</I></CODE> host</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">net <CODECLASS="replaceable"><I>destination</I></CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">To or from <CODECLASS="replaceable"><I>destination</I></CODE> network</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">port <CODECLASS="replaceable"><I>destination</I></CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">To or from <CODECLASS="replaceable"><I>destination</I></CODE> port</TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">ether <CODECLASS="replaceable"><I>address</I></CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">To or from Ethernet <CODECLASS="replaceable"><I>address</I></CODE></TD></TR><TRCLASS="row"VALIGN="TOP"><TDCLASS="entry"ROWSPAN="1"COLSPAN="1"><CODECLASS="replaceable"><I>protocol</I></CODE></TD><TDCLASS="entry"ROWSPAN="1"COLSPAN="1">Of <CODECLASS="replaceable"><I>protocol</I></CODE> type (<BCLASS="emphasis.bold">icmp</B>, <BCLASS="emphasis.bold">udp</B>, or <BCLASS="emphasis.bold">tcp</B>)</TD></TR></TBODY></TABLE><PCLASS="para">Using these primitives with the operators <BCLASS="emphasis.bold">and</B> and <BCLASS="emphasis.bold">or</B>,complex filters can be constructed. However, filters are usuallysimple. Capturing the traffic between two hosts is probably the mostcommon filter. You may further limit the data captured to a specificprotocol, but often you're not sure which protocol will reveal theproblem. Just because the user sees the problem in <BCLASS="emphasis.bold">ftp</B> or<BCLASS="emphasis.bold">telnet</B> does not mean that is where the problem actually occurs.Analysis must often start by capturing all packets, and can only benarrowed after test evidence points to some specific problem.<ACLASS="indexterm"NAME="AUTOID-16543"></A></P><DIVCLASS="sect3"><H4CLASS="sect3"><ACLASS="title"NAME="TCP2-CH-11-SECT-7.1.1">11.7.1.1 Modifying analyzer output </A></H4><PCLASS="para">The example in the previous section shows that <BCLASS="emphasis.bold">snoop</B> displays asingle line of summary information for each packet received. All linesshow the source and destination addresses, and the protocol being used(ICMP and RLOGIN in the example). The lines that summarize the ICMPpackets identify the packet types (Echo request and Echo reply in theexample). The lines that summarize the application protocol packetsdisplay the source port and the first 20 characters of the packetdata.</P><PCLASS="para">This summary information is sufficient to gain insight into how packetsflow between two hosts and into potential problems. However,troubleshooting protocol problems requires more detailed informationabout each packet. <BCLASS="emphasis.bold">snoop</B> has options that give you control overwhat information is displayed.To display the data contained in a packet, use the <BCLASS="emphasis.bold">-x</B> option.It causes the entire contents of the packet to be dumped in hex andASCII. In most cases, you don't need to see the entire packet;usually, the headers are sufficient to troubleshoot a protocolproblem. The <BCLASS="emphasis.bold">-v</B> option displays the headers in a well-formattedand very detailed manner. Because of the large number of linesdisplayed for each packet, only use <BCLASS="emphasis.bold">-v</B> when you need it.</P><PCLASS="para">The following example shows an ICMP Echo Request packet displayed withthe <BCLASS="emphasis.bold">-v</B> option. The same type of packet was summarized in thefirst line of the previous example.</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># <CODECLASS="userinput"><B>snoop -v host almond and host macadamia</B></CODE>Using device /dev/le (promiscuous mode)ETHER:  ----- Ether Header -----ETHER:  ETHER:  Packet 3 arrived at 16:56:57.90ETHER:  Packet size = 98 bytesETHER:  Destination = 8:0:20:22:fd:51, SunETHER:  Source      = 0:0:c0:9a:d0:db, Western DigitalETHER:  Ethertype = 0800 (IP)ETHER:  IP:   ----- IP Header -----IP:   IP:   Version = 4IP:   Header length = 20 bytesIP:   Type of service = 0x00IP:         xxx. .... = 0 (precedence)IP:         ...0 .... = normal delayIP:         .... 0... = normal throughputIP:         .... .0.. = normal reliabilityIP:   Total length = 84 bytesIP:   Identification = 3049IP:   Flags = 0x0IP:         .0.. .... = may fragmentIP:         ..0. .... = last fragmentIP:   Fragment offset = 0 bytesIP:   Time to live = 64 seconds/hopsIP:   Protocol = 1 (ICMP)IP:   Header checksum = fde0IP:   Source address = 172.16.55.106, macadamia.nuts.comIP:   Destination address = 172.16.12.1, almond.nuts.comIP:   No optionsIP:   ICMP:  ----- ICMP Header -----ICMP:  ICMP:  Type = 8 (Echo request)ICMP:  Code = 0ICMP:  Checksum = ac54ICMP:</PRE></BLOCKQUOTE></P><PCLASS="para">The detailed formatting done by <BCLASS="emphasis.bold">snoop</B> maps the bytes receivedfrom the network to the header structure. Look at the description ofthe various header fields in <ACLASS="xref"HREF="ch01_01.htm"TITLE="Overview of TCP/IP">Chapter 1</A>, and <ACLASS="xref"HREF="appf_01.htm"TITLE="Selected TCP/IP Headers">Appendix F, <CITECLASS="appendix">Selected TCP/IP Headers</CITE></A>, for moreinformation.<ACLASS="indexterm"NAME="AUTOID-16562"></A></P></DIV></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_06.htm"TITLE="11.6 Checking Name Service "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 11.6 Checking Name Service "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="TCP/IP Network Administration"><IMGSRC="../gifs/txthome.gif"ALT="TCP/IP Network Administration"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch11_08.htm"TITLE="11.8 Protocol Case Study "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 11.8 Protocol Case Study "BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">11.6 Checking Name Service </TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">11.8 Protocol Case Study </TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><PCLASS="nav"><FONTSIZE="-1">[ <AHREF="../index.htm"TITLE="The Networking CD Bookshelf">Library Home</A> | <AHREF="../dnsbind/index.htm"TITLE="DNS &amp; BIND">DNS &amp; BIND</A> | <AHREF="index.htm"TITLE="TCP/IP Network Administration">TCP/IP</A> | <AHREF="../sendmail/index.htm"TITLE="sendmail">sendmail</A> | <AHREF="../smdref/index.htm"TITLE="sendmail Desktop Reference">sendmail Reference</A> | <AHREF="../firewall/index.htm"TITLE="Building Internet Firewalls">Firewalls</A> | <AHREF="../puis/index.htm"TITLE="Practical UNIX &amp; Internet Security">Practical Security</A> ]</FONT></P></DIV></BODY></HTML>