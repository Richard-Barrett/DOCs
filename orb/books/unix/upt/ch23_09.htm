<HTML><HEAD><TITLE>[Chapter 23] 23.9 delete: Protecting Files from Accidental Deletion </TITLE><METANAME="DC.title"CONTENT="UNIX Power Tools"><METANAME="DC.creator"CONTENT="Jerry Peek, Tim O'Reilly &amp; Mike Loukides"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1998-08-04T21:41:05Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-260-3"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch23_01.htm"TITLE="23. Removing Files"><LINKREL="prev"HREF="ch23_08.htm"TITLE="23.8 Safe Delete: Pros and Cons "><LINKREL="next"HREF="ch23_10.htm"TITLE="23.10 Deletion with Prejudice: rm -f "></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="UNIX Power Tools"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,58"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_08.htm"TITLE="23.8 Safe Delete: Pros and Cons "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.8 Safe Delete: Pros and Cons "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 23<BR>Removing Files</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_10.htm"TITLE="23.10 Deletion with Prejudice: rm -f "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.10 Deletion with Prejudice: rm -f "BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="UPT-ART-5520">23.9 delete: Protecting Files from Accidental Deletion </A></H2><PCLASS="para"><ACLASS="indexterm"NAME="UPT-ART-5520-IX-DELETE-SCRIPT"></A><ACLASS="indexterm"NAME="UPT-ART-5520-IX-DELETING-FILES-SAFEGUARDS-AGAINST"></A>The problem of protecting users from accidental file deletion is onethat many people have encountered, and therefore there are manysolutions of different types already implemented and available.Which solution you choose depends onthe features you want it to have and on how you want it to do its job.Many people do not use theshell-script solutions described<SPANCLASS="link">above (<ACLASS="linkend"HREF="ch23_08.htm"TITLE="Safe Delete: Pros and Cons ">23.8</A>)</SPAN>,because they are too slow or too unreliable orbecause they don't allow deleted files to be recovered for longenough.</P><PCLASS="para">For example, Purdue University runs a large network of many differentmachines that utilize some local file space and some<SPANCLASS="link">NFS (<ACLASS="linkend"HREF="ch01_33.htm"TITLE="UNIX Networking and Communications ">1.33</A>)</SPAN>file space.<ACLASS="indexterm"NAME="UPT-ART-5520-IX-ENTOMB-SYSTEM"></A>Their file recovery system, <EMCLASS="emphasis">entomb</EM>, replaces certain system calls(for example, <EMCLASS="emphasis">open</EM>(2), <EMCLASS="emphasis">unlink</EM>(2)) with <EMCLASS="emphasis">entomb</EM> functions that check tosee if a file would be destroyed by the requested system call; if so,the file is backed up (by asking a local or remote <EMCLASS="emphasis">entomb</EM> daemonto do so) before the actual system call is performed.</P><PCLASS="para">The advantages of this system are that you don't have to create anynew applications to do safe file removal&nbsp;- the standard <EMCLASS="emphasis">rm</EM> programwill automatically do the right thing, as will <EMCLASS="emphasis">mv</EM> and any otherprograms that have the potential of erasing files.Even <EMCLASS="emphasis">cat&nbsp;a&nbsp;b&nbsp;&gt;&nbsp;a</EM> is recoverable.</P><PCLASS="para">A disadvantage of this system is that you have to have the sourcecode for your UNIX system and be able to recompile its utilities inorder to link them against the <EMCLASS="emphasis">entomb</EM> libraries. Furthermore, ifyou wish to install this system on your machines, you have to be ableto install it on <EMCLASS="emphasis">all</EM> of them. If someone learns <EMCLASS="emphasis">entomb</EM> on amachine you manage and then wants to use it on a workstation in aprivate lab for which you do not have source code, it can't be done.Also, there is a danger of people getting used to <EMCLASS="emphasis">entomb</EM> beingthere to save them if they make mistakes, and then losing a file whenthey use <EMCLASS="emphasis">rm</EM> or <EMCLASS="emphasis">mv</EM> on a system that doesn't have <EMCLASS="emphasis">entomb</EM>.</P><PCLASS="para">If you don't have strict control over all the machines on which you want tohave file-deletion protection, or if you don't have source code andtherefore can't use something like <EMCLASS="emphasis">entomb</EM>, there are several otheroptions available. One of them is the <EMCLASS="emphasis">delete</EM> package,written at MIT.</P><TABLECLASS="para.programreference"BORDER="1"><TR><THVALIGN="TOP"><ACLASS="programreference"HREF="examples/index.htm"TITLE="delete">delete</A><BR></TH><TDVALIGN="TOP">&#13;<EMCLASS="emphasis">delete</EM> overcomes several of the disadvantages of <EMCLASS="emphasis">entomb</EM>. Itis very simple, compiles on virtually any machine, and doesn't requireany sort of superuser access to install. This means that if you learnto use <EMCLASS="emphasis">delete</EM> on one system and then move somewhere else, you cantake it with you by getting the source code and simply recompiling iton the new system. Furthermore, <EMCLASS="emphasis">delete</EM> intentionally isn't named<EMCLASS="emphasis">rm</EM>, so that people who use it know they are using it and thereforedon't end up believing that files removed with <EMCLASS="emphasis">rm</EM> can berecovered. However, this means that users have to be educated to use<EMCLASS="emphasis">delete</EM> instead of <EMCLASS="emphasis">rm</EM> when removing files.</TD></TR></TABLE><PCLASS="para"><EMCLASS="emphasis">delete</EM> works by renaming files with a prefix that marks them asdeleted. For example, <EMCLASS="emphasis">delete&nbsp;foo</EM> would simply rename thefile <EMCLASS="emphasis">foo</EM> to <EMCLASS="emphasis">.#foo</EM>. Here's an example of the <EMCLASS="emphasis">delete</EM>,<EMCLASS="emphasis">undelete</EM>, <EMCLASS="emphasis">lsdel</EM>, and <EMCLASS="emphasis">expunge</EM> commands in action:</P><PCLASS="para"><TABLECLASS="screen.co"BORDER="1"><TR><THVALIGN="TOP"><PRECLASS="calloutlist">&#13;<ACLASS="co"HREF="ch16_11.htm"TITLE="16.11 Showing Hidden Files with ls -A and -a ">-A</A> &#13;</PRE></TH><TDVALIGN="TOP"><PRECLASS="screen"><EMCLASS="emphasis">The directory starts with three files:</EM>% <CODECLASS="userinput"><B>ls</B></CODE>a       b       c  <EMCLASS="emphasis">One of the files is deleted:</EM>% <CODECLASS="userinput"><B>delete a</B></CODE><EMCLASS="emphasis">The deleted file doesn't show up with normal ls because the namenow starts with a dot (.). However, it shows up when files starting with .are listed or when the lsdel command is used:</EM>% <CODECLASS="userinput"><B>ls</B></CODE>b       c% <CODECLASS="userinput"><B>ls -A</B></CODE>.#a     b       c% <CODECLASS="userinput"><B>lsdel</B></CODE>a<EMCLASS="emphasis">Bringing the file back with undelete leaves us back where we started:</EM>% <CODECLASS="userinput"><B>undelete a</B></CODE>% <CODECLASS="userinput"><B>ls</B></CODE>a       b       c<EMCLASS="emphasis">We can delete everything:</EM>% <CODECLASS="userinput"><B>delete *</B></CODE>% <CODECLASS="userinput"><B>lsdel</B></CODE>a  b  c<EMCLASS="emphasis">We can expunge individual files or the current working directory:</EM>% <CODECLASS="userinput"><B>expunge a</B></CODE>% <CODECLASS="userinput"><B>lsdel</B></CODE>b  c% <CODECLASS="userinput"><B>expunge</B></CODE><EMCLASS="emphasis">After the last expunge, there are no files left at all:</EM>% <CODECLASS="userinput"><B>lsdel</B></CODE>% <CODECLASS="userinput"><B>ls -A</B></CODE>%</PRE></TD></TR></TABLE></P><PCLASS="para">The technique used by <EMCLASS="emphasis">delete</EM> has some advantages and somedisadvantages. The advantages include:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">It works on any filesystem type&nbsp;- local, NFS, AFS, RFS, whatever.You don't have to have special daemons running on your file serversin order for it to work, and there are no daemons to go down andprevent deleted file archiving from taking place.</P></LI><LICLASS="listitem"><PCLASS="para">It maintains the directory locations in which deleted files arestored so that they can be undeleted in the same locations.&#13;</P></LI><LICLASS="listitem"><PCLASS="para">It maintains file permissions and ownership so that undeleted filescan be restored with them. Furthermore, deleted files can beundeleted by anyone who had permission to delete them in the firstplace, not just by the one individual who deleted them.</P></LI></UL><PCLASS="para">Disadvantages include:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Deleted files are counted against a user's<SPANCLASS="link">disk quota (<ACLASS="linkend"HREF="ch24_17.htm"TITLE="Disk Quotas ">24.17</A>)</SPAN>until they areactually permanently removed (either by the system, a few days afterthey are deleted, or by the user with the <EMCLASS="emphasis">expunge</EM> command thatis part of the <EMCLASS="emphasis">delete</EM> package). Some people would actually callthis an advantage, because it prevents people from using deletedfile space to store large files (something which is possible with<EMCLASS="emphasis">entomb</EM>).</P></LI><LICLASS="listitem"><PCLASS="para">Deleted files show up when a user does <EMCLASS="emphasis">ls -a</EM>. This isconsidered a relatively minor disadvantage by most people,especially sincefiles starting with a dot (<CODECLASS="literal">.</CODE>) are supposed to be<SPANCLASS="link">hidden (<ACLASS="linkend"HREF="ch16_11.htm"TITLE="Showing Hidden Files with ls -A and -a ">16.11</A>)</SPAN>most of the time.</P></LI><LICLASS="listitem"><PCLASS="para">Deleted files have to be searched for in filesystem trees in orderto expunge them, rather than all residing in one location as they dowith <EMCLASS="emphasis">entomb</EM>. This, too, is usually considered a minordisadvantage, since most systems already<SPANCLASS="link">search the entire filesystem (<ACLASS="linkend"HREF="ch23_22.htm"TITLE="Using find to Clear Out Unneeded Files ">23.22</A>)</SPAN>each night automatically in order to delete certaintemporary files.</P></LI><LICLASS="listitem"><PCLASS="para">Only the <EMCLASS="emphasis">entomb</EM> program protects files. A user can still blowaway a file with <EMCLASS="emphasis">mv</EM>,<EMCLASS="emphasis">cat&nbsp;a&nbsp;b&nbsp;&gt;&nbsp;a</EM>, etc.If your main concernis eliminating accidental file deletions with <EMCLASS="emphasis">rm</EM>, thisisn'tmuch of a problem; furthermore, it is not clear that the extraoverhead required to run something like <EMCLASS="emphasis">entomb</EM> is worth theadvantage gained (even if it is possible to do what <EMCLASS="emphasis">entomb</EM> needsat your site).</P></LI></UL><PCLASS="para"><EMCLASS="emphasis">entomb</EM> and <EMCLASS="emphasis">delete</EM> represent the two main approaches to theproblem of protection from accidental file erasure. Other packages ofthis sort choose one or the other of these basic techniques in orderto accomplish their purposes.  <ACLASS="indexterm"NAME="AUTOID-25562"></A><ACLASS="indexterm"NAME="AUTOID-25563"></A><ACLASS="indexterm"NAME="AUTOID-25564"></A></P><DIVCLASS="sect1info"><PCLASS="SECT1INFO">- <SPANCLASS="authorinitials">JIK</SPAN></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_08.htm"TITLE="23.8 Safe Delete: Pros and Cons "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.8 Safe Delete: Pros and Cons "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="UNIX Power Tools"><IMGSRC="../gifs/txthome.gif"ALT="UNIX Power Tools"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_10.htm"TITLE="23.10 Deletion with Prejudice: rm -f "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.10 Deletion with Prejudice: rm -f "BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">23.8 Safe Delete: Pros and Cons </TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">23.10 Deletion with Prejudice: rm -f </TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><IMGSRC="../gifs/smnavbar.gif"USEMAP="#map"BORDER="0"ALT="The UNIX CD Bookshelf Navigation"><MAPNAME="map"><AREASHAPE="RECT"COORDS="0,0,73,21"HREF="../index.htm"ALT="The UNIX CD Bookshelf"><AREASHAPE="RECT"COORDS="74,0,163,21"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="164,0,257,21"HREF="../unixnut/index.htm"ALT="UNIX in a Nutshell"><AREASHAPE="RECT"COORDS="258,0,321,21"HREF="../vi/index.htm"ALT="Learning the vi Editor"><AREASHAPE="RECT"COORDS="322,0,378,21"HREF="../sedawk/index.htm"ALT="sed &amp; awk"><AREASHAPE="RECT"COORDS="379,0,438,21"HREF="../ksh/index.htm"ALT="Learning the Korn Shell"><AREASHAPE="RECT"COORDS="439,0,514,21"HREF="../lrnunix/index.htm"ALT="Learning the UNIX Operating System"></MAP></DIV></BODY></HTML>