<HTML><HEAD><TITLE>[Chapter 23] 23.18 How Making and Deleting Directories Works </TITLE><METANAME="DC.title"CONTENT="UNIX Power Tools"><METANAME="DC.creator"CONTENT="Jerry Peek, Tim O'Reilly &amp; Mike Loukides"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1998-08-04T21:41:15Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-260-3"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch23_01.htm"TITLE="23. Removing Files"><LINKREL="prev"HREF="ch23_17.htm"TITLE="23.17 Problems Deleting Directories "><LINKREL="next"HREF="ch23_19.htm"TITLE="23.19 Deleting (BSD) Manual Pages that Aren't Read "></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="UNIX Power Tools"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,58"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_17.htm"TITLE="23.17 Problems Deleting Directories "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.17 Problems Deleting Directories "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 23<BR>Removing Files</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_19.htm"TITLE="23.19 Deleting (BSD) Manual Pages that Aren't Read "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.19 Deleting (BSD) Manual Pages that Aren't Read "BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="UPT-ART-0104">23.18 How Making and Deleting Directories Works </A></H2><PCLASS="para"></P><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-25904"></A><ACLASS="indexterm"NAME="AUTOID-25907"></A>Every file in the UNIX filesystem&nbsp;- and a directory is just afile, albeit a rather special one&nbsp;- is represented by one<SPANCLASS="link"><EMCLASS="emphasis">inode</EM> (<ACLASS="linkend"HREF="ch01_22.htm"TITLE="How UNIX Keeps Track of Files: Inodes ">1.22</A>)</SPAN>and one or more names (<SPANCLASS="link">directory entries (<ACLASS="linkend"HREF="ch18_02.htm"TITLE="What's Really in a Directory ">18.2</A>)</SPAN>).In a sense the inode<EMCLASS="emphasis">is</EM> the file; each name is a<SPANCLASS="link"><EMCLASS="emphasis">link</EM> (<ACLASS="linkend"HREF="ch18_04.htm"TITLE="More About Links ">18.4</A>)</SPAN>to this inode.An ordinaryfile may have anywhere from one to several thousand links (theexact limit is system dependent), but a directory never has anyfewer than two. Every directory has at least two names.</P><PCLASS="para">Suppose you start in <EMCLASS="emphasis">/usr/tmp</EM> and do a <EMCLASS="emphasis">mkdir&nbsp;x</EM>. What are thetwo links to <EMCLASS="emphasis">x</EM>? They are <EMCLASS="emphasis">/usr/tmp/x</EM> and <EMCLASS="emphasis">/usr/tmp/x/.</EM>,directory entries in <EMCLASS="emphasis">/usr/tmp</EM> and <EMCLASS="emphasis">/usr/tmp/x</EM>, respectively.This might seem rather odd at first: how can a directory nameitself? It's not hard: first you create <EMCLASS="emphasis">/usr/tmp/x</EM>, a completelyempty directory, then link <EMCLASS="emphasis">/usr/tmp/x</EM> to <EMCLASS="emphasis">/usr/tmp/x/.</EM>and you're halfway done.All<EMCLASS="emphasis">link</EM> does is take its first name and turn it into an inode&nbsp;- thefile itself&nbsp;- then make a new entry for the second name,pointing to that inode.You must also link <EMCLASS="emphasis">/usr/tmp</EM> to <EMCLASS="emphasis">/usr/tmp/x/..</EM> to make a properlyformed directory. The <EMCLASS="emphasis">mkdir</EM> program and system callboth do all this properly; and there is no other way for anyoneexcept the<SPANCLASS="link">superuser (<ACLASS="linkend"HREF="ch01_24.htm"TITLE="The Superuser (Root) ">1.24</A>)</SPAN>to create a directory.</P><PCLASS="para">Here is where the trouble creeps in. All <EMCLASS="emphasis">unlink</EM>(2) does is takethe name it is given, convert it to an inode, and remove the name.If the name was the last link to that inode, the file itself isdestroyed as well; if not, it is left intact and may still beaccessed by its other name(s). So what happens if you unlink adirectory? Well, if it is completely empty, it goes away andeverything is fine. However, if it still has <CODECLASS="literal">.</CODE> and<CODECLASS="literal">..</CODE> in it&nbsp;- and it almost certainly will&nbsp;- things arenot so good. The <CODECLASS="literal">.</CODE> link to the directory itself stillexists, so the file that is the directory is not deleted. Thename <EMCLASS="emphasis">/usr/tmp/x</EM> <EMCLASS="emphasis">is</EM> deleted, and that leaves us with a prettyproblem: how can we get rid of that last <CODECLASS="literal">.</CODE> and <CODECLASS="literal">..</CODE>?</P><PCLASS="para">The answer is that we cannot. That directory will stick aroundforever. Worse, it has in it another name for, or link to, <EMCLASS="emphasis">/usr/tmp</EM>,which means that that, too, cannot be deleted. Of course, <EMCLASS="emphasis">fsck</EM>(which does not use the regular filesystem mechanisms) can cleanthis up, but this usually requires a system shutdown.[<EMCLASS="emphasis">fsck</EM> is a filesystem-checking program that the systemadministrator runs. <EMCLASS="emphasis">-JP</EM>&nbsp;]For this reason, again, only the superuser may unlink a directory.Ordinary processes must use the <EMCLASS="emphasis">rmdir</EM> program or system call.</P><PCLASS="para">Incidentally, the <EMCLASS="emphasis">mkdir</EM>(2) and <EMCLASS="emphasis">rmdir</EM>(2) system callsdo not exist on older UNIX systems. On these systems, you mustuse careful<SPANCLASS="link"><EMCLASS="emphasis">fork</EM>-<EMCLASS="emphasis">exec</EM> (<ACLASS="linkend"HREF="ch38_02.htm"TITLE="fork and exec ">38.2</A>)</SPAN>sequences to run the <EMCLASS="emphasis">mkdir</EM> and<EMCLASS="emphasis">rmdir</EM> programs.</P><DIVCLASS="sect1info"><PCLASS="SECT1INFO">- <SPANCLASS="authorinitials">CT</SPAN> <SPANCLASS="bibliomisc">in <ACLASS="systemitem.newsgroup"HREF="news:net.unix">net.unix</A> on Usenet, 25 July 1986</SPAN></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_17.htm"TITLE="23.17 Problems Deleting Directories "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 23.17 Problems Deleting Directories "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="UNIX Power Tools"><IMGSRC="../gifs/txthome.gif"ALT="UNIX Power Tools"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch23_19.htm"TITLE="23.19 Deleting (BSD) Manual Pages that Aren't Read "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 23.19 Deleting (BSD) Manual Pages that Aren't Read "BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">23.17 Problems Deleting Directories </TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">23.19 Deleting (BSD) Manual Pages that Aren't Read </TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><IMGSRC="../gifs/smnavbar.gif"USEMAP="#map"BORDER="0"ALT="The UNIX CD Bookshelf Navigation"><MAPNAME="map"><AREASHAPE="RECT"COORDS="0,0,73,21"HREF="../index.htm"ALT="The UNIX CD Bookshelf"><AREASHAPE="RECT"COORDS="74,0,163,21"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="164,0,257,21"HREF="../unixnut/index.htm"ALT="UNIX in a Nutshell"><AREASHAPE="RECT"COORDS="258,0,321,21"HREF="../vi/index.htm"ALT="Learning the vi Editor"><AREASHAPE="RECT"COORDS="322,0,378,21"HREF="../sedawk/index.htm"ALT="sed &amp; awk"><AREASHAPE="RECT"COORDS="379,0,438,21"HREF="../ksh/index.htm"ALT="Learning the Korn Shell"><AREASHAPE="RECT"COORDS="439,0,514,21"HREF="../lrnunix/index.htm"ALT="Learning the UNIX Operating System"></MAP></DIV></BODY></HTML>