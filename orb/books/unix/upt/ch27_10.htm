<HTML><HEAD><TITLE>[Chapter 27] 27.10 Search RCS Files with rcsgrep </TITLE><METANAME="DC.title"CONTENT="UNIX Power Tools"><METANAME="DC.creator"CONTENT="Jerry Peek, Tim O'Reilly &amp; Mike Loukides"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1998-08-04T21:44:25Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-260-3"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch27_01.htm"TITLE="27. Searching Through Files"><LINKREL="prev"HREF="ch27_09.htm"TITLE="27.9 New greps Are Much Faster "><LINKREL="next"HREF="ch27_11.htm"TITLE="27.11 A Multiline Context grep Using sed "></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="UNIX Power Tools"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,58"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch27_09.htm"TITLE="27.9 New greps Are Much Faster "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 27.9 New greps Are Much Faster "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 27<BR>Searching Through Files</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch27_11.htm"TITLE="27.11 A Multiline Context grep Using sed "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 27.11 A Multiline Context grep Using sed "BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="UPT-ART-7969">27.10 Search RCS Files with rcsgrep </A></H2><TABLECLASS="para.programreference"BORDER="1"><TR><THVALIGN="TOP"><ACLASS="programreference"HREF="examples/index.htm"TITLE="rcsgrep">rcsgrep</A><BR></TH><TDVALIGN="TOP"><ACLASS="indexterm"NAME="AUTOID-30390"></A><ACLASS="indexterm"NAME="AUTOID-30393"></A><ACLASS="indexterm"NAME="AUTOID-30397"></A><ACLASS="indexterm"NAME="AUTOID-30400"></A>Storing multiple versions of a file in<SPANCLASS="link">RCS (<ACLASS="linkend"HREF="ch20_14.htm"TITLE="RCS Basics ">20.14</A>)</SPAN>saves space.How can you search a lot of those files at once?You could check out all the files, then run <EMCLASS="emphasis">grep</EM>-but you'll have toremove the files after you're done searching.Or, you could search the RCS files themselves with a command like<CODECLASS="literal">grep</CODE>&nbsp;<CODECLASS="literal">foo</CODE>&nbsp;<CODECLASS="literal">RCS/*,v</CODE>-but that can show you garbagelines from previous revisions, log messages, and other text that isn'tin the latest revision of your file.This article has two ways to solve that problem.</TD></TR></TABLE><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="UPT-ART-7969-SECT-1.1">27.10.1 rcsgrep, rcsegrep, rcsfgrep </A></H3><PCLASS="para">The <EMCLASS="emphasis">rcsgrep</EM> script&nbsp;- and two links to it named <EMCLASS="emphasis">rcsegrep</EM> and<EMCLASS="emphasis">rcsfgrep</EM>-run <EMCLASS="emphasis">grep</EM>,<SPANCLASS="link"><EMCLASS="emphasis">egrep</EM> (<ACLASS="linkend"HREF="ch27_05.htm"TITLE="Extended Searching for Text with egrep ">27.5</A>)</SPAN>,and<SPANCLASS="link"><EMCLASS="emphasis">fgrep</EM> (<ACLASS="linkend"HREF="ch27_06.htm"TITLE="Fast grep Isn't ">27.6</A>)</SPAN>on allfiles in the RCS directory.(You can also choose the files to search.)</P><PCLASS="para">The script tests its name to decide whether to act like<EMCLASS="emphasis">grep</EM>, <EMCLASS="emphasis">egrep</EM>, or <EMCLASS="emphasis">fgrep</EM>.Then it checks out each file and pipes it to the version of grep you chose.The output looks just like <EMCLASS="emphasis">grep</EM>'s&nbsp;- although, by default, you'llalso see the messages from the <EMCLASS="emphasis">co</EM> command (the <EMCLASS="emphasis">-s</EM> optionsilences those messages).</P><PCLASS="para">By default, <EMCLASS="emphasis">rcsgrep</EM> searches the latest revision of every file.With the <EMCLASS="emphasis">-a</EM> option, <EMCLASS="emphasis">rcsgrep</EM> will search all revisions ofevery file, from first to last.This is very handy when you're trying to see what was changed in aparticular place&nbsp;- and to find which revision(s) have some text thatwas deleted some time ago.(<EMCLASS="emphasis">rcsgrep</EM> uses<SPANCLASS="link"><EMCLASS="emphasis">rcsrevs</EM> (<ACLASS="linkend"HREF="ch20_15.htm"TITLE="List RCS Revision Numbers with rcsrevs ">20.15</A>)</SPAN>to implement <EMCLASS="emphasis">-a</EM>.)</P><PCLASS="para">Some <EMCLASS="emphasis">grep</EM> options need special handling to work right in the script:<EMCLASS="emphasis">-e</EM>, <EMCLASS="emphasis">-f</EM>, and <EMCLASS="emphasis">-l</EM>.(For instance, <EMCLASS="emphasis">-e</EM> and <EMCLASS="emphasis">-f</EM> have an argument after them.The script has to pass both the option and its argument.)The script passes any other options you type to the <EMCLASS="emphasis">grep</EM> command.Your <EMCLASS="emphasis">grep</EM> versions may have some other options that need special handling,too.Just edit the script to handle them.</P><PCLASS="para">You can install this script from the CD-ROMor from the<SPANCLASS="link">online archive (<ACLASS="linkend"HREF="ch52_07.htm"TITLE="Other Ways to Get the Software ">52.7</A>)</SPAN>.If you get it from the archive,ask tar to install <EMCLASS="emphasis">rcsgrep</EM>, its two other links <EMCLASS="emphasis">rcsegrep</EM>and <EMCLASS="emphasis">rcsfgrep</EM>, as well as <EMCLASS="emphasis">rcsrevs</EM>.</P></DIV><DIVCLASS="sect2"><H3CLASS="sect2"><ACLASS="title"NAME="UPT-ART-7969-SECT-1.2">27.10.2 rcsegrep.fast </A></H3><PCLASS="para">To search an RCS file, <EMCLASS="emphasis">rcsgrep</EM> and its cousins run several UNIXprocesses: <EMCLASS="emphasis">co</EM>, <EMCLASS="emphasis">grep</EM>, <EMCLASS="emphasis">sed</EM> and others.Each process takes time to start and run.If your directory has hundreds of RCS files (like our directory forthis book does), searching the whole thing can take a lot of time.I could have cut the number of processes by rewriting <EMCLASS="emphasis">rcsgrep</EM>in Perl; Perl has the functionality of <EMCLASS="emphasis">grep</EM>, <EMCLASS="emphasis">sed</EM> andothers built in, so all it would need to do is run hundreds of<EMCLASS="emphasis">co</EM> processes...which would still make it too slow.</P><TABLECLASS="para.programreference"BORDER="1"><TR><THVALIGN="TOP"><ACLASS="programreference"HREF="examples/index.htm"TITLE="rcsegrep.fast">rcsegrep.fast</A><BR></TH><TDVALIGN="TOP">The solution I came up with was to do everything in (basically)one process: a<SPANCLASS="link"><EMCLASS="emphasis">gawk</EM> (<ACLASS="linkend"HREF="ch33_12.htm"TITLE="Versions of awk ">33.12</A>)</SPAN>script.Instead of using the RCS<EMCLASS="emphasis">co</EM> command to extract each file's latest revision,the <EMCLASS="emphasis">rcsegrep.fast</EM> script reads each RCS file directly(The <EMCLASS="emphasis">rcsfile</EM>(5) manpage explains the format of an RCS file.)An RCS file contains the latest revision of its working file asplain text, with one difference: each <CODECLASS="literal">@</CODE> character is changedto <CODECLASS="literal">@@</CODE>.<EMCLASS="emphasis">rcsegrep.fast</EM> searches the RCS file until it finds thebeginning of the working file.Then it applies an <EMCLASS="emphasis">egrep</EM>-like regular expression to each line.Matching lines are written to standard output with the filename first;the <EMCLASS="emphasis">-n</EM> option gives a line number after the filename.</TD></TR></TABLE><PCLASS="para"><EMCLASS="emphasis">rcsegrep.fast</EM> is sort of a kludge because it's accessing RCSfiles without using RCS tools.There's a chance that it won't work on some versions of RCS, or thatI've made some other programming goof.But it's worked very well for us.It's much faster than <EMCLASS="emphasis">rcsgrep</EM> and friends.I'd recommend using <EMCLASS="emphasis">rcsegrep.fast</EM> when you need to search thelatest revisions of a lot of RCS files; otherwise, stick to the<EMCLASS="emphasis">rcsgrep</EM>s.</P></DIV><DIVCLASS="sect1info"><PCLASS="SECT1INFO">- <SPANCLASS="authorinitials">JP</SPAN></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch27_09.htm"TITLE="27.9 New greps Are Much Faster "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 27.9 New greps Are Much Faster "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="UNIX Power Tools"><IMGSRC="../gifs/txthome.gif"ALT="UNIX Power Tools"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch27_11.htm"TITLE="27.11 A Multiline Context grep Using sed "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 27.11 A Multiline Context grep Using sed "BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">27.9 New greps Are Much Faster </TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">27.11 A Multiline Context grep Using sed </TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><IMGSRC="../gifs/smnavbar.gif"USEMAP="#map"BORDER="0"ALT="The UNIX CD Bookshelf Navigation"><MAPNAME="map"><AREASHAPE="RECT"COORDS="0,0,73,21"HREF="../index.htm"ALT="The UNIX CD Bookshelf"><AREASHAPE="RECT"COORDS="74,0,163,21"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="164,0,257,21"HREF="../unixnut/index.htm"ALT="UNIX in a Nutshell"><AREASHAPE="RECT"COORDS="258,0,321,21"HREF="../vi/index.htm"ALT="Learning the vi Editor"><AREASHAPE="RECT"COORDS="322,0,378,21"HREF="../sedawk/index.htm"ALT="sed &amp; awk"><AREASHAPE="RECT"COORDS="379,0,438,21"HREF="../ksh/index.htm"ALT="Learning the Korn Shell"><AREASHAPE="RECT"COORDS="439,0,514,21"HREF="../lrnunix/index.htm"ALT="Learning the UNIX Operating System"></MAP></DIV></BODY></HTML>