<HTML><HEAD><TITLE>[Chapter 28] 28.9 ex Scripts Built by diff </TITLE><METANAME="DC.title"CONTENT="UNIX Power Tools"><METANAME="DC.creator"CONTENT="Jerry Peek, Tim O'Reilly &amp; Mike Loukides"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1998-08-04T21:44:46Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-260-3"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch28_01.htm"TITLE="28. Comparing Files"><LINKREL="prev"HREF="ch28_08.htm"TITLE="28.8 More Friendly diff Output "><LINKREL="next"HREF="ch28_10.htm"TITLE="28.10 Problems with diff and Tabstops "></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="UNIX Power Tools"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,58"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch28_08.htm"TITLE="28.8 More Friendly diff Output "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 28.8 More Friendly diff Output "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 28<BR>Comparing Files</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch28_10.htm"TITLE="28.10 Problems with diff and Tabstops "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 28.10 Problems with diff and Tabstops "BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="UPT-ART-2820">28.9 ex Scripts Built by diff </A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-31352"></A><ACLASS="indexterm"NAME="AUTOID-31355"></A><ACLASS="indexterm"NAME="AUTOID-31358"></A><ACLASS="indexterm"NAME="UPT-ART-2820-IX-EDITING-WITH-FILE-COMPARISONS"></A><ACLASS="indexterm"NAME="UPT-ART-2820-IX-COMPARING-EDITING-AND"></A>The <EMCLASS="emphasis">-e</EM> option of <EMCLASS="emphasis">diff</EM> produces an editing scriptusable with either<SPANCLASS="link"><EMCLASS="emphasis">ex</EM> (<ACLASS="linkend"HREF="ch33_04.htm"TITLE="Useful ex Commands ">33.4</A>)</SPAN>or <EMCLASS="emphasis">ed</EM>, instead of the usual output.This script consists of a sequence of <CODECLASS="literal">a</CODE> (add), <CODECLASS="literal">c</CODE>(change), and <CODECLASS="literal">d</CODE> (delete) commands necessary to re-create <EMCLASS="emphasis">file2</EM> from <EMCLASS="emphasis">file1</EM> (the first and second files specified on the <EMCLASS="emphasis">diff</EM> command line).</P><PCLASS="para">Obviously there is no need to completely re-create the first file fromthe second, because you could do that easily with <EMCLASS="emphasis">cp</EM>.However, by editing the script produced by <EMCLASS="emphasis">diff</EM>, you can come upwith some desired combination of the two versions.</P><PCLASS="para">It might take you a moment to think of a case in which you might haveuse for this feature.Consider this one: two people have unknowingly made edits todifferent copies of a file, and you need the two versions merged.(This can happen especially easily in a networked environment, inwhich people copy files between machines.Poor coordination can easily result in this kind of problem.)</P><PCLASS="para">To make this situation concrete, let's take a look at two versions ofthe same paragraph, that we want to combine:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"><EMCLASS="emphasis">Version 1:</EM>The Book of Kells, now one of the treasures of the TrinityCollege Library in Dublin, was found in the ancientmonastery at Ceannanus Mor, now called Kells. It is abeautifully illustrated manuscript of the Latin Gospels,and also contains notes on local history. It was written in the eighth century. The manuscript is generally regarded as the finest exampleof Celtic illumination.<EMCLASS="emphasis">Version 2:</EM>The Book of Kells was found in the ancientmonastery at Ceannanus Mor, now called Kells. It is abeautifully illustrated manuscript of the Latin Gospels,and also contains notes on local history. It is believed to have been written in the eighth century. The manuscript is generally regarded as the finest exampleof Celtic illumination.</PRE></BLOCKQUOTE></P><PCLASS="para">As you can see, there is one additional phrase in each of the two files.We can merge them into one file that incorporates bothedits.Typing:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$ <CODECLASS="userinput"><B>diff -e version1 version2 &gt; exscript</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">will yield the following output in the file <EMCLASS="emphasis">exscript</EM>:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">6cIt is believed to have been written in the eighth century. .1,2cThe Book of Kells was found in the ancient.</PRE></BLOCKQUOTE></P><PCLASS="para">You'll notice that the script appears in reverse order, with thechanges later in the file appearing first.This is essential whenever you're making changes based on linenumbers;  otherwise, changes made earlier in the file may change thenumbering, rendering the later parts of the script ineffective.You'll also notice that, as mentioned, this script will simplyrecreate <EMCLASS="emphasis">version2</EM>, which is not what we want.We want the change to line 5, but not the change to lines 1 and 2.We want to edit the script so that it looks like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">6cIt is believed to have been written in the eighth century. .w</PRE></BLOCKQUOTE></P><PCLASS="para">(Notice that we had to add the <CODECLASS="literal">w</CODE> command to write the resultsof the edit back into the file.)Now we can type:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$ <CODECLASS="userinput"><B>ex - version1 &lt; exscript</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">to get the resulting merged file:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">The Book of Kells, now one of the treasures of the TrinityCollege Library in Dublin, was found in the ancientmonastery at Ceannanus Mor, now called Kells. It is abeautifully illustrated manuscript of the Latin Gospels,and also contains notes on local history. It is believed to have been written in the eighth century. The manuscript is generally regarded as the finest exampleof Celtic illumination.</PRE></BLOCKQUOTE></P><PCLASS="para">Using <EMCLASS="emphasis">diff</EM> like this can get confusing, especially when thereare many changes.It is easy to get the direction of changes confused or to make the wrong edits.Just remember to do the following:</P><ULCLASS="itemizedlist"><LICLASS="listitem"><PCLASS="para">Specify the file that is closest in content to your eventual target asthe first file on the <EMCLASS="emphasis">diff</EM> command line.This will minimize the size of the editing script that is produced.</P></LI><LICLASS="listitem"><PCLASS="para">After you have corrected the editing script so that it makes only thechanges that you want, apply it to that same file (the first file).</P></LI></UL><PCLASS="para">Nonetheless, because there is so much room for error, it is better notto have your script write the changes back directly into one of yoursource files.Instead of adding a <CODECLASS="literal">w</CODE> command at the end of the script, addthe command <CODECLASS="literal">%p</CODE> (or <CODECLASS="literal">1,$p</CODE>) to write the results to <SPANCLASS="link">standard output (<ACLASS="linkend"HREF="ch13_01.htm#UPT-ART-1023"TITLE="Using Standard Input and Output">13.1</A>)</SPAN>.This is almost always preferable when you are using a complex editingscript.</P><PCLASS="para">&#13;If we use this command in the editing script, the command line toactually make the edits would look like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$ <CODECLASS="userinput"><B>ex - version1 &lt; exscript &gt; version3</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">Writers often find themselves making extensive changes and thenwishing they could go back and recover some part of an earlierversion.Obviously, frequent backups will help.However, if backup storage space is at a premium, it is possibleto save only some older version of a fileand then keep incremental <EMCLASS="emphasis">diff</EM> <EMCLASS="emphasis">-e</EM> scripts to mark thedifferences between each successive version.(As it turns out, this is what version control systems like<SPANCLASS="link">SCCS and RCS (<ACLASS="linkend"HREF="ch20_12.htm"TITLE="Protecting Files with SCCS or RCS ">20.12</A>)</SPAN>do.)</P><PCLASS="para">To apply multiple scripts to a single file, you can simply pipe themto <EMCLASS="emphasis">ex</EM> rather than redirecting input:</P><PCLASS="para"><TABLECLASS="screen.co"BORDER="1"><TR><THVALIGN="TOP"><PRECLASS="calloutlist"><ACLASS="co"HREF="ch25_02.htm"TITLE="25.2 Four Ways to Skin a cat ">cat</A> </PRE></TH><TDVALIGN="TOP"><PRECLASS="screen">$ <CODECLASS="userinput"><B>cat script1 script2 script3 | ex - oldfile</B></CODE></PRE></TD></TR></TABLE></P><PCLASS="para">But wait!How do you get your <CODECLASS="literal">w</CODE> (or <CODECLASS="literal">%p</CODE>) command into thepipeline?You could edit the last script to include one of these commands.But there's another trick that we ought to look at because itillustrates another useful feature of the shell that many people areunaware of.If you enclose a semicolon-separated list of commands in<SPANCLASS="link">parentheses (<ACLASS="linkend"HREF="ch13_07.htm"TITLE="The () Subshell Operators ">13.7</A>)</SPAN>,the standard output of all of the commands are combined, and can beredirected together.The immediate application is that, if you type:</P><PCLASS="para"><TABLECLASS="screen.co"BORDER="1"><TR><THVALIGN="TOP"><PRECLASS="calloutlist"><ACLASS="co"HREF="ch08_06.htm"TITLE="8.6 Output Command-Line Arguments ">echo</A> </PRE></TH><TDVALIGN="TOP"><PRECLASS="screen">$ <CODECLASS="userinput"><B>cat script1 script2 script3; echo '%p' | ex - oldfile</B></CODE></PRE></TD></TR></TABLE></P><PCLASS="para">the results of the <EMCLASS="emphasis">cat</EM> command will be sent, as usual, tostandard output, and only the results of <EMCLASS="emphasis">echo</EM> will be piped to<EMCLASS="emphasis">ex</EM>.But if you type:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">$ <CODECLASS="userinput"><B>(cat script1 script2 script3; echo '%p') | ex - oldfile</B></CODE></PRE></BLOCKQUOTE></P><PCLASS="para">the output of the entire sequence will make it into the pipeline,which is what we want.</P><ACLASS="indexterm"NAME="AUTOID-31450"></A><ACLASS="indexterm"NAME="AUTOID-31451"></A><DIVCLASS="sect1info"><PCLASS="SECT1INFO">- <SPANCLASS="authorinitials">TOR</SPAN> <SPANCLASS="bibliomisc">from <CITECLASS="citetitle">UNIX Text Processing</CITE>, Hayden Books, 1987, Chapter 12</SPAN></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch28_08.htm"TITLE="28.8 More Friendly diff Output "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 28.8 More Friendly diff Output "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="UNIX Power Tools"><IMGSRC="../gifs/txthome.gif"ALT="UNIX Power Tools"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch28_10.htm"TITLE="28.10 Problems with diff and Tabstops "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 28.10 Problems with diff and Tabstops "BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">28.8 More Friendly diff Output </TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">28.10 Problems with diff and Tabstops </TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><IMGSRC="../gifs/smnavbar.gif"USEMAP="#map"BORDER="0"ALT="The UNIX CD Bookshelf Navigation"><MAPNAME="map"><AREASHAPE="RECT"COORDS="0,0,73,21"HREF="../index.htm"ALT="The UNIX CD Bookshelf"><AREASHAPE="RECT"COORDS="74,0,163,21"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="164,0,257,21"HREF="../unixnut/index.htm"ALT="UNIX in a Nutshell"><AREASHAPE="RECT"COORDS="258,0,321,21"HREF="../vi/index.htm"ALT="Learning the vi Editor"><AREASHAPE="RECT"COORDS="322,0,378,21"HREF="../sedawk/index.htm"ALT="sed &amp; awk"><AREASHAPE="RECT"COORDS="379,0,438,21"HREF="../ksh/index.htm"ALT="Learning the Korn Shell"><AREASHAPE="RECT"COORDS="439,0,514,21"HREF="../lrnunix/index.htm"ALT="Learning the UNIX Operating System"></MAP></DIV></BODY></HTML>