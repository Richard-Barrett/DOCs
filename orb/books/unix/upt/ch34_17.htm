<HTML><HEAD><TITLE>[Chapter 34] 34.17 Searching for Patterns Split Across Lines </TITLE><METANAME="DC.title"CONTENT="UNIX Power Tools"><METANAME="DC.creator"CONTENT="Jerry Peek, Tim O'Reilly &amp; Mike Loukides"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1998-08-04T21:47:27Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-260-3"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch34_01.htm"TITLE="34. The sed Stream Editor"><LINKREL="prev"HREF="ch34_16.htm"TITLE="34.16 The Deliberate Scrivener "><LINKREL="next"HREF="ch34_18.htm"TITLE="34.18 Multiline Delete "></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="UNIX Power Tools"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,58"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch34_16.htm"TITLE="34.16 The Deliberate Scrivener "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 34.16 The Deliberate Scrivener "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 34<BR>The sed Stream Editor</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch34_18.htm"TITLE="34.18 Multiline Delete "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 34.18 Multiline Delete "BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="UPT-ART-0090">34.17 Searching for Patterns Split Across Lines </A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-39103"></A>[Article <ACLASS="xref"HREF="ch27_11.htm"TITLE="A Multiline Context grep Using sed ">27.11</A>introduced ascript called <ICLASS="filename">cgrep.sed</I>,a general-purpose, <ICLASS="filename">grep</I>-like program built with <ICLASS="filename">sed</I>.It allows you to look for one or more words that appear on one lineor across several lines.This article explains the <ICLASS="filename">sed</I> tricks thatare necessary to do this kind of thing.It gets into territory thatis essential for any advanced applications of this obscure yetwonderful editor.(Articles<ACLASS="xref"HREF="ch34_13.htm"TITLE="Hold Space: The Set-Aside Buffer ">34.13</A>through<ACLASS="xref"HREF="ch34_16.htm"TITLE="The Deliberate Scrivener ">34.16</A>have background information.) -JP]</P><PCLASS="para">Let's review the two examples from article<ACLASS="xref"HREF="ch27_11.htm"TITLE="A Multiline Context grep Using sed ">27.11</A>.The first command below finds all lines containing the word <EMCLASS="emphasis">system</EM>in the file <EMCLASS="emphasis">main.c</EM>, and shows 10 additional lines of context aboveand below each match.The second command finds all occurrences of the word &quot;awk&quot; where it isfollowed by the word &quot;perl&quot; somewhere within the next 3 lines:<ACLASS="indexterm"NAME="AUTOID-39117"></A></P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">cgrep -10 system main.ccgrep -3 &quot;awk.*perl&quot;</PRE></BLOCKQUOTE></P><PCLASS="para">Now the script, followed by an explanation of how it works:</P><PCLASS="para"><TABLECLASS="screen.co"BORDER="1"><TR><THVALIGN="TOP"><PRECLASS="calloutlist">&#13;<ACLASS="co"HREF="ch44_06.htm"TITLE="44.6 Pattern Matching in case Statements ">case</A> <ACLASS="co"HREF="ch45_28.htm"TITLE="45.28 Quick Reference: expr ">expr</A> <ACLASS="co"HREF="ch45_12.htm"TITLE="45.12 Parameter Substitution ">${?}</A> <ACLASS="co"HREF="ch44_15.htm"TITLE="44.15 Handling Command-Line Arguments in Shell Scripts ">&quot;$@&quot;</A> </PRE></TH><TDVALIGN="TOP"><PRECLASS="screen">#!/bin/sh#  cgrep - multiline context grep using sed#  Usage: cgrep [-context] pattern [file...]n=3case $1 in -[1-9]*)    n=`expr 1 - &quot;$1&quot;`    shiftesacre=${1?}; shiftsed -n &quot;    1b start    : top    \~$re~{        h; n; p; H; g        b endif    }        N        : start        //{ =; p; }    : endif    $n,\$D    b top&quot; &quot;$@&quot;</PRE></TD></TR></TABLE></P><PCLASS="para">The <EMCLASS="emphasis">sed</EM> script is embedded in a bare-bones<SPANCLASS="link">shell wrapper (<ACLASS="linkend"HREF="ch44_14.htm"TITLE="Putting awk, sed, etc., Inside Shell Scripts ">44.14</A>)</SPAN>to parse out the initial arguments because, unlike <EMCLASS="emphasis">awk</EM> and<EMCLASS="emphasis">perl</EM>, <EMCLASS="emphasis">sed</EM> cannot directly access command-line parameters.If the first argument looks like a <EMCLASS="emphasis">-context</EM> option, variable<EMCLASS="emphasis">n</EM> is reset to one more than the number of lines specified, usinga little trick&nbsp;- the argument is treated as a negative number andsubtracted from <CODECLASS="literal">1</CODE>.The pattern argument is then stored in <CODECLASS="literal">$re</CODE>, with the<CODECLASS="literal">${1?}</CODE> syntax causing the shell to abort with an error messageif no pattern was given.Any remaining arguments are passed as filenames to the <EMCLASS="emphasis">sed</EM>command.</P><PCLASS="para">So that the <CODECLASS="literal">$re</CODE> and <CODECLASS="literal">$n</CODE> parameters can be embedded,the sed script is enclosed in<SPANCLASS="link">double quotes (<ACLASS="linkend"HREF="ch08_14.htm"TITLE="Bourne Shell Quoting ">8.14</A>)</SPAN>.We use the <EMCLASS="emphasis">-n</EM> option because we don't want to print out everyline by default, and because we need to use the <CODECLASS="literal">n</CODE> commandin the script without its side effect of outputting a line.</P><PCLASS="para">The <EMCLASS="emphasis">sed</EM> script itself looks rather unstructured (it was actuallydesigned using a flowchart), but the basic algorithm is easy enoughto understand.We keep a &quot;window&quot; of <EMCLASS="emphasis">n</EM> lines in the pattern spaceand scroll this window through the input stream.If an occurrence of the pattern comes into the window, the entirewindow is printed (providing <EMCLASS="emphasis">n</EM> lines of previous context), andeach subsequent line is printed until the pattern scrolls out of viewagain (providing <EMCLASS="emphasis">n</EM> lines of following context).The sed idiom <CODECLASS="literal">N;D</CODE> is used to advance the window, with the<CODECLASS="literal">D</CODE> not kicking in until the first <EMCLASS="emphasis">n</EM> lines of input havebeen accumulated.</P><PCLASS="para">The core of the script is basically an if-then-else constructthat decides if we are currently &quot;in context.&quot;(The regular expression here is delimited by tilde (<CODECLASS="literal">~</CODE>)characters because tildes are less likely to occur in the user-suppliedpattern than slashes.)<BCLASS="emphasis.bold">If</B> we are still in context, <BCLASS="emphasis.bold">then</B> the next line ofinput is read and output, temporarily using the hold space tosave the window (and effectively doing an <CODECLASS="literal">N</CODE> in the process).<BCLASS="emphasis.bold">Else</B> we append the next input line (<CODECLASS="literal">N</CODE>) and search for thepattern again (an empty regular expression means to reuse thelast pattern).If it's now found, then the pattern must have just come into view&nbsp;- sowe print the current line number followed by the contents of thewindow.Subsequent iterations will take the &quot;then&quot; branch until the patternscrolls out of the window.</P><DIVCLASS="sect1info"><PCLASS="SECT1INFO">- <SPANCLASS="authorinitials">GU</SPAN></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch34_16.htm"TITLE="34.16 The Deliberate Scrivener "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 34.16 The Deliberate Scrivener "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="UNIX Power Tools"><IMGSRC="../gifs/txthome.gif"ALT="UNIX Power Tools"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch34_18.htm"TITLE="34.18 Multiline Delete "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 34.18 Multiline Delete "BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">34.16 The Deliberate Scrivener </TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">34.18 Multiline Delete </TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><IMGSRC="../gifs/smnavbar.gif"USEMAP="#map"BORDER="0"ALT="The UNIX CD Bookshelf Navigation"><MAPNAME="map"><AREASHAPE="RECT"COORDS="0,0,73,21"HREF="../index.htm"ALT="The UNIX CD Bookshelf"><AREASHAPE="RECT"COORDS="74,0,163,21"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="164,0,257,21"HREF="../unixnut/index.htm"ALT="UNIX in a Nutshell"><AREASHAPE="RECT"COORDS="258,0,321,21"HREF="../vi/index.htm"ALT="Learning the vi Editor"><AREASHAPE="RECT"COORDS="322,0,378,21"HREF="../sedawk/index.htm"ALT="sed &amp; awk"><AREASHAPE="RECT"COORDS="379,0,438,21"HREF="../ksh/index.htm"ALT="Learning the Korn Shell"><AREASHAPE="RECT"COORDS="439,0,514,21"HREF="../lrnunix/index.htm"ALT="Learning the UNIX Operating System"></MAP></DIV></BODY></HTML>