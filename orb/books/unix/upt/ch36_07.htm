<HTML><HEAD><TITLE>[Chapter 36] 36.7 Sorting Multiline Entries </TITLE><METANAME="DC.title"CONTENT="UNIX Power Tools"><METANAME="DC.creator"CONTENT="Jerry Peek, Tim O'Reilly &amp; Mike Loukides"><METANAME="DC.publisher"CONTENT="O'Reilly &amp; Associates, Inc."><METANAME="DC.date"CONTENT="1998-08-04T21:48:43Z"><METANAME="DC.type"CONTENT="Text.Monograph"><METANAME="DC.format"CONTENT="text/html"SCHEME="MIME"><METANAME="DC.source"CONTENT="1-56592-260-3"SCHEME="ISBN"><METANAME="DC.language"CONTENT="en-US"><METANAME="generator"CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINKREV="made"HREF="mailto:online-books@oreilly.com"TITLE="Online Books Comments"><LINKREL="up"HREF="ch36_01.htm"TITLE="36. Sorting"><LINKREL="prev"HREF="ch36_06.htm"TITLE="36.6 Miscellaneous sort Hints "><LINKREL="next"HREF="ch36_08.htm"TITLE="36.8 lensort: Sort Lines by Length "></HEAD><BODYBGCOLOR="#FFFFFF"TEXT="#000000"><DIVCLASS="htmlnav"><H1><IMGSRC="gifs/smbanner.gif"ALT="UNIX Power Tools"USEMAP="#srchmap"BORDER="0"></H1><MAPNAME="srchmap"><AREASHAPE="RECT"COORDS="0,0,466,58"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="467,0,514,18"HREF="../search/psrch.htm"ALT="Search this book"></MAP><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch36_06.htm"TITLE="36.6 Miscellaneous sort Hints "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 36.6 Miscellaneous sort Hints "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><B><FONTFACE="ARIEL,HELVETICA,HELV,SANSERIF"SIZE="-1">Chapter 36<BR>Sorting</FONT></B></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch36_08.htm"TITLE="36.8 lensort: Sort Lines by Length "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 36.8 lensort: Sort Lines by Length "BORDER="0"></A></TD></TR></TABLE>&nbsp;<HRALIGN="LEFT"WIDTH="515"TITLE="footer"></DIV><DIVCLASS="SECT1"><H2CLASS="sect1"><ACLASS="title"NAME="UPT-ART-0043">36.7 Sorting Multiline Entries </A></H2><PCLASS="para"><ACLASS="indexterm"NAME="AUTOID-41790"></A>There's one limitation to <EMCLASS="emphasis">sort</EM>. It works a line at a time. Ifyou want to sort a file with multiline entries, you're in toughshape. For example, let's say you have a list of addresses:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Doe, John and Jane30 Anywhere StAnytown, New York10023Buck, Jane and John40 Anywhere StNowheresville, Alaska90023</PRE></BLOCKQUOTE></P><TABLECLASS="para.programreference"BORDER="1"><TR><THVALIGN="TOP"><ACLASS="programreference"HREF="examples/index.htm"TITLE="chunksort">chunksort</A><BR></TH><TDVALIGN="TOP">How would you sort these? Certainly not with <EMCLASS="emphasis">sort</EM>-whatever youdo, you'll end up with a mish-mash of unmatched addresses, names, andzip codes.The <EMCLASS="emphasis">chunksort</EM> script will do the trick.Here's the part of the script that does the real work:<ACLASS="indexterm"NAME="AUTOID-41800"></A></TD></TR></TABLE><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen"># completely empty lines separate records.gawk '{    gsub(/\n/,&quot;\1&quot;);    print $0 &quot;\1&quot; }' RS= $files |sort $sortopts |tr '\1' '\12'</PRE></BLOCKQUOTE></P><PCLASS="para">The script starts with a lot of option processing that we don't showhere&nbsp;- it's incredibly thorough, and allows you to use any <EMCLASS="emphasis">sort</EM>options, except <EMCLASS="emphasis">-o</EM>.It also adds a new <EMCLASS="emphasis">-a</EM> option, whichallows you to sort based on different lines of a multiline entry.Say you're sorting an address file, and the street address is on thesecond line of each entry.The command <CODECLASS="literal">chunksort&nbsp;-a&nbsp;+3</CODE> wouldsort the file based on the zip codes.I'm not sure if this is really useful (you can't, for example, sort onthe third field of the second line), but it's a nice bit ofadditional functionality.</P><PCLASS="para">The body of the script (after the option processing) is conceptuallysimple.It uses<SPANCLASS="link"><EMCLASS="emphasis">gawk</EM> (<ACLASS="linkend"HREF="ch33_12.htm"TITLE="Versions of awk ">33.12</A>)</SPAN>to collapse each multiline record into asingle line, with the CTRL-a character to mark where the linebreaks were. After this processing, a few addresses from a typicaladdress list might look like this:</P><PCLASS="para"><BLOCKQUOTECLASS="screen"><PRECLASS="screen">Doe, John and Jane^A30 Anywhere St^AAnytown, New York^A10023^ABuck, Jane and John^A40 Anywhere St^ANowheresville, Alaska^A90023^A</PRE></BLOCKQUOTE></P><PCLASS="para">Now that we've converted the original file into a list of one-line entries, wehave something that <EMCLASS="emphasis">sort</EM> can handle. So we just use <EMCLASS="emphasis">sort</EM>,with whatever options were supplied on the command line.After sorting,<SPANCLASS="link"><EMCLASS="emphasis">tr</EM> (<ACLASS="linkend"HREF="ch35_11.htm"TITLE="Hacking on Characters with tr ">35.11</A>)</SPAN>&quot;unpacks&quot; this single-linerepresentation, restoring the file to its original form,by converting each CTRL-a back to a newline.Notice that the <EMCLASS="emphasis">gawk</EM> script added an extra CTRL-a to theend of each output line&nbsp;- so <EMCLASS="emphasis">tr</EM> outputs an extra newline, plusthe newline from the <EMCLASS="emphasis">gawk</EM> <EMCLASS="emphasis">print</EM> command, to give a blankline between each entry.(Thanks to Greg Ubben for this improvement.)</P><PCLASS="para">There are lots of interesting variations on this script. You cansubstitute <EMCLASS="emphasis">grep</EM> for the <EMCLASS="emphasis">sort</EM> command, allowing you to search for multiline entries&nbsp;- for example, to look up addresses in anaddress file. This would require slightly different optionprocessing, but the script would be essentially the same.</P><DIVCLASS="sect1info"><PCLASS="SECT1INFO">- <SPANCLASS="authorinitials">JP</SPAN>, <SPANCLASS="authorinitials">ML</SPAN></P></DIV></DIV><DIVCLASS="htmlnav"><P></P><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><TABLEWIDTH="515"BORDER="0"CELLSPACING="0"CELLPADDING="0"><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch36_06.htm"TITLE="36.6 Miscellaneous sort Hints "><IMGSRC="../gifs/txtpreva.gif"ALT="Previous: 36.6 Miscellaneous sort Hints "BORDER="0"></A></TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="book"HREF="index.htm"TITLE="UNIX Power Tools"><IMGSRC="../gifs/txthome.gif"ALT="UNIX Power Tools"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172"><ACLASS="SECT1"HREF="ch36_08.htm"TITLE="36.8 lensort: Sort Lines by Length "><IMGSRC="../gifs/txtnexta.gif"ALT="Next: 36.8 lensort: Sort Lines by Length "BORDER="0"></A></TD></TR><TR><TDALIGN="LEFT"VALIGN="TOP"WIDTH="172">36.6 Miscellaneous sort Hints </TD><TDALIGN="CENTER"VALIGN="TOP"WIDTH="171"><ACLASS="index"HREF="index/idx_0.htm"TITLE="Book Index"><IMGSRC="../gifs/index.gif"ALT="Book Index"BORDER="0"></A></TD><TDALIGN="RIGHT"VALIGN="TOP"WIDTH="172">36.8 lensort: Sort Lines by Length </TD></TR></TABLE><HRALIGN="LEFT"WIDTH="515"TITLE="footer"><IMGSRC="../gifs/smnavbar.gif"USEMAP="#map"BORDER="0"ALT="The UNIX CD Bookshelf Navigation"><MAPNAME="map"><AREASHAPE="RECT"COORDS="0,0,73,21"HREF="../index.htm"ALT="The UNIX CD Bookshelf"><AREASHAPE="RECT"COORDS="74,0,163,21"HREF="index.htm"ALT="UNIX Power Tools"><AREASHAPE="RECT"COORDS="164,0,257,21"HREF="../unixnut/index.htm"ALT="UNIX in a Nutshell"><AREASHAPE="RECT"COORDS="258,0,321,21"HREF="../vi/index.htm"ALT="Learning the vi Editor"><AREASHAPE="RECT"COORDS="322,0,378,21"HREF="../sedawk/index.htm"ALT="sed &amp; awk"><AREASHAPE="RECT"COORDS="379,0,438,21"HREF="../ksh/index.htm"ALT="Learning the Korn Shell"><AREASHAPE="RECT"COORDS="439,0,514,21"HREF="../lrnunix/index.htm"ALT="Learning the UNIX Operating System"></MAP></DIV></BODY></HTML>